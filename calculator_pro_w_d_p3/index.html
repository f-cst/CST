
<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>calculator pro w/d - برنامه سوم</title>
  <script src="https://cdn.tailwindcss.com"></script>
<style>
    :root{
      --bg:#1e293b;
      --card:#334155;
      --muted:#9aa6bf;
      --input-bg:#475569;
      --text-light:#f1f5f9;
    }
    body{
      font-family: Vazirmatn, system-ui, sans-serif; 
      background:var(--bg); 
      color:var(--text-light); 
      min-height:100vh; 
      padding:20px;
    }
    .card{
      background:var(--card); 
      border:1px solid rgba(255,255,255,0.08); 
      border-radius:10px; 
      padding:12px;
    }
    .section-header{
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      gap:8px; 
      cursor:pointer; 
      padding:.5rem; 
      border-radius:8px; 
      background:var(--input-bg); 
      border:1px solid rgba(255,255,255,0.08);
    }
    .section-title{
      font-weight:700;
    }
    .muted{
      color:var(--muted); 
      font-size:.95rem;
    }
    input[type="text"], input[type="date"], input[type="number"], select, textarea { 
      background:var(--input-bg); 
      border:1px solid rgba(255,255,255,0.1); 
      color:var(--text-light); 
      padding:.5rem; 
      border-radius:6px; 
      width:100%; 
      outline: none;
      transition: all 0.2s ease;
    }
    input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, select:focus, textarea:focus { 
      border-color: rgba(59, 130, 246, 0.5);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }
    input::placeholder{ 
      color:#9ca3af; 
    }
    .box-out{ 
      padding:.35rem .6rem; 
      border-radius:6px; 
      display:inline-block; 
      cursor:pointer; 
      margin:.25rem 0; 
      border: 1px solid transparent;
      transition: all 0.2s ease;
    }
    .box-red{ 
      background:#7f1d1d; 
      color:#fff; 
      border-color: #991b1b;
    }
    .box-green{ 
      background:#064e3b; 
      color:#fff; 
      border-color: #065f46;
    }
    .box-gray{ 
      background:#4b5563; 
      color:#fff; 
      border-color: #6b7280;
    }
    .box-blue{ 
      background:#1e3a8a; 
      color:#fff; 
      border-color: #3730a3;
    }
    .box-yellow{ 
      background:#854d0e; 
      color:#fff; 
      border-color: #a16207;
    }
    .num-label{ 
      font-weight:700; 
      margin-left:.45rem; 
      opacity:.95; 
    }
    /* استایل کامل و اصلاح شده برای دکمه‌ها */
    .small-btn{ 
      padding:0.5rem 0.75rem; 
      border-radius:0.5rem; 
      font-size:0.875rem; 
      cursor:pointer; 
      border: 2px solid rgba(255, 255, 255, 0.2);
      background: var(--input-bg);
      color: var(--text-light);
      transition: all 0.3s ease;
      outline: none;
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 40px;
      font-weight: 500;
      text-decoration: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    /* استایل‌های hover و focus برای دکمه‌ها */
    .small-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.4);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .small-btn:focus {
      outline: 2px solid rgba(59, 130, 246, 0.6);
      outline-offset: 2px;
      border-color: rgba(59, 130, 246, 0.8);
    }
    .small-btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    /* استایل‌های خاص برای رنگ‌های مختلف دکمه‌ها */
    .small-btn.bg-slate-600 {
      background: #475569;
      border-color: #64748b;
      color: #fff;
    }
    .small-btn.bg-slate-600:hover {
      background: #64748b;
      border-color: #94a3b8;
    }
    .small-btn.bg-emerald-600 {
      background: #059669;
      border-color: #10b981;
      color: #fff;
    }
    .small-btn.bg-emerald-600:hover {
      background: #10b981;
      border-color: #34d399;
    }
    .small-btn.bg-rose-600 {
      background: #dc2626;
      border-color: #ef4444;
      color: #fff;
    }
    .small-btn.bg-rose-600:hover {
      background: #ef4444;
      border-color: #f87171;
    }
    .small-btn.bg-blue-600 {
      background: #2563eb;
      border-color: #3b82f6;
      color: #fff;
    }
    .small-btn.bg-blue-600:hover {
      background: #3b82f6;
      border-color: #60a5fa;
    }
    .small-btn.bg-yellow-600 {
      background: #d97706;
      border-color: #f59e0b;
      color: #fff;
    }
    .small-btn.bg-yellow-600:hover {
      background: #f59e0b;
      border-color: #fbbf24;
    }
    .small-btn.bg-indigo-600 {
      background: #4f46e5;
      border-color: #6366f1;
      color: #fff;
    }
    .small-btn.bg-indigo-600:hover {
      background: #6366f1;
      border-color: #818cf8;
    }
    .small-btn.bg-purple-600 {
      background: #7c3aed;
      border-color: #8b5cf6;
      color: #fff;
    }
    .small-btn.bg-purple-600:hover {
      background: #8b5cf6;
      border-color: #a78bfa;
    }
    .small-btn.bg-green-600 {
      background: #059669;
      border-color: #10b981;
      color: #fff;
    }
    .small-btn.bg-green-600:hover {
      background: #10b981;
      border-color: #34d399;
    }
    /* استایل برای دکمه‌های در حالت disabled */
    .small-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .small-btn:disabled:hover {
      background: inherit;
      border-color: inherit;
      transform: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    /* استایل مخصوص برای دکمه‌های داخل فهرست جفت‌ارزها */
    #categories_container .small-btn {
      padding: 0.2rem 0.4rem !important;
      font-size: 0.7rem !important;
      min-height: 24px !important;
      border-width: 1px !important;
      white-space: nowrap;
    }
    /* استایل برای selectهای داخل فهرست جفت‌ارزها */
    #categories_container select.small-btn {
      padding: 0.15rem 0.3rem !important;
      font-size: 0.65rem !important;
      min-height: 22px !important;
      max-width: 120px;
    }
    /* استایل برای دکمه‌های عمل در لیست جفت‌ارزها */
    #categories_container button.small-btn {
      min-width: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* استایل برای آیتم‌های لیست جفت‌ارزها */
    #categories_container li {
      padding: 0.4rem 0.5rem !important;
      gap: 0.3rem !important;
    }
    /* استایل برای container دکمه‌ها در هر آیتم */
    #categories_container .flex.gap-1 {
      flex-wrap: nowrap !important;
      gap: 0.2rem !important;
      min-width: fit-content;
    }
    .thin-scroll::-webkit-scrollbar{ 
      width:8px; 
      height:8px; 
    }
    .thin-scroll::-webkit-scrollbar-thumb{ 
      background:rgba(255,255,255,0.1); 
      border-radius:8px; 
    }
    .hidden{ 
      display:none !important; 
    }
    
    .icon-btn{ 
      background:var(--input-bg); 
      border:1px solid rgba(255,255,255,0.08); 
      padding:.35rem .5rem; 
      border-radius:6px; 
      cursor:pointer; 
      color:var(--text-light);
      transition: all 0.2s ease;
    }
    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }
    .title-click{ 
      display:flex; 
      align-items:center; 
      gap:8px; 
    }
    .category-header{ 
      background:rgba(255,255,255,0.08); 
      padding:.5rem; 
      border-radius:6px; 
      margin:.5rem 0; 
      cursor:pointer; 
      border:1px solid rgba(255,255,255,0.08);
      transition: all 0.2s ease;
    }
    .category-header:hover {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(255, 255, 255, 0.15);
    }
    .category-content{ 
      padding:.5rem; 
      border-right:2px solid #0ea5a4; 
      margin-right:.5rem; 
    }
    .danger-zone{ 
      background:#7f1d1d; 
      border:1px solid rgba(239,68,68,0.3); 
      padding:12px; 
      border-radius:8px; 
      margin-top:12px; 
    }
    .calendar-icon{ 
      color:var(--text-light); 
      font-size:1.2rem; 
    }
    .show-picker-btn{ 
      color:var(--text-light) !important; 
      background:rgba(255,255,255,0.15) !important; 
      border:1px solid rgba(255,255,255,0.2) !important; 
      padding: 0.5rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .show-picker-btn:hover {
      background: rgba(255, 255, 255, 0.25) !important;
      border-color: rgba(255, 255, 255, 0.3) !important;
    }
    .center-modal{ 
      display:flex !important; 
      align-items:center; 
      justify-content:center; 
    }
    .category-item{ 
      background:rgba(255,255,255,0.05); 
      border:1px solid rgba(255,255,255,0.1); 
    }
    .resizable-container { 
      resize: vertical; 
      overflow: auto; 
      min-height: 120px; 
      max-height: 400px; 
    }
    .history-compact { 
      max-height: none !important; 
      overflow: visible !important;
    }
    .history-entry-compact {
      background: var(--input-bg);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
      transition: all 0.2s ease;
    }
    .history-entry-compact:hover {
      border-color: rgba(255,255,255,0.2);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    .backup-item {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin: 10px 0;
    }
    .stat-item {
      background: rgba(255,255,255,0.05);
      padding: 8px;
      border-radius: 6px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 1000;
    }
    .modal-content {
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
      margin: auto;
    }
    .closest-info {
      background: rgba(245, 158, 11, 0.2);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 8px;
      padding: 10px;
      margin-top: 12px;
    }
    .multi-date-controls {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 12px;
    }
    .date-range-item {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 8px;
    }
    .date-comparison-header {
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 8px;
    }
    .comparison-group {
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 12px;
      transition: all 0.2s ease;
    }
    .comparison-group:hover {
      border-color: rgba(255,255,255,0.2);
    }
    .signature {
      color: white;
      text-align: center;
      padding: 16px;
      font-family: Vazirmatn, system-ui;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 14px;
      font-weight: 500;
      display: block;
      margin: 30px auto;
      width: fit-content;
      max-width: 90%;
      box-sizing: border-box;
    }
    /* استایل‌های مخصوص موبایل */
    @media only screen and (max-width: 768px) {
      .small-btn {
        min-height: 44px;
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
        border-width: 2px;
      }
      /* استایل مخصوص موبایل برای دکمه‌های فهرست جفت‌ارزها */
      #categories_container .small-btn {
        padding: 0.15rem 0.3rem !important;
        font-size: 0.65rem !important;
        min-height: 22px !important;
      }
      #categories_container select.small-btn {
        padding: 0.1rem 0.25rem !important;
        font-size: 0.6rem !important;
        min-height: 20px !important;
        max-width: 100px;
      }
      #categories_container button.small-btn {
        min-width: 24px;
      }
      #categories_container li {
        padding: 0.3rem 0.4rem !important;
        gap: 0.2rem !important;
        flex-wrap: wrap;
      }
      #categories_container .flex.gap-1 {
        gap: 0.15rem !important;
        order: 2;
        width: 100%;
        justify-content: flex-start;
        margin-top: 0.3rem;
        padding-top: 0.3rem;
        border-top: 1px solid rgba(255,255,255,0.1);
      }
      #categories_container .flex-1 {
        order: 1;
        width: 100%;
      }
      .signature {
        font-size: 14px;
        padding: 15px;
      }
      /* اطمینان از نمایش border در موبایل */
      .small-btn:active {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.4);
        transform: scale(0.98);
      }
      .box-out {
        padding: 0.5rem 0.75rem;
        min-height: 44px;
        display: flex;
        align-items: center;
      }
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 6px;
      }
    }
    @media only screen and (max-width: 480px) {
      .signature {
        font-size: 12px;
        padding: 13px;
      }
      .small-btn {
        padding: 0.875rem 1rem;
        font-size: 0.95rem;
      }
    }
/* استایل برای آیکون دکمه تاگل */
#toggle_icon {
  transition: all 0.3s ease;
  font-weight: bold;
  display: inline-block;
}
/* افکت hover برای دکمه تاگل */
#toggle_history_btn:hover #toggle_icon {
  transform: scale(1.2);
}
/* استایل برای حالت باز بودن */
#toggle_history_btn.open {
  background: #374151 !important;
  border-color: #6b7280 !important;
}
/* استایل برای حالت بسته بودن */
#toggle_history_btn.closed {
  background: #475569 !important;
  border-color: #64748b !important;
}
</style>
</head>
<body>
  <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-4">
    <aside class="card">
      <div id="hdr_pairs" class="section-header">
<div class="title-click">
    <span class="hamburger-icon">⇅</span>
    <span class="section-title">مدیریت جفت‌ارز - برنامه سوم</span>
</div>
      </div>
      <div id="box_pairs" class="mt-3">
        <div class="mb-4 p-3 rounded bg-[var(--input-bg)] border border-white/10">
          <label class="muted block mb-2">مدیریت دسته‌بندی‌ها</label>
          <div class="flex gap-2 mb-2">
            <input id="new_category_name" placeholder="نام دسته‌بندی جدید" type="text" class="flex-1"/>
            <button id="add_category_btn" class="small-btn bg-blue-600 hover:bg-blue-700">افزودن</button>
          </div>
          <div class="flex gap-2 mb-2">
            <select id="category_select" class="flex-1">
              <option value="">بدون دسته‌بندی</option>
            </select>
            <button id="delete_category_btn" class="small-btn bg-rose-600 hover:bg-rose-700" title="حذف دسته‌بندی انتخاب شده">🗑</button>
          </div>
          <div class="mt-2">
            <label class="muted text-xs">دسته‌بندی‌های موجود:</label>
            <div id="categories_list" class="mt-1 space-y-1 max-h-20 overflow-y-auto thin-scroll"></div>
          </div>
        </div>
        <div class="mb-3">
          <input id="new_pair_name" placeholder="مثال: EURUSD" type="text"/>
          <div class="flex gap-2 mt-2">
            <button id="add_pair_btn" class="small-btn bg-emerald-600 hover:bg-emerald-700">افزودن</button>
            <button id="clear_pairs_btn" class="small-btn bg-rose-600 hover:bg-rose-700">حذف همه</button>
          </div>
        </div>
        <div>
          <div class="flex justify-between items-center mb-2">
            <label class="muted">فهرست جفت‌ارزها</label>
            <span class="text-xs muted">(قابل تغییر سایز)</span>
          </div>
          <div id="categories_container" class="resizable-container mt-2 thin-scroll border border-white/10 rounded p-2 space-y-3">
          </div>
        </div>
        <div class="border-t border-white/10 pt-3 mt-3">
          <div class="mb-2">
            <button id="export_btn" class="small-btn bg-blue-600 hover:bg-blue-700 w-full">دانلود بک‌آپ (JSON)</button>
          </div>
          <div class="mb-2">
            <input id="import_file" type="file" accept="application/json" class="hidden"/>
            <button id="import_btn" class="small-btn bg-yellow-600 hover:bg-yellow-700 w-full">بارگذاری بک‌آپ (JSON)</button>
          </div>
          <div class="danger-zone">
            <div class="text-center mb-2">
              <span class="text-white font-semibold">⚙ مدیریت پیشرفته داده‌ها</span>
            </div>
            <div class="mb-3">
              <label class="muted text-xs block mb-1">حذف رکوردهای قدیمی‌تر از:</label>
              <div class="flex gap-2">
                <input id="manual_prune_days" type="number" min="1" max="3650" value="365" class="flex-1 text-center"/>
                <span class="muted text-xs flex items-center">روز</span>
              </div>
              <button id="manual_prune_btn" class="small-btn bg-rose-700 hover:bg-rose-800 text-white w-full mt-2">
                حذف رکوردهای قدیمی
              </button>
            </div>
            <button id="show_stats_btn" class="small-btn bg-purple-600 hover:bg-purple-700 text-white w-full mb-2">
              نمایش آمار و اطلاعات
            </button>
            <button id="manage_backups_btn" class="small-btn bg-indigo-600 hover:bg-indigo-700 text-white w-full">
              مدیریت بک‌آپ‌ها
            </button>
            <p class="muted text-xs mt-2 text-center">این عملیات غیرقابل بازگشت هستند</p>
          </div>
          <p class="muted text-xs mt-2">تاریخ‌ها میلادی ذخیره و نمایش داده می‌شوند.</p>
        </div>
      </div>
    </aside>
    <main class="card">
      <div id="hdr_calc" class="section-header">
        <div class="title-click">
    <span class="hamburger-icon">⇅</span>
    <span class="section-title">ماشین حساب فرمول‌ها — برنامه سوم</span>
</div>
      </div>
      <div id="box_calc" class="mt-3">
        <div class="mb-3">
          <div class="flex items-center gap-2 mb-2">
            <label class="muted flex-1">جفت‌ارز</label>
          </div>
          <select id="pair_select"></select>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-3">
          <div>
            <label class="muted">عدد سقف</label>
            <input id="input_y1" type="text" placeholder=""/>
          </div>
          <div>
            <label class="muted">عدد فعلی سقف</label>
            <input id="input_current_high" type="text" placeholder=""/>
          </div>
          <div>
            <label class="muted">عدد کف</label>
            <input id="input_y2" type="text" placeholder=""/>
          </div>
          <div>
            <label class="muted">عدد فعلی کف</label>
            <input id="input_current_low" type="text" placeholder=""/>
          </div>
        </div>
        <div class="mb-3">
          <label class="muted">تاریخ (میلادی)</label>
          <div class="flex items-center gap-2">
            <input id="date_picker" type="date" class="flex-1"/>
            <button type="button" onclick="document.getElementById('date_picker').showPicker()" class="small-btn show-picker-btn" title="نمایش تقویم">
              📅
            </button>
          </div>
          <p class="muted text-xs mt-1">تاریخ انتخاب‌شده برای ذخیره رکورد استفاده می‌شود.</p>
        </div>
        <div class="mb-3">
          <label class="muted">یادداشت (اختیاری)</label>
          <textarea id="note_input" rows="2" placeholder=""></textarea>
        </div>
        <div class="flex gap-2 mb-3">
          <button id="calculate_button" class="small-btn bg-emerald-600 hover:bg-emerald-700 flex-1">محاسبه و ذخیره</button>
          <button id="reset_button" class="small-btn bg-slate-600 hover:bg-slate-700 flex-1">ریست</button>
        </div>
        <div>
          <h4 class="muted mb-2">نتایج (مرتب‌شده از کوچک به بزرگ)</h4>
          <div id="results_list" class="space-y-2"></div>
          <div id="closest_info" class="closest-info hidden"></div>
          <p id="error_message" class="muted text-rose-400 mt-2"></p>
          
        </div>
      </div>
    </main>
    <section class="card">
      <div id="hdr_history" class="section-header">
                <div class="title-click">
    <span class="hamburger-icon">⇅</span>
    <span class="section-title">تاریخچه - برنامه سوم</span>
</div>
      </div>
      <div id="box_history" class="mt-3">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-semibold">تاریخچه</div>
          <div class="muted">کل: <span id="entries_count">0</span></div>
        </div>
<div class="flex gap-2 mb-3">
  <button id="toggle_history_btn" class="small-btn flex-1 bg-slate-600 hover:bg-slate-700 flex items-center justify-center gap-2 transition-all duration-300 closed">
    <span id="toggle_icon" class="text-lg transition-all duration-300 transform">📁</span>
    <span id="toggle_text" class="transition-all duration-300">نمایش ذخیره‌ها</span>
  </button>
  <button id="quick_prune" class="small-btn bg-rose-600 hover:bg-rose-700 hidden">پاک ۳۰ روزه</button>
</div>
        <div id="history_panel" class="mt-3 hidden">
          <div class="multi-date-controls">
            <div class="flex items-center justify-between mb-3">
              <label class="muted font-semibold">📅 مشاهده چند تاریخ همزمان</label>
              <button id="toggle_multi_date" class="small-btn bg-blue-600 hover:bg-blue-700 text-xs">
                فعال کردن حالت چندتاریخی
              </button>
            </div>
            <div id="single_date_section">
              <div class="mb-2 grid grid-cols-2 gap-2">
                <input id="history_date" type="date"/>
                <select id="history_pair_filter">
                  <option value="">همه جفت‌ارزها</option>
                </select>
              </div>
            </div>
            <div id="multi_date_section" class="hidden">
              <div class="mb-3">
                <div class="flex items-center gap-2 mb-2">
                  <select id="multi_date_pair_filter" class="flex-1">
                    <option value="">همه جفت‌ارزها</option>
                  </select>
                </div>
                <div id="date_ranges_container" class="space-y-2">
                </div>
                <div class="flex gap-2 mt-3">
                  <button id="add_date_btn" class="small-btn bg-green-600 hover:bg-green-700 flex-1">
                    ➕ افزودن تاریخ
                  </button>
                  <button id="apply_multi_date_btn" class="small-btn bg-blue-600 hover:bg-blue-700 flex-1">
                    🔍 اعمال فیلتر
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div id="history_list" class="history-compact space-y-2"></div>
        </div>
        <div id="detail_modal" class="hidden fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
          <div class="bg-[var(--card)] p-6 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto border border-white/10">
            <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-3">
              <h4 class="font-bold text-lg">جزئیات کامل رکورد - برنامه سوم</h4>
              <button id="close_detail" class="small-btn bg-slate-600 hover:bg-slate-700">بستن</button>
            </div>
            <div id="detail_content" class="mt-2 text-sm space-y-4"></div>
            <div class="flex gap-2 mt-6 pt-4 border-t border-white/10">
              <button id="edit_record_btn" class="small-btn bg-yellow-600 hover:bg-yellow-700 flex-1">ویرایش</button>
              <button id="move_record_btn" class="small-btn bg-indigo-600 hover:bg-indigo-700 flex-1">انتقال تاریخ</button>
              <button id="delete_record_btn" class="small-btn bg-rose-600 hover:bg-rose-700 flex-1">حذف</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
  <div id="stats_modal" class="hidden modal-overlay">
    <div class="modal-content bg-[var(--card)] p-6 rounded-lg max-w-md w-full mx-4 border border-white/10">
      <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-3">
        <h4 class="font-bold text-lg">📊 آمار و اطلاعات سیستم - برنامه سوم</h4>
        <button id="close_stats" class="small-btn bg-slate-600 hover:bg-slate-700">✕</button>
      </div>
      <div id="stats_content" class="mt-2 text-sm space-y-4">
      </div>
    </div>
  </div>
  <div id="backups_modal" class="hidden modal-overlay">
    <div class="modal-content bg-[var(--card)] p-6 rounded-lg max-w-2xl w-full mx-4 border border-white/10">
      <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-3">
        <h4 class="font-bold text-lg">💾 مدیریت بک‌آپ‌ها - برنامه سوم</h4>
        <button id="close_backups" class="small-btn bg-slate-600 hover:bg-slate-700">✕</button>
      </div>
      <div id="backups_content" class="mt-2 text-sm space-y-4">
      </div>
    </div>
  </div>
<script>
// ---------- helpers ----------
const uid = ()=> Date.now().toString(36)+Math.random().toString(36).slice(2,6);
const storageGet = k => JSON.parse(localStorage.getItem('calc_pro_3_' + k) || 'null');
const storageSet = (k,v) => localStorage.setItem('calc_pro_3_' + k, JSON.stringify(v));
const AUTO_PRUNE_ENABLED = false;
const MAX_DAYS = 3650;
function nowISO(){ return new Date().toISOString(); }
function formatGregorian(dtISO){
  const d = new Date(dtISO);
  const pad = n => n.toString().padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function ensureDefaults(){ 
  if(!storageGet('pairs')) storageSet('pairs',[]); 
  if(!storageGet('entries')) storageSet('entries',[]);
  if(!storageGet('categories')) storageSet('categories',[
    {id: 'default', name: 'اصلی'},
    {id: 'forex', name: 'فارکس'},
    {id: 'crypto', name: 'ارز دیجیتال'}
  ]);
}
ensureDefaults();
// ---------- تشخیص دستگاه موبایل/تبلت ----------
function isMobileOrTablet() {
    return window.innerWidth <= 1024;
}
// ---------- مدیریت وضعیت باکس‌ها بر اساس دستگاه ----------
function initializeBoxStates() {
    if (isMobileOrTablet()) {
        if(boxPairs) boxPairs.classList.add('hidden');
        if(boxCalc) boxCalc.classList.add('hidden');
        if(boxHistory) boxHistory.classList.add('hidden');
    } else {
        if(boxPairs) boxPairs.classList.remove('hidden');
        if(boxCalc) boxCalc.classList.remove('hidden');
        if(boxHistory) boxHistory.classList.remove('hidden');
    }
}
// ---------- DOM refs ----------
const $ = id => document.getElementById(id);
const pairSelect = $('pair_select');
const historyPairFilter = $('history_pair_filter');
const newPairName = $('new_pair_name');
const addPairBtn = $('add_pair_btn');
const clearPairsBtn = $('clear_pairs_btn');
const categoriesContainer = $('categories_container');
const categorySelect = $('category_select');
const newCategoryName = $('new_category_name');
const addCategoryBtn = $('add_category_btn');
const deleteCategoryBtn = $('delete_category_btn');
const categoriesList = $('categories_list');
const inputY1 = $('input_y1');
const inputCurrentHigh = $('input_current_high');
const inputY2 = $('input_y2');
const inputCurrentLow = $('input_current_low');
const noteInput = $('note_input');
const datePicker = $('date_picker');
const calculateButton = $('calculate_button');
const resetButton = $('reset_button');
const resultsList = $('results_list');
const errorMessage = $('error_message');
const closestInfo = $('closest_info');
const exportBtn = $('export_btn');
const importFile = $('import_file');
const importBtn = $('import_btn');
const historyDate = $('history_date');
const historyList = $('history_list');
const entriesCount = $('entries_count');
const toggleHistoryBtn = $('toggle_history_btn');
const historyPanel = $('history_panel');
const quickPrune = $('quick_prune');
const detailModal = $('detail_modal');
const detailContent = $('detail_content');
const closeDetail = $('close_detail');
const editRecordBtn = $('edit_record_btn');
const moveRecordBtn = $('move_record_btn');
const deleteRecordBtn = $('delete_record_btn');
const togglePairsHdr = $('hdr_pairs');
const boxPairs = $('box_pairs');
const toggleCalcHdr = $('hdr_calc');
const boxCalc = $('box_calc');
const toggleHistoryHdr = $('hdr_history');
const boxHistory = $('box_history');
const toggleMultiDateBtn = $('toggle_multi_date');
const singleDateSection = $('single_date_section');
const multiDateSection = $('multi_date_section');
const multiDatePairFilter = $('multi_date_pair_filter');
const dateRangesContainer = $('date_ranges_container');
const addDateBtn = $('add_date_btn');
const applyMultiDateBtn = $('apply_multi_date_btn');
// ---------- UI utils ----------
function safeForEach(arr, fn){ if(!Array.isArray(arr)) return; arr.forEach(fn); }

// ---------- توابع جدید برای پردازش فرمت نقطه‌دار بدون اعشار ----------
function parseFormattedInteger(str) {
  if (!str) return { rawNumber: NaN, format: { hasDot: false } };
  const original = str.toString().trim();
  const hasDot = original.includes('.');
  if (!hasDot) {
    const cleaned = original.replace(/[^\d]/g, '');
    return { rawNumber: cleaned ? parseInt(cleaned, 10) : NaN, format: { hasDot: false } };
  }
  const parts = original.split('.');
  if (parts.length !== 2) {
    const cleaned = original.replace(/[^\d]/g, '');
    return { rawNumber: cleaned ? parseInt(cleaned, 10) : NaN, format: { hasDot: false } };
  }
  const [leftPart, rightPart] = parts;
  const leftDigits = leftPart.replace(/[^\d]/g, '');
  const rightDigits = rightPart.replace(/[^\d]/g, '');
  if (!leftDigits && !rightDigits) return { rawNumber: NaN, format: { hasDot: false } };
  const fullNumberStr = (leftDigits + rightDigits) || '0';
  const totalLength = fullNumberStr.length;
  const rawNumber = parseInt(fullNumberStr, 10);
  return {
    rawNumber,
    format: {
      hasDot: true,
      left: leftDigits.length,
      right: rightDigits.length,
      total: totalLength
    }
  };
}

function formatOutputByInputFormat(number, inputFormat) {
  if (isNaN(number)) return '';
  const numStr = Math.abs(number).toString();
  const isNegative = number < 0;
  if (!inputFormat || !inputFormat.hasDot) {
    return isNegative ? '-' + numStr : numStr;
  }
  const { left, right, total } = inputFormat;
  let padded = numStr.padStart(total, '0');
  if (padded.length > total) {
    padded = padded.slice(-total);
  }
  const leftPart = padded.slice(0, left);
  const rightPart = padded.slice(left);
  const finalLeft = leftPart === '' ? '0' : parseInt(leftPart || '0', 10).toString();
  let result = finalLeft + '.' + rightPart;
  if (isNegative) result = '-' + result;
  return result;
}

function findClosestNumbers(numbers) {
  if (numbers.length < 2) return { pairs: [], minDistance: 0 };
  let minDistance = Infinity;
  const closestPairs = [];
  for (let i = 0; i < numbers.length; i++) {
    for (let j = i + 1; j < numbers.length; j++) {
      const distance = Math.abs(numbers[i].value - numbers[j].value);
      if (distance < minDistance) {
        minDistance = distance;
        closestPairs.length = 0;
        closestPairs.push([numbers[i], numbers[j]]);
      } else if (distance === minDistance) {
        closestPairs.push([numbers[i], numbers[j]]);
      }
    }
  }
  return { pairs: closestPairs, minDistance };
}

function renderClosestInfo(closestPairs, minDistance, inputFormat) {
  if (!closestInfo) return;
  if (closestPairs.length === 0) {
    closestInfo.classList.add('hidden');
    return;
  }
  const displayDist = formatOutputByInputFormat(minDistance, inputFormat);
  let closestText = `<div class="text-sm font-semibold mb-2">نزدیک‌ترین اعداد (فاصله: ${displayDist}):</div>`;
  closestPairs.forEach(pair => {
    const display1 = formatOutputByInputFormat(pair[0].value, inputFormat);
    const display2 = formatOutputByInputFormat(pair[1].value, inputFormat);
    closestText += `<div class="text-xs mb-1">• ${pair[0].label} (${display1}) و ${pair[1].label} (${display2})</div>`;
  });
  closestInfo.innerHTML = closestText;
  closestInfo.classList.remove('hidden');
}

function computeOutputs(y1, y2, currentLow, currentHigh) {
  const result1 = Math.floor(Math.pow(Math.sqrt(y1) - 1, 2));
  const result2 = Math.floor(Math.pow(Math.sqrt(y1) - 0.5, 2));
  const result3 = Math.floor(Math.pow(Math.sqrt(y2) + 1, 2));
  const result4 = Math.floor(Math.pow(Math.sqrt(y2) + 0.5, 2));
  return [result1, result2, result3, result4];
}

function decideColor(v, currentLow, currentHigh){ 
  if(v < currentLow) return 'box-red'; 
  if(v > currentHigh) return 'box-green'; 
  return 'box-gray'; 
}

function buildDisplayOutputs(outputs, currentLow, currentHigh, inputFormat, closestPairs = []) {
  const results = [];
  if (!isNaN(outputs[0])) results.push({ label: "فرمول ۱ (سقف)", value: outputs[0] });
  if (!isNaN(outputs[1])) results.push({ label: "فرمول ۲ (سقف)", value: outputs[1] });
  if (!isNaN(outputs[2])) results.push({ label: "فرمول ۳ (کف)", value: outputs[2] });
  if (!isNaN(outputs[3])) results.push({ label: "فرمول ۴ (کف)", value: outputs[3] });
  results.sort((a, b) => a.value - b.value);
  return results.map((result, index) => {
    const color = decideColor(result.value, currentLow, currentHigh);
    const isClosest = closestPairs.some(pair => 
      pair.some(p => p.label === result.label && p.value === result.value)
    );
    const displayVal = formatOutputByInputFormat(result.value, inputFormat);
    const suffix = (result.value < currentLow ? ' ↓ زیر کف فعلی' : (result.value > currentHigh ? ' ↑ بالای سقف فعلی' : ''));
    return { 
      order: index + 1, 
      label: result.label,
      raw: result.value, 
      display: displayVal, 
      color: isClosest ? 'box-yellow' : color, 
      suffix: suffix 
    };
  });
}

function renderResultsDisplay(outputsDisplay){
  if(!resultsList) return;
  resultsList.innerHTML = '';
  safeForEach(outputsDisplay, it=>{
    const span = document.createElement('span');
    span.className = `box-out ${it.color} cursor-pointer hover:opacity-80 transition-opacity`;
    span.title = `کلیک برای کپی: ${it.display}`;
    span.innerHTML = `<span class="num-label">${it.order}.</span> (${it.label}) ${it.display} ${it.suffix}`;
    span.addEventListener('click', () => copyToClipboard(it.display));
    const p = document.createElement('div'); p.appendChild(span); resultsList.appendChild(p);
  });
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    const message = document.createElement('div');
    message.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-bounce';
    message.innerHTML = `✅ عدد <strong>${text}</strong> کپی شد`;
    document.body.appendChild(message);
    setTimeout(() => {
      if (document.body.contains(message)) {
        document.body.removeChild(message);
      }
    }, 2000);
  }).catch(err => {
    console.error('خطا در کپی کردن: ', err);
    const textArea = document.createElement('textarea');
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
  });
}

// ---------- مدیریت داده‌ها ----------
function saveEntry(pairId, inputs, outputsDisplay, note='', dateISO=null, inputFormat=null, closestInfo=null){
  const entries = storageGet('entries')||[];
  const si = dateISO || nowISO();
  const entry = { 
    id: uid(), 
    pairId, 
    dateISO: si, 
    dateDisplay: formatGregorian(si), 
    inputs, 
    outputsDisplay, 
    note,
    inputFormat: inputFormat,
    closestInfo: closestInfo || null
  };
  entries.push(entry); 
  storageSet('entries', entries);
  if (AUTO_PRUNE_ENABLED) pruneOldEntries();
  renderHistory();
}

function pruneOldEntries(){
  if (!AUTO_PRUNE_ENABLED) return;
  const entries = storageGet('entries')||[];
  const cutoff = Date.now() - (MAX_DAYS * 24 * 60 * 60 * 1000);
  const kept = entries.filter(e => new Date(e.dateISO).getTime() >= cutoff);
  if(kept.length !== entries.length) storageSet('entries', kept);
}

initializeBoxStates();

// ---------- event listeners ----------

if(calculateButton) calculateButton.addEventListener('click', ()=>{
  if(!inputY1 || !inputY2 || !inputCurrentHigh || !inputCurrentLow){ 
    if(errorMessage) errorMessage.textContent = 'خطا: برخی فیلدها موجود نیستند.'; 
    return; 
  }
  if(errorMessage) errorMessage.textContent = '';
  try{
    const parsedY1 = parseFormattedInteger(inputY1.value);
    const parsedCurrentHigh = parseFormattedInteger(inputCurrentHigh.value);
    const parsedY2 = parseFormattedInteger(inputY2.value);
    const parsedCurrentLow = parseFormattedInteger(inputCurrentLow.value);

    const y1 = parsedY1.rawNumber;
    const currentHigh = parsedCurrentHigh.rawNumber;
    const y2 = parsedY2.rawNumber;
    const currentLow = parsedCurrentLow.rawNumber;

    if(isNaN(y1) || isNaN(y2) || isNaN(currentLow) || isNaN(currentHigh)) throw new Error('لطفاً چهار فیلد اصلی را با اعداد معتبر پر کنید.');
    if(y1 < 0 || y2 < 0) throw new Error('لطفاً فقط اعداد مثبت وارد کنید.');

    const outputs = computeOutputs(y1, y2, currentLow, currentHigh);

    const resultsForClosest = [];
    if (!isNaN(outputs[0])) resultsForClosest.push({ label: "فرمول ۱ (سقف)", value: outputs[0] });
    if (!isNaN(outputs[1])) resultsForClosest.push({ label: "فرمول ۲ (سقف)", value: outputs[1] });
    if (!isNaN(outputs[2])) resultsForClosest.push({ label: "فرمول ۳ (کف)", value: outputs[2] });
    if (!isNaN(outputs[3])) resultsForClosest.push({ label: "فرمول ۴ (کف)", value: outputs[3] });

    const { pairs: closestPairs, minDistance } = findClosestNumbers(resultsForClosest);

    const displays = buildDisplayOutputs(outputs, currentLow, currentHigh, parsedY1.format, closestPairs);
    renderResultsDisplay(displays);
    renderClosestInfo(closestPairs, minDistance, parsedY1.format);

    let chosenISO = null;
    if(datePicker && datePicker.value){
      const dp = datePicker.value;
      const now = new Date();
      const timePart = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
      const iso = new Date(dp + 'T' + timePart);
      if(!isNaN(iso)) chosenISO = iso.toISOString();
    }
    if(!chosenISO) chosenISO = nowISO();

    const pairId = pairSelect ? pairSelect.value || null : null;
    const note = noteInput ? noteInput.value || '' : '';

    saveEntry(pairId, {
      y1, y2, currentLow, currentHigh,
      originalY1: inputY1.value,
      originalCurrentHigh: inputCurrentHigh.value,
      originalY2: inputY2.value,
      originalCurrentLow: inputCurrentLow.value
    }, displays, note, chosenISO, parsedY1.format, {
      closestPairs: closestPairs,
      minDistance: minDistance
    });
  }catch(err){ 
    if(errorMessage) errorMessage.textContent = 'خطا: '+err.message; 
  }
});



if(resetButton) resetButton.addEventListener('click', ()=>{
  if(inputY1) inputY1.value = '';
  if(inputY2) inputY2.value = '';
  if(inputCurrentHigh) inputCurrentHigh.value = '';
  if(inputCurrentLow) inputCurrentLow.value = '';
  if(resultsList) resultsList.innerHTML = '';
  if(errorMessage) errorMessage.textContent = '';
  if(closestInfo) {
    closestInfo.innerHTML = '';
    closestInfo.classList.add('hidden');
  }
});


// ---------- مدیریت جفت‌ارزها ----------
function renderPairs(){
  const pairs = storageGet('pairs') || [];
  if(pairSelect) pairSelect.innerHTML = '';
  if(historyPairFilter) historyPairFilter.innerHTML = '<option value="">همه جفت‌ارزها</option>';
  if(multiDatePairFilter) multiDatePairFilter.innerHTML = '<option value="">همه جفت‌ارزها</option>';
  pairs.forEach(p => {
    if(pairSelect){
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.name;
      pairSelect.appendChild(opt);
    }
    if(historyPairFilter){
      const opt2 = document.createElement('option');
      opt2.value = p.id;
      opt2.textContent = p.name;
      historyPairFilter.appendChild(opt2);
    }
    if(multiDatePairFilter){
      const opt3 = document.createElement('option');
      opt3.value = p.id;
      opt3.textContent = p.name;
      multiDatePairFilter.appendChild(opt3);
    }
  });
  if(pairs.length === 0 && pairSelect){
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = 'ابتدا یک جفت‌ارز اضافه کنید';
    pairSelect.appendChild(opt);
  }
  renderCategories();
}
function addPair(name){
  if(!name || !name.trim()) return;
  const pairs = storageGet('pairs')||[];
  const selectedCategory = categorySelect ? categorySelect.value : null;
  pairs.push({
    id: uid(), 
    name: name.trim(),
    categoryId: selectedCategory || null
  });
  storageSet('pairs', pairs);
  renderPairs();
}
function swapPairs(i,j){
  const pairs = storageGet('pairs')||[];
  if(!pairs[i] || !pairs[j]) return;
  [pairs[i], pairs[j]] = [pairs[j], pairs[i]];
  storageSet('pairs', pairs);
  renderPairs();
}
function movePairToCategory(pairId, newCategoryId){
  const pairs = storageGet('pairs')||[];
  const pair = pairs.find(p => p.id === pairId);
  if(pair){
    pair.categoryId = newCategoryId || null;
    storageSet('pairs', pairs);
    renderPairs();
  }
}
if(addPairBtn) addPairBtn.addEventListener('click', ()=>{ addPair(newPairName ? newPairName.value : ''); if(newPairName) newPairName.value=''; });
if(clearPairsBtn) clearPairsBtn.addEventListener('click', ()=>{ if(confirm('آیا همه جفت‌ارزها حذف شوند؟')){ storageSet('pairs', []); renderPairs(); } });
// ---------- مدیریت دسته‌بندی‌ها ----------
function renderCategories(){
  const categories = storageGet('categories') || [];
  const pairs = storageGet('pairs') || [];
  if(categorySelect){
    categorySelect.innerHTML = '<option value="">بدون دسته‌بندی</option>';
    categories.forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat.id;
      opt.textContent = cat.name;
      categorySelect.appendChild(opt);
    });
  }
  if(categoriesList){
    categoriesList.innerHTML = '';
    if(categories.length === 0){
      categoriesList.innerHTML = '<div class="text-xs muted text-center py-1">دسته‌بندی‌ای وجود ندارد</div>';
    } else {
      categories.forEach(cat => {
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center p-1 px-2 rounded category-item';
        div.innerHTML = `
          <span class="text-xs">${cat.name}</span>
          <span class="text-xs muted">${pairs.filter(p => p.categoryId === cat.id).length} جفت‌ارز</span>
        `;
        categoriesList.appendChild(div);
      });
    }
  }
  if(categoriesContainer){
    categoriesContainer.innerHTML = '';
    const uncategorizedPairs = pairs.filter(p => !p.categoryId);
    if(uncategorizedPairs.length > 0){
      renderCategorySection(null, 'بدون دسته‌بندی', uncategorizedPairs);
    }
    categories.forEach(category => {
      const categoryPairs = pairs.filter(p => p.categoryId === category.id);
      if(categoryPairs.length > 0){
        renderCategorySection(category.id, category.name, categoryPairs);
      }
    });
  }
}
function renderCategorySection(categoryId, categoryName, pairs){
  const section = document.createElement('div');
  section.className = 'category-section';
  section.innerHTML = `
    <div class="category-header flex justify-between items-center" data-category="${categoryId || ''}">
      <div class="font-semibold text-sm">${categoryName} (${pairs.length})</div>
    </div>
    <div class="category-content">
      <ul class="space-y-2 pairs-list-${categoryId || 'uncategorized'}"></ul>
    </div>
  `;
  categoriesContainer.appendChild(section);
  const pairsList = section.querySelector(`.pairs-list-${categoryId || 'uncategorized'}`);
  pairs.forEach(p => {
    const li = document.createElement('li');
    li.className = 'flex items-center justify-between gap-2 p-2 rounded bg-white/5';
    const categories = storageGet('categories') || [];
    const categoryOptions = categories.map(cat => 
      `<option value="${cat.id}" ${p.categoryId === cat.id ? 'selected' : ''}>${cat.name}</option>`
    ).join('');
    li.innerHTML = `
      <div class="flex-1 text-sm">${p.name}</div>
      <div class="flex gap-1">
        <select class="small-btn bg-slate-600 text-xs move-category" data-id="${p.id}">
          <option value="">انتقال به...</option>
          ${categoryOptions}
          <option value="" ${!p.categoryId ? 'selected' : ''}>بدون دسته‌بندی</option>
        </select>
        <button data-action="up" data-id="${p.id}" class="small-btn bg-slate-600">▲</button>
        <button data-action="down" data-id="${p.id}" class="small-btn bg-slate-600">▼</button>
        <button data-action="edit" data-id="${p.id}" class="small-btn bg-yellow-600">✎</button>
        <button data-action="delete" data-id="${p.id}" class="small-btn bg-rose-600">🗑</button>
      </div>
    `;
    pairsList.appendChild(li);
  });
  const header = section.querySelector('.category-header');
  header.addEventListener('click', () => {
    const content = section.querySelector('.category-content');
    content.classList.toggle('hidden');
  });
}
function addCategory(name){
  if(!name || !name.trim()) return;
  const categories = storageGet('categories') || [];
  if(categories.some(cat => cat.name === name.trim())){
    alert('این نام دسته‌بندی قبلاً وجود دارد!');
    return;
  }
  categories.push({id: uid(), name: name.trim()});
  storageSet('categories', categories);
  renderCategories();
}
function deleteCategory(){
  const selectedCategoryId = categorySelect ? categorySelect.value : null;
  if(!selectedCategoryId){
    alert('لطفاً یک دسته‌بندی را انتخاب کنید!');
    return;
  }
  const categories = storageGet('categories') || [];
  const category = categories.find(cat => cat.id === selectedCategoryId);
  if(!category) return;
  const pairs = storageGet('pairs') || [];
  const pairsInCategory = pairs.filter(p => p.categoryId === selectedCategoryId);
  if(pairsInCategory.length > 0){
    if(!confirm(`دسته‌بندی "${category.name}" دارای ${pairsInCategory.length} جفت‌ارز است. آیا می‌خواهید این دسته‌بندی حذف شود و جفت‌ارزهای آن به "بدون دسته‌بندی" منتقل شوند؟`)){
      return;
    }
    pairsInCategory.forEach(p => { p.categoryId = null; });
    storageSet('pairs', pairs);
  } else {
    if(!confirm(`آیا از حذف دسته‌بندی "${category.name}" مطمئن هستید؟`)) return;
  }
  const updatedCategories = categories.filter(cat => cat.id !== selectedCategoryId);
  storageSet('categories', updatedCategories);
  renderCategories();
  renderPairs();
}
if(addCategoryBtn) addCategoryBtn.addEventListener('click', () => { addCategory(newCategoryName ? newCategoryName.value : ''); if(newCategoryName) newCategoryName.value = ''; });
if(deleteCategoryBtn) deleteCategoryBtn.addEventListener('click', deleteCategory);
if(categoriesContainer){
  categoriesContainer.addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const action = btn.dataset.action; const id = btn.dataset.id;
    const pairs = storageGet('pairs')||[]; const idx = pairs.findIndex(p => p.id === id);
    if(action === 'up' && idx > 0) swapPairs(idx, idx-1);
    if(action === 'down' && idx < pairs.length-1) swapPairs(idx, idx+1);
    if(action === 'delete'){ if(!confirm('آیا حذف شود؟')) return; pairs.splice(idx,1); storageSet('pairs', pairs); renderPairs(); }
    if(action === 'edit'){ const newName = prompt('نام جدید:', pairs[idx].name); if(newName && newName.trim()){ pairs[idx].name = newName.trim(); storageSet('pairs', pairs); renderPairs(); } }
  });
  categoriesContainer.addEventListener('change', (e) => {
    if(e.target.classList.contains('move-category')){
      const pairId = e.target.dataset.id;
      const newCategoryId = e.target.value || null;
      movePairToCategory(pairId, newCategoryId);
    }
  });
}
// ---------- تاریخچه ----------
function renderHistory(){
  if (multiDateSection && !multiDateSection.classList.contains('hidden')) {
    const selectedPair = multiDatePairFilter ? multiDatePairFilter.value : null;
    const selectedDates = dateRanges.filter(r => r.date).map(r => r.date);
    if (selectedDates.length > 0) {
      renderMultiDateHistory(selectedPair, selectedDates);
      return;
    }
  }
  const entries = (storageGet('entries')||[]).slice();
  entries.sort((a,b)=> new Date(b.dateISO).getTime() - new Date(a.dateISO).getTime());
  if(entriesCount) entriesCount.textContent = entries.length;
  const filterDate = historyDate && historyDate.value ? new Date(historyDate.value).toDateString() : null;
  const filterPair = historyPairFilter && historyPairFilter.value ? historyPairFilter.value : null;
  if(historyList) historyList.innerHTML = '';
  let filtered = entries;
  if(!filterDate){
    const today = new Date().toDateString();
    filtered = entries.filter(e => new Date(e.dateISO).toDateString() === today);
  } else {
    filtered = entries.filter(e => new Date(e.dateISO).toDateString() === filterDate);
  }
  if(filterPair) filtered = filtered.filter(e => e.pairId === filterPair);
  if(filtered.length === 0){ 
    if(historyList) historyList.innerHTML = '<div class="muted text-sm text-center py-4">رکوردی جهت نمایش وجود ندارد.</div>'; 
    return; 
  }
  safeForEach(filtered, e=>{
    const pair = (storageGet('pairs')||[]).find(p=>p.id===e.pairId);
    const pairName = pair?.name || '—';
    const category = pair ? (storageGet('categories')||[]).find(c=>c.id===pair.categoryId) : null;
    const wrapper = document.createElement('div'); 
    wrapper.className = 'history-entry-compact flex flex-col gap-3 hover:border-white/20 transition-colors';
    let closestHTML = '';
    if (e.closestInfo && e.closestInfo.closestPairs && e.closestInfo.closestPairs.length > 0) {
      const displayDist = formatOutputByInputFormat(e.closestInfo.minDistance, e.inputFormat);
      closestHTML = `
        <div class="mt-2 pt-2 border-t border-white/10">
          <div class="text-xs muted mb-1">نزدیک‌ترین اعداد (فاصله: ${displayDist}):</div>
          <div class="text-xs space-y-1">
            ${e.closestInfo.closestPairs.map(pair => 
              `• ${pair[0].label} و ${pair[1].label}`
            ).join('<br>')}
          </div>
        </div>
      `;
    }
    wrapper.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="text-sm font-semibold">${pairName}</div>
          ${category ? `<span class="text-xs bg-blue-600 px-2 py-1 rounded">${category.name}</span>` : ''}
        </div>
        <div class="text-xs muted">${e.dateDisplay}</div>
      </div>
      <div class="flex gap-2 flex-wrap justify-center">
        ${e.outputsDisplay.map(it => 
          `<span class="box-out ${it.color} cursor-pointer hover:opacity-80 transition-opacity" 
                  title="کلیک برای کپی: ${it.display}"
                  onclick="copyToClipboard('${it.display}')">
            <span class="num-label">${it.order}.</span> (${it.label}) ${it.display} ${it.suffix}
          </span>`
        ).join('')}
      </div>
      ${closestHTML}
    `;
    const bottom = document.createElement('div'); 
    bottom.className = 'flex gap-2 justify-end';
    const viewBtn = document.createElement('button'); 
    viewBtn.className = 'small-btn bg-indigo-600 hover:bg-indigo-700 rounded transition-colors'; 
    viewBtn.textContent = 'نمایش جزئیات'; 
    viewBtn.addEventListener('click', ()=> showDetail(e.id));
    bottom.appendChild(viewBtn);
    wrapper.appendChild(bottom);
    historyList.appendChild(wrapper);
  });
}
function showDetail(entryId){
  const entries = storageGet('entries')||[]; 
  const e = entries.find(x=>x.id===entryId); 
  if(!e) return;
  const pair = (storageGet('pairs')||[]).find(p=>p.id===e.pairId);
  const pairName = pair?.name || '—';
  const category = pair ? (storageGet('categories')||[]).find(c=>c.id===pair.categoryId) : null;
  if(detailContent) detailContent.innerHTML = '';
  let closestHTML = '';
  if (e.closestInfo && e.closestInfo.closestPairs && e.closestInfo.closestPairs.length > 0) {
    const displayDist = formatOutputByInputFormat(e.closestInfo.minDistance, e.inputFormat);
    closestHTML = `
      <div class="bg-white/5 p-4 rounded">
        <div class="text-xs muted mb-3">نزدیک‌ترین اعداد</div>
        <div class="text-sm space-y-2">
          <div class="font-semibold">فاصله: ${displayDist}</div>
          ${e.closestInfo.closestPairs.map(pair => 
            `<div class="flex justify-between items-center p-2 bg-white/5 rounded">
              <div>${pair[0].label} و ${pair[1].label}</div>
            </div>`
          ).join('')}
        </div>
      </div>
    `;
  }
  detailContent.innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="space-y-3">
        <div class="bg-white/5 p-3 rounded">
          <div class="text-xs muted mb-1">جفت‌ارز</div>
          <div class="font-semibold flex items-center gap-2">
            ${pairName}
            ${category ? `<span class="text-xs bg-blue-600 px-2 py-1 rounded">${category.name}</span>` : ''}
          </div>
        </div>
        <div class="bg-white/5 p-3 rounded">
          <div class="text-xs muted mb-1">تاریخ (میلادی)</div>
          <div class="font-semibold">${e.dateDisplay}</div>
        </div>
      </div>
      <div class="space-y-3">
        <div class="bg-white/5 p-3 rounded">
          <div class="text-xs muted mb-1">یادداشت</div>
          <div class="font-semibold">${e.note||'---'}</div>
        </div>
      </div>
    </div>
    <div class="bg-white/5 p-4 rounded">
      <div class="text-xs muted mb-3">ورودی‌ها</div>
      <div class="grid grid-cols-2 gap-3 text-sm">
        <div>عدد سقف: <span class="font-mono">${e.inputs.originalY1}</span></div>
        <div>سقف فعلی: <span class="font-mono">${e.inputs.originalCurrentHigh}</span></div>
        <div>عدد کف: <span class="font-mono">${e.inputs.originalY2}</span></div>
        <div>کف فعلی: <span class="font-mono">${e.inputs.originalCurrentLow}</span></div>
      </div>
    </div>
    <div class="bg-white/5 p-4 rounded">
      <div class="text-xs muted mb-3">خروجی‌ها (مرتب‌شده)</div>
      <div class="flex flex-wrap gap-2 justify-center">
        ${e.outputsDisplay.map(it => 
          `<span class="box-out ${it.color} cursor-default text-sm">
            <span class="num-label">${it.order}.</span> (${it.label}) ${it.display} ${it.suffix}
          </span>`
        ).join('')}
      </div>
    </div>
    ${closestHTML}
  `;
  if(detailModal) {
    detailModal.classList.remove('hidden');
    detailModal.classList.add('center-modal');
  }
  if(editRecordBtn) editRecordBtn.onclick = ()=> editRecord(e.id);
  if(deleteRecordBtn) deleteRecordBtn.onclick = ()=> deleteRecord(e.id);
  if(moveRecordBtn) moveRecordBtn.onclick = ()=> moveRecord(e.id);
}
if(closeDetail) closeDetail.addEventListener('click', ()=> { 
  if(detailModal) {
    detailModal.classList.add('hidden');
    detailModal.classList.remove('center-modal');
  }
});
function deleteRecord(id){ 
  if(!confirm('آیا از حذف این رکورد مطمئن هستید؟')) return; 
  const entries = storageGet('entries')||[]; 
  const idx = entries.findIndex(x=>x.id===id); 
  if(idx===-1) return; 
  entries.splice(idx,1); 
  storageSet('entries',entries); 
  renderHistory(); 
  if(detailModal) {
    detailModal.classList.add('hidden');
    detailModal.classList.remove('center-modal');
  }
}
function editRecord(id){
  const entries = storageGet('entries')||[]; const e = entries.find(x=>x.id===id); if(!e) return;
  if(!confirm('مقادیر رکورد در فرم بارگذاری خواهد شد. پس از ویرایش دکمهٔ محاسبه را بزنید تا رکورد جدید ذخیره شود. رکورد قدیمی حذف می‌شود. ادامه می‌دهید؟')) return;
  if(pairSelect) pairSelect.value = e.pairId || '';
  if(inputY1) inputY1.value = e.inputs.originalY1; 
  if(inputCurrentHigh) inputCurrentHigh.value = e.inputs.originalCurrentHigh; 
  if(inputY2) inputY2.value = e.inputs.originalY2; 
  if(inputCurrentLow) inputCurrentLow.value = e.inputs.originalCurrentLow; 
  if(noteInput) noteInput.value = e.note||''; 
  if(datePicker) datePicker.value = e.dateDisplay.split(' ')[0] || '';
  const idx = entries.findIndex(x=>x.id===id); if(idx!==-1){ entries.splice(idx,1); storageSet('entries',entries); }
  renderHistory(); 
  if(detailModal) {
    detailModal.classList.add('hidden');
    detailModal.classList.remove('center-modal');
  }
  window.scrollTo({top:0, behavior:'smooth'});
}
function moveRecord(id){
  const newDate = prompt('تاریخ جدید (YYYY-MM-DD) را وارد کنید:'); if(!newDate) return;
  const d = new Date(newDate + 'T00:00:00'); if(isNaN(d)){ alert('تاریخ نامعتبر.'); return; }
  const entries = storageGet('entries')||[]; const e = entries.find(x=>x.id===id); if(!e) return;
  e.dateISO = d.toISOString(); e.dateDisplay = formatGregorian(e.dateISO); storageSet('entries',entries); renderHistory(); 
  if(detailModal) {
    detailModal.classList.add('hidden');
    detailModal.classList.remove('center-modal');
  }
}
// ---------- backup/import ----------
function showNotification(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg z-50 animate-bounce ${type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`;
  toast.innerHTML = message;
  document.body.appendChild(toast);
  setTimeout(() => {
    if (document.body.contains(toast)) {
      document.body.removeChild(toast);
    }
  }, 4000);
}
if(exportBtn) exportBtn.addEventListener('click', ()=>{
  try {
    const payload = { 
      pairs: storageGet('pairs')||[], 
      entries: storageGet('entries')||[], 
      categories: storageGet('categories')||[],
      meta: {
        created: new Date().toISOString(),
        version: '3.0',
        entryCount: (storageGet('entries')||[]).length,
        pairCount: (storageGet('pairs')||[]).length,
        categoryCount: (storageGet('categories')||[]).length,
        backupId: uid()
      }
    };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json;charset=utf-8'});
    const url = URL.createObjectURL(blob); 
    const a = document.createElement('a'); 
    a.href = url; 
    a.download = 'calculator_pro_w_d_p3-'+new Date().toISOString().slice(0,10)+'.json'; 
    document.body.appendChild(a); 
    a.click(); 
    a.remove(); 
    URL.revokeObjectURL(url);
    showNotification('✅ فایل پشتیبان با موفقیت دانلود شد');
  } catch (err) {
    console.error('خطا در دانلود بک‌آپ:', err);
    showNotification('❌ خطا در دانلود فایل پشتیبان: ' + err.message, 'error');
  }
});
if(importBtn) importBtn.addEventListener('click', ()=> importFile && importFile.click());
if(importFile) importFile.addEventListener('change', (e)=>{ 
  const f = e.target.files[0]; 
  if(!f) return; 
  const reader = new FileReader(); 
  reader.onload = ()=>{ 
    try{ 
      const obj = JSON.parse(reader.result); 
      if(!obj) throw new Error('فایل نامعتبر');
      const currentData = {
        pairs: storageGet('pairs') || [],
        entries: storageGet('entries') || [],
        categories: storageGet('categories') || []
      };
      try {
        if(Array.isArray(obj.pairs)) storageSet('pairs', obj.pairs);
        else storageSet('pairs', []);
        if(Array.isArray(obj.entries)) storageSet('entries', obj.entries);
        else storageSet('entries', []);
        if(Array.isArray(obj.categories)) storageSet('categories', obj.categories);
        else storageSet('categories', []);
        showNotification('بک‌آپ با موفقیت بارگذاری شد','success');
        renderPairs(); 
        renderHistory(); 
        let message = '✅ بک‌آپ با موفقیت بارگذاری شد!\n';
        message += `📊 اطلاعات بک‌آپ:\n`;
        message += `• ${obj.entries?.length || 0} رکورد تاریخی\n`;
        message += `• ${obj.pairs?.length || 0} جفت‌ارز\n`;
        message += `• ${obj.categories?.length || 0} دسته‌بندی\n`;
        alert(message);
      } catch (error) {
        storageSet('pairs', currentData.pairs);
        storageSet('entries', currentData.entries);
        storageSet('categories', currentData.categories);
        throw error;
      }
    } catch(err) { 
      alert('خطا در بارگذاری بک‌آپ: ' + err.message); 
    } 
  }; 
  reader.readAsText(f); 
  importFile.value=''; 
});
// ---------- UI controls ----------
function updateToggleButton(isOpen) {
  const toggleIcon = document.getElementById('toggle_icon');
  const toggleText = document.getElementById('toggle_text');
  const toggleBtn = document.getElementById('toggle_history_btn');
  if (isOpen) {
    toggleIcon.textContent = '📂';
    toggleIcon.style.transform = 'rotate(0deg) scale(1.1)';
    toggleText.textContent = 'بستن ذخیره‌ها';
    toggleBtn.classList.remove('closed');
    toggleBtn.classList.add('open');
  } else {
    toggleIcon.textContent = '📁';
    toggleIcon.style.transform = 'rotate(0deg) scale(1)';
    toggleText.textContent = 'نمایش ذخیره‌ها';
    toggleBtn.classList.remove('open');
    toggleBtn.classList.add('closed');
  }
}
if(toggleHistoryBtn) toggleHistoryBtn.addEventListener('click', ()=>{
  const isCurrentlyHidden = historyPanel.classList.contains('hidden');
  if(isCurrentlyHidden){
    historyPanel.classList.remove('hidden'); 
    updateToggleButton(true);
    const today = new Date().toISOString().split('T')[0];
    if(historyDate) historyDate.value = today;
    renderHistory();
  } else { 
    historyPanel.classList.add('hidden'); 
    updateToggleButton(false);
  }
});
if(historyDate) historyDate.addEventListener('change', renderHistory);
if(historyPairFilter) historyPairFilter.addEventListener('change', renderHistory);
if(togglePairsHdr) togglePairsHdr.addEventListener('click', ()=> { boxPairs.classList.toggle('hidden'); });
if(toggleCalcHdr) toggleCalcHdr.addEventListener('click', ()=> { boxCalc.classList.toggle('hidden'); });
if(toggleHistoryHdr) toggleHistoryHdr.addEventListener('click', ()=> { boxHistory.classList.toggle('hidden'); });
// ---------- شروع اولیه ----------
if((storageGet('pairs')||[]).length === 0){ 
  storageSet('pairs', [
    {id:uid(), name:'EURUSD', categoryId: 'forex'},
    {id:uid(), name:'GBPUSD', categoryId: 'forex'},
    {id:uid(), name:'BTCUSD', categoryId: 'crypto'},
    {id:uid(), name:'ETHUSD', categoryId: 'crypto'}
  ]); 
}
window.addEventListener('load', () => {
  const today = new Date().toISOString().split('T')[0];
  if(historyDate) historyDate.value = today;
  setTimeout(() => { if(inputY1) inputY1.focus(); }, 1000);
});
renderPairs(); 
renderHistory();
setTimeout(() => {
  console.log('✅ سیستم Calculator PRO - برنامه سوم آماده است!');
}, 1000);
</script>
<div class="signature">
    طراحی و ساخت توسط ⦙ سعید شیخ احمد صفاری
</div>
  <BR>
    <BR>
</body>
</html>