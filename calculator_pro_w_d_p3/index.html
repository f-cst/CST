<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>calculator pro w/d - Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø³ÙˆÙ…</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Ù„ÛŒÙ†Ú© ÙÙˆÙ†Øª ÙˆØ²ÛŒØ±Ù…ØªÙ† -->
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
  
  <style>
    :root{
      --bg:#1e293b;
      --card:#334155;
      --muted:#9aa6bf;
      --input-bg:#475569;
      --text-light:#f1f5f9;
    }
    body{
      font-family: 'Vazirmatn', sans-serif; 
      background:var(--bg); 
      color:var(--text-light); 
      min-height:100vh; 
      padding:20px;
      font-size: 16px;
      line-height: 1.6;
    }
    button, input, optgroup, select, textarea {
      font-family: 'Vazirmatn', sans-serif;
    }
    .card{
      background:var(--card); 
      border:1px solid rgba(255,255,255,0.08); 
      border-radius:10px; 
      padding:12px;
    }
    .section-header{
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      gap:8px; 
      cursor:pointer; 
      padding:.5rem; 
      border-radius:8px; 
      background:var(--input-bg);
      border:1px solid rgba(255,255,255,0.08);
    }
    .section-title{
      font-weight:700;
    }
    .muted{
      color:var(--muted); 
      font-size:.9rem;
    }
    input[type="text"], input[type="date"], input[type="number"], select, textarea { 
      background:var(--input-bg); 
      border:1px solid rgba(255,255,255,0.1);
      color:var(--text-light); 
      padding:.6rem .5rem; 
      border-radius:6px; 
      width:100%; 
      outline: none;
      transition: all 0.2s ease;
      font-size: 1rem;
    }
    input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, select:focus, textarea:focus { 
      border-color: rgba(59, 130, 246, 0.5);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }
    input::placeholder{ 
      color:#9ca3af;
    }
    .box-out{ 
      padding:.35rem .6rem; 
      border-radius:6px; 
      display:inline-block; 
      cursor:pointer; 
      margin:.25rem 0;
      border: 1px solid transparent;
      transition: all 0.2s ease;
      font-size: 0.95rem;
    }
    .box-red{ 
      background:#7f1d1d;
      color:#fff; 
      border-color: #991b1b;
    }
    .box-green{ 
      background:#064e3b; 
      color:#fff; 
      border-color: #065f46;
    }
    .box-gray{ 
      background:#4b5563; 
      color:#fff; 
      border-color: #6b7280;
    }
    .box-blue{ 
      background:#1e3a8a; 
      color:#fff; 
      border-color: #3730a3;
    }
    .box-yellow{ 
      background:#854d0e; 
      color:#fff; 
      border-color: #a16207;
    }
    .num-label{ 
      font-weight:700; 
      margin-left:.45rem; 
      opacity:.95;
    }
    .small-btn{ 
      padding:0.5rem 0.75rem;
      border-radius:0.5rem; 
      font-size:0.9rem; 
      cursor:pointer; 
      border: 2px solid rgba(255, 255, 255, 0.2);
      background: var(--input-bg);
      color: var(--text-light);
      transition: all 0.3s ease;
      outline: none;
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 40px;
      font-weight: 500;
      text-decoration: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .small-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.4);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .small-btn:focus {
      outline: 2px solid rgba(59, 130, 246, 0.6);
      outline-offset: 2px;
      border-color: rgba(59, 130, 246, 0.8);
    }
    .small-btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    .small-btn.bg-slate-600 { background: #475569; border-color: #64748b; color: #fff; }
    .small-btn.bg-slate-600:hover { background: #64748b; border-color: #94a3b8; }
    .small-btn.bg-emerald-600 { background: #059669; border-color: #10b981; color: #fff; }
    .small-btn.bg-emerald-600:hover { background: #10b981; border-color: #34d399; }
    .small-btn.bg-rose-600 { background: #dc2626; border-color: #ef4444; color: #fff; }
    .small-btn.bg-rose-600:hover { background: #ef4444; border-color: #f87171; }
    .small-btn.bg-blue-600 { background: #2563eb; border-color: #3b82f6; color: #fff; }
    .small-btn.bg-blue-600:hover { background: #3b82f6; border-color: #60a5fa; }
    .small-btn.bg-yellow-600 { background: #d97706; border-color: #f59e0b; color: #fff; }
    .small-btn.bg-yellow-600:hover { background: #f59e0b; border-color: #fbbf24; }
    .small-btn.bg-indigo-600 { background: #4f46e5; border-color: #6366f1; color: #fff; }
    .small-btn.bg-indigo-600:hover { background: #6366f1; border-color: #818cf8; }
    .small-btn.bg-purple-600 { background: #7c3aed; border-color: #8b5cf6; color: #fff; }
    .small-btn.bg-purple-600:hover { background: #8b5cf6; border-color: #a78bfa; }
    .small-btn.bg-green-600 { background: #059669; border-color: #10b981; color: #fff; }
    .small-btn.bg-green-600:hover { background: #10b981; border-color: #34d399; }
    .small-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    #categories_container .small-btn {
      padding: 0.2rem 0.4rem !important;
      font-size: 0.75rem !important;
      min-height: 28px !important;
      border-width: 1px !important;
      white-space: nowrap;
    }
    #categories_container select.small-btn {
      padding: 0.15rem 0.3rem !important;
      font-size: 0.7rem !important;
      min-height: 26px !important;
      max-width: 120px;
    }
    #categories_container button.small-btn {
      min-width: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #categories_container li {
      padding: 0.4rem 0.5rem !important;
      gap: 0.3rem !important;
    }
    #categories_container .flex.gap-1 {
      flex-wrap: nowrap !important;
      gap: 0.2rem !important;
      min-width: fit-content;
    }
    .thin-scroll::-webkit-scrollbar{ 
      width:8px; 
      height:8px;
    }
    .thin-scroll::-webkit-scrollbar-thumb{ 
      background:rgba(255,255,255,0.1); 
      border-radius:8px;
    }
    .hidden{ 
      display:none !important;
    }
    .icon-btn{ 
      background:var(--input-bg); 
      border:1px solid rgba(255,255,255,0.08);
      padding:.35rem .5rem; 
      border-radius:6px; 
      cursor:pointer; 
      color:var(--text-light);
      transition: all 0.2s ease;
    }
    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }
    .title-click{ 
      display:flex; 
      align-items:center; 
      gap:8px;
    }
    .category-header{ 
      background:rgba(255,255,255,0.08); 
      padding:.5rem; 
      border-radius:6px; 
      margin:.5rem 0; 
      cursor:pointer; 
      border:1px solid rgba(255,255,255,0.08);
      transition: all 0.2s ease;
    }
    .category-header:hover {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(255, 255, 255, 0.15);
    }
    .category-content{ 
      padding:.5rem; 
      border-right:2px solid #0ea5a4;
      margin-right:.5rem; 
    }
    .danger-zone{ 
      background:#7f1d1d; 
      border:1px solid rgba(239,68,68,0.3); 
      padding:12px; 
      border-radius:8px; 
      margin-top:12px;
    }
    .calendar-icon{ 
      color:var(--text-light); 
      font-size:1.2rem;
    }
    .show-picker-btn{ 
      color:var(--text-light) !important; 
      background:rgba(255,255,255,0.15) !important; 
      border:1px solid rgba(255,255,255,0.2) !important;
      padding: 0.5rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .show-picker-btn:hover {
      background: rgba(255, 255, 255, 0.25) !important;
      border-color: rgba(255, 255, 255, 0.3) !important;
    }
    .center-modal{ 
      display:flex !important; 
      align-items:center;
      justify-content:center; 
    }
    .category-item{ 
      background:rgba(255,255,255,0.05); 
      border:1px solid rgba(255,255,255,0.1);
    }
    .resizable-container { 
      resize: vertical; 
      overflow: auto; 
      min-height: 120px; 
      max-height: 400px;
    }
    .history-compact { 
      max-height: none !important; 
      overflow: visible !important;
    }
    .history-entry-compact {
      background: var(--input-bg);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
      transition: all 0.2s ease;
    }
    .history-entry-compact:hover {
      border-color: rgba(255,255,255,0.2);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    .backup-item {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin: 10px 0;
    }
    .stat-item {
      background: rgba(255,255,255,0.05);
      padding: 8px;
      border-radius: 6px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal-content {
      position: relative;
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }
    
    .closest-info {
      background: rgba(245, 158, 11, 0.2);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 8px;
      padding: 10px;
      margin-top: 12px;
    }
    .multi-date-controls {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 12px;
    }
    .date-range-item {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 8px;
    }
    .date-comparison-header {
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 8px;
    }
    .comparison-group {
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 12px;
      transition: all 0.2s ease;
    }
    .comparison-group:hover {
      border-color: rgba(255,255,255,0.2);
    }
    .signature {
      color: white;
      text-align: center;
      padding: 16px;
      font-family: 'Vazirmatn', system-ui;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 12px;
      font-weight: 500;
      display: block;
      margin: 30px auto;
      width: fit-content;
      max-width: 90%;
      box-sizing: border-box;
    }
    
    @media only screen and (max-width: 768px) {
      body {
        padding: 10px;
      }
      .small-btn {
        min-height: 44px;
        padding: 0.6rem 0.8rem;
        font-size: 0.95rem;
        border-width: 2px;
      }
      #categories_container .small-btn {
        padding: 0.2rem 0.3rem !important;
        font-size: 0.75rem !important;
        min-height: 26px !important;
      }
      #categories_container select.small-btn {
        padding: 0.1rem 0.25rem !important;
        font-size: 0.7rem !important;
        min-height: 24px !important;
        max-width: 100px;
      }
      #categories_container button.small-btn {
        min-width: 24px;
      }
      #categories_container li {
        padding: 0.3rem 0.4rem !important;
        gap: 0.2rem !important;
        flex-wrap: wrap;
      }
      #categories_container .flex.gap-1 {
        gap: 0.15rem !important;
        order: 2;
        width: 100%;
        justify-content: flex-start;
        margin-top: 0.3rem;
        padding-top: 0.3rem;
        border-top: 1px solid rgba(255,255,255,0.1);
      }
      #categories_container .flex-1 {
        order: 1;
        width: 100%;
      }
      .signature {
        font-size: 13px;
        padding: 15px;
      }
      .small-btn:active {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.4);
        transform: scale(0.98);
      }
      .box-out {
        padding: 0.5rem 0.75rem;
        min-height: 44px;
        display: flex;
        align-items: center;
        font-size: 1rem;
      }
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 6px;
      }
    }
    @media only screen and (max-width: 480px) {
      .signature {
        font-size: 12px;
        padding: 12px;
      }
      .small-btn {
        padding: 0.7rem 0.9rem;
        font-size: 0.95rem;
      }
      .section-title {
        font-size: 1rem;
      }
    }
    #toggle_icon {
      transition: all 0.3s ease;
      font-weight: bold;
      display: inline-block;
    }
    #toggle_history_btn:hover #toggle_icon {
      transform: scale(1.2);
    }
    #toggle_history_btn.open {
      background: #374151 !important;
      border-color: #6b7280 !important;
    }
    #toggle_history_btn.closed {
      background: #475569 !important;
      border-color: #64748b !important;
    }
    .micro-btn{ 
      background:#0ea5a4; 
      color:#021; 
      padding:.45rem .6rem; 
      border-radius:6px; 
      font-weight:700; 
      cursor:pointer; 
      border: 2px solid #0ea5a4;
      transition: all 0.3s ease;
    }
    .micro-btn:hover {
      background: #0d9488;
      border-color: #0d9488;
      transform: translateY(-1px);
    }
    .micro-btn.recording{ 
      background:#ef4444; 
      color:#fff; 
      border-color: #ef4444;
    }
    .micro-btn.connected{ 
      background:#10b981; 
      color:#fff; 
      border-color: #10b981;
    }
  </style>
</head>
<body>
  <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-4">
    <!-- Ø³ØªÙˆÙ† Ø§ÙˆÙ„: Ù…Ø¯ÛŒØ±ÛŒØª Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§ -->
    <aside class="card">
      <div id="hdr_pairs" class="section-header">
        <div class="title-click">
          <span class="hamburger-icon">â‡…</span>
          <span class="section-title">Ù…Ø¯ÛŒØ±ÛŒØª Ø¬ÙØªâ€ŒØ§Ø±Ø² - Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø³ÙˆÙ…</span>
        </div>
      </div>
      <div id="box_pairs" class="mt-3">
        <div class="mb-4 p-3 rounded bg-[var(--input-bg)] border border-white/10">
          <label class="muted block mb-2">Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</label>
          <div class="flex gap-2 mb-2">
            <input id="new_category_name" placeholder="Ù†Ø§Ù… Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¬Ø¯ÛŒØ¯" type="text" class="flex-1"/>
            <button id="add_category_btn" class="small-btn bg-blue-600 hover:bg-blue-700">Ø§ÙØ²ÙˆØ¯Ù†</button>
          </div>
          <div class="flex gap-2 mb-2">
            <select id="category_select" class="flex-1">
              <option value="">Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</option>
            </select>
            <button id="delete_category_btn" class="small-btn bg-rose-600 hover:bg-rose-700" title="Ø­Ø°Ù Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡">ğŸ—‘</button>
          </div>
          <div class="mt-2">
            <label class="muted text-xs">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯:</label>
            <div id="categories_list" class="mt-1 space-y-1 max-h-20 overflow-y-auto thin-scroll"></div>
          </div>
        </div>
        <div class="mb-3">
          <input id="new_pair_name" placeholder="Ù…Ø«Ø§Ù„: EURUSD" type="text"/>
          <div class="flex gap-2 mt-2">
            <button id="add_pair_btn" class="small-btn bg-emerald-600 hover:bg-emerald-700">Ø§ÙØ²ÙˆØ¯Ù†</button>
            <button id="clear_pairs_btn" class="small-btn bg-rose-600 hover:bg-rose-700">Ø­Ø°Ù Ù‡Ù…Ù‡</button>
          </div>
        </div>
        <div>
          <div class="flex justify-between items-center mb-2">
            <label class="muted">ÙÙ‡Ø±Ø³Øª Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§</label>
            <span class="text-xs muted">(Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ± Ø³Ø§ÛŒØ²)</span>
          </div>
          <div id="categories_container" class="resizable-container mt-2 thin-scroll border border-white/10 rounded p-2 space-y-3">
          </div>
        </div>
        <div class="border-t border-white/10 pt-3 mt-3">
          <div class="mb-2">
            <button id="export_btn" class="small-btn bg-blue-600 hover:bg-blue-700 w-full">Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ú©â€ŒØ¢Ù¾ (JSON)</button>
          </div>
          <div class="mb-2">
            <input id="import_file" type="file" accept="application/json" class="hidden"/>
            <button id="import_btn" class="small-btn bg-yellow-600 hover:bg-yellow-700 w-full">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ú©â€ŒØ¢Ù¾ (JSON)</button>
          </div>
          <div class="danger-zone">
            <div class="text-center mb-2">
              <span class="text-white font-semibold">âš  Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</span>
            </div>
            <div class="mb-3">
              <label class="muted text-xs block mb-1">Ø­Ø°Ù Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ± Ø§Ø²:</label>
              <div class="flex gap-2">
                <input id="manual_prune_days" type="number" min="1" max="3650" value="365" class="flex-1 text-center"/>
                <span class="muted text-xs flex items-center">Ø±ÙˆØ²</span>
              </div>
              <button id="manual_prune_btn" class="small-btn bg-rose-700 hover:bg-rose-800 text-white w-full mt-2">
                Ø­Ø°Ù Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ
              </button>
            </div>
            <button id="show_stats_btn" class="small-btn bg-purple-600 hover:bg-purple-700 text-white w-full mb-2">
              Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
            </button>
            <button id="manage_backups_btn" class="small-btn bg-indigo-600 hover:bg-indigo-700 text-white w-full">
              Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ú©â€ŒØ¢Ù¾â€ŒÙ‡Ø§
            </button>
            <p class="muted text-xs mt-2 text-center">Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù‡Ø³ØªÙ†Ø¯</p>
          </div>
          <p class="muted text-xs mt-2">ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</p>
        </div>
      </div>
    </aside>

    <!-- Ø³ØªÙˆÙ† Ø¯ÙˆÙ…: Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ -->
    <main class="card">
      <div id="hdr_calc" class="section-header">
        <div class="title-click">
          <span class="hamburger-icon">â‡…</span>
          <span class="section-title">Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ â€” Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø³ÙˆÙ…</span>
        </div>
      </div>
      <div id="box_calc" class="mt-3">
        <div class="mb-3">
          <div class="flex items-center gap-2 mb-2">
            <label class="muted flex-1">Ø¬ÙØªâ€ŒØ§Ø±Ø²</label>
            <button id="micro_toggle" class="micro-btn" title="Ø´Ø±ÙˆØ¹/ØªÙˆÙ‚Ù ÙˆØ±ÙˆØ¯ ØµÙˆØªÛŒ">ğŸ™ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† ØµÙˆØª</button>
          </div>
          <select id="pair_select"></select>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-3">
          <div>
            <label class="muted">Ø¹Ø¯Ø¯ Ø³Ù‚Ù</label>
            <input id="input_y1" type="text" placeholder=""/>
          </div>
          <div>
            <label class="muted">Ø¹Ø¯Ø¯ ÙØ¹Ù„ÛŒ Ø³Ù‚Ù</label>
            <input id="input_current_high" type="text" placeholder=""/>
          </div>
          <div>
            <label class="muted">Ø¹Ø¯Ø¯ Ú©Ù</label>
            <input id="input_y2" type="text" placeholder=""/>
          </div>
          <div>
            <label class="muted">Ø¹Ø¯Ø¯ ÙØ¹Ù„ÛŒ Ú©Ù</label>
            <input id="input_current_low" type="text" placeholder=""/>
          </div>
        </div>
        <div class="mb-3">
          <label class="muted">ØªØ§Ø±ÛŒØ® (Ù…ÛŒÙ„Ø§Ø¯ÛŒ)</label>
          <div class="flex items-center gap-2">
            <input id="date_picker" type="date" class="flex-1"/>
            <button type="button" onclick="document.getElementById('date_picker').showPicker()" class="small-btn show-picker-btn" title="Ù†Ù…Ø§ÛŒØ´ ØªÙ‚ÙˆÛŒÙ…">
              ğŸ“…
            </button>
          </div>
          <p class="muted text-xs mt-1">ØªØ§Ø±ÛŒØ® Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø±Ú©ÙˆØ±Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
        </div>
        <div class="mb-3">
          <label class="muted">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
          <textarea id="note_input" rows="2" placeholder=""></textarea>
        </div>
        <div class="flex gap-2 mb-3">
          <button id="calculate_button" class="small-btn bg-emerald-600 hover:bg-emerald-700 flex-1">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ Ø°Ø®ÛŒØ±Ù‡</button>
          <button id="reset_button" class="small-btn bg-slate-600 hover:bg-slate-700 flex-1">Ø±ÛŒØ³Øª</button>
        </div>
        <div>
          <h4 class="muted mb-2">Ù†ØªØ§ÛŒØ¬ (Ù…Ø±ØªØ¨â€ŒØ´Ø¯Ù‡ Ø§Ø² Ú©ÙˆÚ†Ú© Ø¨Ù‡ Ø¨Ø²Ø±Ú¯)</h4>
          <div id="results_list" class="space-y-2"></div>
          <div id="closest_info" class="closest-info hidden"></div>
          <p id="error_message" class="muted text-rose-400 mt-2"></p>
          <p id="voice_status" class="muted mt-2"></p>
        </div>
      </div>
    </main>

    <!-- Ø³ØªÙˆÙ† Ø³ÙˆÙ…: ØªØ§Ø±ÛŒØ®Ú†Ù‡ -->
    <section class="card">
      <div id="hdr_history" class="section-header">
        <div class="title-click">
          <span class="hamburger-icon">â‡…</span>
          <span class="section-title">ØªØ§Ø±ÛŒØ®Ú†Ù‡ - Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø³ÙˆÙ…</span>
        </div>
      </div>
      <div id="box_history" class="mt-3">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-semibold">ØªØ§Ø±ÛŒØ®Ú†Ù‡</div>
          <div class="muted">Ú©Ù„: <span id="entries_count">0</span></div>
        </div>
        <div class="flex gap-2 mb-3">
          <button id="toggle_history_btn" class="small-btn flex-1 bg-slate-600 hover:bg-slate-700 flex items-center justify-center gap-2 transition-all duration-300 closed">
            <span id="toggle_icon" class="text-lg transition-all duration-300 transform">ğŸ“</span>
            <span id="toggle_text" class="transition-all duration-300">Ù†Ù…Ø§ÛŒØ´ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ‡Ø§</span>
          </button>
          <button id="quick_prune" class="small-btn bg-rose-600 hover:bg-rose-700 hidden">Ù¾Ø§Ú© Û³Û° Ø±ÙˆØ²Ù‡</button>
        </div>
        <div id="history_panel" class="mt-3 hidden">
          <div class="multi-date-controls">
            <div class="flex items-center justify-between mb-3">
              <label class="muted font-semibold">ğŸ“… Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú†Ù†Ø¯ ØªØ§Ø±ÛŒØ® Ù‡Ù…Ø²Ù…Ø§Ù†</label>
              <button id="toggle_multi_date" class="small-btn bg-blue-600 hover:bg-blue-700 text-xs">
                ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø­Ø§Ù„Øª Ú†Ù†Ø¯ØªØ§Ø±ÛŒØ®ÛŒ
              </button>
            </div>
            <div id="single_date_section">
              <div class="mb-2 grid grid-cols-2 gap-2">
                <input id="history_date" type="date"/>
                <select id="history_pair_filter">
                  <option value="">Ù‡Ù…Ù‡ Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§</option>
                </select>
              </div>
            </div>
            <div id="multi_date_section" class="hidden">
              <div class="mb-3">
                <div class="flex items-center gap-2 mb-2">
                  <select id="multi_date_pair_filter" class="flex-1">
                    <option value="">Ù‡Ù…Ù‡ Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§</option>
                  </select>
                </div>
                <div id="date_ranges_container" class="space-y-2">
                </div>
                <div class="flex gap-2 mt-3">
                  <button id="add_date_btn" class="small-btn bg-green-600 hover:bg-green-700 flex-1">
                    â• Ø§ÙØ²ÙˆØ¯Ù† ØªØ§Ø±ÛŒØ®
                  </button>
                  <button id="apply_multi_date_btn" class="small-btn bg-blue-600 hover:bg-blue-700 flex-1">
                    âœ… Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div id="history_list" class="history-compact space-y-2"></div>
        </div>

        <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¬Ø²Ø¦ÛŒØ§Øª -->
        <div id="detail_modal" class="hidden modal-overlay">
          <div class="modal-content p-6 max-w-2xl">
            <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-3">
              <h4 class="font-bold text-lg">Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„ Ø±Ú©ÙˆØ±Ø¯ - Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø³ÙˆÙ…</h4>
              <button id="close_detail" class="small-btn bg-slate-600 hover:bg-slate-700">Ø¨Ø³ØªÙ†</button>
            </div>
            <div id="detail_content" class="mt-2 text-sm space-y-4"></div>
            <div class="flex gap-2 mt-6 pt-4 border-t border-white/10">
              <button id="edit_record_btn" class="small-btn bg-yellow-600 hover:bg-yellow-700 flex-1">ÙˆÛŒØ±Ø§ÛŒØ´</button>
              <button id="move_record_btn" class="small-btn bg-indigo-600 hover:bg-indigo-700 flex-1">Ø§Ù†ØªÙ‚Ø§Ù„ ØªØ§Ø±ÛŒØ®</button>
              <button id="delete_record_btn" class="small-btn bg-rose-600 hover:bg-rose-700 flex-1">Ø­Ø°Ù</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
  
  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¢Ù…Ø§Ø± -->
  <div id="stats_modal" class="hidden modal-overlay">
    <div class="modal-content p-6 max-w-md">
      <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-3">
        <h4 class="font-bold text-lg">ğŸ“Š Ø¢Ù…Ø§Ø± Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ… - Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø³ÙˆÙ…</h4>
        <button id="close_stats" class="small-btn bg-slate-600 hover:bg-slate-700">âœ•</button>
      </div>
      <div id="stats_content" class="mt-2 text-sm space-y-4">
      </div>
    </div>
  </div>
  
  <!-- Ù…ÙˆØ¯Ø§Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ú©â€ŒØ¢Ù¾ -->
  <div id="backups_modal" class="hidden modal-overlay">
    <div class="modal-content p-6 max-w-2xl">
      <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-3">
        <h4 class="font-bold text-lg">ğŸ’¾ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ú©â€ŒØ¢Ù¾â€ŒÙ‡Ø§ - Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø³ÙˆÙ…</h4>
        <button id="close_backups" class="small-btn bg-slate-600 hover:bg-slate-700">âœ•</button>
      </div>
      <div id="backups_content" class="mt-2 text-sm space-y-4">
      </div>
    </div>
  </div>

  <script>
    // ---------- Helpers ----------
    const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
    const storageGet = k => JSON.parse(localStorage.getItem('calc_pro_3_' + k) || 'null');
    const storageSet = (k, v) => localStorage.setItem('calc_pro_3_' + k, JSON.stringify(v));
    const AUTO_PRUNE_ENABLED = false;
    const MAX_DAYS = 3650;
    
    function nowISO() { 
      return new Date().toISOString();
    }
    
    function formatGregorian(dtISO) {
      const d = new Date(dtISO);
      const pad = n => n.toString().padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    
    function ensureDefaults() { 
      if (!storageGet('pairs')) storageSet('pairs', []); 
      if (!storageGet('entries')) storageSet('entries', []);
      if (!storageGet('categories')) storageSet('categories', [
        {id: 'default', name: 'Ø§ØµÙ„ÛŒ'},
        {id: 'forex', name: 'ÙØ§Ø±Ú©Ø³'},
        {id: 'crypto', name: 'Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„'}
      ]);
    }
    
    ensureDefaults();
    
    // ---------- DOM Refs ----------
    const $ = id => document.getElementById(id);
    
    // Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§
    const pairSelect = $('pair_select');
    const newPairName = $('new_pair_name');
    const addPairBtn = $('add_pair_btn');
    const clearPairsBtn = $('clear_pairs_btn');
    const categoriesContainer = $('categories_container');
    
    // Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§
    const categorySelect = $('category_select');
    const newCategoryName = $('new_category_name');
    const addCategoryBtn = $('add_category_btn');
    const deleteCategoryBtn = $('delete_category_btn');
    const categoriesList = $('categories_list');
    
    // Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨
    const inputY1 = $('input_y1');
    const inputCurrentHigh = $('input_current_high');
    const inputY2 = $('input_y2');
    const inputCurrentLow = $('input_current_low');
    const noteInput = $('note_input');
    const datePicker = $('date_picker');
    const calculateButton = $('calculate_button');
    const resetButton = $('reset_button');
    const resultsList = $('results_list');
    const errorMessage = $('error_message');
    const voiceStatus = $('voice_status');
    const closestInfo = $('closest_info');
    
    // ØªØ§Ø±ÛŒØ®Ú†Ù‡
    const historyDate = $('history_date');
    const historyPairFilter = $('history_pair_filter');
    const historyList = $('history_list');
    const entriesCount = $('entries_count');
    const toggleHistoryBtn = $('toggle_history_btn');
    const historyPanel = $('history_panel');
    
    // Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§
    const detailModal = $('detail_modal');
    const detailContent = $('detail_content');
    const closeDetail = $('close_detail');
    const editRecordBtn = $('edit_record_btn');
    const moveRecordBtn = $('move_record_btn');
    const deleteRecordBtn = $('delete_record_btn');
    const statsModal = $('stats_modal');
    const backupsModal = $('backups_modal');
    
    // Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø§Ú©Ø³â€ŒÙ‡Ø§
    const togglePairsHdr = $('hdr_pairs');
    const boxPairs = $('box_pairs');
    const toggleCalcHdr = $('hdr_calc');
    const boxCalc = $('box_calc');
    const toggleHistoryHdr = $('hdr_history');
    const boxHistory = $('box_history');
    
    // ÙˆØ±ÙˆØ¯ ØµÙˆØªÛŒ
    const microToggle = $('micro_toggle');
    
    // Ø­Ø§Ù„Øª Ú†Ù†Ø¯ØªØ§Ø±ÛŒØ®ÛŒ
    const toggleMultiDateBtn = $('toggle_multi_date');
    const singleDateSection = $('single_date_section');
    const multiDateSection = $('multi_date_section');
    const multiDatePairFilter = $('multi_date_pair_filter');
    const dateRangesContainer = $('date_ranges_container');
    const addDateBtn = $('add_date_btn');
    const applyMultiDateBtn = $('apply_multi_date_btn');
    
    // Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
    const exportBtn = $('export_btn');
    const importFile = $('import_file');
    const importBtn = $('import_btn');
    const showStatsBtn = $('show_stats_btn');
    const manageBackupsBtn = $('manage_backups_btn');
    const manualPruneBtn = $('manual_prune_btn');
    const closeStats = $('close_stats');
    const closeBackups = $('close_backups');
    const statsContent = $('stats_content');
    const backupsContent = $('backups_content');
    
    // ---------- State Variables ----------
    let isMultiDate = false;
    let dateRanges = [];
    
    // ---------- Core Functions ----------
    
    function parseFormattedInteger(str) {
      if (!str) return { rawNumber: NaN, format: { hasDot: false } };
      
      const original = str.toString().trim();
      const hasDot = original.includes('.');
      
      if (!hasDot) {
        const cleaned = original.replace(/[^\d]/g, '');
        return { rawNumber: cleaned ? parseInt(cleaned, 10) : NaN, format: { hasDot: false } };
      }
      
      const parts = original.split('.');
      if (parts.length !== 2) {
        const cleaned = original.replace(/[^\d]/g, '');
        return { rawNumber: cleaned ? parseInt(cleaned, 10) : NaN, format: { hasDot: false } };
      }
      
      const [leftPart, rightPart] = parts;
      const leftDigits = leftPart.replace(/[^\d]/g, '');
      const rightDigits = rightPart.replace(/[^\d]/g, '');
      
      if (!leftDigits && !rightDigits) return { rawNumber: NaN, format: { hasDot: false } };
      
      const fullNumberStr = (leftDigits + rightDigits) || '0';
      const totalLength = fullNumberStr.length;
      const rawNumber = parseInt(fullNumberStr, 10);
      
      return {
        rawNumber,
        format: {
          hasDot: true,
          left: leftDigits.length,
          right: rightDigits.length,
          total: totalLength
        }
      };
    }
    
    function formatOutputByInputFormat(number, inputFormat) {
      if (isNaN(number)) return '';
      
      const numStr = Math.abs(number).toString();
      const isNegative = number < 0;
      
      if (!inputFormat || !inputFormat.hasDot) {
        return isNegative ? '-' + numStr : numStr;
      }
      
      const { left, right, total } = inputFormat;
      let padded = numStr.padStart(total, '0');
      
      if (padded.length > total) {
        padded = padded.slice(-total);
      }
      
      const leftPart = padded.slice(0, left);
      const rightPart = padded.slice(left);
      
      const finalLeft = leftPart === '' ? '0' : parseInt(leftPart || '0', 10).toString();
      let result = finalLeft + '.' + rightPart;
      
      if (isNegative) result = '-' + result;
      
      return result;
    }
    
    function findClosestNumbers(numbers) {
      if (numbers.length < 2) return { pairs: [], minDistance: 0 };
      
      let minDistance = Infinity;
      const closestPairs = [];
      
      for (let i = 0; i < numbers.length; i++) {
        for (let j = i + 1; j < numbers.length; j++) {
          const distance = Math.abs(numbers[i].value - numbers[j].value);
          
          if (distance < minDistance) {
            minDistance = distance;
            closestPairs.length = 0;
            closestPairs.push([numbers[i], numbers[j]]);
          } else if (distance === minDistance) {
            closestPairs.push([numbers[i], numbers[j]]);
          }
        }
      }
      
      return { pairs: closestPairs, minDistance };
    }
    
    function computeOutputs(y1, y2) {
      const result1 = Math.floor(Math.pow(Math.sqrt(y1) - 1, 2));
      const result2 = Math.floor(Math.pow(Math.sqrt(y1) - 0.5, 2));
      const result3 = Math.floor(Math.pow(Math.sqrt(y2) + 1, 2));
      const result4 = Math.floor(Math.pow(Math.sqrt(y2) + 0.5, 2));
      
      return [result1, result2, result3, result4];
    }
    
    function decideColor(v, currentLow, currentHigh) { 
      if (v < currentLow) return 'box-red'; 
      if (v > currentHigh) return 'box-green'; 
      return 'box-gray';
    }
    
    // ---------- Render Functions ----------
    
    function renderPairs() {
      const pairs = storageGet('pairs') || [];
      
      if (pairSelect) {
        pairSelect.innerHTML = '';
        pairs.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.name;
          pairSelect.appendChild(opt);
        });
        
        if (pairs.length === 0) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø¬ÙØªâ€ŒØ§Ø±Ø² Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯';
          pairSelect.appendChild(opt);
        }
      }
      
      if (historyPairFilter) {
        historyPairFilter.innerHTML = '<option value="">Ù‡Ù…Ù‡ Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§</option>';
        pairs.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.name;
          historyPairFilter.appendChild(opt);
        });
      }
      
      if (multiDatePairFilter) {
        multiDatePairFilter.innerHTML = '<option value="">Ù‡Ù…Ù‡ Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§</option>';
        pairs.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.name;
          multiDatePairFilter.appendChild(opt);
        });
      }
      
      renderCategories();
    }
    
    function renderCategories() {
      const categories = storageGet('categories') || [];
      const pairs = storageGet('pairs') || [];
      
      if (categorySelect) {
        categorySelect.innerHTML = '<option value="">Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</option>';
        categories.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat.id;
          opt.textContent = cat.name;
          categorySelect.appendChild(opt);
        });
      }
      
      if (categoriesList) {
        categoriesList.innerHTML = '';
        
        if (categories.length === 0) {
          categoriesList.innerHTML = '<div class="text-xs muted text-center py-1">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
        } else {
          categories.forEach(cat => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-1 px-2 rounded category-item';
            div.innerHTML = `
              <span class="text-xs">${cat.name}</span>
              <span class="text-xs muted">${pairs.filter(p => p.categoryId === cat.id).length} Ø¬ÙØªâ€ŒØ§Ø±Ø²</span>
            `;
            categoriesList.appendChild(div);
          });
        }
      }
      
      if (categoriesContainer) {
        categoriesContainer.innerHTML = '';
        
        const uncategorizedPairs = pairs.filter(p => !p.categoryId);
        if (uncategorizedPairs.length > 0) {
          renderCategorySection(null, 'Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ', uncategorizedPairs);
        }
        
        categories.forEach(category => {
          const categoryPairs = pairs.filter(p => p.categoryId === category.id);
          if (categoryPairs.length > 0) {
            renderCategorySection(category.id, category.name, categoryPairs);
          }
        });
      }
    }
    
    function renderCategorySection(categoryId, categoryName, pairs) {
      const section = document.createElement('div');
      section.className = 'category-section';
      section.innerHTML = `
        <div class="category-header flex justify-between items-center" data-category="${categoryId || ''}">
          <div class="font-semibold text-sm">${categoryName} (${pairs.length})</div>
        </div>
        <div class="category-content">
          <ul class="space-y-2 pairs-list-${categoryId || 'uncategorized'}"></ul>
        </div>
      `;
      
      categoriesContainer.appendChild(section);
      
      const pairsList = section.querySelector(`.pairs-list-${categoryId || 'uncategorized'}`);
      
      pairs.forEach(p => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between gap-2 p-2 rounded bg-white/5';
        
        const categories = storageGet('categories') || [];
        const categoryOptions = categories.map(cat => 
          `<option value="${cat.id}" ${p.categoryId === cat.id ? 'selected' : ''}>${cat.name}</option>`
        ).join('');
        
        li.innerHTML = `
          <div class="flex-1 text-sm">${p.name}</div>
          <div class="flex gap-1">
            <select class="small-btn bg-slate-600 text-xs move-category" data-id="${p.id}">
              <option value="">Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡...</option>
              ${categoryOptions}
              <option value="" ${!p.categoryId ? 'selected' : ''}>Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</option>
            </select>
            <button data-action="up" data-id="${p.id}" class="small-btn bg-slate-600">â¬†</button>
            <button data-action="down" data-id="${p.id}" class="small-btn bg-slate-600">â¬‡</button>
            <button data-action="edit" data-id="${p.id}" class="small-btn bg-yellow-600">âœ</button>
            <button data-action="delete" data-id="${p.id}" class="small-btn bg-rose-600">ğŸ—‘</button>
          </div>
        `;
        
        pairsList.appendChild(li);
      });
      
      const header = section.querySelector('.category-header');
      header.addEventListener('click', () => {
        const content = section.querySelector('.category-content');
        content.classList.toggle('hidden');
      });
    }
    
    // ---------- Event Listeners ----------
    
    // Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§
    if (addPairBtn) {
      addPairBtn.addEventListener('click', () => {
        const name = newPairName.value.trim();
        if (!name) return;
        
        const pairs = storageGet('pairs') || [];
        const selectedCategory = categorySelect.value || null;
        
        pairs.push({
          id: uid(),
          name: name,
          categoryId: selectedCategory
        });
        
        storageSet('pairs', pairs);
        renderPairs();
        newPairName.value = '';
      });
    }
    
    if (clearPairsBtn) {
      clearPairsBtn.addEventListener('click', () => {
        if (confirm('Ø¢ÛŒØ§ Ù‡Ù…Ù‡ Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯ØŸ')) {
          storageSet('pairs', []);
          renderPairs();
        }
      });
    }
    
    // Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§
    if (addCategoryBtn) {
      addCategoryBtn.addEventListener('click', () => {
        const name = newCategoryName.value.trim();
        if (!name) return;
        
        const categories = storageGet('categories') || [];
        
        if (categories.some(cat => cat.name === name)) {
          alert('Ø§ÛŒÙ† Ù†Ø§Ù… Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯!');
          return;
        }
        
        categories.push({id: uid(), name: name});
        storageSet('categories', categories);
        renderCategories();
        newCategoryName.value = '';
      });
    }
    
    if (deleteCategoryBtn) {
      deleteCategoryBtn.addEventListener('click', () => {
        const selectedCategoryId = categorySelect.value;
        if (!selectedCategoryId) {
          alert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯!');
          return;
        }
        
        const categories = storageGet('categories') || [];
        const category = categories.find(cat => cat.id === selectedCategoryId);
        if (!category) return;
        
        const pairs = storageGet('pairs') || [];
        const pairsInCategory = pairs.filter(p => p.categoryId === selectedCategoryId);
        
        if (pairsInCategory.length > 0) {
          if (!confirm(`Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ "${category.name}" Ø¯Ø§Ø±Ø§ÛŒ ${pairsInCategory.length} Ø¬ÙØªâ€ŒØ§Ø±Ø² Ø§Ø³Øª. Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø­Ø°Ù Ø´ÙˆØ¯ Ùˆ Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§ÛŒ Ø¢Ù† Ø¨Ù‡ "Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ" Ù…Ù†ØªÙ‚Ù„ Ø´ÙˆÙ†Ø¯ØŸ`)) {
            return;
          }
          
          pairsInCategory.forEach(p => { p.categoryId = null; });
          storageSet('pairs', pairs);
        } else {
          if (!confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ "${category.name}" Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`)) return;
        }
        
        const updatedCategories = categories.filter(cat => cat.id !== selectedCategoryId);
        storageSet('categories', updatedCategories);
        renderCategories();
        renderPairs();
      });
    }
    
    // Ù…Ø¯ÛŒØ±ÛŒØª Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§ Ø¯Ø± Ù„ÛŒØ³Øª
    if (categoriesContainer) {
      categoriesContainer.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        
        const action = btn.dataset.action;
        const id = btn.dataset.id;
        const pairs = storageGet('pairs') || [];
        const idx = pairs.findIndex(p => p.id === id);
        
        if (action === 'up' && idx > 0) {
          [pairs[idx], pairs[idx - 1]] = [pairs[idx - 1], pairs[idx]];
          storageSet('pairs', pairs);
          renderPairs();
        }
        
        if (action === 'down' && idx < pairs.length - 1) {
          [pairs[idx], pairs[idx + 1]] = [pairs[idx + 1], pairs[idx]];
          storageSet('pairs', pairs);
          renderPairs();
        }
        
        if (action === 'delete') {
          if (!confirm('Ø¢ÛŒØ§ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
          pairs.splice(idx, 1);
          storageSet('pairs', pairs);
          renderPairs();
        }
        
        if (action === 'edit') {
          const newName = prompt('Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯:', pairs[idx].name);
          if (newName && newName.trim()) {
            pairs[idx].name = newName.trim();
            storageSet('pairs', pairs);
            renderPairs();
          }
        }
      });
      
      categoriesContainer.addEventListener('change', (e) => {
        if (e.target.classList.contains('move-category')) {
          const pairId = e.target.dataset.id;
          const newCategoryId = e.target.value || null;
          
          const pairs = storageGet('pairs') || [];
          const pair = pairs.find(p => p.id === pairId);
          if (pair) {
            pair.categoryId = newCategoryId;
            storageSet('pairs', pairs);
            renderPairs();
          }
        }
      });
    }
    
    // Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨
    if (calculateButton) {
      calculateButton.addEventListener('click', () => {
        if (!inputY1 || !inputY2 || !inputCurrentHigh || !inputCurrentLow) {
          if (errorMessage) errorMessage.textContent = 'Ø®Ø·Ø§: Ø¨Ø±Ø®ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³ØªÙ†Ø¯.';
          return;
        }
        
        if (errorMessage) errorMessage.textContent = '';
        
        try {
          const parsedY1 = parseFormattedInteger(inputY1.value);
          const parsedCurrentHigh = parseFormattedInteger(inputCurrentHigh.value);
          const parsedY2 = parseFormattedInteger(inputY2.value);
          const parsedCurrentLow = parseFormattedInteger(inputCurrentLow.value);
          
          const y1 = parsedY1.rawNumber;
          const currentHigh = parsedCurrentHigh.rawNumber;
          const y2 = parsedY2.rawNumber;
          const currentLow = parsedCurrentLow.rawNumber;
          
          if (isNaN(y1) || isNaN(y2) || isNaN(currentLow) || isNaN(currentHigh)) {
            throw new Error('Ù„Ø·ÙØ§Ù‹ Ú†Ù‡Ø§Ø± ÙÛŒÙ„Ø¯ Ø§ØµÙ„ÛŒ Ø±Ø§ Ø¨Ø§ Ø§Ø¹Ø¯Ø§Ø¯ Ù…Ø¹ØªØ¨Ø± Ù¾Ø± Ú©Ù†ÛŒØ¯.');
          }
          
          if (y1 < 0 || y2 < 0) throw new Error('Ù„Ø·ÙØ§Ù‹ ÙÙ‚Ø· Ø§Ø¹Ø¯Ø§Ø¯ Ù…Ø«Ø¨Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
          
          const outputs = computeOutputs(y1, y2);
          
          const resultsForClosest = [];
          if (!isNaN(outputs[0])) resultsForClosest.push({ label: "ÙØ±Ù…ÙˆÙ„ Û± (Ø³Ù‚Ù)", value: outputs[0] });
          if (!isNaN(outputs[1])) resultsForClosest.push({ label: "ÙØ±Ù…ÙˆÙ„ Û² (Ø³Ù‚Ù)", value: outputs[1] });
          if (!isNaN(outputs[2])) resultsForClosest.push({ label: "ÙØ±Ù…ÙˆÙ„ Û³ (Ú©Ù)", value: outputs[2] });
          if (!isNaN(outputs[3])) resultsForClosest.push({ label: "ÙØ±Ù…ÙˆÙ„ Û´ (Ú©Ù)", value: outputs[3] });
          
          const { pairs: closestPairs, minDistance } = findClosestNumbers(resultsForClosest);
          
          // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬
          const resultsDisplay = [];
          const resultsWithLabels = [
            { label: "ÙØ±Ù…ÙˆÙ„ Û± (Ø³Ù‚Ù)", value: outputs[0] },
            { label: "ÙØ±Ù…ÙˆÙ„ Û² (Ø³Ù‚Ù)", value: outputs[1] },
            { label: "ÙØ±Ù…ÙˆÙ„ Û³ (Ú©Ù)", value: outputs[2] },
            { label: "ÙØ±Ù…ÙˆÙ„ Û´ (Ú©Ù)", value: outputs[3] }
          ].filter(r => !isNaN(r.value));
          
          resultsWithLabels.sort((a, b) => a.value - b.value);
          
          resultsWithLabels.forEach((result, index) => {
            const color = decideColor(result.value, currentLow, currentHigh);
            const displayVal = formatOutputByInputFormat(result.value, parsedY1.format);
            const suffix = (result.value < currentLow ? ' â†“ Ø²ÛŒØ± Ú©Ù ÙØ¹Ù„ÛŒ' : 
                          (result.value > currentHigh ? ' â†‘ Ø¨Ø§Ù„Ø§ÛŒ Ø³Ù‚Ù ÙØ¹Ù„ÛŒ' : ''));
            
            resultsDisplay.push({
              order: index + 1,
              label: result.label,
              display: displayVal,
              color: color,
              suffix: suffix
            });
          });
          
          // Ø±Ù†Ø¯Ø± Ù†ØªØ§ÛŒØ¬
          if (resultsList) {
            resultsList.innerHTML = '';
            resultsDisplay.forEach(item => {
              const div = document.createElement('div');
              div.innerHTML = `
                <span class="box-out ${item.color} cursor-pointer hover:opacity-80 transition-opacity" 
                      onclick="copyToClipboard('${item.display}')"
                      title="Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ: ${item.display}">
                  <span class="num-label">${item.order}.</span> (${item.label}) ${item.display} ${item.suffix}
                </span>
              `;
              resultsList.appendChild(div);
            });
          }
          
          // Ù†Ù…Ø§ÛŒØ´ Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ø§Ø¹Ø¯Ø§Ø¯
          if (closestInfo) {
            if (closestPairs.length > 0) {
              const displayDist = formatOutputByInputFormat(minDistance, parsedY1.format);
              let closestText = `<div class="text-sm font-semibold mb-2">Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ø§Ø¹Ø¯Ø§Ø¯ (ÙØ§ØµÙ„Ù‡: ${displayDist}):</div>`;
              
              closestPairs.forEach(pair => {
                const display1 = formatOutputByInputFormat(pair[0].value, parsedY1.format);
                const display2 = formatOutputByInputFormat(pair[1].value, parsedY1.format);
                closestText += `<div class="text-xs mb-1">â€¢ ${pair[0].label} (${display1}) Ùˆ ${pair[1].label} (${display2})</div>`;
              });
              
              closestInfo.innerHTML = closestText;
              closestInfo.classList.remove('hidden');
            } else {
              closestInfo.classList.add('hidden');
            }
          }
          
          // Ø°Ø®ÛŒØ±Ù‡ Ø±Ú©ÙˆØ±Ø¯
          let chosenISO = null;
          if (datePicker && datePicker.value) {
            const dp = datePicker.value;
            const now = new Date();
            const timePart = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            const iso = new Date(dp + 'T' + timePart);
            
            if (!isNaN(iso)) chosenISO = iso.toISOString();
          }
          
          if (!chosenISO) chosenISO = nowISO();
          
          const pairId = pairSelect ? pairSelect.value || null : null;
          const note = noteInput ? noteInput.value || '' : '';
          
          const entries = storageGet('entries') || [];
          entries.push({
            id: uid(),
            pairId: pairId,
            dateISO: chosenISO,
            dateDisplay: formatGregorian(chosenISO),
            inputs: {
              y1, y2, currentLow, currentHigh,
              originalY1: inputY1.value,
              originalCurrentHigh: inputCurrentHigh.value,
              originalY2: inputY2.value,
              originalCurrentLow: inputCurrentLow.value
            },
            outputsDisplay: resultsDisplay,
            note: note,
            inputFormat: parsedY1.format,
            closestInfo: {
              closestPairs: closestPairs,
              minDistance: minDistance
            }
          });
          
          storageSet('entries', entries);
          renderHistory();
          
        } catch (err) {
          if (errorMessage) errorMessage.textContent = 'Ø®Ø·Ø§: ' + err.message;
        }
      });
    }
    
    if (resetButton) {
      resetButton.addEventListener('click', () => {
        if (inputY1) inputY1.value = '';
        if (inputY2) inputY2.value = '';
        if (inputCurrentHigh) inputCurrentHigh.value = '';
        if (inputCurrentLow) inputCurrentLow.value = '';
        if (resultsList) resultsList.innerHTML = '';
        if (errorMessage) errorMessage.textContent = '';
        if (closestInfo) {
          closestInfo.innerHTML = '';
          closestInfo.classList.add('hidden');
        }
      });
    }
    
    // ØªØ§Ø¨Ø¹ Ú©Ù¾ÛŒ Ø¨Ù‡ Ú©Ù„ÛŒÙ¾â€ŒØ¨ÙˆØ±Ø¯
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        const message = document.createElement('div');
        message.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-bounce';
        message.innerHTML = `âœ… Ø¹Ø¯Ø¯ <strong>${text}</strong> Ú©Ù¾ÛŒ Ø´Ø¯`;
        document.body.appendChild(message);
        
        setTimeout(() => {
          if (document.body.contains(message)) {
            document.body.removeChild(message);
          }
        }, 2000);
      }).catch(err => {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù†: ', err);
      });
    }
    
    // ---------- ØªØ§Ø±ÛŒØ®Ú†Ù‡ ----------
    
    function renderHistory() {
      const entries = (storageGet('entries') || []).slice();
      entries.sort((a, b) => new Date(b.dateISO).getTime() - new Date(a.dateISO).getTime());
      
      if (entriesCount) entriesCount.textContent = entries.length;
      
      if (multiDateSection && !multiDateSection.classList.contains('hidden')) {
        const selectedPair = multiDatePairFilter ? multiDatePairFilter.value : null;
        const selectedDates = dateRanges.filter(r => r.date).map(r => r.date);
        
        if (selectedDates.length > 0) {
          renderMultiDateHistory(selectedPair, selectedDates);
          return;
        }
      }
      
      const filterDate = historyDate && historyDate.value ? new Date(historyDate.value).toDateString() : null;
      const filterPair = historyPairFilter && historyPairFilter.value ? historyPairFilter.value : null;
      
      if (historyList) historyList.innerHTML = '';
      
      let filtered = entries;
      
      if (!filterDate) {
        const today = new Date().toDateString();
        filtered = entries.filter(e => new Date(e.dateISO).toDateString() === today);
      } else {
        filtered = entries.filter(e => new Date(e.dateISO).toDateString() === filterDate);
      }
      
      if (filterPair) filtered = filtered.filter(e => e.pairId === filterPair);
      
      if (filtered.length === 0) {
        if (historyList) historyList.innerHTML = '<div class="muted text-sm text-center py-4">Ø±Ú©ÙˆØ±Ø¯ÛŒ Ø¬Ù‡Øª Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div>';
        return;
      }
      
      filtered.forEach(e => {
        const pair = (storageGet('pairs') || []).find(p => p.id === e.pairId);
        const pairName = pair?.name || 'â€”';
        const category = pair ? (storageGet('categories') || []).find(c => c.id === pair.categoryId) : null;
        
        const wrapper = document.createElement('div');
        wrapper.className = 'history-entry-compact flex flex-col gap-3 hover:border-white/20 transition-colors';
        
        let closestHTML = '';
        if (e.closestInfo && e.closestInfo.closestPairs && e.closestInfo.closestPairs.length > 0) {
          const displayDist = formatOutputByInputFormat(e.closestInfo.minDistance, e.inputFormat);
          
          closestHTML = `
            <div class="mt-2 pt-2 border-t border-white/10">
              <div class="text-xs muted mb-1">Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ø§Ø¹Ø¯Ø§Ø¯ (ÙØ§ØµÙ„Ù‡: ${displayDist}):</div>
              <div class="text-xs space-y-1">
                ${e.closestInfo.closestPairs.map(pair =>
                  `â€¢ ${pair[0].label} Ùˆ ${pair[1].label}`
                ).join('<br>')}
              </div>
            </div>
          `;
        }
        
        wrapper.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <div class="text-sm font-semibold">${pairName}</div>
              ${category ? `<span class="text-xs bg-blue-600 px-2 py-1 rounded">${category.name}</span>` : ''}
            </div>
            <div class="text-xs muted">${e.dateDisplay}</div>
          </div>
          <div class="flex gap-2 flex-wrap justify-center">
            ${e.outputsDisplay.map(it =>
              `<span class="box-out ${it.color} cursor-pointer hover:opacity-80 transition-opacity"
                     title="Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ: ${it.display}"
                     onclick="copyToClipboard('${it.display}')">
                <span class="num-label">${it.order}.</span> (${it.label}) ${it.display} ${it.suffix}
              </span>`
            ).join('')}
          </div>
          ${closestHTML}
        `;
        
        const bottom = document.createElement('div');
        bottom.className = 'flex gap-2 justify-end';
        
        const viewBtn = document.createElement('button');
        viewBtn.className = 'small-btn bg-indigo-600 hover:bg-indigo-700 rounded transition-colors';
        viewBtn.textContent = 'Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª';
        viewBtn.addEventListener('click', () => showDetail(e.id));
        
        bottom.appendChild(viewBtn);
        wrapper.appendChild(bottom);
        historyList.appendChild(wrapper);
      });
    }
    
    function renderMultiDateHistory(selectedPair, selectedDates) {
      const entries = (storageGet('entries') || []).slice();
      
      if (!historyList) return;
      historyList.innerHTML = '';
      
      if (!selectedDates || selectedDates.length === 0) {
        historyList.innerHTML = '<div class="muted text-sm text-center py-4">Ù‡ÛŒÚ† ØªØ§Ø±ÛŒØ®ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>';
        return;
      }
      
      const normDates = Array.from(new Set(selectedDates
        .map(d => {
          if (!d) return null;
          const dt = new Date(d);
          return isNaN(dt.getTime()) ? null : dt.toISOString().split('T')[0];
        })
        .filter(Boolean)
      )).sort();
      
      if (normDates.length === 0) {
        historyList.innerHTML = '<div class="muted text-sm text-center py-4">Ù‡ÛŒÚ† ØªØ§Ø±ÛŒØ® Ù…Ø¹ØªØ¨Ø±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>';
        return;
      }
      
      const header = document.createElement('div');
      header.className = 'date-comparison-header';
      header.textContent = 'Ù…Ù‚Ø§ÛŒØ³Ù‡ Ú†Ù†Ø¯ ØªØ§Ø±ÛŒØ® Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡';
      historyList.appendChild(header);
      
      const pairs = storageGet('pairs') || [];
      const categories = storageGet('categories') || [];
      const entriesByDate = {};
      
      normDates.forEach(d => { entriesByDate[d] = []; });
      
      entries.forEach(e => {
        const dt = new Date(e.dateISO);
        if (isNaN(dt.getTime())) return;
        
        const key = dt.toISOString().split('T')[0];
        if (!entriesByDate[key]) return;
        
        if (selectedPair && e.pairId !== selectedPair) return;
        entriesByDate[key].push(e);
      });
      
      let hasAny = false;
      
      normDates.forEach(dateKey => {
        const groupEntries = entriesByDate[dateKey] || [];
        const group = document.createElement('div');
        group.className = 'comparison-group';
        
        const title = document.createElement('div');
        title.className = 'text-xs muted mb-2 font-semibold';
        title.textContent = 'ØªØ§Ø±ÛŒØ®: ' + new Date(dateKey).toLocaleDateString('en-CA');
        group.appendChild(title);
        
        if (groupEntries.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'muted text-xs';
          empty.textContent = 'Ø±Ú©ÙˆØ±Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ØªØ§Ø±ÛŒØ® ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.';
          group.appendChild(empty);
        } else {
          hasAny = true;
          groupEntries.sort((a, b) => new Date(b.dateISO).getTime() - new Date(a.dateISO).getTime());
          
          groupEntries.forEach(e => {
            const pair = pairs.find(p => p.id === e.pairId);
            const pairName = pair?.name || 'â€”';
            const category = pair ? categories.find(c => c.id === pair.categoryId) : null;
            
            const wrapper = document.createElement('div');
            wrapper.className = 'history-entry-compact flex flex-col gap-3 hover:border-white/20 transition-colors';
            
            let closestHTML = '';
            if (e.closestInfo && e.closestInfo.closestPairs && e.closestInfo.closestPairs.length > 0) {
              const displayDist = formatOutputByInputFormat(e.closestInfo.minDistance, e.inputFormat);
              
              closestHTML = `
                <div class="mt-2 pt-2 border-t border-white/10">
                  <div class="text-xs muted mb-1">Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ø§Ø¹Ø¯Ø§Ø¯ (ÙØ§ØµÙ„Ù‡: ${displayDist}):</div>
                  <div class="text-xs space-y-1">
                    ${e.closestInfo.closestPairs.map(pair =>
                      `â€¢ ${pair[0].label} Ùˆ ${pair[1].label}`
                    ).join('<br>')}
                  </div>
                </div>
              `;
            }
            
            wrapper.innerHTML = `
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <div class="text-sm font-semibold">${pairName}</div>
                  ${category ? `<span class="text-xs bg-blue-600 px-2 py-1 rounded">${category.name}</span>` : ''}
                </div>
                <div class="text-xs muted">${e.dateDisplay}</div>
              </div>
              <div class="flex gap-2 flex-wrap justify-center">
                ${e.outputsDisplay.map(it =>
                  `<span class="box-out ${it.color} cursor-pointer hover:opacity-80 transition-opacity"
                         title="Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ: ${it.display}"
                         onclick="copyToClipboard('${it.display}')">
                    <span class="num-label">${it.order}.</span> (${it.label}) ${it.display} ${it.suffix}
                  </span>`
                ).join('')}
              </div>
              ${closestHTML}
            `;
            
            const bottom = document.createElement('div');
            bottom.className = 'flex gap-2 justify-end';
            
            const viewBtn = document.createElement('button');
            viewBtn.className = 'small-btn bg-indigo-600 hover:bg-indigo-700 rounded transition-colors';
            viewBtn.textContent = 'Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª';
            viewBtn.addEventListener('click', () => showDetail(e.id));
            
            bottom.appendChild(viewBtn);
            wrapper.appendChild(bottom);
            group.appendChild(wrapper);
          });
        }
        
        historyList.appendChild(group);
      });
      
      if (!hasAny) {
        historyList.innerHTML = '<div class="muted text-sm text-center py-4">Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø±Ú©ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>';
      }
    }
    
    // Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø§Ù„Øª Ú†Ù†Ø¯ØªØ§Ø±ÛŒØ®ÛŒ
    if (toggleMultiDateBtn) {
      toggleMultiDateBtn.addEventListener('click', () => {
        isMultiDate = !isMultiDate;
        if (isMultiDate) {
          toggleMultiDateBtn.textContent = 'ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ú†Ù†Ø¯ØªØ§Ø±ÛŒØ®ÛŒ';
          if (singleDateSection) singleDateSection.classList.add('hidden');
          if (multiDateSection) multiDateSection.classList.remove('hidden');
          if (historyDate) historyDate.value = '';
          if (dateRanges.length === 0) addMultiDateRangeUI();
        } else {
          toggleMultiDateBtn.textContent = 'ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø­Ø§Ù„Øª Ú†Ù†Ø¯ØªØ§Ø±ÛŒØ®ÛŒ';
          if (singleDateSection) singleDateSection.classList.remove('hidden');
          if (multiDateSection) multiDateSection.classList.add('hidden');
          resetMultiDateUI();
          renderHistory();
        }
      });
    }
    
    function resetMultiDateUI() {
      if (dateRangesContainer) dateRangesContainer.innerHTML = '';
      dateRanges = [];
    }
    
    function addMultiDateRangeUI() {
      if (!dateRangesContainer) return;
      
      const id = Date.now().toString() + '_' + Math.random().toString(16).slice(2);
      dateRanges.push({ id, date: null });
      
      const div = document.createElement('div');
      div.className = 'date-range-item';
      div.id = 'range_' + id;
      div.innerHTML = `
        <div class="flex gap-2 items-center">
          <input type="date" class="multi-date-input flex-1" data-id="${id}">
          <button class="small-btn bg-rose-600 hover:bg-rose-700 remove-range" data-id="${id}">âœ•</button>
        </div>`;
      
      dateRangesContainer.appendChild(div);
      
      const input = div.querySelector('.multi-date-input');
      const removeBtn = div.querySelector('.remove-range');
      
      if (input) {
        input.addEventListener('change', (e) => {
          const rid = e.target.dataset.id;
          const item = dateRanges.find(r => r.id === rid);
          if (item) item.date = e.target.value;
        });
      }
      
      if (removeBtn) {
        removeBtn.addEventListener('click', (e) => {
          const rid = e.target.dataset.id;
          dateRanges = dateRanges.filter(r => r.id !== rid);
          const row = document.getElementById('range_' + rid);
          if (row && row.parentNode) row.parentNode.removeChild(row);
          renderHistory();
        });
      }
    }
    
    if (addDateBtn) {
      addDateBtn.addEventListener('click', (e) => {
        e.preventDefault();
        addMultiDateRangeUI();
      });
    }
    
    if (applyMultiDateBtn) {
      applyMultiDateBtn.addEventListener('click', (e) => {
        e.preventDefault();
        renderHistory();
      });
    }
    
    if (historyDate) historyDate.addEventListener('change', renderHistory);
    if (historyPairFilter) historyPairFilter.addEventListener('change', renderHistory);
    
    // ---------- Ù…ÙˆØ¯Ø§Ù„ Ø¬Ø²Ø¦ÛŒØ§Øª ----------
    
    function showDetail(entryId) {
      const entries = storageGet('entries') || [];
      const e = entries.find(x => x.id === entryId);
      if (!e) return;
      
      const pair = (storageGet('pairs') || []).find(p => p.id === e.pairId);
      const pairName = pair?.name || 'â€”';
      const category = pair ? (storageGet('categories') || []).find(c => c.id === pair.categoryId) : null;
      
      if (detailContent) detailContent.innerHTML = '';
      
      let closestHTML = '';
      if (e.closestInfo && e.closestInfo.closestPairs && e.closestInfo.closestPairs.length > 0) {
        const displayDist = formatOutputByInputFormat(e.closestInfo.minDistance, e.inputFormat);
        
        closestHTML = `
          <div class="bg-white/5 p-4 rounded">
            <div class="text-xs muted mb-3">Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ø§Ø¹Ø¯Ø§Ø¯</div>
            <div class="text-sm space-y-2">
              <div class="font-semibold">ÙØ§ØµÙ„Ù‡: ${displayDist}</div>
              ${e.closestInfo.closestPairs.map(pair =>
                `<div class="flex justify-between items-center p-2 bg-white/5 rounded">
                  <div>${pair[0].label} Ùˆ ${pair[1].label}</div>
                </div>`
              ).join('')}
            </div>
          </div>
        `;
      }
      
      detailContent.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-3">
            <div class="bg-white/5 p-3 rounded">
              <div class="text-xs muted mb-1">Ø¬ÙØªâ€ŒØ§Ø±Ø²</div>
              <div class="font-semibold flex items-center gap-2">
                ${pairName}
                ${category ? `<span class="text-xs bg-blue-600 px-2 py-1 rounded">${category.name}</span>` : ''}
              </div>
            </div>
            <div class="bg-white/5 p-3 rounded">
              <div class="text-xs muted mb-1">ØªØ§Ø±ÛŒØ® (Ù…ÛŒÙ„Ø§Ø¯ÛŒ)</div>
              <div class="font-semibold">${e.dateDisplay}</div>
            </div>
          </div>
          <div class="space-y-3">
            <div class="bg-white/5 p-3 rounded">
              <div class="text-xs muted mb-1">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</div>
              <div class="font-semibold">${e.note || '---'}</div>
            </div>
          </div>
        </div>
        <div class="bg-white/5 p-4 rounded">
          <div class="text-xs muted mb-3">ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§</div>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div>Ø¹Ø¯Ø¯ Ø³Ù‚Ù: <span class="font-mono">${e.inputs.originalY1}</span></div>
            <div>Ø³Ù‚Ù ÙØ¹Ù„ÛŒ: <span class="font-mono">${e.inputs.originalCurrentHigh}</span></div>
            <div>Ø¹Ø¯Ø¯ Ú©Ù: <span class="font-mono">${e.inputs.originalY2}</span></div>
            <div>Ú©Ù ÙØ¹Ù„ÛŒ: <span class="font-mono">${e.inputs.originalCurrentLow}</span></div>
          </div>
        </div>
        <div class="bg-white/5 p-4 rounded">
          <div class="text-xs muted mb-3">Ø®Ø±ÙˆØ¬ÛŒâ€ŒÙ‡Ø§ (Ù…Ø±ØªØ¨â€ŒØ´Ø¯Ù‡)</div>
          <div class="flex flex-wrap gap-2 justify-center">
            ${e.outputsDisplay.map(it =>
              `<span class="box-out ${it.color} cursor-default text-sm">
                <span class="num-label">${it.order}.</span> (${it.label}) ${it.display} ${it.suffix}
              </span>`
            ).join('')}
          </div>
        </div>
        ${closestHTML}
      `;
      
      if (detailModal) {
        detailModal.classList.remove('hidden');
      }
      
      if (editRecordBtn) editRecordBtn.onclick = () => editRecord(e.id);
      if (deleteRecordBtn) deleteRecordBtn.onclick = () => deleteRecord(e.id);
      if (moveRecordBtn) moveRecordBtn.onclick = () => moveRecord(e.id);
    }
    
    if (closeDetail) {
      closeDetail.addEventListener('click', () => {
        if (detailModal) {
          detailModal.classList.add('hidden');
        }
      });
    }
    
    function deleteRecord(id) {
      if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;
      
      const entries = storageGet('entries') || [];
      const idx = entries.findIndex(x => x.id === id);
      if (idx === -1) return;
      
      entries.splice(idx, 1);
      storageSet('entries', entries);
      renderHistory();
      
      if (detailModal) {
        detailModal.classList.add('hidden');
      }
    }
    
    function editRecord(id) {
      const entries = storageGet('entries') || [];
      const e = entries.find(x => x.id === id);
      if (!e) return;
      
      if (!confirm('Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ú©ÙˆØ±Ø¯ Ø¯Ø± ÙØ±Ù… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯. Ù¾Ø³ Ø§Ø² ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡â€Œâ€ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯ ØªØ§ Ø±Ú©ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆØ¯. Ø±Ú©ÙˆØ±Ø¯ Ù‚Ø¯ÛŒÙ…ÛŒ Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø§Ø¯Ø§Ù…Û€ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØ¯ØŸ')) return;
      
      if (pairSelect) pairSelect.value = e.pairId || '';
      if (inputY1) inputY1.value = e.inputs.originalY1;
      if (inputCurrentHigh) inputCurrentHigh.value = e.inputs.originalCurrentHigh;
      if (inputY2) inputY2.value = e.inputs.originalY2;
      if (inputCurrentLow) inputCurrentLow.value = e.inputs.originalCurrentLow;
      if (noteInput) noteInput.value = e.note || '';
      if (datePicker) datePicker.value = e.dateDisplay.split(' ')[0] || '';
      
      const idx = entries.findIndex(x => x.id === id);
      if (idx !== -1) {
        entries.splice(idx, 1);
        storageSet('entries', entries);
      }
      
      renderHistory();
      
      if (detailModal) {
        detailModal.classList.add('hidden');
      }
      
      window.scrollTo({top: 0, behavior: 'smooth'});
    }
    
    function moveRecord(id) {
      const newDate = prompt('ØªØ§Ø±ÛŒØ® Ø¬Ø¯ÛŒØ¯ (YYYY-MM-DD) Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');
      if (!newDate) return;
      
      const d = new Date(newDate + 'T00:00:00');
      if (isNaN(d)) {
        alert('ØªØ§Ø±ÛŒØ® Ù†Ø§Ù…Ø¹ØªØ¨Ø±.');
        return;
      }
      
      const entries = storageGet('entries') || [];
      const e = entries.find(x => x.id === id);
      if (!e) return;
      
      e.dateISO = d.toISOString();
      e.dateDisplay = formatGregorian(e.dateISO);
      storageSet('entries', entries);
      renderHistory();
      
      if (detailModal) {
        detailModal.classList.add('hidden');
      }
    }
    
    // ---------- Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø§Ú©Ø³â€ŒÙ‡Ø§ ----------
    
    function updateToggleButton(isOpen) {
      const toggleIcon = document.getElementById('toggle_icon');
      const toggleText = document.getElementById('toggle_text');
      const toggleBtn = document.getElementById('toggle_history_btn');
      
      if (isOpen) {
        toggleIcon.textContent = 'ğŸ“‚';
        toggleIcon.style.transform = 'rotate(0deg) scale(1.1)';
        toggleText.textContent = 'Ø¨Ø³ØªÙ† Ø°Ø®ÛŒØ±Ù‡â€ŒÙ‡Ø§';
        toggleBtn.classList.remove('closed');
        toggleBtn.classList.add('open');
      } else {
        toggleIcon.textContent = 'ğŸ“';
        toggleIcon.style.transform = 'rotate(0deg) scale(1)';
        toggleText.textContent = 'Ù†Ù…Ø§ÛŒØ´ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ‡Ø§';
        toggleBtn.classList.remove('open');
        toggleBtn.classList.add('closed');
      }
    }
    
    if (toggleHistoryBtn) {
      toggleHistoryBtn.addEventListener('click', () => {
        const isCurrentlyHidden = historyPanel.classList.contains('hidden');
        
        if (isCurrentlyHidden) {
          historyPanel.classList.remove('hidden');
          updateToggleButton(true);
          const today = new Date().toISOString().split('T')[0];
          if (historyDate) historyDate.value = today;
          renderHistory();
        } else {
          historyPanel.classList.add('hidden');
          updateToggleButton(false);
        }
      });
    }
    
    if (togglePairsHdr) {
      togglePairsHdr.addEventListener('click', () => {
        if (boxPairs) boxPairs.classList.toggle('hidden');
      });
    }
    
    if (toggleCalcHdr) {
      toggleCalcHdr.addEventListener('click', () => {
        if (boxCalc) boxCalc.classList.toggle('hidden');
      });
    }
    
    if (toggleHistoryHdr) {
      toggleHistoryHdr.addEventListener('click', () => {
        if (boxHistory) boxHistory.classList.toggle('hidden');
      });
    }
    
    // ---------- ÙˆØ±ÙˆØ¯ ØµÙˆØªÛŒ ----------
    
    let recognition = null;
    let isRecording = false;
    let isVoiceActive = false;
    let currentField = null;
    const numericFields = [inputY1, inputCurrentHigh, inputY2, inputCurrentLow];
    
    if (microToggle) {
      microToggle.addEventListener('click', () => {
        if (isVoiceActive) {
          stopVoiceRecognition();
          microToggle.textContent = 'ğŸ™ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† ØµÙˆØª';
          if (voiceStatus) voiceStatus.textContent = 'Ø§ØªØµØ§Ù„ ØµÙˆØªÛŒ Ù‚Ø·Ø¹ Ø´Ø¯';
        } else {
          isVoiceActive = true;
          microToggle.textContent = 'ğŸ™ Ù‚Ø·Ø¹ ØµÙˆØª';
          microToggle.classList.add('connected');
          
          if (voiceStatus) voiceStatus.textContent = 'Ø§ØªØµØ§Ù„ ØµÙˆØªÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯. Ø±ÙˆÛŒ ÙÛŒÙ„Ø¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.';
          
          const emptyField = numericFields.find(field => !field.value || field.value.trim() === '');
          if (emptyField) {
            emptyField.focus();
          } else {
            numericFields[0].focus();
          }
        }
      });
    }
    
    function parseNumberFromTranscript(transcript) {
      if (!transcript) return null;
      
      const persianDigits = {'Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9'};
      let normalized = transcript.replace(/[Û°-Û¹]/g, d => persianDigits[d]);
      normalized = normalized.replace(/[^\d.-]/g, '');
      
      const match = normalized.match(/-?\d*\.?\d+/);
      return match ? match[0] : null;
    }
    
    function startVoiceRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        if (voiceStatus) voiceStatus.textContent = 'Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² ØªØ´Ø®ÛŒØµ ØµÙˆØª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.';
        return;
      }
      
      recognition = new SpeechRecognition();
      recognition.lang = 'fa-IR';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.continuous = false;
      
      recognition.onstart = () => {
        isRecording = true;
        if (microToggle) microToggle.classList.add('recording');
        if (voiceStatus && currentField) {
          voiceStatus.textContent = `ğŸ¤ Ø¯Ø± Ø­Ø§Ù„ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ù„Ø·ÙØ§Ù‹ Ø¹Ø¯Ø¯ Ø±Ø§ Ø¨Ú¯ÙˆÛŒÛŒØ¯`;
        }
      };
      
      recognition.onend = () => {
        isRecording = false;
        if (microToggle) microToggle.classList.remove('recording');
        
        if (isVoiceActive && currentField) {
          setTimeout(() => {
            if (!isRecording && isVoiceActive) {
              startVoiceRecognition();
            }
          }, 300);
        }
      };
      
      recognition.onerror = (ev) => {
        isRecording = false;
        if (microToggle) microToggle.classList.remove('recording');
        
        if (isVoiceActive && currentField) {
          setTimeout(() => {
            if (!isRecording && isVoiceActive) {
              startVoiceRecognition();
            }
          }, 1000);
        }
      };
      
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        const numStr = parseNumberFromTranscript(transcript);
        
        if (numStr && currentField) {
          currentField.value = numStr;
          if (voiceStatus) voiceStatus.textContent = `âœ… Ø¹Ø¯Ø¯ "${numStr}" Ø¯Ø± ÙÛŒÙ„Ø¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÙˆØ§Ø±Ø¯ Ø´Ø¯`;
          
          const currentIndex = numericFields.indexOf(currentField);
          if (currentIndex < numericFields.length - 1) {
            setTimeout(() => {
              numericFields[currentIndex + 1].focus();
            }, 500);
          }
        } else if (voiceStatus) {
          voiceStatus.textContent = 'âŒ Ø¹Ø¯Ø¯ ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.';
        }
      };
      
      try {
        recognition.start();
      } catch (e) {
        console.log('Ø®Ø·Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹ Ø¶Ø¨Ø·:', e);
      }
    }
    
    function stopVoiceRecognition() {
      isVoiceActive = false;
      
      try {
        if (recognition) recognition.stop();
      } catch (e) {}
      
      recognition = null;
      isRecording = false;
      
      if (microToggle) {
        microToggle.classList.remove('recording');
        microToggle.classList.remove('connected');
      }
      
      if (voiceStatus) voiceStatus.textContent = 'Ø§ØªØµØ§Ù„ ØµÙˆØªÛŒ Ù‚Ø·Ø¹ Ø´Ø¯';
    }
    
    numericFields.forEach((field) => {
      if (!field) return;
      
      field.addEventListener('focus', () => {
        currentField = field;
        
        if (isVoiceActive && !isRecording) {
          startVoiceRecognition();
        } else if (isVoiceActive) {
          if (voiceStatus) voiceStatus.textContent = `ğŸ¤ Ø¯Ø± Ø­Ø§Ù„ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ù„Ø·ÙØ§Ù‹ Ø¹Ø¯Ø¯ Ø±Ø§ Ø¨Ú¯ÙˆÛŒÛŒØ¯`;
        }
      });
    });
    
    // ---------- Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ ----------
    
    if (exportBtn) {
      exportBtn.addEventListener('click', () => {
        try {
          const payload = {
            pairs: storageGet('pairs') || [],
            entries: storageGet('entries') || [],
            categories: storageGet('categories') || [],
            meta: {
              created: new Date().toISOString(),
              version: '3.0',
              entryCount: (storageGet('entries') || []).length,
              pairCount: (storageGet('pairs') || []).length,
              categoryCount: (storageGet('categories') || []).length,
              backupId: uid()
            }
          };
          
          const blob = new Blob([JSON.stringify(payload, null, 2)], {type: 'application/json;charset=utf-8'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'calculator_pro_w_d_p3-' + new Date().toISOString().slice(0, 10) + '.json';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          
          showNotification('âœ… ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯');
        } catch (err) {
          console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ú©â€ŒØ¢Ù¾:', err);
          showNotification('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†: ' + err.message, 'error');
        }
      });
    }
    
    if (importBtn) {
      importBtn.addEventListener('click', () => importFile && importFile.click());
    }
    
    if (importFile) {
      importFile.addEventListener('change', (e) => {
        const f = e.target.files[0];
        if (!f) return;
        
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const obj = JSON.parse(reader.result);
            if (!obj) throw new Error('ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø±');
            
            if (Array.isArray(obj.pairs)) storageSet('pairs', obj.pairs);
            if (Array.isArray(obj.entries)) storageSet('entries', obj.entries);
            if (Array.isArray(obj.categories)) storageSet('categories', obj.categories);
            
            showNotification('Ø¨Ú©â€ŒØ¢Ù¾ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯', 'success');
            renderPairs();
            renderHistory();
            
            alert('âœ… Ø¨Ú©â€ŒØ¢Ù¾ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯!');
          } catch (err) {
            alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ú©â€ŒØ¢Ù¾: ' + err.message);
          }
        };
        
        reader.readAsText(f);
        importFile.value = '';
      });
    }
    
    function showNotification(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg z-50 animate-bounce ${type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`;
      toast.innerHTML = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 4000);
    }
    
    // ---------- Ù…ÙˆØ¯Ø§Ù„ Ø¢Ù…Ø§Ø± ----------
    
    if (showStatsBtn) {
      showStatsBtn.addEventListener('click', () => {
        if (statsModal) {
          statsModal.classList.remove('hidden');
          
          const pairs = storageGet('pairs') || [];
          const entries = storageGet('entries') || [];
          const categories = storageGet('categories') || [];
          
          let statsHTML = `
            <div class="stats-grid">
              <div class="stat-item">
                <div class="text-lg font-bold">${pairs.length}</div>
                <div class="text-xs muted">Ø¬ÙØªâ€ŒØ§Ø±Ø²</div>
              </div>
              <div class="stat-item">
                <div class="text-lg font-bold">${entries.length}</div>
                <div class="text-xs muted">Ø±Ú©ÙˆØ±Ø¯ ØªØ§Ø±ÛŒØ®ÛŒ</div>
              </div>
              <div class="stat-item">
                <div class="text-lg font-bold">${categories.length}</div>
                <div class="text-xs muted">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</div>
              </div>
              <div class="stat-item">
                <div class="text-lg font-bold">${new Date().toLocaleDateString('fa-IR')}</div>
                <div class="text-xs muted">ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ²</div>
              </div>
            </div>
          `;
          
          if (statsContent) {
            statsContent.innerHTML = statsHTML;
          }
        }
      });
    }
    
    if (closeStats) {
      closeStats.addEventListener('click', () => {
        if (statsModal) statsModal.classList.add('hidden');
      });
    }
    
    if (manageBackupsBtn) {
      manageBackupsBtn.addEventListener('click', () => {
        if (backupsModal) backupsModal.classList.remove('hidden');
        
        if (backupsContent) {
          backupsContent.innerHTML = `
            <div class="text-center py-4">
              <p class="muted">Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ú©â€ŒØ¢Ù¾â€ŒÙ‡Ø§ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.</p>
            </div>
          `;
        }
      });
    }
    
    if (closeBackups) {
      closeBackups.addEventListener('click', () => {
        if (backupsModal) backupsModal.classList.add('hidden');
      });
    }
    
    if (manualPruneBtn) {
      manualPruneBtn.addEventListener('click', () => {
        const days = document.getElementById('manual_prune_days').value;
        if (!days || isNaN(days) || days < 1) {
          alert('Ù„Ø·ÙØ§Ù‹ ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
          return;
        }
        
        if (confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ± Ø§Ø² ${days} Ø±ÙˆØ² Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.`)) {
          const entries = storageGet('entries') || [];
          const cutoff = Date.now() - (days * 24 * 60 * 60 * 1000);
          const kept = entries.filter(e => new Date(e.dateISO).getTime() >= cutoff);
          
          if (kept.length !== entries.length) {
            storageSet('entries', kept);
            renderHistory();
            alert(`${entries.length - kept.length} Ø±Ú©ÙˆØ±Ø¯ Ù‚Ø¯ÛŒÙ…ÛŒ Ø­Ø°Ù Ø´Ø¯.`);
          } else {
            alert('Ù‡ÛŒÚ† Ø±Ú©ÙˆØ±Ø¯ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù ÛŒØ§ÙØª Ù†Ø´Ø¯.');
          }
        }
      });
    }
    
    // ---------- Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ----------
    
    window.addEventListener('load', () => {
      const today = new Date().toISOString().split('T')[0];
      if (historyDate) historyDate.value = today;
      setTimeout(() => { if (inputY1) inputY1.focus(); }, 1000);
    });
    
    // Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
    if ((storageGet('pairs') || []).length === 0) {
      storageSet('pairs', [
        {id: uid(), name: 'EURUSD', categoryId: 'forex'},
        {id: uid(), name: 'GBPUSD', categoryId: 'forex'},
        {id: uid(), name: 'BTCUSD', categoryId: 'crypto'},
        {id: uid(), name: 'ETHUSD', categoryId: 'crypto'}
      ]);
    }
    
    renderPairs();
    renderHistory();
    
    console.log('âœ… Ø³ÛŒØ³ØªÙ… Calculator PRO - Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø³ÙˆÙ… Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª!');
  </script>
  
  <div class="signature">
    Ø·Ø±Ø§Ø­ÛŒ Ùˆ Ø³Ø§Ø®Øª ØªÙˆØ³Ø· â¤ï¸ Ø³Ø¹ÛŒØ¯ Ø´ÛŒØ® Ø§Ø­Ù…Ø¯ ØµÙØ§Ø±ÛŒ
  </div>
  <br>
  <br>
</body>
</html>
