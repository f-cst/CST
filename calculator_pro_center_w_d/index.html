<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>calculator pro center w/d - Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÙˆÙ…</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#1e293b;
      --card:#334155;
      --muted:#9aa6bf;
      --input-bg:#475569;
      --text-light:#f1f5f9;
    }
    body{font-family: Vazirmatn, system-ui, sans-serif; background:var(--bg); color:var(--text-light); min-height:100vh; padding:20px;}
    .card{background:var(--card); border:1px solid rgba(255,255,255,0.08); border-radius:10px; padding:12px;}
    .section-header{display:flex; align-items:center; justify-content:space-between; gap:8px; cursor:pointer; padding:.5rem; border-radius:8px; background:var(--input-bg); border:1px solid rgba(255,255,255,0.08);}
    .section-title{font-weight:700;}
    .muted{color:var(--muted); font-size:.95rem;}
    input[type="text"], input[type="date"], input[type="number"], select, textarea { background:var(--input-bg); border:1px solid rgba(255,255,255,0.1); color:var(--text-light); padding:.5rem; border-radius:6px; width:100%; }
    input::placeholder{ color:#9ca3af; }
    .box-out{ padding:.35rem .6rem; border-radius:6px; display:inline-block; cursor:pointer; margin:.25rem 0; }
    .box-red{ background:#7f1d1d; color:#fff; }
    .box-green{ background:#064e3b; color:#fff; }
    .box-gray{ background:#4b5563; color:#fff; }
    .box-blue{ background:#1e3a8a; color:#fff; }
    .num-label{ font-weight:700; margin-left:.45rem; opacity:.95; }
    .small-btn{ padding:.25rem .5rem; border-radius:.375rem; font-size:.85rem; cursor:pointer; border:none; transition:all 0.2s; }
    .thin-scroll::-webkit-scrollbar{ width:8px; height:8px; }
    .thin-scroll::-webkit-scrollbar-thumb{ background:rgba(255,255,255,0.1); border-radius:8px; }
    .hidden{ display:none !important; }
    .micro-btn{ background:#0ea5a4; color:#021; padding:.45rem .6rem; border-radius:6px; font-weight:700; cursor:pointer; }
    .micro-btn.recording{ background:#ef4444; color:#fff; }
    .micro-btn.connected{ background:#10b981; color:#fff; }
    .icon-btn{ background:var(--input-bg); border:1px solid rgba(255,255,255,0.08); padding:.35rem .5rem; border-radius:6px; cursor:pointer; color:var(--text-light); }
    .title-click{ display:flex; align-items:center; gap:8px; }
    .category-header{ background:rgba(255,255,255,0.08); padding:.5rem; border-radius:6px; margin:.5rem 0; cursor:pointer; border:1px solid rgba(255,255,255,0.08); }
    .category-content{ padding:.5rem; border-right:2px solid #0ea5a4; margin-right:.5rem; }
    .danger-zone{ background:#7f1d1d; border:1px solid rgba(239,68,68,0.3); padding:12px; border-radius:8px; margin-top:12px; }
    .calendar-icon{ color:var(--text-light); font-size:1.2rem; }
    .show-picker-btn{ color:var(--text-light) !important; background:rgba(255,255,255,0.15) !important; border:1px solid rgba(255,255,255,0.2) !important; }
    .center-modal{ display:flex !important; align-items:center; justify-content:center; }
    .category-item{ background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); }
    .resizable-container { resize: vertical; overflow: auto; min-height: 120px; max-height: 400px; }
    
    /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ø³Ú©Ø±ÙˆÙ„ */
    .history-compact { 
      max-height: none !important; 
      overflow: visible !important;
    }
    .history-entry-compact {
      background: var(--input-bg);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
    }

    /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ´Ø±ÙØªÙ‡ */
    .backup-item {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin: 10px 0;
    }
    .stat-item {
      background: rgba(255,255,255,0.05);
      padding: 8px;
      border-radius: 6px;
      text-align: center;
    }
    
    /* Ø¨Ù‡Ø¨ÙˆØ¯ Ø§Ø³ØªØ§ÛŒÙ„ Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 1000;
    }
    
    .modal-content {
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
      margin: auto;
    }

    /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¬ÙØªâ€ŒØ§Ø±Ø² Ø­Ø°Ù Ø´Ø¯Ù‡ */
    .deleted-pair {
      background: #7f1d1d;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.75rem;
      margin-right: 4px;
    }

    /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ú†Ù†Ø¯Ú¯Ø§Ù†Ù‡ */
    .multi-date-controls {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 12px;
    }
    .date-range-item {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 8px;
    }
    .date-comparison-header {
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 8px;
    }
    .comparison-group {
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 12px;
    }


    .signature {
    color: white;
    text-align: center;
    padding: 16px;
    font-family: Vazirmatn, system-ui;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    font-size: 14px;
    font-weight: 500;
    display: block;
    margin: 30px auto;
    width: fit-content;
    max-width: 90%;
    box-sizing: border-box;
}

@media only screen and (max-width: 768px) {
    .signature {
        font-size: 14px;
        padding: 15px;
    }
}

@media only screen and (max-width: 480px) {
    .signature {
        font-size: 12px;
        padding: 13px;
    }
}
    
  </style>
</head>
<body>
  <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-4">

    <!-- Ù…Ø¯ÛŒØ±ÛŒØª Ø¬ÙØªâ€ŒØ§Ø±Ø² -->
    <aside class="card">
      <div id="hdr_pairs" class="section-header">
        <div class="title-click"><span class="section-title">Ù…Ø¯ÛŒØ±ÛŒØª Ø¬ÙØªâ€ŒØ§Ø±Ø² - Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÙˆÙ…</span> <span class="muted"></span></div>
      </div>
      <div id="box_pairs" class="mt-3">
        <!-- Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ -->
        <div class="mb-4 p-3 rounded bg-[var(--input-bg)] border border-white/10">
          <label class="muted block mb-2">Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</label>
          <div class="flex gap-2 mb-2">
            <input id="new_category_name" placeholder="Ù†Ø§Ù… Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¬Ø¯ÛŒØ¯" type="text" class="flex-1"/>
            <button id="add_category_btn" class="small-btn bg-blue-600 hover:bg-blue-700">Ø§ÙØ²ÙˆØ¯Ù†</button>
          </div>
          <div class="flex gap-2 mb-2">
            <select id="category_select" class="flex-1">
              <option value="">Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</option>
            </select>
            <button id="delete_category_btn" class="small-btn bg-rose-600 hover:bg-rose-700" title="Ø­Ø°Ù Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡">ğŸ—‘</button>
          </div>
          <div class="mt-2">
            <label class="muted text-xs">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯:</label>
            <div id="categories_list" class="mt-1 space-y-1 max-h-20 overflow-y-auto thin-scroll"></div>
          </div>
        </div>

        <!-- Ø§ÙØ²ÙˆØ¯Ù† Ø¬ÙØªâ€ŒØ§Ø±Ø² Ø¬Ø¯ÛŒØ¯ -->
        <div class="mb-3">
          <input id="new_pair_name" placeholder="Ù…Ø«Ø§Ù„: EURUSD" type="text"/>
          <div class="flex gap-2 mt-2">
            <button id="add_pair_btn" class="small-btn bg-emerald-600 hover:bg-emerald-700">Ø§ÙØ²ÙˆØ¯Ù†</button>
            <button id="clear_pairs_btn" class="small-btn bg-rose-600 hover:bg-rose-700">Ø­Ø°Ù Ù‡Ù…Ù‡</button>
          </div>
        </div>

        <!-- Ù†Ù…Ø§ÛŒØ´ Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <label class="muted">ÙÙ‡Ø±Ø³Øª Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§</label>
            <span class="text-xs muted">(Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ± Ø³Ø§ÛŒØ²)</span>
          </div>
          <div id="categories_container" class="resizable-container mt-2 thin-scroll border border-white/10 rounded p-2 space-y-3">
            <!-- Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
          </div>
        </div>

        <div class="border-t border-white/10 pt-3 mt-3">
          <div class="mb-2">
            <button id="export_btn" class="small-btn bg-blue-600 hover:bg-blue-700 w-full">Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ú©â€ŒØ¢Ù¾ (JSON)</button>
          </div>
          <div class="mb-2">
            <input id="import_file" type="file" accept="application/json" class="hidden"/>
            <button id="import_btn" class="small-btn bg-yellow-600 hover:bg-yellow-700 w-full">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ú©â€ŒØ¢Ù¾ (JSON)</button>
          </div>
          
          <!-- Ø¨Ø®Ø´ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ´Ø±ÙØªÙ‡ -->
          <div class="danger-zone">
            <div class="text-center mb-2">
              <span class="text-white font-semibold">âš™ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</span>
            </div>
            
            <!-- Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªÛŒ Ø­Ø°Ù Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ -->
            <div class="mb-3">
              <label class="muted text-xs block mb-1">Ø­Ø°Ù Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ± Ø§Ø²:</label>
              <div class="flex gap-2">
                <input id="manual_prune_days" type="number" min="1" max="3650" value="365" class="flex-1 text-center"/>
                <span class="muted text-xs flex items-center">Ø±ÙˆØ²</span>
              </div>
              <button id="manual_prune_btn" class="small-btn bg-rose-700 hover:bg-rose-800 text-white w-full mt-2">
                Ø­Ø°Ù Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ
              </button>
            </div>

            <!-- Ø¢Ù…Ø§Ø± Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª -->
            <button id="show_stats_btn" class="small-btn bg-purple-600 hover:bg-purple-700 text-white w-full mb-2">
              Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
            </button>

            <!-- Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ú©â€ŒØ¢Ù¾â€ŒÙ‡Ø§ -->
            <button id="manage_backups_btn" class="small-btn bg-indigo-600 hover:bg-indigo-700 text-white w-full">
              Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ú©â€ŒØ¢Ù¾â€ŒÙ‡Ø§
            </button>
            
            <p class="muted text-xs mt-2 text-center">Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù‡Ø³ØªÙ†Ø¯</p>
          </div>
          
          <p class="muted text-xs mt-2">ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</p>
        </div>
      </div>
    </aside>

    <!-- Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ Ø¨Ø§ ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ø¯ 02 -->
    <main class="card">
      <div id="hdr_calc" class="section-header">
        <div class="title-click"><span class="section-title">Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ â€” Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÙˆÙ…</span> <span class="muted"></span></div>
      </div>

      <div id="box_calc" class="mt-3">
        <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ -->
        <div class="mb-3">
          <div class="flex items-center gap-2 mb-2">
            <label class="muted flex-1">Ø¬ÙØªâ€ŒØ§Ø±Ø²</label>
            <button id="micro_toggle" class="micro-btn" title="Ø´Ø±ÙˆØ¹/ØªÙˆÙ‚Ù ÙˆØ±ÙˆØ¯ ØµÙˆØªÛŒ">ğŸ¤ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† ØµÙˆØª</button>
          </div>
          <select id="pair_select"></select>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-3">
          <div>
            <label class="muted">Ø¹Ø¯Ø¯ ÙˆØ±ÙˆØ¯ÛŒ Ø¨Ø®Ø´ Û±</label>
            <input id="input_y1" type="text" placeholder="Ø¹Ø¯Ø¯ Ø§ÙˆÙ„"/>
          </div>
          <div>
            <label class="muted">Ø¹Ø¯Ø¯ ÙˆØ±ÙˆØ¯ÛŒ Ø¨Ø®Ø´ Û²</label>
            <input id="input_y2" type="text" placeholder="Ø¹Ø¯Ø¯ Ø¯ÙˆÙ…"/>
          </div>
        </div>

        <div class="mb-3">
          <label class="muted">ØªØ§Ø±ÛŒØ® (Ù…ÛŒÙ„Ø§Ø¯ÛŒ)</label>
          <div class="flex items-center gap-2">
            <input id="date_picker" type="date" class="flex-1"/>
            <button type="button" onclick="document.getElementById('date_picker').showPicker()" class="small-btn show-picker-btn" title="Ù†Ù…Ø§ÛŒØ´ ØªÙ‚ÙˆÛŒÙ…">
              ğŸ“…
            </button>
          </div>
          <p class="muted text-xs mt-1">ØªØ§Ø±ÛŒØ® Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø±Ú©ÙˆØ±Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
        </div>

        <div class="mb-3">
          <label class="muted">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
          <textarea id="note_input" rows="2" placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
        </div>

        <div class="flex gap-2 mb-3">
          <button id="calculate_button" class="small-btn bg-emerald-600 hover:bg-emerald-700 flex-1">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ Ø°Ø®ÛŒØ±Ù‡</button>
          <button id="reset_button" class="small-btn bg-slate-600 hover:bg-slate-700 flex-1">Ø±ÛŒØ³Øª</button>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-3">
          <div>
            <h4 class="muted mb-2">Ù†ØªØ§ÛŒØ¬ Ø¨Ø®Ø´ Û±</h4>
            <div id="results_list_1" class="space-y-2 min-h-[120px]"></div>
          </div>
          <div>
            <h4 class="muted mb-2">Ù†ØªØ§ÛŒØ¬ Ø¨Ø®Ø´ Û²</h4>
            <div id="results_list_2" class="space-y-2 min-h-[120px]"></div>
          </div>
        </div>

        <div class="bg-[var(--input-bg)] p-3 rounded border border-white/10">
          <h4 class="muted mb-2">ØªØ­Ù„ÛŒÙ„ Ù†Ù‡Ø§ÛŒÛŒ</h4>
          <div id="analysis_result" class="font-semibold text-center space-y-2"></div>
          <p id="error_message" class="muted text-rose-400 mt-2 text-center"></p>
          <p id="voice_status" class="muted mt-2 text-center"></p>
        </div>
      </div>
    </main>

    <!-- ØªØ§Ø±ÛŒØ®Ú†Ù‡ -->
    <section class="card">
      <div id="hdr_history" class="section-header">
        <div class="title-click"><span class="section-title">ØªØ§Ø±ÛŒØ®Ú†Ù‡ - Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÙˆÙ…</span> <span class="muted"></span></div>
      </div>

      <div id="box_history" class="mt-3">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-semibold">ØªØ§Ø±ÛŒØ®Ú†Ù‡</div>
          <div class="muted">Ú©Ù„: <span id="entries_count">0</span></div>
        </div>

        <div class="flex gap-2 mb-3">
          <button id="toggle_history_btn" class="small-btn flex-1 bg-slate-600 hover:bg-slate-700">Ù†Ù…Ø§ÛŒØ´ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ‡Ø§</button>
          <button id="quick_prune" class="small-btn bg-rose-600 hover:bg-rose-700 hidden">Ù¾Ø§Ú© Û³Û° Ø±ÙˆØ²Ù‡</button>
        </div>

        <div id="history_panel" class="mt-3 hidden">
          <!-- Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ ØªØ§Ø±ÛŒØ® Ú†Ù†Ø¯Ú¯Ø§Ù†Ù‡ -->
          <div class="multi-date-controls">
            <div class="flex items-center justify-between mb-3">
              <label class="muted font-semibold">ğŸ“… Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú†Ù†Ø¯ ØªØ§Ø±ÛŒØ® Ù‡Ù…Ø²Ù…Ø§Ù†</label>
              <button id="toggle_multi_date" class="small-btn bg-blue-600 hover:bg-blue-700 text-xs">
                ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø­Ø§Ù„Øª Ú†Ù†Ø¯ØªØ§Ø±ÛŒØ®ÛŒ
              </button>
            </div>
            
            <div id="single_date_section">
              <div class="mb-2 grid grid-cols-2 gap-2">
                <input id="history_date" type="date"/>
                <select id="history_pair_filter">
                  <option value="">Ù‡Ù…Ù‡ Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§</option>
                </select>
              </div>
            </div>
            
            <div id="multi_date_section" class="hidden">
              <div class="mb-3">
                <div class="flex items-center gap-2 mb-2">
                  <select id="multi_date_pair_filter" class="flex-1">
                    <option value="">Ù‡Ù…Ù‡ Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§</option>
                  </select>
                </div>
                
                <div id="date_ranges_container" class="space-y-2">
                  <!-- ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                </div>
                
                <div class="flex gap-2 mt-3">
                  <button id="add_date_btn" class="small-btn bg-green-600 hover:bg-green-700 flex-1">
                    â• Ø§ÙØ²ÙˆØ¯Ù† ØªØ§Ø±ÛŒØ®
                  </button>
                  <button id="apply_multi_date_btn" class="small-btn bg-blue-600 hover:bg-blue-700 flex-1">
                    ğŸ” Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div id="history_list" class="history-compact space-y-2"></div>
        </div>

        <!-- Ù¾Ù†Ø¬Ø±Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø± Ù…Ø±Ú©Ø² ØµÙØ­Ù‡ -->
        <div id="detail_modal" class="hidden fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
          <div class="bg-[var(--card)] p-6 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto border border-white/10">
            <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-3">
              <h4 class="font-bold text-lg">Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„ Ø±Ú©ÙˆØ±Ø¯ - Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÙˆÙ…</h4>
              <button id="close_detail" class="small-btn bg-slate-600 hover:bg-slate-700">Ø¨Ø³ØªÙ†</button>
            </div>
            <div id="detail_content" class="mt-2 text-sm space-y-4"></div>
            <div class="flex gap-2 mt-6 pt-4 border-t border-white/10">
              <button id="edit_record_btn" class="small-btn bg-yellow-600 hover:bg-yellow-700 flex-1">ÙˆÛŒØ±Ø§ÛŒØ´</button>
              <button id="move_record_btn" class="small-btn bg-indigo-600 hover:bg-indigo-700 flex-1">Ø§Ù†ØªÙ‚Ø§Ù„ ØªØ§Ø±ÛŒØ®</button>
              <button id="delete_record_btn" class="small-btn bg-rose-600 hover:bg-rose-700 flex-1">Ø­Ø°Ù</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ -->
  <div id="stats_modal" class="hidden modal-overlay">
    <div class="modal-content bg-[var(--card)] p-6 rounded-lg max-w-md w-full mx-4 border border-white/10">
      <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-3">
        <h4 class="font-bold text-lg">ğŸ“Š Ø¢Ù…Ø§Ø± Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ… - Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÙˆÙ…</h4>
        <button id="close_stats" class="small-btn bg-slate-600 hover:bg-slate-700">âœ•</button>
      </div>
      <div id="stats_content" class="mt-2 text-sm space-y-4">
        <!-- Ø¢Ù…Ø§Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
      </div>
    </div>
  </div>

  <div id="backups_modal" class="hidden modal-overlay">
    <div class="modal-content bg-[var(--card)] p-6 rounded-lg max-w-2xl w-full mx-4 border border-white/10">
      <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-3">
        <h4 class="font-bold text-lg">ğŸ’¾ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ú©â€ŒØ¢Ù¾â€ŒÙ‡Ø§ - Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÙˆÙ…</h4>
        <button id="close_backups" class="small-btn bg-slate-600 hover:bg-slate-700">âœ•</button>
      </div>
      <div id="backups_content" class="mt-2 text-sm space-y-4">
        <!-- Ù„ÛŒØ³Øª Ø¨Ú©â€ŒØ¢Ù¾â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
      </div>
    </div>
  </div>

  <script>
    /* ---------- helpers ---------- */
    const uid = ()=> Date.now().toString(36)+Math.random().toString(36).slice(2,6);
    
    // ØªØºÛŒÛŒØ± Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ localStorage Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØ¯Ø§Ø®Ù„ Ø¨Ø§ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§ÙˆÙ„
    const storageGet = k => JSON.parse(localStorage.getItem('calc_pro_2_' + k) || '[]');
    const storageSet = (k,v) => localStorage.setItem('calc_pro_2_' + k, JSON.stringify(v));
    
    // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø­Ø°Ù Ø®ÙˆØ¯Ú©Ø§Ø± 30 Ø±ÙˆØ²Ù‡
    const AUTO_PRUNE_ENABLED = false;
    const MAX_DAYS = 3650; // 10 Ø³Ø§Ù„ - Ø¹Ù…Ù„Ø§Ù‹ ØºÛŒØ±ÙØ¹Ø§Ù„
    
    function nowISO(){ return new Date().toISOString(); }
    function formatGregorian(dtISO){
      const d = new Date(dtISO);
      const pad = n => n.toString().padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    
    function ensureDefaults(){ 
      if(!storageGet('pairs').length) storageSet('pairs',[]); 
      if(!storageGet('entries').length) storageSet('entries',[]);
      if(!storageGet('categories').length) storageSet('categories',[
        {id: 'default', name: 'Ø§ØµÙ„ÛŒ'},
        {id: 'forex', name: 'ÙØ§Ø±Ú©Ø³'},
        {id: 'crypto', name: 'Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„'}
      ]);
    }
    ensureDefaults();

    /* ---------- safe DOM refs ---------- */
    const $ = id => document.getElementById(id);
    const pairsListEl = $('pairs_list');
    const pairSelect = $('pair_select');
    const historyPairFilter = $('history_pair_filter');
    const newPairName = $('new_pair_name');
    const addPairBtn = $('add_pair_btn');
    const clearPairsBtn = $('clear_pairs_btn');
    const categoriesContainer = $('categories_container');
    const categorySelect = $('category_select');
    const newCategoryName = $('new_category_name');
    const addCategoryBtn = $('add_category_btn');
    const deleteCategoryBtn = $('delete_category_btn');
    const categoriesList = $('categories_list');

    const inputY1 = $('input_y1');
    const inputY2 = $('input_y2');
    const noteInput = $('note_input');
    const datePicker = $('date_picker');
    const calculateButton = $('calculate_button');
    const resetButton = $('reset_button');
    const resultsList1 = $('results_list_1');
    const resultsList2 = $('results_list_2');
    const analysisResult = $('analysis_result');
    const errorMessage = $('error_message');
    const voiceStatus = $('voice_status');

    const exportBtn = $('export_btn');
    const importFile = $('import_file');
    const importBtn = $('import_btn');

    const historyDate = $('history_date');
    const historyList = $('history_list');
    const entriesCount = $('entries_count');

    const toggleHistoryBtn = $('toggle_history_btn');
    const historyPanel = $('history_panel');
    const quickPrune = $('quick_prune');

    const detailModal = $('detail_modal');
    const detailContent = $('detail_content');
    const closeDetail = $('close_detail');
    const editRecordBtn = $('edit_record_btn');
    const moveRecordBtn = $('move_record_btn');
    const deleteRecordBtn = $('delete_record_btn');

    const togglePairsHdr = $('hdr_pairs');
    const boxPairs = $('box_pairs');
    const toggleCalcHdr = $('hdr_calc');
    const boxCalc = $('box_calc');
    const toggleHistoryHdr = $('hdr_history');
    const boxHistory = $('box_history');

    const microToggle = $('micro_toggle');

    // Ø¹Ù†Ø§ØµØ± Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ® Ú†Ù†Ø¯Ú¯Ø§Ù†Ù‡
    const toggleMultiDateBtn = $('toggle_multi_date');
    const singleDateSection = $('single_date_section');
    const multiDateSection = $('multi_date_section');
    const multiDatePairFilter = $('multi_date_pair_filter');
    const dateRangesContainer = $('date_ranges_container');
    const addDateBtn = $('add_date_btn');
    const applyMultiDateBtn = $('apply_multi_date_btn');

    /* ---------- UI utils ---------- */
    function safeForEach(arr, fn){ if(!Array.isArray(arr)) return; arr.forEach(fn); }

    // ---------- ØªÙˆØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ùˆ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø­Ù„ Ù…Ø´Ú©Ù„ Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ø§Ø¹Ø¯Ø§Ø¯ ----------

    // ØªØ§Ø¨Ø¹ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§Ø¹Ø¯Ø§Ø¯ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ±ÙˆØ¯ÛŒ Ø§ØµÙ„ÛŒ
    function formatNumberBasedOnInput(number, originalInput) {
      if (!originalInput) return number.toString();
      
      // Ø¨Ø±Ø±Ø³ÛŒ Ø¢ÛŒØ§ Ø¯Ø± ÙˆØ±ÙˆØ¯ÛŒ Ø§ØµÙ„ÛŒ Ø§Ø² Ù†Ù‚Ø·Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø¨ÙˆØ¯
      const hasDot = originalInput.includes('.');
      
      if (hasDot) {
        // Ø§Ú¯Ø± Ù†Ù‚Ø·Ù‡ Ø¯Ø§Ø´ØªØŒ Ø¹Ø¯Ø¯ Ø±Ø§ Ø¨Ø§ Ù†Ù‚Ø·Ù‡ Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†
        return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      } else {
        // Ø§Ú¯Ø± Ù†Ù‚Ø·Ù‡ Ù†Ø¯Ø§Ø´ØªØŒ Ø¹Ø¯Ø¯ Ø±Ø§ Ø¨Ø¯ÙˆÙ† Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†
        return number.toString();
      }
    }

    // ØªØ§Ø¨Ø¹ parseNumberInput Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ - Ù†Ù‚Ø·Ù‡ Ø±Ø§ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±Ø¯
    function parseNumberInput(str) { 
      if(!str) return {value: NaN, original: str}; 
      
      // Ø°Ø®ÛŒØ±Ù‡ ÙˆØ±ÙˆØ¯ÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´
      const original = str.toString();
      
      // Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ø§Øª: ØªÙ…Ø§Ù… Ù†Ù‚Ø§Ø· Ø±Ø§ Ø­Ø°Ù Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
      const cleaned = str.toString()
        .replace(/[\sØŒ]/g, '') // Ø­Ø°Ù ÙØ§ØµÙ„Ù‡ Ùˆ ÙˆÛŒØ±Ú¯ÙˆÙ„ ÙØ§Ø±Ø³ÛŒ
        .replace(/,/g, '')     // Ø­Ø°Ù ÙˆÛŒØ±Ú¯ÙˆÙ„ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ
        .replace(/\./g, '');   // Ø­Ø°Ù ØªÙ…Ø§Ù… Ù†Ù‚Ø§Ø· Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ø§Øª
      
      return {
        value: parseFloat(cleaned),
        original: original
      }; 
    }

    // ØªØ§Ø¨Ø¹ formatWithDots Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ§Ù‚Ø¹ÛŒ Ú©Ù‡ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ø¯Ø§Ø±ÛŒÙ…
    function formatWithDots(number){ 
      return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.'); 
    }

    // ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: Ø­Ø°Ù Ø¯Ø³ØªÛŒ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ (ÙÙ‚Ø· Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ - Ø¨Ø¯ÙˆÙ† ØªØ£Ø«ÛŒØ± Ø¨Ø± Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§)
    function manualPruneOldEntries(days = 365) {
      const entries = storageGet('entries') || [];
      const cutoff = Date.now() - (days * 24 * 60 * 60 * 1000);
      const kept = entries.filter(e => new Date(e.dateISO).getTime() >= cutoff);
      const deletedCount = entries.length - kept.length;
      
      if (deletedCount > 0) {
        storageSet('entries', kept);
        renderHistory();
        return deletedCount;
      }
      return 0;
    }

    // ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± Ø³ÛŒØ³ØªÙ…
    function showSystemStats() {
      const entries = storageGet('entries') || [];
      const pairs = storageGet('pairs') || [];
      const categories = storageGet('categories') || [];
      
      // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù…
      const now = new Date();
      const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
      
      const recentEntries = entries.filter(e => new Date(e.dateISO) >= thirtyDaysAgo);
      const oldestEntry = entries.length > 0 ? 
        new Date(Math.min(...entries.map(e => new Date(e.dateISO).getTime()))) : null;
      
      // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø¬Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
      const dataSize = JSON.stringify({
        pairs: pairs,
        entries: entries,
        categories: categories
      }).length;
      
      let statsHTML = `
        <div class="stats-grid">
          <div class="stat-item">
            <div class="text-xs muted">Ú©Ù„ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§</div>
            <div class="font-bold text-lg text-green-400">${entries.length}</div>
          </div>
          <div class="stat-item">
            <div class="text-xs muted">Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Û³Û° Ø±ÙˆØ²Ù‡</div>
            <div class="font-bold text-lg text-blue-400">${recentEntries.length}</div>
          </div>
          <div class="stat-item">
            <div class="text-xs muted">Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§</div>
            <div class="font-bold text-lg text-yellow-400">${pairs.length}</div>
          </div>
          <div class="stat-item">
            <div class="text-xs muted">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</div>
            <div class="font-bold text-lg text-purple-400">${categories.length}</div>
          </div>
        </div>
        
        <div class="bg-white/5 p-3 rounded mt-4">
          <div class="text-xs muted mb-2">ğŸ“… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø²Ù…Ø§Ù†ÛŒ:</div>
          <div class="text-sm space-y-1">
            <div>Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯: <span class="font-mono">${oldestEntry ? formatGregorian(oldestEntry.toISOString()) : '---'}</span></div>
            <div>Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯: <span class="font-mono">${entries.length > 0 ? formatGregorian(entries[entries.length-1].dateISO) : '---'}</span></div>
          </div>
        </div>
        
        <div class="bg-white/5 p-3 rounded mt-4">
          <div class="text-xs muted mb-2">ğŸ’¾ ÙØ¶Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ:</div>
          <div class="text-sm space-y-1">
            <div>Ø­Ø¬Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§: <span class="font-bold text-cyan-400">${(dataSize / 1024).toFixed(2)} KB</span></div>
            <div>Ú©Ù„ localStorage: <span class="font-mono">${(JSON.stringify(localStorage).length / 1024).toFixed(2)} KB</span></div>
          </div>
        </div>
        
        <div class="bg-white/5 p-3 rounded mt-4">
          <div class="text-xs muted mb-2">ğŸ”§ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø³ÛŒØ³ØªÙ…:</div>
          <div class="text-sm space-y-1">
            <div>Ø­Ø°Ù Ø®ÙˆØ¯Ú©Ø§Ø±: <span class="text-red-400 font-bold">âŒ ØºÛŒØ±ÙØ¹Ø§Ù„</span></div>
            <div>Ø°Ø®ÛŒØ±Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡: <span class="text-green-400 font-bold">âœ… Ú©Ø§Ù…Ù„</span></div>
            <div>Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: <span class="font-mono">${new Date().toLocaleString('fa-IR')}</span></div>
          </div>
        </div>
      `;
      
      if ($('stats_content')) {
        $('stats_content').innerHTML = statsHTML;
      }
      
      if ($('stats_modal')) {
        $('stats_modal').classList.remove('hidden');
        $('stats_modal').classList.add('center-modal');
      }
    }

    // ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ú©â€ŒØ¢Ù¾â€ŒÙ‡Ø§
    function manageBackups() {
      const entries = storageGet('entries') || [];
      const pairs = storageGet('pairs') || [];
      const categories = storageGet('categories') || [];
      
      let backupsHTML = `
        <div class="mb-4">
          <h5 class="font-semibold mb-2 flex items-center gap-2">
            <span>ğŸ’¾</span> Ø¨Ú©â€ŒØ¢Ù¾ ÙØ¹Ù„ÛŒ:
          </h5>
          <div class="backup-item">
            <div class="flex justify-between items-center mb-3">
              <div>
                <div class="font-semibold">Ø¨Ú©â€ŒØ¢Ù¾ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø³ÛŒØ³ØªÙ…</div>
                <div class="text-xs muted">ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯: ${new Date().toLocaleString('fa-IR')}</div>
              </div>
              <button onclick="createBackup()" class="small-btn bg-green-600 hover:bg-green-700">
                ğŸ“¥ Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ú©â€ŒØ¢Ù¾ Ø¬Ø¯ÛŒØ¯
              </button>
            </div>
            <div class="stats-grid">
              <div class="stat-item">
                <div class="text-xs muted">Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§</div>
                <div class="font-bold text-green-400">${entries.length}</div>
              </div>
              <div class="stat-item">
                <div class="text-xs muted">Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§</div>
                <div class="font-bold text-yellow-400">${pairs.length}</div>
              </div>
              <div class="stat-item">
                <div class="text-xs muted">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</div>
                <div class="font-bold text-purple-400">${categories.length}</div>
              </div>
              <div class="stat-item">
                <div class="text-xs muted">Ø­Ø¬Ù… Ø¯Ø§Ø¯Ù‡</div>
                <div class="font-bold text-cyan-400">${(JSON.stringify({pairs, entries, categories}).length / 1024).toFixed(1)} KB</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="border-t border-white/10 pt-4">
          <h5 class="font-semibold mb-2 flex items-center gap-2">
            <span>ğŸ“‹</span> Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ:
          </h5>
          <div class="bg-white/5 p-3 rounded text-xs space-y-2">
            <div class="flex items-start gap-2">
              <span class="text-green-400">âœ…</span>
              <div><strong>Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ú©â€ŒØ¢Ù¾:</strong> Ø§Ø² Ø¯Ú©Ù…Ù‡ "Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ú©â€ŒØ¢Ù¾" Ø¯Ø± Ø¨Ø®Ø´ Ù…Ø¯ÛŒØ±ÛŒØª Ø¬ÙØªâ€ŒØ§Ø±Ø² Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯</div>
            </div>
            <div class="flex items-start gap-2">
              <span class="text-blue-400">ğŸ’¾</span>
              <div><strong>Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ú©â€ŒØ¢Ù¾:</strong> Ù‡Ù…ÛŒØ´Ù‡ ÛŒÚ© Ú©Ù¾ÛŒ Ø§Ø² ÙØ§ÛŒÙ„ JSON Ø¯Ø± Ù…Ú©Ø§Ù† Ø§Ù…Ù† Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯</div>
            </div>
            <div class="flex items-start gap-2">
              <span class="text-yellow-400">âš ï¸</span>
              <div><strong>Ù‡Ø´Ø¯Ø§Ø±:</strong> Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ú©â€ŒØ¢Ù¾ØŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ Ø±Ø§ Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ú©â€ŒØ¢Ù¾ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†Ø¯</div>
            </div>
            <div class="flex items-start gap-2">
              <span class="text-red-400">ğŸ”’</span>
              <div><strong>Ø§Ù…Ù†ÛŒØª:</strong> ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¨Ú©â€ŒØ¢Ù¾ Ø­Ø§ÙˆÛŒ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ù‡Ø³ØªÙ†Ø¯ØŒ Ø¢Ù†Ù‡Ø§ Ø±Ø§ Ø¯Ø± Ù…Ú©Ø§Ù† Ø§Ù…Ù† Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯</div>
            </div>
          </div>
        </div>
        
        <div class="border-t border-white/10 pt-4 mt-4">
          <h5 class="font-semibold mb-2 flex items-center gap-2">
            <span>ğŸ› ï¸</span> Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡:
          </h5>
          <div class="grid grid-cols-1 gap-2">
            <button onclick="exportFullBackup()" class="small-btn bg-blue-600 hover:bg-blue-700 w-full">
              ğŸ“Š Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ú©â€ŒØ¢Ù¾ Ú©Ø§Ù…Ù„ Ø¨Ø§ Ø¢Ù…Ø§Ø±
            </button>
            <button onclick="validateData()" class="small-btn bg-purple-600 hover:bg-purple-700 w-full">
              ğŸ” Ø¨Ø±Ø±Ø³ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            </button>
          </div>
        </div>
      `;
      
      if ($('backups_content')) {
        $('backups_content').innerHTML = backupsHTML;
      }
      
      if ($('backups_modal')) {
        $('backups_modal').classList.remove('hidden');
        $('backups_modal').classList.add('center-modal');
      }
    }

    // ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ú©â€ŒØ¢Ù¾ Ø¨Ø§ timestamp
    function createBackup() {
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
      const entries = storageGet('entries') || [];
      const pairs = storageGet('pairs') || [];
      const categories = storageGet('categories') || [];
      
      const payload = { 
        pairs: pairs, 
        entries: entries, 
        categories: categories,
        meta: {
          created: new Date().toISOString(),
          version: '2.0',
          entryCount: entries.length,
          pairCount: pairs.length,
          categoryCount: categories.length,
          dataSize: JSON.stringify({pairs, entries, categories}).length,
          backupId: uid(),
          pairInfo: pairs.map(p => ({
            id: p.id,
            name: p.name,
            categoryId: p.categoryId
          }))
        }
      };
      
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json;charset=utf-8'});
      const url = URL.createObjectURL(blob); 
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = `calc-pro-2-backup-${timestamp}.json`; 
      document.body.appendChild(a); 
      a.click(); 
      a.remove(); 
      URL.revokeObjectURL(url);
      
      alert(`âœ… Ø¨Ú©â€ŒØ¢Ù¾ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯!\nğŸ“ ÙØ§ÛŒÙ„: calc-pro-2-backup-${timestamp}.json\nğŸ“Š Ø­Ø¬Ù…: ${(blob.size / 1024).toFixed(2)} KB`);
    }

    // ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ú©â€ŒØ¢Ù¾ Ú©Ø§Ù…Ù„ Ø¨Ø§ Ø¢Ù…Ø§Ø±
    function exportFullBackup() {
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
      const entries = storageGet('entries') || [];
      const pairs = storageGet('pairs') || [];
      const categories = storageGet('categories') || [];
      
      // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¢Ù…Ø§Ø± ØªÙØµÛŒÙ„ÛŒ
      const stats = {
        totalEntries: entries.length,
        totalPairs: pairs.length,
        totalCategories: categories.length,
        dateRange: {
          oldest: entries.length > 0 ? Math.min(...entries.map(e => new Date(e.dateISO).getTime())) : null,
          newest: entries.length > 0 ? Math.max(...entries.map(e => new Date(e.dateISO).getTime())) : null
        },
        pairUsage: {},
        categoryDistribution: {}
      };
      
      // Ø¢Ù…Ø§Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§
      entries.forEach(entry => {
        const pairName = pairs.find(p => p.id === entry.pairId)?.name || 'Ù†Ø§Ù…Ø´Ø®Øµ';
        stats.pairUsage[pairName] = (stats.pairUsage[pairName] || 0) + 1;
      });
      
      // ØªÙˆØ²ÛŒØ¹ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§
      pairs.forEach(pair => {
        const categoryName = categories.find(c => c.id === pair.categoryId)?.name || 'Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ';
        stats.categoryDistribution[categoryName] = (stats.categoryDistribution[categoryName] || 0) + 1;
      });
      
      const payload = { 
        data: {
          pairs: pairs, 
          entries: entries, 
          categories: categories
        },
        statistics: stats,
        meta: {
          exportType: 'full_backup_with_stats',
          created: new Date().toISOString(),
          version: '2.0',
          generator: 'Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ ØªØ­Ù„ÛŒÙ„ÛŒ - Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÙˆÙ…'
        }
      };
      
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json;charset=utf-8'});
      const url = URL.createObjectURL(blob); 
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = `calc-pro-2-full-backup-${timestamp}.json`; 
      document.body.appendChild(a); 
      a.click(); 
      a.remove(); 
      URL.revokeObjectURL(url);
      
      alert(`âœ… Ø¨Ú©â€ŒØ¢Ù¾ Ú©Ø§Ù…Ù„ Ø¨Ø§ Ø¢Ù…Ø§Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯!\nğŸ“ ÙØ§ÛŒÙ„: calc-pro-2-full-backup-${timestamp}.json\nğŸ“Š Ø­Ø¬Ù…: ${(blob.size / 1024).toFixed(2)} KB`);
    }

    // ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: Ø¨Ø±Ø±Ø³ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
    function validateData() {
      const entries = storageGet('entries') || [];
      const pairs = storageGet('pairs') || [];
      const categories = storageGet('categories') || [];
      
      let issues = [];
      let warnings = [];
      
      // Ø¨Ø±Ø±Ø³ÛŒ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù…Ø¹ÛŒÙˆØ¨
      entries.forEach((entry, index) => {
        if (!entry.id) issues.push(`Ø±Ú©ÙˆØ±Ø¯ ${index + 1}: ÙØ§Ù‚Ø¯ Ø´Ù†Ø§Ø³Ù‡ Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯`);
        if (!entry.dateISO) issues.push(`Ø±Ú©ÙˆØ±Ø¯ ${index + 1}: ÙØ§Ù‚Ø¯ ØªØ§Ø±ÛŒØ®`);
        if (entry.pairId && !pairs.find(p => p.id === entry.pairId)) {
          warnings.push(`Ø±Ú©ÙˆØ±Ø¯ ${index + 1}: Ø¬ÙØªâ€ŒØ§Ø±Ø² Ù…Ø±Ø¬Ø¹ Ø­Ø°Ù Ø´Ø¯Ù‡`);
        }
      });
      
      // Ø¨Ø±Ø±Ø³ÛŒ Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§ÛŒ Ù…Ø¹ÛŒÙˆØ¨
      pairs.forEach((pair, index) => {
        if (!pair.id) issues.push(`Ø¬ÙØªâ€ŒØ§Ø±Ø² ${index + 1}: ÙØ§Ù‚Ø¯ Ø´Ù†Ø§Ø³Ù‡`);
        if (!pair.name) issues.push(`Ø¬ÙØªâ€ŒØ§Ø±Ø² ${index + 1}: ÙØ§Ù‚Ø¯ Ù†Ø§Ù…`);
        if (pair.categoryId && !categories.find(c => c.id === pair.categoryId)) {
          warnings.push(`Ø¬ÙØªâ€ŒØ§Ø±Ø² ${pair.name}: Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù…Ø±Ø¬Ø¹ Ø­Ø°Ù Ø´Ø¯Ù‡`);
        }
      });
      
      // Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø¹ÛŒÙˆØ¨
      categories.forEach((category, index) => {
        if (!category.id) issues.push(`Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ ${index + 1}: ÙØ§Ù‚Ø¯ Ø´Ù†Ø§Ø³Ù‡`);
        if (!category.name) issues.push(`Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ ${index + 1}: ÙØ§Ù‚Ø¯ Ù†Ø§Ù…`);
      });
      
      let resultMessage = 'ğŸ” Ù†ØªÛŒØ¬Ù‡ Ø¨Ø±Ø±Ø³ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:\n\n';
      
      if (issues.length === 0 && warnings.length === 0) {
        resultMessage += 'âœ… ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø³Ø§Ù„Ù… Ùˆ ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Ù‡Ø³ØªÙ†Ø¯!\n';
        resultMessage += `ğŸ“Š Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ:\n`;
        resultMessage += `â€¢ ${entries.length} Ø±Ú©ÙˆØ±Ø¯ Ø³Ø§Ù„Ù…\n`;
        resultMessage += `â€¢ ${pairs.length} Ø¬ÙØªâ€ŒØ§Ø±Ø² Ø³Ø§Ù„Ù…\n`;
        resultMessage += `â€¢ ${categories.length} Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø³Ø§Ù„Ù…`;
      } else {
        if (issues.length > 0) {
          resultMessage += `âŒ Ù…Ø´Ú©Ù„Ø§Øª Ø¬Ø¯ÛŒ (${issues.length}):\n`;
          issues.slice(0, 5).forEach(issue => resultMessage += `â€¢ ${issue}\n`);
          if (issues.length > 5) resultMessage += `â€¢ ... Ùˆ ${issues.length - 5} Ù…Ø´Ú©Ù„ Ø¯ÛŒÚ¯Ø±\n`;
          resultMessage += '\n';
        }
        
        if (warnings.length > 0) {
          resultMessage += `âš ï¸ Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ (${warnings.length}):\n`;
          warnings.slice(0, 5).forEach(warning => resultMessage += `â€¢ ${warning}\n`);
          if (warnings.length > 5) resultMessage += `â€¢ ... Ùˆ ${warnings.length - 5} Ù‡Ø´Ø¯Ø§Ø± Ø¯ÛŒÚ¯Ø±\n`;
        }
      }
      
      alert(resultMessage);
    }

    /* ---------- Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ ---------- */
    function renderCategories(){
      const categories = storageGet('categories') || [];
      const pairs = storageGet('pairs') || [];
      
      // Ø±Ù†Ø¯Ø± select Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§
      if(categorySelect){
        categorySelect.innerHTML = '<option value="">Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</option>';
        categories.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat.id;
          opt.textContent = cat.name;
          categorySelect.appendChild(opt);
        });
      }
      
      // Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯
      if(categoriesList){
        categoriesList.innerHTML = '';
        if(categories.length === 0){
          categoriesList.innerHTML = '<div class="text-xs muted text-center py-1">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
        } else {
          categories.forEach(cat => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-1 px-2 rounded category-item';
            div.innerHTML = `
              <span class="text-xs">${cat.name}</span>
              <span class="text-xs muted">${pairs.filter(p => p.categoryId === cat.id).length} Ø¬ÙØªâ€ŒØ§Ø±Ø²</span>
            `;
            categoriesList.appendChild(div);
          });
        }
      }
      
      // Ø±Ù†Ø¯Ø± Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§
      if(categoriesContainer){
        categoriesContainer.innerHTML = '';
        
        // Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ "Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ"
        const uncategorizedPairs = pairs.filter(p => !p.categoryId);
        if(uncategorizedPairs.length > 0){
          renderCategorySection(null, 'Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ', uncategorizedPairs);
        }
        
        // Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡
        categories.forEach(category => {
          const categoryPairs = pairs.filter(p => p.categoryId === category.id);
          if(categoryPairs.length > 0){
            renderCategorySection(category.id, category.name, categoryPairs);
          }
        });
      }
    }

    function renderCategorySection(categoryId, categoryName, pairs){
      const section = document.createElement('div');
      section.className = 'category-section';
      section.innerHTML = `
        <div class="category-header flex justify-between items-center" data-category="${categoryId || ''}">
          <div class="font-semibold text-sm">${categoryName} (${pairs.length})</div>
          <div class="muted text-xs">â–¼</div>
        </div>
        <div class="category-content">
          <ul class="space-y-2 pairs-list-${categoryId || 'uncategorized'}"></ul>
        </div>
      `;
      
      categoriesContainer.appendChild(section);
      
      // Ø±Ù†Ø¯Ø± Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§ÛŒ Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ
      const pairsList = section.querySelector(`.pairs-list-${categoryId || 'uncategorized'}`);
      pairs.forEach(p => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between gap-2 p-2 rounded bg-white/5';
        
        // Ø¯Ø±Ø³Øª Ú©Ø±Ø¯Ù† options Ø¨Ø±Ø§ÛŒ select
        const categories = storageGet('categories') || [];
        const categoryOptions = categories.map(cat => 
          `<option value="${cat.id}" ${p.categoryId === cat.id ? 'selected' : ''}>${cat.name}</option>`
        ).join('');
        
        li.innerHTML = `
          <div class="flex-1 text-sm">${p.name}</div>
          <div class="flex gap-1">
            <select class="small-btn bg-slate-600 text-xs move-category" data-id="${p.id}">
              <option value="">Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡...</option>
              ${categoryOptions}
              <option value="" ${!p.categoryId ? 'selected' : ''}>Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</option>
            </select>
            <button data-action="up" data-id="${p.id}" class="small-btn bg-slate-600">â–²</button>
            <button data-action="down" data-id="${p.id}" class="small-btn bg-slate-600">â–¼</button>
            <button data-action="edit" data-id="${p.id}" class="small-btn bg-yellow-600">âœ</button>
            <button data-action="delete" data-id="${p.id}" class="small-btn bg-rose-600">ğŸ—‘</button>
          </div>
        `;
        pairsList.appendChild(li);
      });
      
      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener Ø¨Ø±Ø§ÛŒ collapse/expand
      const header = section.querySelector('.category-header');
      header.addEventListener('click', () => {
        const content = section.querySelector('.category-content');
        content.classList.toggle('hidden');
      });
    }

    function addCategory(name){
      if(!name || !name.trim()) return;
      const categories = storageGet('categories') || [];
      // Ø¨Ø±Ø±Ø³ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ù†Ø¨ÙˆØ¯Ù† Ù†Ø§Ù…
      if(categories.some(cat => cat.name === name.trim())){
        alert('Ø§ÛŒÙ† Ù†Ø§Ù… Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯!');
        return;
      }
      categories.push({id: uid(), name: name.trim()});
      storageSet('categories', categories);
      renderCategories();
    }

    function deleteCategory(){
      const selectedCategoryId = categorySelect ? categorySelect.value : null;
      if(!selectedCategoryId){
        alert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯!');
        return;
      }
      
      const categories = storageGet('categories') || [];
      const category = categories.find(cat => cat.id === selectedCategoryId);
      if(!category) return;
      
      // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯
      const pairs = storageGet('pairs') || [];
      const pairsInCategory = pairs.filter(p => p.categoryId === selectedCategoryId);
      
      if(pairsInCategory.length > 0){
        if(!confirm(`Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ "${category.name}" Ø¯Ø§Ø±Ø§ÛŒ ${pairsInCategory.length} Ø¬ÙØªâ€ŒØ§Ø±Ø² Ø§Ø³Øª. Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø­Ø°Ù Ø´ÙˆØ¯ Ùˆ Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§ÛŒ Ø¢Ù† Ø¨Ù‡ "Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ" Ù…Ù†ØªÙ‚Ù„ Ø´ÙˆÙ†Ø¯ØŸ`)){
          return;
        }
        // Ø§Ù†ØªÙ‚Ø§Ù„ Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§ Ø¨Ù‡ Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ
        pairsInCategory.forEach(p => {
          p.categoryId = null;
        });
        storageSet('pairs', pairs);
      } else {
        if(!confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ "${category.name}" Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`)){
          return;
        }
      }
      
      // Ø­Ø°Ù Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ
      const updatedCategories = categories.filter(cat => cat.id !== selectedCategoryId);
      storageSet('categories', updatedCategories);
      renderCategories();
      renderPairs();
    }

    /* ---------- pairs management ---------- */
    function renderPairs(){
      const pairs = storageGet('pairs') || [];
      
      // Ø±Ù†Ø¯Ø± selectÙ‡Ø§
      if(pairSelect) pairSelect.innerHTML = '';
      if(historyPairFilter) {
        historyPairFilter.innerHTML = '<option value="">Ù‡Ù…Ù‡ Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§</option>';
      }
      if(multiDatePairFilter) {
        multiDatePairFilter.innerHTML = '<option value="">Ù‡Ù…Ù‡ Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§</option>';
      }
      
      pairs.forEach(p => {
        if(pairSelect){
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.name;
          pairSelect.appendChild(opt);
        }
        if(historyPairFilter){
          const opt2 = document.createElement('option');
          opt2.value = p.id;
          opt2.textContent = p.name;
          historyPairFilter.appendChild(opt2);
        }
        if(multiDatePairFilter){
          const opt3 = document.createElement('option');
          opt3.value = p.id;
          opt3.textContent = p.name;
          multiDatePairFilter.appendChild(opt3);
        }
      });
      
      if(pairs.length === 0){
        if(pairSelect){
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø¬ÙØªâ€ŒØ§Ø±Ø² Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯';
          pairSelect.appendChild(opt);
        }
      }
      
      // Ø±Ù†Ø¯Ø± Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§
      renderCategories();
    }

    function addPair(name){
      if(!name || !name.trim()) return;
      const pairs = storageGet('pairs')||[];
      const selectedCategory = categorySelect ? categorySelect.value : null;
      
      pairs.push({
        id: uid(), 
        name: name.trim(),
        categoryId: selectedCategory || null
      });
      
      storageSet('pairs', pairs);
      renderPairs();
    }

    function swapPairs(i,j){
      const pairs = storageGet('pairs')||[];
      if(!pairs[i] || !pairs[j]) return;
      [pairs[i], pairs[j]] = [pairs[j], pairs[i]];
      storageSet('pairs', pairs);
      renderPairs();
    }

    function movePairToCategory(pairId, newCategoryId){
      const pairs = storageGet('pairs')||[];
      const pair = pairs.find(p => p.id === pairId);
      if(pair){
        pair.categoryId = newCategoryId || null;
        storageSet('pairs', pairs);
        renderPairs();
      }
    }

    if(categoriesContainer){
      categoriesContainer.addEventListener('click', (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const action = btn.dataset.action; const id = btn.dataset.id;
        const pairs = storageGet('pairs')||[]; const idx = pairs.findIndex(p => p.id === id);
        if(action === 'up' && idx > 0) swapPairs(idx, idx-1);
        if(action === 'down' && idx < pairs.length-1) swapPairs(idx, idx+1);
        if(action === 'delete'){ if(!confirm('Ø¢ÛŒØ§ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return; pairs.splice(idx,1); storageSet('pairs', pairs); renderPairs(); }
        if(action === 'edit'){ const newName = prompt('Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯:', pairs[idx].name); if(newName && newName.trim()){ pairs[idx].name = newName.trim(); storageSet('pairs', pairs); renderPairs(); } }
      });
      
      categoriesContainer.addEventListener('change', (e) => {
        if(e.target.classList.contains('move-category')){
          const pairId = e.target.dataset.id;
          const newCategoryId = e.target.value || null;
          movePairToCategory(pairId, newCategoryId);
        }
      });
    }

    if(addPairBtn) addPairBtn.addEventListener('click', ()=>{ addPair(newPairName ? newPairName.value : ''); if(newPairName) newPairName.value=''; });
    if(clearPairsBtn) clearPairsBtn.addEventListener('click', ()=>{ if(confirm('Ø¢ÛŒØ§ Ù‡Ù…Ù‡ Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯ØŸ')){ storageSet('pairs', []); renderPairs(); } });
    if(addCategoryBtn) addCategoryBtn.addEventListener('click', () => { addCategory(newCategoryName ? newCategoryName.value : ''); if(newCategoryName) newCategoryName.value = ''; });
    if(deleteCategoryBtn) deleteCategoryBtn.addEventListener('click', deleteCategory);

    /* ---------- ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ø¯ 02 ---------- */

    // ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ú©Ø¯ 02 - Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
    function calculateForOneInput(yStr, outputContainer) {
      if(!outputContainer) return [];
      
      outputContainer.innerHTML = '';
      if (!yStr) return [];

      const parsed = parseNumberInput(yStr);
      const y = parsed.value;

      if (isNaN(y)) throw new Error(`ÙˆØ±ÙˆØ¯ÛŒ "${yStr}" ÛŒÚ© Ø¹Ø¯Ø¯ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.`);
      if (y < 0) throw new Error("Ù„Ø·ÙØ§Ù‹ ÙÙ‚Ø· Ø§Ø¹Ø¯Ø§Ø¯ Ù…Ø«Ø¨Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");

      const results = [
        Math.floor(Math.pow(Math.sqrt(y) - 0.13, 2)),
        Math.floor(Math.pow(Math.sqrt(y) - 0.25, 2)),
        Math.floor(Math.pow(Math.sqrt(y) + 0.13, 2)),
        Math.floor(Math.pow(Math.sqrt(y) + 0.25, 2))
      ];

      // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø´Ù…Ø§Ø±Ù‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø§Ø² Ú©ÙˆÚ†Ú© Ø¨Ù‡ Ø¨Ø²Ø±Ú¯
      const sortedResults = [...results].sort((a, b) => a - b);

      sortedResults.forEach((res, index) => {
        // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ú©Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ±ÙˆØ¯ÛŒ Ø§ØµÙ„ÛŒ ÙØ±Ù…Øª Ù…ÛŒâ€ŒØ¯Ù‡Ø¯
        const displayValue = formatNumberBasedOnInput(res, parsed.original);
        const span = document.createElement('span');
        span.className = `box-out box-gray cursor-pointer hover:opacity-80 transition-opacity`;
        span.title = `Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ: ${displayValue}`;
        span.innerHTML = `<span class="num-label">${index + 1}.</span> ${displayValue}`;
        span.addEventListener('click', () => copyToClipboard(displayValue));
        const p = document.createElement('div'); 
        p.appendChild(span); 
        outputContainer.appendChild(p);
      });

      return sortedResults;
    }

    // ØªØ§Ø¨Ø¹ Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ø²ÙˆØ¬ Ø¨ÛŒÙ† Ø¯Ùˆ Ú¯Ø±ÙˆÙ‡ + Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢Ù†Ù‡Ø§
    function findClosestPairAcrossSets(set1, set2) {
      // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ù…Ù„ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§
      if (!set1 || !set2 || !Array.isArray(set1) || !Array.isArray(set2) || set1.length === 0 || set2.length === 0) {
        return null;
      }

      let minDifference = Infinity;
      let closestPair = null;
      let closestIndexes = null;

      for (let i = 0; i < set1.length; i++) {
        for (let j = 0; j < set2.length; j++) {
          // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¹Ø¯Ø¯ Ø¨Ø§Ø´Ù†Ø¯
          if (typeof set1[i] !== 'number' || typeof set2[j] !== 'number') continue;
          
          const diff = Math.abs(set1[i] - set2[j]);
          if (diff < minDifference) {
            minDifference = diff;
            closestPair = [set1[i], set2[j]];
            closestIndexes = [i + 1, j + 1]; // +1 Ú†ÙˆÙ† Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§ Ø§Ø² 1 Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
          }
        }
      }
      
      // Ø¨Ø±Ø±Ø³ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ù†ØªÛŒØ¬Ù‡ Ù…Ø¹ØªØ¨Ø± Ø¨Ø§Ø´Ø¯
      if (closestPair && Array.isArray(closestPair) && closestPair.length === 2 && 
          closestIndexes && Array.isArray(closestIndexes) && closestIndexes.length === 2) {
        return { 
          pair: closestPair, 
          difference: minDifference,
          indexes: closestIndexes // [Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø± Ø¨Ø®Ø´ Û±, Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø± Ø¨Ø®Ø´ Û²]
        };
      }
      
      return null;
    }

    function renderResultsDisplay(results1, results2, closest) {
      if (!analysisResult) return;
      
      // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ù…Ù„ closest Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø³ØªÙØ§Ø¯Ù‡
      if (closest && closest.pair && Array.isArray(closest.pair) && closest.pair.length === 2 && 
          closest.indexes && Array.isArray(closest.indexes) && closest.indexes.length === 2) {
        
        // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ÙØ±Ù…Øª Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± ØªØ­Ù„ÛŒÙ„
        const formattedPair = `${closest.pair[0]} (Ø¨Ø®Ø´ Û±) Ùˆ ${closest.pair[1]} (Ø¨Ø®Ø´ Û²)`;
        const formattedDiff = closest.difference;
        const indexesText = `${closest.indexes[0]}/${closest.indexes[1]}`;
        
        analysisResult.innerHTML = `
          <div>Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ø²ÙˆØ¬: <b class="text-green-400">${formattedPair}</b></div>
          <div>Ø§Ø®ØªÙ„Ø§Ù: <b class="text-green-400">${formattedDiff}</b></div>
          <div>Ø´Ù…Ø§Ø±Ù‡ Ù†ØªØ§ÛŒØ¬ Ù†Ø²Ø¯ÛŒÚ©: <b class="text-yellow-400">${indexesText}</b></div>
          <div class="text-xs muted mt-1">(Ø¹Ø¯Ø¯ ${closest.indexes[0]} Ø¨Ø®Ø´ Û± Ø¨Ø§ Ø¹Ø¯Ø¯ ${closest.indexes[1]} Ø¨Ø®Ø´ Û²)</div>
        `;
      } else if (inputY1 && inputY2 && inputY1.value && inputY2.value) {
        analysisResult.textContent = 'ØªØ­Ù„ÛŒÙ„ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ ÙˆÙ„ÛŒ Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ø²ÙˆØ¬ ÛŒØ§ÙØª Ù†Ø´Ø¯.';
      } else {
        analysisResult.textContent = 'Ù„Ø·ÙØ§Ù‹ Ø§Ø¹Ø¯Ø§Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.';
      }
    }

    /* ---------- entries save/prune ---------- */
    function saveEntry(pairId, inputs, results1, results2, closest, note='', dateISO=null){
      const entries = storageGet('entries')||[];
      const si = dateISO || nowISO();
      
      // Ø¨Ø±Ø±Ø³ÛŒ ØµØ­Øª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ closest Ù‚Ø¨Ù„ Ø§Ø² Ø°Ø®ÛŒØ±Ù‡
      const safeClosest = (closest && closest.pair && Array.isArray(closest.pair) && closest.pair.length === 2 && 
                          closest.indexes && Array.isArray(closest.indexes) && closest.indexes.length === 2) ? closest : null;
      
      const entry = { 
        id: uid(), 
        pairId, 
        dateISO: si, 
        dateDisplay: formatGregorian(si), 
        inputs, 
        results1: Array.isArray(results1) ? results1 : [], 
        results2: Array.isArray(results2) ? results2 : [], 
        closest: safeClosest,
        note,
        // Ø°Ø®ÛŒØ±Ù‡ ÙØ±Ù…Øª ÙˆØ±ÙˆØ¯ÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´
        inputFormats: {
          y1: inputs.originalY1 || '',
          y2: inputs.originalY2 || ''
        }
      };
      entries.push(entry); 
      storageSet('entries', entries);
      
      // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø­Ø°Ù Ø®ÙˆØ¯Ú©Ø§Ø± - ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù† Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
      if (AUTO_PRUNE_ENABLED) {
        pruneOldEntries();
      }
      
      renderHistory();
    }

    // ØªØ§Ø¨Ø¹ Ø­Ø°Ù Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒÙ‡Ø§ - ÙÙ‚Ø· Ø§Ú¯Ø± ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    function pruneOldEntries(){
      if (!AUTO_PRUNE_ENABLED) return;
      
      const entries = storageGet('entries')||[];
      const cutoff = Date.now() - (MAX_DAYS * 24 * 60 * 60 * 1000);
      const kept = entries.filter(e => new Date(e.dateISO).getTime() >= cutoff);
      if(kept.length !== entries.length) storageSet('entries', kept);
    }

    /* ---------- calculate logic ---------- */
    if(calculateButton) calculateButton.addEventListener('click', ()=>{
      if(!inputY1 || !inputY2){ if(errorMessage) errorMessage.textContent = 'Ø®Ø·Ø§: Ø¨Ø±Ø®ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³ØªÙ†Ø¯.'; return; }
      if(errorMessage) errorMessage.textContent = '';
      try{
        const parsedY1 = parseNumberInput(inputY1.value);
        const parsedY2 = parseNumberInput(inputY2.value);
        const y1 = parsedY1.value;
        const y2 = parsedY2.value;
        
        if(isNaN(y1) || isNaN(y2)) throw new Error('Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ø¨Ø§ Ø§Ø¹Ø¯Ø§Ø¯ Ù…Ø¹ØªØ¨Ø± Ù¾Ø± Ú©Ù†ÛŒØ¯.');
        if(y1 < 0 || y2 < 0) throw new Error('Ù„Ø·ÙØ§Ù‹ ÙÙ‚Ø· Ø§Ø¹Ø¯Ø§Ø¯ Ù…Ø«Ø¨Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');

        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†ØªØ§ÛŒØ¬ Ø¨Ø§ ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ø¯ 02
        const results1 = calculateForOneInput(inputY1.value, resultsList1);
        const results2 = calculateForOneInput(inputY2.value, resultsList2);

        // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ø²ÙˆØ¬
        const closest = findClosestPairAcrossSets(results1, results2);
        renderResultsDisplay(results1, results2, closest);

        // ØªØ¹ÛŒÛŒÙ† ØªØ§Ø±ÛŒØ® - Ø°Ø®ÛŒØ±Ù‡ Ø­ØªÛŒ Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ
        let chosenISO = null;
        if(datePicker && datePicker.value){
          const dp = datePicker.value; // YYYY-MM-DD
          const now = new Date();
          const timePart = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
          const iso = new Date(dp + 'T' + timePart);
          if(!isNaN(iso)) chosenISO = iso.toISOString();
        }
        if(!chosenISO) chosenISO = nowISO();

        const pairId = pairSelect ? pairSelect.value || null : null;
        const note = noteInput ? noteInput.value || '' : '';
        
        // Ø§Ø±Ø³Ø§Ù„ ÙˆØ±ÙˆØ¯ÛŒ Ø§ØµÙ„ÛŒ Ø¨Ù‡ ØªØ§Ø¨Ø¹ saveEntry
        saveEntry(pairId, {
          y1, 
          y2,
          originalY1: parsedY1.original,
          originalY2: parsedY2.original
        }, results1, results2, closest, note, chosenISO);

      }catch(err){ if(errorMessage) errorMessage.textContent = 'Ø®Ø·Ø§: '+err.message; }
    });

    if(resetButton) resetButton.addEventListener('click', ()=>{
      if(inputY1) inputY1.value=''; 
      if(inputY2) inputY2.value=''; 
      if(noteInput) noteInput.value=''; 
      if(datePicker) datePicker.value=''; 
      if(resultsList1) resultsList1.innerHTML=''; 
      if(resultsList2) resultsList2.innerHTML=''; 
      if(analysisResult) analysisResult.innerHTML=''; 
      if(errorMessage) errorMessage.textContent=''; 
      if(voiceStatus) voiceStatus.textContent='';
    });

    /* ---------- ØªØ§Ø¨Ø¹ Ú©Ù¾ÛŒ Ø¨Ù‡ Ú©Ù„ÛŒÙ¾â€ŒØ¨ÙˆØ±Ø¯ ---------- */
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showCopySuccess(text);
      }).catch(err => {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù†: ', err);
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showCopySuccess(text);
      });
    }

    // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª Ú©Ù¾ÛŒ
    function showCopySuccess(text) {
      const message = document.createElement('div');
      message.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-bounce';
      message.innerHTML = `âœ… Ø¹Ø¯Ø¯ <strong>${text}</strong> Ú©Ù¾ÛŒ Ø´Ø¯`;
      
      document.body.appendChild(message);
      
      setTimeout(() => {
        if (document.body.contains(message)) {
          document.body.removeChild(message);
        }
      }, 2000);
    }

    /* ---------- Ù…Ø¯ÛŒØ±ÛŒØª ØªØ§Ø±ÛŒØ® Ú†Ù†Ø¯Ú¯Ø§Ù†Ù‡ ---------- */
    let dateRanges = [];

    // ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø­Ø§Ù„Øª Ú†Ù†Ø¯ØªØ§Ø±ÛŒØ®ÛŒ
    function toggleMultiDateMode() {
      const isMultiDateActive = multiDateSection.classList.contains('hidden');
      
      if (isMultiDateActive) {
        // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø­Ø§Ù„Øª Ú†Ù†Ø¯ØªØ§Ø±ÛŒØ®ÛŒ
        singleDateSection.classList.add('hidden');
        multiDateSection.classList.remove('hidden');
        toggleMultiDateBtn.textContent = 'Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø­Ø§Ù„Øª Ø¹Ø§Ø¯ÛŒ';
        toggleMultiDateBtn.classList.remove('bg-blue-600');
        toggleMultiDateBtn.classList.add('bg-gray-600');
        
        // Ø§Ú¯Ø± ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ Ø®Ø§Ù„ÛŒ Ù‡Ø³ØªÙ†Ø¯ØŒ ÛŒÚ© ØªØ§Ø±ÛŒØ® Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
        if (dateRanges.length === 0) {
          addDateRange();
        }
      } else {
        // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø­Ø§Ù„Øª Ú†Ù†Ø¯ØªØ§Ø±ÛŒØ®ÛŒ
        singleDateSection.classList.remove('hidden');
        multiDateSection.classList.add('hidden');
        toggleMultiDateBtn.textContent = 'ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø­Ø§Ù„Øª Ú†Ù†Ø¯ØªØ§Ø±ÛŒØ®ÛŒ';
        toggleMultiDateBtn.classList.remove('bg-gray-600');
        toggleMultiDateBtn.classList.add('bg-blue-600');
        
        // Ø±Ù†Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø§ ØªØ§Ø±ÛŒØ® Ø¹Ø§Ø¯ÛŒ
        renderHistory();
      }
    }

    // ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯ ØªØ§Ø±ÛŒØ® Ø¬Ø¯ÛŒØ¯
    function addDateRange() {
      const dateId = uid();
      dateRanges.push({
        id: dateId,
        date: ''
      });
      
      renderDateRanges();
    }

    // ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: Ø±Ù†Ø¯Ø± ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ ØªØ§Ø±ÛŒØ®
    function renderDateRanges() {
      if (!dateRangesContainer) return;
      
      dateRangesContainer.innerHTML = '';
      
      dateRanges.forEach((range, index) => {
        const dateItem = document.createElement('div');
        dateItem.className = 'date-range-item';
        dateItem.innerHTML = `
          <div class="flex items-center gap-2">
            <label class="text-xs muted flex-1">ØªØ§Ø±ÛŒØ® ${index + 1}:</label>
            <button onclick="removeDateRange('${range.id}')" class="small-btn bg-rose-600 hover:bg-rose-700 text-xs" title="Ø­Ø°Ù Ø§ÛŒÙ† ØªØ§Ø±ÛŒØ®">
              ğŸ—‘
            </button>
          </div>
          <input type="date" 
                 class="w-full mt-1" 
                 value="${range.date}"
                 onchange="updateDateRange('${range.id}', this.value)">
        `;
        dateRangesContainer.appendChild(dateItem);
      });
    }

    // ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ§Ø±ÛŒØ®
    function updateDateRange(dateId, newDate) {
      const range = dateRanges.find(r => r.id === dateId);
      if (range) {
        range.date = newDate;
      }
    }

    // ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: Ø­Ø°Ù ØªØ§Ø±ÛŒØ®
    function removeDateRange(dateId) {
      dateRanges = dateRanges.filter(r => r.id !== dateId);
      renderDateRanges();
    }

    // ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ú†Ù†Ø¯Ú¯Ø§Ù†Ù‡
    function applyMultiDateFilter() {
      const selectedPair = multiDatePairFilter ? multiDatePairFilter.value : null;
      const selectedDates = dateRanges.filter(r => r.date).map(r => r.date);
      
      if (selectedDates.length === 0) {
        alert('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© ØªØ§Ø±ÛŒØ® Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
        return;
      }
      
      renderMultiDateHistory(selectedPair, selectedDates);
    }

    // ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: Ø±Ù†Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø§ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ú†Ù†Ø¯Ú¯Ø§Ù†Ù‡
    function renderMultiDateHistory(pairFilter = null, dates = []) {
      const entries = (storageGet('entries')||[]).slice();
      entries.sort((a,b)=> new Date(b.dateISO).getTime() - new Date(a.dateISO).getTime());
      
      if(historyList) historyList.innerHTML = '';
      
      // ÙÛŒÙ„ØªØ± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¬ÙØª Ø§Ø±Ø²
      let filtered = entries;
      if(pairFilter){
        filtered = filtered.filter(e => e.pairId === pairFilter);
      }
      
      // ÙÛŒÙ„ØªØ± Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
      const dateFiltered = filtered.filter(e => {
        const entryDate = e.dateISO.split('T')[0];
        return dates.includes(entryDate);
      });
      
      if(dateFiltered.length === 0){ 
        if(historyList) historyList.innerHTML = '<div class="muted text-sm text-center py-4">Ø±Ú©ÙˆØ±Ø¯ÛŒ Ø¬Ù‡Øª Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div>'; 
        return; 
      }
      
      // Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¬ÙØª Ø§Ø±Ø²
      const groupedByPair = {};
      dateFiltered.forEach(e => {
        const pairId = e.pairId || 'unknown';
        if (!groupedByPair[pairId]) {
          groupedByPair[pairId] = [];
        }
        groupedByPair[pairId].push(e);
      });
      
      // Ø±Ù†Ø¯Ø± Ù‡Ø± Ú¯Ø±ÙˆÙ‡
      Object.keys(groupedByPair).forEach(pairId => {
        const pairEntries = groupedByPair[pairId];
        const pair = (storageGet('pairs')||[]).find(p=>p.id===pairId);
        const pairName = pair?.name || 'â€”';
        const category = pair ? (storageGet('categories')||[]).find(c=>c.id===pair.categoryId) : null;
        
        const groupWrapper = document.createElement('div');
        groupWrapper.className = 'comparison-group';
        groupWrapper.innerHTML = `
          <div class="date-comparison-header flex items-center justify-between">
            <div class="flex items-center gap-2">
              <div class="text-sm font-semibold">${pairName}</div>
              ${category ? `<span class="text-xs bg-blue-600 px-2 py-1 rounded">${category.name}</span>` : ''}
            </div>
            <div class="text-xs muted">${pairEntries.length} Ø±Ú©ÙˆØ±Ø¯ Ø¯Ø± ${dates.length} ØªØ§Ø±ÛŒØ®</div>
          </div>
        `;
        
        // Ø±Ù†Ø¯Ø± Ù‡Ø± Ø±Ú©ÙˆØ±Ø¯ Ø¯Ø± Ø§ÛŒÙ† Ú¯Ø±ÙˆÙ‡
        pairEntries.forEach(e => {
          const wrapper = document.createElement('div'); 
          wrapper.className = 'history-entry-compact flex flex-col gap-3 hover:border-white/20 transition-colors mt-2';
          
          // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ Ø¨Ø®Ø´ Û± Ùˆ Û² Ø¨Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ù…Ù„ - Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ÙØ±Ù…Øª Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ±ÙˆØ¯ÛŒ Ø§ØµÙ„ÛŒ
          const results1Html = e.results1 && Array.isArray(e.results1) && e.results1.length ? e.results1.map((val, idx) => {
            const displayValue = e.inputFormats && e.inputFormats.y1 && e.inputFormats.y1.includes('.') ? formatWithDots(val) : val.toString();
            return `<span class="box-out box-gray cursor-pointer hover:opacity-80 transition-opacity" 
                   title="Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ: ${displayValue}"
                   onclick="copyToClipboard('${displayValue}')">
              <span class="num-label">${idx + 1}.</span> ${displayValue}
            </span>`;
          }).join('') : '<span class="text-xs muted">Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¯Ù‡</span>';
          
          const results2Html = e.results2 && Array.isArray(e.results2) && e.results2.length ? e.results2.map((val, idx) => {
            const displayValue = e.inputFormats && e.inputFormats.y2 && e.inputFormats.y2.includes('.') ? formatWithDots(val) : val.toString();
            return `<span class="box-out box-gray cursor-pointer hover:opacity-80 transition-opacity" 
                   title="Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ: ${displayValue}"
                   onclick="copyToClipboard('${displayValue}')">
              <span class="num-label">${idx + 1}.</span> ${displayValue}
            </span>`;
          }).join('') : '<span class="text-xs muted">Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¯Ù‡</span>';
          
          // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ù…Ù„ closest Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§
          let closestHtml = '';
          if (e.closest && e.closest.pair && Array.isArray(e.closest.pair) && e.closest.pair.length === 2 &&
              e.closest.indexes && Array.isArray(e.closest.indexes) && e.closest.indexes.length === 2) {
            closestHtml = `
            <div class="bg-white/5 p-2 rounded text-center">
              <div class="text-xs muted">Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ø²ÙˆØ¬</div>
              <div class="text-sm font-semibold">${e.closest.pair[0]} Ùˆ ${e.closest.pair[1]}</div>
              <div class="text-xs muted">Ø§Ø®ØªÙ„Ø§Ù: ${e.closest.difference}</div>
              <div class="text-xs font-semibold text-yellow-400 mt-1">Ø´Ù…Ø§Ø±Ù‡ Ù†ØªØ§ÛŒØ¬: ${e.closest.indexes[0]}/${e.closest.indexes[1]}</div>
            </div>
            `;
          }
          
          wrapper.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="text-xs muted">${e.dateDisplay}</div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <div class="text-xs muted mb-1">Ø¨Ø®Ø´ Û±</div>
                <div class="flex flex-col gap-1">${results1Html}</div>
              </div>
              <div>
                <div class="text-xs muted mb-1">Ø¨Ø®Ø´ Û²</div>
                <div class="flex flex-col gap-1">${results2Html}</div>
              </div>
            </div>
            ${closestHtml}
          `;
          
          const bottom = document.createElement('div'); 
          bottom.className = 'flex gap-2 justify-end';
          const viewBtn = document.createElement('button'); 
          viewBtn.className = 'small-btn bg-indigo-600 hover:bg-indigo-700 rounded transition-colors text-xs'; 
          viewBtn.textContent = 'Ø¬Ø²Ø¦ÛŒØ§Øª'; 
          viewBtn.addEventListener('click', ()=> showDetail(e.id));
          bottom.appendChild(viewBtn);
          wrapper.appendChild(bottom);
          
          groupWrapper.appendChild(wrapper);
        });
        
        historyList.appendChild(groupWrapper);
      });
    }

    /* ---------- history rendering & actions ---------- */
    function renderHistory(){
      // Ø§Ú¯Ø± Ø­Ø§Ù„Øª Ú†Ù†Ø¯ØªØ§Ø±ÛŒØ®ÛŒ ÙØ¹Ø§Ù„ Ø§Ø³ØªØŒ Ø§Ø² ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
      if (multiDateSection && !multiDateSection.classList.contains('hidden')) {
        const selectedPair = multiDatePairFilter ? multiDatePairFilter.value : null;
        const selectedDates = dateRanges.filter(r => r.date).map(r => r.date);
        
        if (selectedDates.length > 0) {
          renderMultiDateHistory(selectedPair, selectedDates);
          return;
        }
      }
      
      // Ø­Ø§Ù„Øª Ø¹Ø§Ø¯ÛŒ - ÛŒÚ© ØªØ§Ø±ÛŒØ®
      const entries = (storageGet('entries')||[]).slice();
      entries.sort((a,b)=> new Date(b.dateISO).getTime() - new Date(a.dateISO).getTime());
      if(entriesCount) entriesCount.textContent = entries.length;
      const filterDate = historyDate && historyDate.value ? new Date(historyDate.value).toDateString() : null;
      const filterPair = historyPairFilter && historyPairFilter.value ? historyPairFilter.value : null;
      if(historyList) historyList.innerHTML = '';

      let filtered = entries;
      if(!filterDate){
        const today = new Date().toDateString();
        filtered = entries.filter(e => new Date(e.dateISO).toDateString() === today);
      } else {
        filtered = entries.filter(e => new Date(e.dateISO).toDateString() === filterDate);
      }

      if(filterPair){
        filtered = filtered.filter(e => e.pairId === filterPair);
      }

      if(filtered.length === 0){ 
        if(historyList) historyList.innerHTML = '<div class="muted text-sm text-center py-4">Ø±Ú©ÙˆØ±Ø¯ÛŒ Ø¬Ù‡Øª Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div>'; 
        return; 
      }

      safeForEach(filtered, e=>{
        const pair = (storageGet('pairs')||[]).find(p=>p.id===e.pairId);
        const pairName = pair?.name || 'â€”';
        const category = pair ? (storageGet('categories')||[]).find(c=>c.id===pair.categoryId) : null;
        
        const wrapper = document.createElement('div'); 
        wrapper.className = 'history-entry-compact flex flex-col gap-3 hover:border-white/20 transition-colors';
        
        // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ Ø¨Ø®Ø´ Û± Ùˆ Û² Ø¨Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ù…Ù„ - Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ÙØ±Ù…Øª Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ±ÙˆØ¯ÛŒ Ø§ØµÙ„ÛŒ
        const results1Html = e.results1 && Array.isArray(e.results1) && e.results1.length ? e.results1.map((val, idx) => {
          const displayValue = e.inputFormats && e.inputFormats.y1 && e.inputFormats.y1.includes('.') ? formatWithDots(val) : val.toString();
          return `<span class="box-out box-gray cursor-pointer hover:opacity-80 transition-opacity" 
                 title="Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ: ${displayValue}"
                 onclick="copyToClipboard('${displayValue}')">
            <span class="num-label">${idx + 1}.</span> ${displayValue}
          </span>`;
        }).join('') : '<span class="text-xs muted">Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¯Ù‡</span>';
        
        const results2Html = e.results2 && Array.isArray(e.results2) && e.results2.length ? e.results2.map((val, idx) => {
          const displayValue = e.inputFormats && e.inputFormats.y2 && e.inputFormats.y2.includes('.') ? formatWithDots(val) : val.toString();
          return `<span class="box-out box-gray cursor-pointer hover:opacity-80 transition-opacity" 
                 title="Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ: ${displayValue}"
                 onclick="copyToClipboard('${displayValue}')">
            <span class="num-label">${idx + 1}.</span> ${displayValue}
          </span>`;
        }).join('') : '<span class="text-xs muted">Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¯Ù‡</span>';
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ù…Ù„ closest Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§
        let closestHtml = '';
        if (e.closest && e.closest.pair && Array.isArray(e.closest.pair) && e.closest.pair.length === 2 &&
            e.closest.indexes && Array.isArray(e.closest.indexes) && e.closest.indexes.length === 2) {
          closestHtml = `
          <div class="bg-white/5 p-2 rounded text-center">
            <div class="text-xs muted">Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ø²ÙˆØ¬</div>
            <div class="text-sm font-semibold">${e.closest.pair[0]} Ùˆ ${e.closest.pair[1]}</div>
            <div class="text-xs muted">Ø§Ø®ØªÙ„Ø§Ù: ${e.closest.difference}</div>
            <div class="text-xs font-semibold text-yellow-400 mt-1">Ø´Ù…Ø§Ø±Ù‡ Ù†ØªØ§ÛŒØ¬: ${e.closest.indexes[0]}/${e.closest.indexes[1]}</div>
          </div>
          `;
        }
        
        wrapper.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <div class="text-sm font-semibold">${pairName}</div>
              ${category ? `<span class="text-xs bg-blue-600 px-2 py-1 rounded">${category.name}</span>` : ''}
              ${!pair ? `<span class="deleted-pair">Ø­Ø°Ù Ø´Ø¯Ù‡</span>` : ''}
            </div>
            <div class="text-xs muted">${e.dateDisplay}</div>
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="text-xs muted mb-1">Ø¨Ø®Ø´ Û±</div>
              <div class="flex flex-col gap-1">${results1Html}</div>
            </div>
            <div>
              <div class="text-xs muted mb-1">Ø¨Ø®Ø´ Û²</div>
              <div class="flex flex-col gap-1">${results2Html}</div>
            </div>
          </div>
          
          ${closestHtml}
        `;
        
        const bottom = document.createElement('div'); 
        bottom.className = 'flex gap-2 justify-end';
        const viewBtn = document.createElement('button'); 
        viewBtn.className = 'small-btn bg-indigo-600 hover:bg-indigo-700 rounded transition-colors'; 
        viewBtn.textContent = 'Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª'; 
        viewBtn.addEventListener('click', ()=> showDetail(e.id));
        bottom.appendChild(viewBtn);
        wrapper.appendChild(bottom);
        historyList.appendChild(wrapper);
      });
    }

    function showDetail(entryId){
      const entries = storageGet('entries')||[]; 
      const e = entries.find(x=>x.id===entryId); 
      if(!e) return;
      
      const pair = (storageGet('pairs')||[]).find(p=>p.id===e.pairId);
      const pairName = pair?.name || 'â€”';
      const category = pair ? (storageGet('categories')||[]).find(c=>c.id===pair.categoryId) : null;
      
      if(detailContent) detailContent.innerHTML = '';
      
      // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ù…Ù„ closest Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª
      let closestHtml = '';
      if (e.closest && e.closest.pair && Array.isArray(e.closest.pair) && e.closest.pair.length === 2 &&
          e.closest.indexes && Array.isArray(e.closest.indexes) && e.closest.indexes.length === 2) {
        closestHtml = `
        <div class="bg-white/5 p-4 rounded">
          <div class="text-xs muted mb-3">ØªØ­Ù„ÛŒÙ„ Ù†Ù‡Ø§ÛŒÛŒ</div>
          <div class="text-center space-y-2">
            <div class="text-sm font-semibold">Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ø²ÙˆØ¬: ${e.closest.pair[0]} Ùˆ ${e.closest.pair[1]}</div>
            <div class="text-xs muted">Ø§Ø®ØªÙ„Ø§Ù: ${e.closest.difference}</div>
            <div class="text-sm font-semibold text-yellow-400">Ø´Ù…Ø§Ø±Ù‡ Ù†ØªØ§ÛŒØ¬ Ù†Ø²Ø¯ÛŒÚ©: ${e.closest.indexes[0]}/${e.closest.indexes[1]}</div>
            <div class="text-xs muted">(Ø¹Ø¯Ø¯ ${e.closest.indexes[0]} Ø¨Ø®Ø´ Û± Ø¨Ø§ Ø¹Ø¯Ø¯ ${e.closest.indexes[1]} Ø¨Ø®Ø´ Û²)</div>
          </div>
        </div>
        `;
      }
      
      detailContent.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-3">
            <div class="bg-white/5 p-3 rounded">
              <div class="text-xs muted mb-1">Ø¬ÙØªâ€ŒØ§Ø±Ø²</div>
              <div class="font-semibold flex items-center gap-2">
                ${pairName}
                ${category ? `<span class="text-xs bg-blue-600 px-2 py-1 rounded">${category.name}</span>` : ''}
                ${!pair ? `<span class="deleted-pair">Ø­Ø°Ù Ø´Ø¯Ù‡</span>` : ''}
              </div>
            </div>
            <div class="bg-white/5 p-3 rounded">
              <div class="text-xs muted mb-1">ØªØ§Ø±ÛŒØ® (Ù…ÛŒÙ„Ø§Ø¯ÛŒ)</div>
              <div class="font-semibold">${e.dateDisplay}</div>
            </div>
          </div>
          
          <div class="space-y-3">
            <div class="bg-white/5 p-3 rounded">
              <div class="text-xs muted mb-1">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</div>
              <div class="font-semibold">${e.note||'---'}</div>
            </div>
          </div>
        </div>
        
        <div class="bg-white/5 p-4 rounded">
          <div class="text-xs muted mb-3">ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§</div>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div>Ø¹Ø¯Ø¯ Ø¨Ø®Ø´ Û±: <span class="font-mono">${e.inputFormats?.y1 || e.inputs?.y1 || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</span></div>
            <div>Ø¹Ø¯Ø¯ Ø¨Ø®Ø´ Û²: <span class="font-mono">${e.inputFormats?.y2 || e.inputs?.y2 || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</span></div>
          </div>
        </div>
        
        <div class="bg-white/5 p-4 rounded">
          <div class="text-xs muted mb-3">Ù†ØªØ§ÛŒØ¬ Ø¨Ø®Ø´ Û±</div>
          <div class="flex flex-wrap gap-2 justify-center">
            ${e.results1 && Array.isArray(e.results1) && e.results1.length ? e.results1.map((val, idx) => {
              const displayValue = e.inputFormats && e.inputFormats.y1 && e.inputFormats.y1.includes('.') ? formatWithDots(val) : val.toString();
              return `<span class="box-out box-gray cursor-default text-sm">
                <span class="num-label">${idx + 1}.</span> ${displayValue}
              </span>`;
            }).join('') : '<span class="text-xs muted">Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¯Ù‡</span>'}
          </div>
        </div>
        
        <div class="bg-white/5 p-4 rounded">
          <div class="text-xs muted mb-3">Ù†ØªØ§ÛŒØ¬ Ø¨Ø®Ø´ Û²</div>
          <div class="flex flex-wrap gap-2 justify-center">
            ${e.results2 && Array.isArray(e.results2) && e.results2.length ? e.results2.map((val, idx) => {
              const displayValue = e.inputFormats && e.inputFormats.y2 && e.inputFormats.y2.includes('.') ? formatWithDots(val) : val.toString();
              return `<span class="box-out box-gray cursor-default text-sm">
                <span class="num-label">${idx + 1}.</span> ${displayValue}
              </span>`;
            }).join('') : '<span class="text-xs muted">Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¯Ù‡</span>'}
          </div>
        </div>
        
        ${closestHtml}
      `;

      if(detailModal) {
        detailModal.classList.remove('hidden');
        detailModal.classList.add('center-modal');
      }

      if(editRecordBtn) editRecordBtn.onclick = ()=> editRecord(e.id);
      if(deleteRecordBtn) deleteRecordBtn.onclick = ()=> deleteRecord(e.id);
      if(moveRecordBtn) moveRecordBtn.onclick = ()=> moveRecord(e.id);
    }

    if(closeDetail) closeDetail.addEventListener('click', ()=> { 
      if(detailModal) {
        detailModal.classList.add('hidden');
        detailModal.classList.remove('center-modal');
      }
    });

    function deleteRecord(id){ 
      if(!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return; 
      const entries = storageGet('entries')||[]; 
      const idx = entries.findIndex(x=>x.id===id); 
      if(idx===-1) return; 
      entries.splice(idx,1); 
      storageSet('entries',entries); 
      renderHistory(); 
      if(detailModal) {
        detailModal.classList.add('hidden');
        detailModal.classList.remove('center-modal');
      }
    }

    function editRecord(id){
      const entries = storageGet('entries')||[]; const e = entries.find(x=>x.id===id); if(!e) return;
      if(!confirm('Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ú©ÙˆØ±Ø¯ Ø¯Ø± ÙØ±Ù… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯. Ù¾Ø³ Ø§Ø² ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡Ù” Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯ ØªØ§ Ø±Ú©ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆØ¯. Ø±Ú©ÙˆØ±Ø¯ Ù‚Ø¯ÛŒÙ…ÛŒ Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØ¯ØŸ')) return;
      if(pairSelect) pairSelect.value = e.pairId || '';
      if(inputY1 && e.inputFormats) inputY1.value = e.inputFormats.y1 || e.inputs.y1; 
      if(inputY2 && e.inputFormats) inputY2.value = e.inputFormats.y2 || e.inputs.y2; 
      if(noteInput) noteInput.value = e.note||''; 
      if(datePicker) datePicker.value = e.dateDisplay.split(' ')[0] || '';
      
      // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ Ù‚Ø¨Ù„ÛŒ
      if(e.inputs){
        calculateForOneInput(e.inputFormats?.y1 || e.inputs.y1.toString(), resultsList1);
        calculateForOneInput(e.inputFormats?.y2 || e.inputs.y2.toString(), resultsList2);
        
        const closest = findClosestPairAcrossSets(e.results1, e.results2);
        renderResultsDisplay(e.results1, e.results2, closest);
      }
      
      const idx = entries.findIndex(x=>x.id===id); 
      if(idx!==-1){ 
        entries.splice(idx,1); 
        storageSet('entries',entries); 
      }
      
      renderHistory(); 
      if(detailModal) {
        detailModal.classList.add('hidden');
        detailModal.classList.remove('center-modal');
      }
      window.scrollTo({top:0, behavior:'smooth'});
    }

    function moveRecord(id){
      const newDate = prompt('ØªØ§Ø±ÛŒØ® Ø¬Ø¯ÛŒØ¯ (YYYY-MM-DD) Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:'); if(!newDate) return;
      const d = new Date(newDate + 'T00:00:00'); if(isNaN(d)){ alert('ØªØ§Ø±ÛŒØ® Ù†Ø§Ù…Ø¹ØªØ¨Ø±.'); return; }
      const entries = storageGet('entries')||[]; const e = entries.find(x=>x.id===id); if(!e) return;
      e.dateISO = d.toISOString(); e.dateDisplay = formatGregorian(e.dateISO); storageSet('entries',entries); renderHistory(); 
      if(detailModal) {
        detailModal.classList.add('hidden');
        detailModal.classList.remove('center-modal');
      }
    }

    /* ---------- backup/import/prune ---------- */
    if(exportBtn) exportBtn.addEventListener('click', ()=>{
      const payload = { 
        pairs: storageGet('pairs')||[], 
        entries: storageGet('entries')||[], 
        categories: storageGet('categories')||[],
        meta: {
          created: new Date().toISOString(),
          version: '2.0',
          entryCount: (storageGet('entries')||[]).length,
          pairCount: (storageGet('pairs')||[]).length,
          categoryCount: (storageGet('categories')||[]).length,
          backupId: uid(),
          pairInfo: (storageGet('pairs')||[]).map(p => ({
            id: p.id,
            name: p.name,
            categoryId: p.categoryId
          }))
        }
      };
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json;charset=utf-8'});
      const url = URL.createObjectURL(blob); 
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = 'calc-pro-2-'+new Date().toISOString().slice(0,10)+'.json'; 
      document.body.appendChild(a); 
      a.click(); 
      a.remove(); 
      URL.revokeObjectURL(url);
    });

    if(importBtn) importBtn.addEventListener('click', ()=> {
      if(importFile) importFile.click();
    });

    // ØªØ§Ø¨Ø¹ import Ú©Ø§Ù…Ù„Ø§Ù‹ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø­Ù„ Ù…Ø´Ú©Ù„
    if(importFile) importFile.addEventListener('change', (e)=>{ 
      const f = e.target.files[0]; 
      if(!f) return; 
      const reader = new FileReader(); 
      reader.onload = ()=>{ 
        try{ 
          const obj = JSON.parse(reader.result); 
          if(!obj) throw new Error('ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø±');
          
          // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²
          const currentData = {
            pairs: storageGet('pairs') || [],
            entries: storageGet('entries') || [],
            categories: storageGet('categories') || []
          };
          
          try {
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² ÙØ±Ù…Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
            let pairs = [], entries = [], categories = [];
            
            if(obj.data) {
              // ÙØ±Ù…Øª Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ø¢Ù…Ø§Ø±
              pairs = obj.data.pairs || [];
              entries = obj.data.entries || [];
              categories = obj.data.categories || [];
            } else {
              // ÙØ±Ù…Øª Ù‚Ø¯ÛŒÙ…ÛŒ
              pairs = obj.pairs || [];
              entries = obj.entries || [];
              categories = obj.categories || [];
            }
            
            // Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ú©Ø§Ù…Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (Ù†Ù‡ Ø§Ù„Ø­Ø§Ù‚)
            storageSet('pairs', pairs);
            storageSet('entries', entries);
            storageSet('categories', categories);
            
            renderPairs(); 
            renderHistory(); 
            
            // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù…Ù„ Ø¨Ú©â€ŒØ¢Ù¾
            let message = 'âœ… Ø¨Ú©â€ŒØ¢Ù¾ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯!\n\n';
            message += `ğŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ú©â€ŒØ¢Ù¾:\n`;
            message += `â€¢ ${entries.length} Ø±Ú©ÙˆØ±Ø¯ ØªØ§Ø±ÛŒØ®ÛŒ\n`;
            message += `â€¢ ${pairs.length} Ø¬ÙØªâ€ŒØ§Ø±Ø²\n`;
            message += `â€¢ ${categories.length} Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ\n\n`;
            
            // Ù†Ù…Ø§ÛŒØ´ Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯Ù‡
            if(pairs.length > 0) {
              message += `ğŸ“‹ Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯Ù‡:\n`;
              pairs.forEach((pair, index) => {
                const category = categories.find(c => c.id === pair.categoryId);
                message += `${index + 1}. ${pair.name}${category ? ` (${category.name})` : ''}\n`;
              });
            }
            
            alert(message);
            
          } catch (error) {
            // Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ØŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ø±Ùˆ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ú©Ù†
            storageSet('pairs', currentData.pairs);
            storageSet('entries', currentData.entries);
            storageSet('categories', currentData.categories);
            throw error;
          }
          
        } catch(err) { 
          alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„: ' + err.message); 
        } 
      }; 
      reader.readAsText(f); 
      importFile.value=''; 
    });

    // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±
    if(quickPrune) {
      quickPrune.style.display = 'none';
    }

    /* ---------- history panel toggle & section toggles ---------- */
    if(toggleHistoryBtn) toggleHistoryBtn.addEventListener('click', ()=>{
      if(historyPanel.classList.contains('hidden')){
        historyPanel.classList.remove('hidden'); 
        toggleHistoryBtn.textContent = 'Ø¨Ø³ØªÙ† Ø°Ø®ÛŒØ±Ù‡â€ŒÙ‡Ø§';
        const today = new Date().toISOString().split('T')[0];
        if(historyDate) historyDate.value = today;
        renderHistory();
      } else { 
        historyPanel.classList.add('hidden'); 
        toggleHistoryBtn.textContent = 'Ù†Ù…Ø§ÛŒØ´ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ‡Ø§'; 
      }
    });

    if(historyDate) historyDate.addEventListener('change', renderHistory);
    if(historyPairFilter) historyPairFilter.addEventListener('change', renderHistory);

    if(togglePairsHdr) togglePairsHdr.addEventListener('click', ()=> { boxPairs.classList.toggle('hidden'); });
    if(toggleCalcHdr) toggleCalcHdr.addEventListener('click', ()=> { boxCalc.classList.toggle('hidden'); });
    if(toggleHistoryHdr) toggleHistoryHdr.addEventListener('click', ()=> { boxHistory.classList.toggle('hidden'); });

    /* ---------- Ù…Ø¯ÛŒØ±ÛŒØª ØªØ§Ø±ÛŒØ® Ú†Ù†Ø¯Ú¯Ø§Ù†Ù‡ ---------- */
    if(toggleMultiDateBtn) {
      toggleMultiDateBtn.addEventListener('click', toggleMultiDateMode);
    }

    if(addDateBtn) {
      addDateBtn.addEventListener('click', addDateRange);
    }

    if(applyMultiDateBtn) {
      applyMultiDateBtn.addEventListener('click', applyMultiDateFilter);
    }

    if(multiDatePairFilter) {
      multiDatePairFilter.addEventListener('change', function() {
        if (!multiDateSection.classList.contains('hidden')) {
          const selectedDates = dateRanges.filter(r => r.date).map(r => r.date);
          if (selectedDates.length > 0) {
            applyMultiDateFilter();
          }
        }
      });
    }

    /* ---------- Speech recognition ---------- */
    let recognition = null;
    let isRecording = false;
    let isVoiceActive = false;
    let currentField = null;

    const numericFields = [inputY1, inputY2];

    function parseNumberFromTranscript(transcript){
      if(!transcript) return null;
      
      const persianDigits = {'Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9'};
      let normalized = transcript.replace(/[Û°-Û¹]/g, d => persianDigits[d]);
      
      normalized = normalized.replace(/[^\d.-]/g, '');
      
      const match = normalized.match(/-?\d*\.?\d+/);
      return match ? match[0] : null;
    }

    function startVoiceRecognition(){
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SpeechRecognition){ 
        if(voiceStatus) voiceStatus.textContent = 'Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² ØªØ´Ø®ÛŒØµ ØµÙˆØª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.';
        return; 
      }
      
      recognition = new SpeechRecognition();
      recognition.lang = 'fa-IR';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.continuous = false;

      recognition.onstart = () => {
        isRecording = true;
        if(microToggle) microToggle.classList.add('recording');
        if(voiceStatus && currentField) {
          const fieldName = getFieldName(currentField);
          voiceStatus.textContent = `ğŸ¤ Ø¯Ø± Ø­Ø§Ù„ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ø±Ø§ÛŒ ${fieldName}... Ø¹Ø¯Ø¯ Ø±Ø§ Ø¨Ú¯ÙˆÛŒÛŒØ¯`;
        }
      };
      
      recognition.onend = () => {
        isRecording = false;
        if(microToggle) microToggle.classList.remove('recording');
        
        if(isVoiceActive && currentField){
          setTimeout(() => {
            if(!isRecording && isVoiceActive) {
              startVoiceRecognition();
            }
          }, 300);
        }
      };
      
      recognition.onerror = (ev) => {
        isRecording = false;
        if(microToggle) microToggle.classList.remove('recording');
        
        if(isVoiceActive && currentField){
          setTimeout(() => {
            if(!isRecording && isVoiceActive) {
              startVoiceRecognition();
            }
          }, 1000);
        }
      };
      
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        const numStr = parseNumberFromTranscript(transcript);
        
        if(numStr && currentField){
          currentField.value = numStr;
          const fieldName = getFieldName(currentField);
          if(voiceStatus) voiceStatus.textContent = `âœ… Ø¹Ø¯Ø¯ "${numStr}" Ø¯Ø± ${fieldName} ÙˆØ§Ø±Ø¯ Ø´Ø¯`;
          
          const currentIndex = numericFields.indexOf(currentField);
          if(currentIndex < numericFields.length - 1){
            setTimeout(() => {
              numericFields[currentIndex + 1].focus();
            }, 500);
          }
        } else if(voiceStatus) {
          voiceStatus.textContent = 'âŒ Ø¹Ø¯Ø¯ ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.';
        }
      };
      
      try{
        recognition.start();
      }catch(e){
        console.log('Ø®Ø·Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹ Ø¶Ø¨Ø·:', e);
      }
    }

    function stopVoiceRecognition(){
      isVoiceActive = false;
      try{
        if(recognition) recognition.stop();
      }catch(e){}
      recognition = null;
      isRecording = false;
      if(microToggle) {
        microToggle.classList.remove('recording');
        microToggle.classList.remove('connected');
      }
      if(voiceStatus) voiceStatus.textContent = 'ğŸ”‡ Ø§ØªØµØ§Ù„ ØµÙˆØªÛŒ Ù‚Ø·Ø¹ Ø´Ø¯';
    }

    function getFieldName(field){
      const names = {
        [inputY1]: 'Ø¹Ø¯Ø¯ Ø¨Ø®Ø´ Û±',
        [inputY2]: 'Ø¹Ø¯Ø¯ Ø¨Ø®Ø´ Û²'
      };
      return names[field] || 'Ø§ÛŒÙ† ÙÛŒÙ„Ø¯';
    }

    safeForEach(numericFields, (field) => {
      if(!field) return;
      
      field.addEventListener('focus', () => {
        currentField = field;
        
        if(isVoiceActive && !isRecording){
          startVoiceRecognition();
        } else if(isVoiceActive) {
          const fieldName = getFieldName(field);
          if(voiceStatus) voiceStatus.textContent = `ğŸ¤ Ø¯Ø± Ø­Ø§Ù„ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ø±Ø§ÛŒ ${fieldName}... Ø¹Ø¯Ø¯ Ø±Ø§ Ø¨Ú¯ÙˆÛŒÛŒØ¯`;
        }
      });
    });

    if(microToggle){
      microToggle.addEventListener('click', ()=>{
        if(isVoiceActive){
          stopVoiceRecognition();
          microToggle.textContent = 'ğŸ¤ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† ØµÙˆØª';
          if(voiceStatus) voiceStatus.textContent = 'ğŸ”‡ Ø§ØªØµØ§Ù„ ØµÙˆØªÛŒ Ù‚Ø·Ø¹ Ø´Ø¯';
        } else {
          isVoiceActive = true;
          microToggle.textContent = 'ğŸ”‡ Ù‚Ø·Ø¹ ØµÙˆØª';
          microToggle.classList.add('connected');
          
          if(voiceStatus) voiceStatus.textContent = 'ğŸ¤ Ø§ØªØµØ§Ù„ ØµÙˆØªÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯. Ø±ÙˆÛŒ ÙÛŒÙ„Ø¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.';
          
          if(currentField){
            startVoiceRecognition();
          } else {
            const emptyField = numericFields.find(field => !field.value || field.value.trim() === '');
            if(emptyField){
              emptyField.focus();
            } else {
              numericFields[0].focus();
            }
          }
        }
      });
    }

    // ---------- Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listeners Ø¬Ø¯ÛŒØ¯ ----------

    // Ø¯Ú©Ù…Ù‡ Ø­Ø°Ù Ø¯Ø³ØªÛŒ
    if ($('manual_prune_btn')) {
      $('manual_prune_btn').addEventListener('click', function() {
        const days = parseInt($('manual_prune_days').value) || 365;
        if (days < 1) {
          alert('ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² Û° Ø¨Ø§Ø´Ø¯');
          return;
        }
        
        if (confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ± Ø§Ø² ${days} Ø±ÙˆØ² Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ\nØ§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.`)) {
          const deletedCount = manualPruneOldEntries(days);
          if (deletedCount > 0) {
            alert(`âœ… ${deletedCount} Ø±Ú©ÙˆØ±Ø¯ Ù‚Ø¯ÛŒÙ…ÛŒ Ø­Ø°Ù Ø´Ø¯.`);
          } else {
            alert('â„¹ï¸ Ù‡ÛŒÚ† Ø±Ú©ÙˆØ±Ø¯ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù ÛŒØ§ÙØª Ù†Ø´Ø¯.');
          }
        }
      });
    }

    // Ø¯Ú©Ù…Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø±
    if ($('show_stats_btn')) {
      $('show_stats_btn').addEventListener('click', showSystemStats);
    }

    // Ø¯Ú©Ù…Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ú©â€ŒØ¢Ù¾â€ŒÙ‡Ø§
    if ($('manage_backups_btn')) {
      $('manage_backups_btn').addEventListener('click', manageBackups);
    }

    // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ Ø¢Ù…Ø§Ø±
    if ($('close_stats')) {
      $('close_stats').addEventListener('click', function() {
        $('stats_modal').classList.add('hidden');
        $('stats_modal').classList.remove('center-modal');
      });
    }

    // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ Ø¨Ú©â€ŒØ¢Ù¾â€ŒÙ‡Ø§
    if ($('close_backups')) {
      $('close_backups').addEventListener('click', function() {
        $('backups_modal').classList.add('hidden');
        $('backups_modal').classList.remove('center-modal');
      });
    }

    // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø®Ø§Ø±Ø¬
    window.addEventListener('click', function(event) {
      if (event.target === $('stats_modal')) {
        $('stats_modal').classList.add('hidden');
        $('stats_modal').classList.remove('center-modal');
      }
      if (event.target === $('backups_modal')) {
        $('backups_modal').classList.add('hidden');
        $('backups_modal').classList.remove('center-modal');
      }
      if (event.target === $('detail_modal')) {
        $('detail_modal').classList.add('hidden');
        $('detail_modal').classList.remove('center-modal');
      }
    });

    // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ Ø¨Ø§ Ú©Ù„ÛŒØ¯ Escape
    window.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        if ($('stats_modal') && !$('stats_modal').classList.contains('hidden')) {
          $('stats_modal').classList.add('hidden');
          $('stats_modal').classList.remove('center-modal');
        }
        if ($('backups_modal') && !$('backups_modal').classList.contains('hidden')) {
          $('backups_modal').classList.add('hidden');
          $('backups_modal').classList.remove('center-modal');
        }
        if ($('detail_modal') && !$('detail_modal').classList.contains('hidden')) {
          $('detail_modal').classList.add('hidden');
          $('detail_modal').classList.remove('center-modal');
        }
      }
    });

    window.addEventListener('load', () => {
      setTimeout(() => {
        if(numericFields[0]){
          numericFields[0].focus();
        }
      }, 1000);
    });

    /* ---------- initial data ---------- */
    if((storageGet('pairs')||[]).length === 0){ 
      storageSet('pairs', [
        {id:uid(), name:'EURUSD', categoryId: 'forex'},
        {id:uid(), name:'GBPUSD', categoryId: 'forex'},
        {id:uid(), name:'BTCUSD', categoryId: 'crypto'},
        {id:uid(), name:'ETHUSD', categoryId: 'crypto'}
      ]); 
    }

    window.addEventListener('load', () => {
      const today = new Date().toISOString().split('T')[0];
      if(historyDate) historyDate.value = today;
    });

    renderPairs(); 
    renderHistory();

    // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³ÛŒØ³ØªÙ…
    setTimeout(() => {
      console.log('âœ… Ø³ÛŒØ³ØªÙ… Calculator PRO - Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÙˆÙ… Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª! ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„:');
      console.log('â€¢ Ø­Ø°Ù Ø®ÙˆØ¯Ú©Ø§Ø± 30 Ø±ÙˆØ²Ù‡: ØºÛŒØ±ÙØ¹Ø§Ù„');
      console.log('â€¢ Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ù…Ù„ ØªØ§Ø±ÛŒØ®Ú†Ù‡: ÙØ¹Ø§Ù„');
      console.log('â€¢ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªÛŒ Ø­Ø°Ù: ÙØ¹Ø§Ù„');
      console.log('â€¢ Ø¨Ú©â€ŒØ¢Ù¾ Ú©Ø§Ù…Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§: ÙØ¹Ø§Ù„');
      console.log('â€¢ Ù†Ù…Ø§ÛŒØ´ Ø§Ø¹Ø¯Ø§Ø¯ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ±ÙˆØ¯ÛŒ: ÙØ¹Ø§Ù„');
      console.log('â€¢ Ø¹Ø¯Ù… ØªØ¯Ø§Ø®Ù„ Ø¨Ø§ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§ÙˆÙ„: ÙØ¹Ø§Ù„');
      console.log('â€¢ Ø­Ø§Ù„Øª Ú†Ù†Ø¯ØªØ§Ø±ÛŒØ®ÛŒ: ÙØ¹Ø§Ù„');
    }, 1000);

  </script>
  
  <!-- Ø§ÛŒÙ† Ú©Ø¯ Ø±Ø§ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ bodyØŒ Ù‚Ø¨Ù„ Ø§Ø² Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† </body> Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯ -->

<div class="signature">
    Ø·Ø±Ø§Ø­ÛŒ Ùˆ Ø³Ø§Ø®Øª ØªÙˆØ³Ø· â¦™ Ø³Ø¹ÛŒØ¯ Ø´ÛŒØ® Ø§Ø­Ù…Ø¯ ØµÙØ§Ø±ÛŒ
</div>
  
  
</body>
</html>
