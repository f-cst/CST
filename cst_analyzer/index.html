<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CST Geometry Analyzer</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Ø§ÙØ²ÙˆØ¯Ù† ÙÙˆÙ†Øª ÙˆØ²ÛŒØ±Ù…ØªÙ† Ù…Ø´Ø§Ø¨Ù‡ Ú©Ø¯ Ø§ÙˆÙ„ -->
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
<style>
  :root {
    /* --- Ù¾Ø§Ù„Øª Ø±Ù†Ú¯ÛŒ Ø¬Ø¯ÛŒØ¯ --- */
    --bg-primary: #071020;       /* Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø§ØµÙ„ÛŒ */
    
    /* Ø±Ù†Ú¯ Ø²Ù…ÛŒÙ†Ù‡ Ù…Ø­ØªÙˆØ§ÛŒ Ø¨Ø§Ú©Ø³â€ŒÙ‡Ø§ */
    --bg-card: #0f172a;          
    
    /* Ø±Ù†Ú¯ Ø²Ù…ÛŒÙ†Ù‡ Ù‡Ø¯Ø±Ù‡Ø§ */
    --bg-header: #1e293b;        
    
    /* Ø±Ù†Ú¯ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ */
    --bg-input: #1e293b;

    --border-color: #334155;     
    --text-primary: #e6eef8;
    --text-secondary: #94a3b8;
    --accent-color: #0ea5a4;
    --danger-color: #ef4444;
    --success-color: #10b981;
  }
  
  * {
    box-sizing: border-box;
  }
  
  body {
    /* Ø§Ø¹Ù…Ø§Ù„ ÙÙˆÙ†Øª ÙˆØ²ÛŒØ±Ù…ØªÙ† Ø¨Ø±Ø§ÛŒ Ú©Ù„ ØµÙØ­Ù‡ */
    font-family: 'Vazirmatn', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    padding: 12px;
    margin: 0;
    line-height: 1.6; /* Ú©Ù…ÛŒ Ø§ÙØ²Ø§ÛŒØ´ Ø§Ø±ØªÙØ§Ø¹ Ø®Ø· Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø§ÛŒÛŒ Ø¨Ù‡ØªØ± */
    overscroll-behavior-y: none;
    font-size: 16px; /* Ø³Ø§ÛŒØ² Ù¾Ø§ÛŒÙ‡ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ */
  }
  
  .container {
    max-width: 1150px;
    margin: 0 auto;
    padding-bottom: 50px;
  }
  
  #sectionsContainer {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 20px;
  }
  
  .card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    margin-bottom: 0;
    overflow: hidden;
    cursor: default;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  
  .collapsible-card {
    max-height: 60px;
    overflow: hidden;
    transition: max-height 0.4s ease-out;
  }
  
  .collapsible-card.open {
    max-height: 9999px;
    transition: max-height 0.6s ease-in;
  }
  
  .collapsible-header {
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    background: var(--bg-header);
    border-bottom: 1px solid var(--border-color);
    transition: background-color 0.2s;
  }

  .collapsible-header:hover {
      filter: brightness(1.1);
  }
  
  .collapsible-header h3 {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 600; /* Ú©Ù…ÛŒ Ø¶Ø®ÛŒÙ…â€ŒØªØ± Ø¨Ø±Ø§ÛŒ ØªÛŒØªØ±Ù‡Ø§ */
    border-bottom: none;
    padding-bottom: 0;
    flex: 1;
  }
  
  .toggle-icon {
    font-size: 1.2rem;
    transition: transform 0.3s;
    color: var(--accent-color);
  }
  
  .collapsible-card.open .toggle-icon {
    transform: rotate(180deg);
  }
  
  .collapsible-content {
    padding: 0 16px 16px;
    overflow: visible;
    background: var(--bg-card);
  }
  
  h1, h2, h3 {
    margin-top: 0;
    color: var(--text-primary);
    font-family: 'Vazirmatn', sans-serif;
  }
  
  h1 {
    font-size: 1.5rem;
    text-align: center;
    margin-bottom: 20px;
    font-weight: 700;
  }
  
  h3 {
    font-size: 1.2rem;
    margin-bottom: 12px;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 8px;
  }
  
  label {
    display: block;
    margin-bottom: 6px;
    color: var(--text-secondary);
    font-size: 0.9rem;
    font-weight: 500;
  }
  
  input, select, textarea, button {
    font-family: 'Vazirmatn', sans-serif; /* Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ÙÙˆÙ†Øª Ø¯Ø± ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ */
    font-size: 1rem;
  }
  
  input, select, textarea {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid var(--border-color);
    background: var(--bg-input);
    color: var(--text-primary);
    margin-bottom: 8px;
  }
  
  .row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 10px;
  }
  
  .col {
    flex: 1;
    min-width: 0;
  }
  
  button {
    background: var(--accent-color);
    color: #021;
    padding: 10px 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
    margin-bottom: 8px;
    white-space: nowrap;
    width: auto;
    min-width: 120px;
    display: inline-block;
  }
  
  button:hover {
    opacity: 0.9;
    transform: translateY(-1px);
  }
  
  .btn-full { width: 100%; }
  .btn-danger { background: var(--danger-color); color: white; }
  .btn-success { background: var(--success-color); color: white; }
  .btn-small { padding: 8px 12px; font-size: 0.85rem; min-width: 100px; }
  .btn-auto { width: auto; }
  
  .btn-group {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 8px;
    font-size: 0.9rem; /* Ú©Ù…ÛŒ Ø¨Ø²Ø±Ú¯ØªØ± Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø§ÛŒÛŒ Ø¨Ù‡ØªØ± */
  }
  
  th, td {
    padding: 10px 8px;
    border-bottom: 1px solid var(--border-color);
    text-align: center;
    white-space: nowrap;
    user-select: text;
  }
  
  th {
    background: var(--bg-header);
    color: var(--text-secondary);
    font-weight: 600;
  }
  
  .small {
    font-size: 0.85rem;
    color: var(--text-secondary);
    line-height: 1.5;
  }
  
  .symbols-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
    min-height: 60px;
    padding: 12px;
    background: var(--bg-input);
    border-radius: 8px;
    border: 1px solid var(--border-color);
    align-items: flex-start;
  }
  
  .chip {
    display: inline-flex;
    padding: 10px 16px;
    border-radius: 8px;
    background: linear-gradient(135deg, #0f172a, #1e293b);
    color: #9ff;
    cursor: grab;
    margin: 4px;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    font-weight: 500;
    user-select: none;
    border: 1px solid #0ea5a4;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    position: relative;
    min-width: 80px;
    justify-content: center;
    align-items: center;
  }
  
  .chip:hover {
    background: linear-gradient(135deg, #0ea5a4, #0d9488);
    color: #021;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(14, 165, 164, 0.3);
  }
  
  .chip.dragging {
    opacity: 0.8;
    cursor: grabbing;
    transform: rotate(5deg) scale(1.05);
    z-index: 1000;
    box-shadow: 0 6px 12px rgba(14, 165, 164, 0.4);
  }
  
  .chip-placeholder {
    display: inline-block;
    padding: 10px 16px;
    margin: 4px;
    border: 2px dashed #0ea5a4;
    border-radius: 8px;
    opacity: 0.6;
    background: rgba(14, 165, 164, 0.1);
    min-width: 80px;
    height: 40px;
  }
  
  .chip-overlay {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--accent-color);
    color: #021;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: bold;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .chip:hover .chip-overlay { opacity: 1; }
  
  .controls { display: flex; gap: 8px; flex-wrap: wrap; }
  
  pre {
    background: #041219;
    padding: 8px;
    border-radius: 6px;
    color: var(--text-secondary);
    white-space: pre-wrap;
    font-size: 0.8rem;
    overflow-x: auto;
    font-family: 'Vazirmatn', monospace;
  }
  
  .icon-btn {
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    padding: 6px 8px;
    border-radius: 6px;
    cursor: pointer;
    width: auto;
    margin: 2px;
    font-size: 0.8rem;
    min-width: auto;
  }
  
  .action-col { white-space: nowrap; user-select: none; }
  .action-col button { width: auto; display: inline-block; margin: 0 2px; min-width: auto; }
  
  #alertModal, #statsModal, #editModal, #moveModal, #guideModal {
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: var(--bg-card);
    border: 2px solid #16424a;
    padding: 20px;
    border-radius: 10px;
    z-index: 10000;
    display: none;
    width: 90%;
    max-width: 420px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 25px rgba(0,0,0,0.5);
  }
  
  .modal-bg {
    position: fixed;
    left: 0; top: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 9998;
    display: none;
    backdrop-filter: blur(2px);
  }
  
  .date-range-toggle {
    background: #1e3a5f;
    color: var(--text-primary);
    border: 1px solid #234;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    width: auto;
    min-width: auto;
    font-family: 'Vazirmatn', sans-serif;
  }
  
  .date-range-toggle.active { background: var(--accent-color); color: #021; }
  
  .danger-zone {
    background: rgba(127, 29, 29, 0.2);
    border: 1px solid rgba(239,68,68,0.3);
    padding: 16px;
    border-radius: 8px;
    margin-top: 16px;
  }
  
  .text-center { text-align: center; }
  .mb-2 { margin-bottom: 8px; }
  .mt-2 { margin-top: 8px; }
  .w-full { width: 100%; }
  .flex { display: flex; }
  .flex-1 { flex: 1; }
  .items-center { align-items: center; }
  .gap-2 { gap: 8px; }
  .block { display: block; }
  .hidden { display: none; }
  .form-group { margin-bottom: 12px; }
  
  .chart-wrapper {
    position: relative;
    width: 100%;
    margin-top: 16px;
    background: var(--bg-input);
    border-radius: 8px;
    padding: 16px;
    border: 1px solid var(--border-color);
  }
  
  .chart-container {
    position: relative;
    width: 100%;
    height: 400px;
  }
  
  .bar-chart-isolated {
    position: relative;
    z-index: 100;
    pointer-events: auto;
  }
  
  .horizontal-line {
    position: absolute;
    border-top: 1px solid #9fb3c8;
    pointer-events: none;
    z-index: 101;
    width: 100%;
    left: 0;
  }
  
  .horizontal-line:hover { border-top-color: var(--accent-color); }
  
  .horizontal-line-wrapper {
    position: absolute;
    width: 100%;
    left: 0;
    height: 20px;
    cursor: ns-resize;
    z-index: 102;
    pointer-events: auto;
    background: transparent;
  }
  
  .horizontal-line-wrapper:hover { background: rgba(14, 165, 164, 0.05); }
  
  .line-guide {
    position: absolute;
    top: -25px;
    left: 10px;
    background: rgba(14, 165, 164, 0.9);
    color: #021;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 103;
    pointer-events: none;
    font-family: 'Vazirmatn', sans-serif;
  }
  
  .horizontal-line-wrapper:hover .line-guide { opacity: 1; }
  
  .collapsible-card { touch-action: auto; }
  .card[draggable="true"] .chart-wrapper .chart-container { pointer-events: auto; }

  .guide-icon {
    position: absolute !important;
    top: 1rem !important;
    right: 1rem !important;
    width: 2.125rem !important;
    height: 2.125rem !important;
    min-width: 2.125rem !important;
    max-width: 2.125rem !important;
    aspect-ratio: 1/1 !important;
    background: var(--accent-color) !important;
    color: #021 !important;
    font-size: 1.1rem !important;
    font-weight: bold !important;
    border-radius: 50% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    flex-shrink: 0 !important;
    flex-grow: 0 !important;
    flex-basis: auto !important;
    z-index: 9999 !important;
    cursor: pointer !important;
    border: none !important;
    padding: 0 !important;
    margin-bottom: 2.5rem !important;
  }
  
  .guide-icon:hover {
    transform: scale(1.10);
    background: #0d9488;
  }

  @media (max-width: 768px) {
    .guide-icon {
      width: 1.75rem !important;
      height: 1.75rem !important;
      min-width: 1.75rem !important;
      max-width: 1.75rem !important;
      font-size: 1rem !important;
      top: 0.75rem !important;
      right: 0.75rem !important;
      margin-bottom: 2rem !important;
    }
    .chart-wrapper .small {
      font-size: 0.75rem !important;
      line-height: 1.4 !important;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
      padding-right: 3rem !important;
    }
  }
  
  @media (max-width: 480px) {
    .guide-icon {
      width: 1.5rem !important;
      height: 1.5rem !important;
      min-width: 1.5rem !important;
      max-width: 1.5rem !important;
      font-size: 0.9rem !important;
      top: 0.5rem !important;
      right: 0.5rem !important;
      margin-bottom: 1.75rem !important;
    }
    .chart-wrapper .small {
      font-size: 0.7rem !important;
      padding-right: 2.5rem !important;
    }
  }

  @media (min-width: 1200px) {
    .guide-icon {
      width: 2.25rem !important;
      height: 2.25rem !important;
      min-width: 2.25rem !important;
      max-width: 2.25rem !important;
      font-size: 1.2rem !important;
      margin-bottom: 3rem !important;
    }
  }

  .chart-wrapper .small[style*="text-align: center"] {
    padding-right: 3rem !important;
    margin-bottom: 1rem !important;
    word-break: break-word !important;
    overflow-wrap: break-word !important;
  }
  
  @media (max-width: 768px) {
    body { padding: 8px; font-size: 15px; } /* Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª Ù…ÙˆØ¨Ø§ÛŒÙ„ */
    .card { margin-bottom: 0; }
    .collapsible-header { padding: 12px; }
    h1 { font-size: 1.3rem; }
    h3 { font-size: 1.1rem; }
    .row { flex-direction: column; gap: 8px; }
    .col { width: 100%; }
    button { padding: 12px; font-size: 1rem; width: 100%; min-width: auto; }
    .btn-group { flex-direction: column; }
    .btn-group button { width: 100%; }
    .chart-container { height: 300px; }
    .chart-wrapper { padding: 12px; }
    .symbols-grid { padding: 8px; gap: 6px; }
    .chip { padding: 8px 12px; font-size: 0.85rem; min-width: 70px; }
    table { font-size: 0.8rem; display: block; overflow-x: auto; white-space: nowrap; }
    th, td { padding: 8px 4px; }
    .icon-btn { padding: 4px 6px; font-size: 0.7rem; }
    input, select, textarea { padding: 12px; font-size: 1rem; }
    .collapsible-content { max-height: none !important; }
  }
  
  @media (max-width: 480px) {
    body { padding: 6px; font-size: 14px; } /* Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª Ù…ÙˆØ¨Ø§ÛŒÙ„ Ú©ÙˆÚ†Ú© */
    .card { margin-bottom: 0; }
    h1 { font-size: 1.2rem; }
    .chart-container { height: 250px; }
    .symbols-grid { padding: 6px; gap: 4px; }
    .chip { padding: 6px 10px; font-size: 0.8rem; min-width: 60px; }
    table { font-size: 0.75rem; }
    th, td { padding: 4px 2px; }
    .collapsible-content { max-height: none !important; }
  }
  
  .history-table-container {
    overflow-x: auto;
    margin-top: 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    -webkit-overflow-scrolling: touch;
    user-select: text;
    cursor: grab;
  }
  
  .history-table-container table { min-width: 800px; }
  .history-table-container.dragging { cursor: grabbing; }
  
  .history-card {
    background: var(--bg-input);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    border: 1px solid var(--border-color);
  }
  
  .history-card .row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    padding-bottom: 6px;
  }
  
  .history-card .row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
  .history-card .label { color: var(--text-secondary); font-size: 0.85rem; }
  .history-card .value { color: var(--text-primary); font-size: 0.9rem; text-align: left; }
  .history-card .actions { display: flex; justify-content: center; gap: 6px; margin-top: 8px; }
  
  .footer {
    color: white;
    text-align: center;
    padding: 16px;
    font-family: 'Vazirmatn', system-ui;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    font-size: 12px;
    font-weight: 500;
    display: block;
    margin: 30px auto;
    width: fit-content;
    max-width: 90%;
  }

  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    min-width: 250px;
    background: var(--success-color);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 10001;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    font-size: 0.9rem;
    text-align: center;
    font-weight: 500;
    font-family: 'Vazirmatn', sans-serif;
  }
  
  .toast.show { transform: translateX(0); }
  .toast.error { background: var(--danger-color); }

  @media (max-width: 768px) {
    .toast { right: 10px; left: 10px; min-width: auto; top: 10px; }
  }
</style>
</head>
<body>
<div class="container">
  <h1>CST Geometry Analyzer â€” Ù¾ÛŒØ´Ø±ÙØªÙ‡</h1>

  <div id="sectionsContainer">
    <div class="card collapsible-card" data-section="1">
      <div class="collapsible-header" onclick="toggleSection('1')">
        <h3>Û±) ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† / Ø«Ø¨Øª Ø±ÙˆØ² Ø¬Ø¯ÛŒØ¯</h3>
        <span class="toggle-icon">â–¼</span>
      </div>
     
      <div class="collapsible-content">
         <br>
        <div class="small">Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø¬ÙØª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.
        Ø³Ù¾Ø³ High Ùˆ Low Ø±ÙˆØ² Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù† (ÛŒØ§ Mid).</div>

        <div class="row">
          <div class="col">
            <label>Ø¬ÙØª Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡</label>
            <select id="selectedSymbol"></select>
          </div>
          <div class="col">
            <label>ØªØ§Ø±ÛŒØ® (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
            <input id="inputDate" type="date">
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>High Ø±ÙˆØ² Ø¬Ø¯ÛŒØ¯</label>
            <input id="inputHigh" placeholder="Ù…Ø«Ø§Ù„: 76500">
          </div>
          <div class="col">
            <label>Low Ø±ÙˆØ² Ø¬Ø¯ÛŒØ¯</label>
            <input id="inputLow" placeholder="Ù…Ø«Ø§Ù„: 76300">
          </div>
        </div>
        
        <div class="btn-group">
          <button id="addDayBtn">Ø«Ø¨Øª Ø±ÙˆØ² Ø¬Ø¯ÛŒØ¯</button>
          <button id="useMidBtn" class="btn-small">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø®ÙˆØ¯Ú©Ø§Ø±</button>
        </div>

        <div style="margin-top:6px" class="small">Ø§Ú¯Ø± ÙÙ‚Ø· Mid Ø¯Ø§Ø±ÛŒØŒ High = Low = Mid Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡ ÛŒØ§ Ø§Ø² Ø¯Ú©Ù…Ù‡ Â«Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø®ÙˆØ¯Ú©Ø§Ø±Â» Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†.</div>
      </div>
    </div>

    <div class="card collapsible-card" data-section="2">
      <div class="collapsible-header" onclick="toggleSection('2')">
        <h3>Û²) Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ùˆ ØªØ­Ù„ÛŒÙ„</h3>
        <span class="toggle-icon">â–¼</span>
      </div>
      
      <div class="collapsible-content">
        <br>
        <div class="row">
          <div class="col">
            <label>Ø¬ÙØª Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„</label>
            <select id="selectedSymbol3"></select>
          </div>
        </div>

        <div id="summarySection" style="margin-top:12px;display:none">
          <div class="small">
            <strong>Ø®Ù„Ø§ØµÙ‡ Ø¨Ø§Ø²Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ (Ø§Ø² Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø±ÙˆØ²):</strong>
            <div id="summaryText"></div>
          </div>
          <div class="history-table-container" id="tableContainer">
            <table id="summaryTable"><thead><tr>
               <th>Ø±Ø¯ÛŒÙ</th><th>ØªØ§Ø±ÛŒØ®</th><th>High</th><th>Low</th><th>Mid</th><th>Ø²Ø§ÙˆÛŒÙ‡</th><th>ØªØ­Ù„ÛŒÙ„ Ûµâ€ŒØ±ÙˆØ²Ù‡</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
            </tr></thead><tbody></tbody></table>
          </div>
          <div class="chart-wrapper">
            <div class="small" style="margin-bottom: 8px; text-align: center; color: var(--text-secondary);">ğŸ’¡ Ø¨Ø±Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ… Ø³Ø·Ø­ØŒ Ø®Ø· Ø§ÙÙ‚ÛŒ Ø±Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¬Ø§Ø¨Ø¬Ø§ Ú©Ù†ÛŒØ¯ (Ø¨Ø§Ù„Ø§/Ù¾Ø§ÛŒÛŒÙ† Ø¨Ú©Ø´ÛŒØ¯) â€” Ù†Ù…ÙˆØ¯Ø§Ø± Ù…ÛŒÙ„Ù‡â€ŒØ§ÛŒ: Ù‡Ø± Ø±ÙˆØ² ÛŒÚ© Ù…ÛŒÙ„Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªÙØ§ÙˆØª Ø²Ø§ÙˆÛŒÙ‡ Ù†Ø³Ø¨Øª Ø¨Ù‡ Ø±ÙˆØ² Ù‚Ø¨Ù„ (Ø¨Ø§Ù„Ø§=Ø¨ÛŒØ´ØªØ±ØŒ Ù¾Ø§ÛŒÛŒÙ†=Ú©Ù…ØªØ±)</div>
            <button class="guide-icon" onclick="openGuideModal()" title="Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ú†Ø§Ø±Øª Ù…ÛŒÙ„Ù‡â€ŒØ§ÛŒ">â“</button>
            <div class="chart-container bar-chart-isolated">
              <canvas id="angleBarChart"></canvas>
              <div id="horizontalLineContainerBar" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5;"></div>
            </div>
          </div>
          <div class="chart-wrapper">
            <div class="small" style="margin-bottom: 8px; text-align: center; color: var(--text-secondary);">ğŸ’¡ Ø®Ø· Ø§ÙÙ‚ÛŒ Ø¨Ø§ Ù‡Ù…ÙˆÙ† Ø¯Ù‚Øª Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡ MidÙ‡Ø§</div>
            <div class="chart-container">
              <canvas id="midChart"></canvas>
              <div id="horizontalLineContainerLine" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5;"></div>
            </div>
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Ù†ÙˆØ¹ Ø¨Ø§Ø²Ù‡ ØªØ­Ù„ÛŒÙ„</label>
          <div class="btn-group">
            <button id="daysRangeToggle" class="date-range-toggle active">ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø§Ø² Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†</button>
            <button id="dateRangeToggle" class="date-range-toggle">Ø¨Ø§Ø²Ù‡ ØªØ§Ø±ÛŒØ® Ø¯Ù„Ø®ÙˆØ§Ù‡</button>
          </div>
        </div>

        <div id="daysRangeSection">
          <div class="form-group">
            <label>Ø¨Ø§Ø²Ù‡Ù” ØªØ­Ù„ÛŒÙ„ (ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø§Ø² Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†)</label>
            <input id="analysisDays" type="number" min="2" max="3650" value="5"> 
            <div class="small">Ù¾ÛŒØ´â€ŒÙØ±Ø¶ = 5 Ø±ÙˆØ². Ø¨Ø±Ø§ÛŒ Ù…Ø«Ø§Ù„ 30 (Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡) ÛŒØ§ 365 (Ø³Ø§Ù„Ø§Ù†Ù‡) ÙˆØ§Ø±Ø¯ Ú©Ù† Ùˆ Ø³Ù¾Ø³ Â«Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ùˆ ØªØ­Ù„ÛŒÙ„Â» Ø±Ø§ Ø¨Ø²Ù†.</div>
          </div>
          
          <div class="btn-group">
            <button id="showHistoryBtn">Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ùˆ ØªØ­Ù„ÛŒÙ„</button>
          </div>
        </div>

        <div id="dateRangeSection" class="hidden">
          <div class="row">
            <div class="col">
              <label>ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</label>
              <input id="startDate" type="date">
            </div>
            <div class="col">
              <label>ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†</label>
              <input id="endDate" type="date">
            </div>
          </div>
          
          <div class="btn-group">
            <button id="showDateRangeBtn">Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ùˆ ØªØ­Ù„ÛŒÙ„</button>
          </div>
          
          <div class="small">ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ùˆ Ù¾Ø§ÛŒØ§Ù† Ø¯Ù„Ø®ÙˆØ§Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 2024-09-10 ØªØ§ 2024-09-13)</div>
        </div>
      </div>
    </div>

    <div class="card collapsible-card" data-section="3">
      <div class="collapsible-header" onclick="toggleSection('3')">
        <h3>Û³) Ù…Ø¯ÛŒØ±ÛŒØª Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§</h3>
        <span class="toggle-icon">â–¼</span>
      </div>
      
      <div class="collapsible-content">
        <br>
        <div class="form-group">
          <label>Ù†Ø§Ù… Ø¬ÙØªâ€ŒØ§Ø±Ø² (Ù…Ø«Ø§Ù„: EURUSD ÛŒØ§ BTCUSD)</label>
          <input id="newSymbol" placeholder="Ù†Ø§Ù… Ø¬ÙØªâ€ŒØ§Ø±Ø² Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯">
        </div>
        
        <div class="btn-group">
          <button id="addSymbolBtn">Ø§ÙØ²ÙˆØ¯Ù† / Ø§Ù†ØªØ®Ø§Ø¨</button>
        </div>

        <div class="small">Ù„ÛŒØ³Øª Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§ (Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ / Ø¨Ø±Ø§ÛŒ Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¢Ø²Ø§Ø¯ Ø¨Ú©Ø´ÛŒØ¯ Ùˆ Ø±Ù‡Ø§ Ú©Ù†ÛŒØ¯):</div>
        <div id="symbolsList" class="symbols-grid">
        </div>
        
        <div style="margin-top:8px" class="small">
          ğŸ’¡ <strong>Ø§Ù…Ú©Ø§Ù† Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¢Ø²Ø§Ø¯:</strong> Ù‡Ø± Ø¬ÙØª Ø§Ø±Ø²ÛŒ Ø±Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯Ø± Ù‡Ø± Ù…ÙˆÙ‚Ø¹ÛŒØªÛŒ Ø§Ø² ØµÙØ­Ù‡ Ùˆ Ú©Ù†Ø§Ø± Ù‡Ø± Ø¬ÙØª Ø§Ø±Ø² Ø¯ÛŒÚ¯Ø±ÛŒ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯
        </div>
        <BR>
        <div class="btn-group">
          <button id="deleteSelectedSymbol" class="btn-danger">Ø­Ø°Ù Ø¬ÙØª Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡</button>
        </div>
      </div>
    </div>

    <div class="card collapsible-card" data-section="4">
      <div class="collapsible-header" onclick="toggleSection('4')">
        <h3>Û´) Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h3>
        <span class="toggle-icon">â–¼</span>
      </div>
      
      <div class="collapsible-content">
<br>
        <div class="row">
          <div class="col">
            <label>Ù†ÙˆØ¹ Ù‡Ø´Ø¯Ø§Ø± ØµÙˆØªÛŒ Ù‡Ù†Ú¯Ø§Ù… Â«Ø§Ø­ØªÙ…Ø§Ù„ ØªØºÛŒÛŒØ± Ø±ÙˆÙ†Ø¯Â»</label>
            <select id="alertSoundMode">
              <option value="tts">TTS (ØµØ¯Ø§ÛŒ Ø²Ù†Ø§Ù†Ù‡ ÙØ§Ø±Ø³ÛŒ)</option>
              <option value="beep">Beep Ø³Ø§Ø¯Ù‡</option>
              <option value="both">Ù‡Ø± Ø¯Ùˆ (TTS + Beep)</option>
              <option value="off">Ø®Ø§Ù…ÙˆØ´</option>
            </select>
          </div>
          <div class="col">
            <label>&nbsp;</label>
            <button id="testAlertBtn">Ø¢Ø²Ù…Ø§ÛŒØ´ Ù‡Ø´Ø¯Ø§Ø±</button>
          </div>
        </div>

        <div class="row">
            <div class="col">
                <button id="exportBtn" class="btn-full">Ø®Ø±ÙˆØ¬ÛŒ (Backup)</button>
            </div>
            <div class="col">
                <button id="importBtn" class="btn-full" style="background-color: #0ea5a4;">ÙˆØ±ÙˆØ¯ÛŒ (Restore)</button>
                <input id="importFile" type="file" accept=".json" style="display: none;">
            </div>
        </div>

        <div class="danger-zone">
          <div class="text-center mb-2">
            <span style="color: white; font-weight: bold;">âš™ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</span>
          </div>
          
          <div class="mb-3">
            <label class="small block mb-1">Ø­Ø°Ù Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ± Ø§Ø²:</label>
            <div class="flex gap-2">
              <input id="manualPruneDays" type="number" min="1" max="3650" value="365" style="flex:1; text-align:center;">
              <span class="small flex items-center">Ø±ÙˆØ²</span>
            </div>
            <button id="manualPruneBtn" class="btn-danger w-full mt-2">
              Ø­Ø°Ù Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ
            </button>
          </div>

          <button id="showStatsBtn" class="w-full mb-2">
            Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
          </button>

          <p class="small text-center mt-2">Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù‡Ø³ØªÙ†Ø¯</p>
        </div>
      </div>
    </div>
  </div>

  <div class="card small" style="background: var(--bg-card); padding: 16px;">
    <strong>â€Œ â€ŒÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§:</strong>
    <ul>
      <li><strong>Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯:</strong> Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ Ø·ÙˆØ± Ø¯Ø§Ø¦Ù…ÛŒ Ø­ÙØ¸ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ (Ø­ØªÛŒ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ)</li>
      <li><strong>Ø­Ø°Ù Ø¯Ø³ØªÛŒ:</strong> ÙÙ‚Ø· Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø¨Ø®Ø´ "Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§" Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯</li>
      <li>ØªØ­Ù„ÛŒÙ„ Ø²Ø§ÙˆÛŒÙ‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Mid Ù‡Ø± Ø±ÙˆØ² Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Mid = (High+Low)/2). Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù†Ù…Ø§ÛŒØ´ ØªØ­Ù„ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¬ÙØª Ûµ Ø±ÙˆØ²Ù‡ Ø§Ø³Øª Ø§Ù…Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ø¹Ø¯Ø¯ Ø¯Ù„Ø®ÙˆØ§Ù‡ 2..3650 ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒ (Ø­ØªÛŒ Ø³Ø§Ù„Ø§Ù†Ù‡).</li>
    </ul>
  </div>

</div>

<div id="statsModal">
  <h3>ğŸ“Š Ø¢Ù…Ø§Ø± Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ…</h3>
  <div id="statsContent" style="margin-bottom:10px;color:#e6eef8"></div>
  <div class="btn-group">
    <button id="closeStatsBtn">Ø¨Ø³ØªÙ†</button>
  </div>
</div>

<div id="guideModal">
  <h3>ğŸ“– Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ú†Ø§Ø±Øª Ù…ÛŒÙ„Ù‡â€ŒØ§ÛŒ Ø²Ø§ÙˆÛŒÙ‡ Ø±ÙˆÙ†Ø¯</h3>
  <div id="guideContent" style="margin-bottom:10px;color:#e6eef8; white-space: pre-line;"></div>
  <div class="btn-group">
    <button onclick="closeGuideModal()">Ø¨Ø³ØªÙ†</button>
  </div>
</div>

<div id="alertModal">
  <h3 id="alertTitle">âš ï¸ Ù‡Ø´Ø¯Ø§Ø±: Ø§Ø­ØªÙ…Ø§Ù„ ØªØºÛŒÛŒØ± Ø±ÙˆÙ†Ø¯</h3>
  <div id="alertBody" style="margin-bottom:10px;color:#ffd9d9"></div>
  <div class="btn-group">
    <button id="closeAlert">Ø¨Ø³ØªÙ†</button>
  </div>
</div>
<div class="modal-bg" id="modalBg"></div>

<div id="editModal">
  <h3>âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ø±Ú©ÙˆØ±Ø¯</h3>
  <div class="small" style="margin-bottom:6px">Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªØ§Ø±ÛŒØ®ØŒ High Ùˆ Low Ø±Ú©ÙˆØ±Ø¯ Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯.</div>
  <div style="margin-bottom:8px">
    <label>ØªØ§Ø±ÛŒØ®</label><input id="editDate" type="date">
    <label>High</label><input id="editHigh">
    <label>Low</label><input id="editLow">
  </div>
  <div class="btn-group">
    <button id="saveEditBtn">Ø°Ø®ÛŒØ±Ù‡</button>
    <button id="cancelEditBtn" class="btn-danger">Ø§Ù†ØµØ±Ø§Ù</button>
  </div>
</div>

<div id="moveModal">
  <h3>ğŸ”€ Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ø±Ú©ÙˆØ±Ø¯</h3>
  <div class="small" style="margin-bottom:6px">Ø´Ù…Ø§Ø±Ù‡Ù” Ø¬Ø¯ÛŒØ¯ Ø±Ø¯ÛŒÙ (1 = Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†ØŒ ...)</div>
  <div style="margin-bottom:8px">
    <label>Ø´Ù…Ø§Ø±Ù‡ Ø±Ø¯ÛŒÙ Ø¬Ø¯ÛŒØ¯ (1..30)</label><input id="moveToIndex" type="number" min="1" max="30" value="1">
  </div>
  <div class="btn-group">
    <button id="doMoveBtn">Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ</button>
    <button id="cancelMoveBtn" class="btn-danger">Ø§Ù†ØµØ±Ø§Ù</button>
  </div>
</div>

<script>
// ---------- helpers ----------
function parseNum(v){
  if(v===null||v===undefined) return null;
  v = String(v).trim();
  if(v==="") return null;
  v = v.replace(/[Û°-Û¹]/g, d => String('Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d)));
  v = v.replace(/,/g, '.');
  v = v.replace(/\./g, '');
  const n = Number(v);
  return isNaN(n)?null:n;
}

const STORAGE_KEY = 'cst_data_final_v5';
const SECTIONS_ORDER_KEY = 'cst_sections_order';
const SECTION_OPEN_KEY = 'cst_section_open_';
let store = { symbols: {}, symbolOrder: [] };
let sectionsOrder = [1, 2, 3, 4]; // ØªØ±ØªÛŒØ¨ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
let lastAlertShownAt = 0;
const ALERT_THROTTLE_MS = 3000;
// Ù…ØªÙ† Ø±Ø§Ù‡Ù†Ù…Ø§
const GUIDE_TEXT = `### Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³Ø±ÛŒØ¹ Ú†Ø§Ø±Øª Ù…ÛŒÙ„Ù‡â€ŒØ§ÛŒ Ø²Ø§ÙˆÛŒÙ‡ Ø±ÙˆÙ†Ø¯ (CST Analyzer)

**Ú†ÛŒ Ù†Ø´ÙˆÙ† Ù…ÛŒâ€ŒØ¯Ù‡ØŸ** Ù‡Ø± Ù…ÛŒÙ„Ù‡ ÛŒÚ© "Ø±ÙˆØ²" Ø±Ùˆ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡ Ùˆ Ø§Ø±ØªÙØ§Ø¹Ø´ **ØªÙØ§ÙˆØª Ø²Ø§ÙˆÛŒÙ‡ Ø´ÛŒØ¨ Ù‚ÛŒÙ…Øª (Mid)** Ù†Ø³Ø¨Øª Ø¨Ù‡ Ø±ÙˆØ² Ù‚Ø¨Ù„Ù‡.
Ø²Ø§ÙˆÛŒÙ‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Î”Mid (ØªÙØ§ÙˆØª Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† High/Low) Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´Ù‡: Ù…Ø«Ø¨Øª=ØµØ¹ÙˆØ¯ÛŒØŒ Ù…Ù†ÙÛŒ=Ù†Ø²ÙˆÙ„ÛŒ.
**Ø±Ù†Ú¯ Ùˆ Ù…Ø¹Ù†ÛŒ:**
- **Ø³Ø¨Ø² Ø¨Ù„Ù†Ø¯:** Ø²Ø§ÙˆÛŒÙ‡ Ù‚ÙˆÛŒâ€ŒØªØ± Ø´Ø¯Ù‡ (Ø±ÙˆÙ†Ø¯ Ø´ØªØ§Ø¨ Ú¯Ø±ÙØªÙ‡ØŒ Ù…Ø«Ù„ breakout ØµØ¹ÙˆØ¯ÛŒ) â†’ ÙØ±ØµØª Ø®Ø±ÛŒØ¯ØŸ
- **Ù‚Ø±Ù…Ø² Ø¨Ù„Ù†Ø¯:** Ø²Ø§ÙˆÛŒÙ‡ Ø¶Ø¹ÛŒÙâ€ŒØªØ± ÛŒØ§ Ù…Ø¹Ú©ÙˆØ³ (Ø§ØµÙ„Ø§Ø­/ØªØºÛŒÛŒØ± Ø±ÙˆÙ†Ø¯) â†’ Ù‡Ø´Ø¯Ø§Ø± ÙØ±ÙˆØ´ ÛŒØ§ ØµØ¨Ø±.
- **ØµÙØ±/Ú©ÙˆÚ†Ú© (Ø®Ø§Ú©Ø³ØªØ±ÛŒ):** Ø±ÙˆÙ†Ø¯ Ø«Ø§Ø¨Øª ÛŒØ§ ÙØ´Ø±Ø¯Ú¯ÛŒ â†’ Ù…Ù†ØªØ¸Ø± Ø´Ú©Ø³Øª Ø¨Ø§Ø´.
**Ù†Ú©Ø§Øª Ø§Ø³ØªÙØ§Ø¯Ù‡:** Hover Ú©Ù† ØªØ§ "ØªÙØ§ÙˆØª" Ùˆ "Ø²Ø§ÙˆÛŒÙ‡ Ø§Ù…Ø±ÙˆØ²" Ø±Ùˆ Ø¨Ø¨ÛŒÙ†ÛŒ. Ø®Ø· Ø§ÙÙ‚ÛŒ Ø±Ùˆ Ø¨Ú©Ø´ Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø³Ø·ÙˆØ­.
Ø§Ú¯Ø± Ù…ÛŒÙ„Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø±Ù…Ø²/Ø³Ø¨Ø² Ø¨Ø²Ø±Ú¯ Ø¯ÛŒØ¯ÛŒØŒ Ú†Ú© Ú©Ù† ØªØ­Ù„ÛŒÙ„ Ûµâ€ŒØ±ÙˆØ²Ù‡ Ø±Ùˆ â€“ Ø§Ø­ØªÙ…Ø§Ù„ ØªØºÛŒÛŒØ± Ø±ÙˆÙ†Ø¯ Ø²ÛŒØ§Ø¯Ù‡! ğŸš€`;
// ---------- Drag & Drop Ø¨Ø±Ø§ÛŒ Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§ ----------
function refreshSymbolsList(){
  const container = document.getElementById('symbolsList');
  const sel = document.getElementById('selectedSymbol');
  const sel3 = document.getElementById('selectedSymbol3');
  const currentSelected = sel.value;
  
  container.innerHTML = ''; 
  sel.innerHTML = '';
  sel3.innerHTML = '';
  const names = store.symbolOrder || [];
  if(names.length === 0){
    container.innerHTML = '<div class="small" style="width:100%; text-align:center; padding:20px;">Ù‡ÛŒÚ† Ø¬ÙØªâ€ŒØ§Ø±Ø²ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡. ÛŒÚ© Ù†Ø§Ù… ÙˆØ§Ø±Ø¯ Ú©Ù† Ùˆ Â«Ø§ÙØ²ÙˆØ¯Ù†Â» Ø¨Ø²Ù†.</div>';
    const opt = document.createElement('option');
    opt.value = '';
    opt.text = '-- Ø¬ÙØª Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ --';
    sel.appendChild(opt);
    sel3.appendChild(opt.cloneNode(true));
    return;
  }

  names.forEach((name, index) => {
    const chip = createSymbolChip(name, index);
    container.appendChild(chip);
  });
  names.forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.text = name;
    sel.appendChild(opt);
    sel3.appendChild(opt.cloneNode(true));
  });
  if (currentSelected && names.includes(currentSelected)) {
    sel.value = currentSelected;
    sel3.value = currentSelected;
  } else if (names.length > 0) {
    sel.value = names[0];
    sel3.value = names[0];
  }

  setupFreeDragAndDrop(container);
}

function createSymbolChip(name, index) {
  const chip = document.createElement('div');
  chip.className = 'chip';
  chip.textContent = name;
  chip.dataset.symbolName = name;
  chip.dataset.index = index;
  chip.draggable = true;
  
  const overlay = document.createElement('div');
  overlay.className = 'chip-overlay';
  overlay.textContent = 'â‡…';
  chip.appendChild(overlay);
  chip.onclick = () => { 
    document.getElementById('selectedSymbol').value = name; 
    document.getElementById('selectedSymbol3').value = name;
    renderSummaryForRange(name, true); 
  };
  
  return chip;
}

function setupFreeDragAndDrop(container) {
  let draggedItem = null;
  let placeholder = null;
  container.querySelectorAll('.chip').forEach(chip => {
    chip.addEventListener('dragstart', function(e) {
      draggedItem = this;
      this.classList.add('dragging');
      
      placeholder = document.createElement('div');
      placeholder.className = 'chip-placeholder';
      this.parentNode.insertBefore(placeholder, this.nextSibling);
      
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', this.dataset.symbolName);
    });

    chip.addEventListener('dragend', function() {
      this.classList.remove('dragging');
      
      
      if (placeholder && placeholder.parentNode) {
        placeholder.parentNode.removeChild(placeholder);
      }
      
      draggedItem = null;
      placeholder = null;
      
      updateSymbolOrderFromFreeDOM();
    });
  });
  container.addEventListener('dragover', function(e) {
    e.preventDefault();
    if (!draggedItem) return;
    
    const afterElement = getFreeDragAfterElement(container, e.clientX, e.clientY);
    
    if (afterElement == null) {
      container.appendChild(placeholder);
    } else {
      container.insertBefore(placeholder, afterElement);
    }
  });
  container.addEventListener('drop', function(e) {
    e.preventDefault();
    if (!draggedItem) return;
    
    if (placeholder && placeholder.parentNode) {
      container.insertBefore(draggedItem, placeholder);
      placeholder.parentNode.removeChild(placeholder);
    }
    
    draggedItem.classList.remove('dragging');
    draggedItem = null;
    placeholder = null;
    
    updateSymbolOrderFromFreeDOM();
  });
}

function getFreeDragAfterElement(container, x, y) {
  const draggableElements = [...container.querySelectorAll('.chip:not(.dragging)')];
  return draggableElements.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offsetX = x - box.left - box.width / 2;
    const offsetY = y - box.top - box.height / 2;
    
    const distance = Math.sqrt(offsetX * offsetX + offsetY * offsetY);
    
    if (distance < 100 && distance > closest.distance) {
      return { distance: distance, element: child };
    } else {
      return closest;
    }
  }, { distance: Number.NEGATIVE_INFINITY, element: null }).element;
}

function updateSymbolOrderFromFreeDOM() {
  const container = document.getElementById('symbolsList');
  const newOrder = Array.from(container.querySelectorAll('.chip'))
    .map(chip => chip.dataset.symbolName);
  
  store.symbolOrder = newOrder;
  saveStore();
  
  refreshSymbolDropdown();
}

function refreshSymbolDropdown() {
  const sel = document.getElementById('selectedSymbol');
  const sel3 = document.getElementById('selectedSymbol3');
  const currentSelected = sel.value;
  sel.innerHTML = '';
  sel3.innerHTML = '';
  
  store.symbolOrder.forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.text = name;
    sel.appendChild(opt);
    sel3.appendChild(opt.cloneNode(true));
  });
  if (currentSelected && store.symbolOrder.includes(currentSelected)) {
    sel.value = currentSelected;
    sel3.value = currentSelected;
  } else if (store.symbolOrder.length > 0) {
    sel.value = store.symbolOrder[0];
    sel3.value = store.symbolOrder[0];
  }
}

function ensureSymbol(name){
  name = String(name || '').trim().toUpperCase();
  if(!name) return null;
  if(!store.symbols[name]){
    store.symbols[name] = { name, history: [], created: Date.now() };
    if (!store.symbolOrder.includes(name)) {
      store.symbolOrder.push(name);
    }
    saveStore();
    refreshSymbolsList();
  }
  return store.symbols[name];
}

function computeMid(high, low){ return (high + low) / 2; }

function analyzeAnglesFor(midArray, windows=5){
  if(!midArray || midArray.length < 2) return {angles:[], avgAbs:0, verdict:'Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª'};
  const use = Math.min(windows, midArray.length);
  const arr = midArray.slice(-use);
  const angles = [];
  for(let i=0;i<arr.length-1;i++){
    const dp = arr[i+1] - arr[i];
    const ang = Math.atan(dp/1) * 180 / Math.PI;
    angles.push(ang);
  }
  const absAngles = angles.map(a=>Math.abs(a));
  const avgAbs = absAngles.length ? (absAngles.reduce((s,x)=>s+x,0)/absAngles.length) : 0;
  const pos = angles.filter(a=>a>0).length;
  const neg = angles.filter(a=>a<0).length;
  const lastSign = angles.length ? (angles[angles.length-1] > 0 ? 'pos' : (angles[angles.length-1] < 0 ? 'neg' : 'zero')) : 'zero';
  let verdict = '';
  const majority = pos >= neg ? 'pos' : 'neg';
  let weakening = false;
  if(absAngles.length >= 2){
    const la = absAngles;
    if(la[la.length-1] < la[la.length-2] && la[la.length-2] <= (la[la.length-3]||Infinity)) weakening = true;
  }
  if(lastSign !== 'zero' && lastSign !== majority) verdict = 'ğŸ”´ Ø§Ø­ØªÙ…Ø§Ù„ ØªØºÛŒÛŒØ± Ø±ÙˆÙ†Ø¯ (Ø¹Ù„Ø§Ù…Øª Ø§Ø®ÛŒØ± Ù…Ø®Ø§Ù„Ù Ø§Ú©Ø«Ø±ÛŒØª)';
  else {
    if(avgAbs > 45) verdict = 'ğŸ”µ Ø§Ø¯Ø§Ù…Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡Ù” Ù‚ÙˆÛŒ';
    else if(avgAbs >= 25) verdict = 'ğŸŸ¡ Ø±ÙˆÙ†Ø¯ Ù…ØªÙˆØ³Ø· â€” Ù…Ø±Ø§Ù‚Ø¨ Ø§ØµÙ„Ø§Ø­';
    else verdict = 'ğŸ”» ÙØ´Ø±Ø¯Ú¯ÛŒ ÛŒØ§ Ø¶Ø¹Ù Ø±ÙˆÙ†Ø¯ â€” Ø§Ø­ØªÙ…Ø§Ù„ ØªØºÛŒÛŒØ± ÛŒØ§ Ø´Ú©Ø³Øª Ù†Ø§Ú¯Ù‡Ø§Ù†ÛŒ';
    if(weakening) verdict += '\nâš ï¸ Ù†Ø´Ø§Ù†Ù‡Ù” ØªØ¶Ø¹ÛŒÙ: Ø²Ø§ÙˆÛŒÙ‡â€ŒÙ‡Ø§ Ú©Ø§Ù‡Ø´ ÛŒØ§ÙØªÙ‡â€ŒØ§Ù†Ø¯';
  }
  return {angles, avgAbs, verdict};
}

function addDayToSymbol(symName, high, low, dateStr=null){
  const sym = store.symbols[symName]; if(!sym) return false;
  const h = parseFloat(high);
  const l = parseFloat(low);
  if(isNaN(h) || isNaN(l)) return false;
  const mid = computeMid(h,l);
  const rec = { date: dateStr ||
  new Date().toISOString().slice(0,10), high:h, low:l, mid };
  sym.history.push(rec);
  
  recomputeAnalysesForSymbol(sym);
  saveStore(); return true;
}

function recomputeAnalysesForSymbol(sym){
  sym.history.forEach((r, idx) => {
    const window5 = sym.history.slice(Math.max(0, idx-4), idx+1).map(x=>x.mid);
    r.analysis5 = analyzeAnglesFor(window5, window5.length).verdict || '';
    const window30 = sym.history.slice(Math.max(0, idx-29), idx+1).map(x=>x.mid);
    r.analysis30 = analyzeAnglesFor(window30, window30.length).verdict || '';
  });
  const mids = sym.history.map(r=>r.mid);
  const last5 = analyzeAnglesFor(mids, Math.min(5,mids.length));
  const last30 = analyzeAnglesFor(mids, Math.min(30,mids.length));
  sym.lastSummary = { date: (sym.history[sym.history.length-1]||{}).date ||
  '', last5:last5.verdict, last30:last30.verdict, avgAngle5:last5.avgAbs, avgAngle30:last30.avgAbs };
}

// ØªØ§Ø¨Ø¹ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ… Ø¹Ø±Ø¶ Ø®Ø·ÙˆØ· Ø§ÙÙ‚ÛŒ (Ø§Ø³ØªØ®Ø±Ø§Ø¬â€ŒØ´Ø¯Ù‡ Ø§Ø² resize)
function resizeHorizontalLines() {
  ['horizontalLineContainerBar', 'horizontalLineContainerLine'].forEach(id => {
    const lineContainer = document.getElementById(id);
    if (lineContainer && lineContainer.children.length > 0) {
      const wrapper = lineContainer.children[0];
      const chartCont = lineContainer.closest('.chart-container');
      if (chartCont) {
        const canvas = chartCont.querySelector('canvas');
        if (canvas) {
          const rect = 
            canvas.getBoundingClientRect();
          wrapper.style.width = rect.width + 'px';
          const line = wrapper.querySelector('.horizontal-line');
          if (line) {
            line.style.width = rect.width + 'px';
          }
        }
      }
    }
  });
}

// ---------- ØªÙˆØ§Ø¨Ø¹ ØªØ­Ù„ÛŒÙ„ Ùˆ Ù†Ù…Ø§ÛŒØ´ ----------
function renderSummaryForRange(symName, isDaysRange = true, requestedDays = 5, startDate = null, endDate = null) {
  const summaryDiv = document.getElementById('summarySection');
  const summaryText = document.getElementById('summaryText');
  const tableBody = document.querySelector('#summaryTable tbody');
  const sym = store.symbols[symName];
  if (!sym || sym.history.length === 0) {
    summaryDiv.style.display = 'none';
    if (window._barChart) window._barChart.destroy();
    if (window._chart) window._chart.destroy();
    return;
  }

  const hist = sym.history.slice();
  let displayHist, angles, analysis;

  if (isDaysRange) {
    displayHist = hist.slice(-requestedDays);
    // Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ø¨Ø§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯ (Ù…Ø«Ù„ 30+ Ø±ÙˆØ²)
    const mids = displayHist.map(h => h.mid);
    analysis = analyzeAnglesFor(mids, requestedDays);
    angles = analysis.angles;
  } else {
    // Filter by date range
    displayHist = hist.filter(record => {
      const recordDate = new Date(record.date);
      const start = new Date(startDate);
      const end = new Date(endDate);
      return recordDate >= start && recordDate <= end;
    });
    if (displayHist.length === 0) {
      summaryDiv.style.display = 'none';
      if (window._barChart) window._barChart.destroy();
      if (window._chart) window._chart.destroy();
      return;
    }
    const mids = displayHist.map(h => h.mid);
    analysis = analyzeAnglesFor(mids, displayHist.length);
    angles = analysis.angles;
  }

  // Ø®Ù„Ø§ØµÙ‡ Ù…ØªÙ†
  const rangeText = isDaysRange ? `${requestedDays} Ø±ÙˆØ²Ù‡` : `ØªØ§Ø±ÛŒØ® ${startDate} ØªØ§ ${endDate}`;
  summaryText.innerHTML = `
    <div>Ù†ØªÛŒØ¬Ù‡ ØªØ­Ù„ÛŒÙ„: ${analysis.verdict ||
    '-'} <br>
    Ø²Ø§ÙˆÛŒÙ‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†: ${analysis.avgAbs.toFixed(2)}Â° <br>
    (ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§: ${displayHist.length})</div>
  `;
  // Ø¨Ø§Ú©Ø³ Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ØµÙˆØ±Øª Ø§Ø¹Ø¯Ø§Ø¯ (Ø¬Ø¯ÙˆÙ„)
  tableBody.innerHTML = '';
  for (let i = displayHist.length - 1; i >= 0; i--) {
    const r = displayHist[i];
    const rowIndex = displayHist.length - i;
    // Find angle for this interval (between i and i+1)
    const angleIndex = displayHist.length - 1 - i;
    // Reverse index for angles
    const angle = angleIndex < angles.length ? angles[angleIndex] : null;
    // Find original index for operations
    const originalIdx = hist.findIndex(origRec => origRec.date === r.date && origRec.high === r.high && origRec.low === r.low);
    const row = document.createElement('tr');
    row.dataset.idx = originalIdx;
    row.innerHTML = `
      <td>${rowIndex}</td>
      <td>${r.date}</td>
      <td>${r.high}</td>
      <td>${r.low}</td>
      <td>${r.mid.toFixed(2)}</td>
      <td>${angle ?
      angle.toFixed(2) + 'Â°' : '-'}</td>
      <td>${r.analysis5 ||
      ''}</td>
      <td class="action-col">
        <button class="icon-btn edit-btn" data-idx="${originalIdx}">âœï¸</button>
        <button class="icon-btn del-btn" data-idx="${originalIdx}">âŒ</button>
        <button class="icon-btn move-btn" data-idx="${originalIdx}">ğŸ”€</button>
      </td>
    `;
    tableBody.appendChild(row);
  }

  // Event listeners for table
  tableBody.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', () => openEditModal(symName, parseInt(btn.dataset.idx))));
  tableBody.querySelectorAll('.del-btn').forEach(btn => btn.addEventListener('click', () => {
    if (!confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒ Ø§ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
    sym.history.splice(parseInt(btn.dataset.idx), 1);
    recomputeAnalysesForSymbol(sym);
    saveStore();
    renderSummaryForRange(symName, isDaysRange, requestedDays, startDate, endDate);
    checkAndAlertIfChange(symName);
  }));
  tableBody.querySelectorAll('.move-btn').forEach(btn => btn.addEventListener('click', () => openMoveModal(symName, parseInt(btn.dataset.idx))));

  // Ø¨Ø§Ú©Ø³ Ù†Ù…ÙˆØ¯Ø§Ø± Ù…ÛŒÙ„Ù‡â€ŒØ§ÛŒ: Ù‡Ø± Ø±ÙˆØ² ÛŒÚ© Ù…ÛŒÙ„Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªÙØ§ÙˆØª Ø²Ø§ÙˆÛŒÙ‡ Ù†Ø³Ø¨Øª Ø¨Ù‡ Ø±ÙˆØ² Ù‚Ø¨Ù„ (Ø®Ø§Ù…ØŒ Ø¨Ø¯ÙˆÙ† scaling - Ù…Ø«Ø¨Øª/Ù…Ù†ÙÛŒ)
  const displayDates = displayHist.map(h => h.date).slice(1);
  // Ø§Ø² Ø¯ÙˆÙ…ÛŒÙ† ØªØ§Ø±ÛŒØ® (ØªØ¹Ø¯Ø§Ø¯ Ù…ÛŒÙ„Ù‡â€ŒÙ‡Ø§ = ØªØ¹Ø¯Ø§Ø¯ Ø²Ø§ÙˆÛŒÙ‡â€ŒÙ‡Ø§)
  
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ diffAngles: ØªÙØ§ÙˆØª Ù‡Ø± Ø²Ø§ÙˆÛŒÙ‡ Ø¨Ø§ Ù‚Ø¨Ù„ÛŒ (Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø±ÙˆØ² Ø¬Ø² Ø§ÙˆÙ„ÛŒÙ†)
  const diffAngles = [];
  const absoluteAnglesForTooltip = []; // Ø²Ø§ÙˆÛŒÙ‡ Ù…Ø·Ù„Ù‚ Ø¨Ø±Ø§ÛŒ tooltip
  if (angles.length > 0) {
    // Ø§ÙˆÙ„ÛŒÙ† Ù…ÛŒÙ„Ù‡: Ø²Ø§ÙˆÛŒÙ‡ Ù…Ø·Ù„Ù‚ (base)
    diffAngles.push(angles[0]);
    absoluteAnglesForTooltip.push(angles[0]);
    // Ø¨Ù‚ÛŒÙ‡: ØªÙØ§ÙˆØª
    for (let i = 1; i < angles.length; i++) {
      const diff = angles[i] - angles[i - 1];
      diffAngles.push(diff);
      absoluteAnglesForTooltip.push(angles[i]);
    }
  } else {
    diffAngles.push(0);
    absoluteAnglesForTooltip.push(0);
  }

  // Ù…Ø­Ø§Ø³Ø¨Ù‡ maxAbs Ø¨Ø±Ø§ÛŒ symmetric scale (Ø§Ø² -maxAbs ØªØ§ +maxAbs)
  const maxAbsDiff = Math.max(...diffAngles.map(Math.abs), 1);
  // Ø­Ø¯Ø§Ù‚Ù„ 1 Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØµÙØ±

  const ctxBar = document.getElementById('angleBarChart').getContext('2d');
  if (window._barChart) window._barChart.destroy();
  window._barChart = new Chart(ctxBar, {
    type: 'bar',
    data: {
      labels: displayDates,
      datasets: [{
        label: 'ØªÙØ§ÙˆØª Ø²Ø§ÙˆÛŒÙ‡ Ù†Ø³Ø¨Øª Ø¨Ù‡ Ø±ÙˆØ² Ù‚Ø¨Ù„ (Ø¯Ø±Ø¬Ù‡)',
        data: diffAngles,
        backgroundColor: diffAngles.map(diff => diff > 0 ? 'rgba(16, 185, 129, 0.6)' : (diff < 0 ? 'rgba(239, 68, 68, 0.6)' : 'rgba(156, 163, 175, 0.6)')),
        borderColor: diffAngles.map(diff => diff > 0 ? '#10b981' 
          : (diff < 0 ? '#ef4444' : '#9ca3af')),
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        legend: { display: false },
        tooltip: {
          callbacks: {
             label: function(context) {
              const idx = context.dataIndex;
              const diff = diffAngles[idx];
              const absAngle = absoluteAnglesForTooltip[idx];
              return `ØªÙØ§ÙˆØª: ${diff.toFixed(2)}Â° | Ø²Ø§ÙˆÛŒÙ‡ Ø§Ù…Ø±ÙˆØ²: ${absAngle.toFixed(2)}Â°`;
            }
           }
        }
      },
      scales: {
        y: {
          beginAtZero: true, // Ø§Ø² 0 Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¢Ø³Ø§Ù†
          min: -maxAbsDiff * 1.1, // symmetric: Ù¾Ø§ÛŒÛŒÙ† ØªØ§ -1.1 * max
          max: maxAbsDiff * 1.1, // Ø¨Ø§Ù„Ø§ ØªØ§ +1.1 * max
           ticks: { 
            color: '#9fb3c8',
            stepSize: Math.max(0.5, maxAbsDiff / 10), // Ú¯Ø§Ù… Ú©ÙˆÚ†Ú© Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† ØªÙØ§ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ø±ÛŒØ²
            callback: function(value) {
              return value.toFixed(1);
              // 1 Ø±Ù‚Ù… Ø§Ø¹Ø´Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø¯Ù‚Øª
            }
          },
          grid: { color: 'rgba(159, 179, 200, 0.1)' }
        },
        x: {
          ticks: { color: '#9fb3c8' },
          grid: { color: 'rgba(159, 179, 200, 0.1)' }
        }
      }
    }
  });
  // Force resize after creation
  window._barChart.resize();
  // Ø¨Ø§Ú©Ø³ Ù†Ù…ÙˆØ¯Ø§Ø± Ù‡Ù†Ø¯Ø³ÛŒ (Line Chart Ø¨Ø±Ø§ÛŒ Mid)
  const chartLabels = displayHist.map(h => h.date);
  const chartMids = displayHist.map(h => h.mid);
  const ctx = document.getElementById('midChart').getContext('2d');
  if (window._chart) window._chart.destroy();
  window._chart = new Chart(ctx, {
    type: 'line',
    data: { labels: chartLabels, datasets: [{ label: symName + ' â€” Mid', data: chartMids, fill:false, borderWidth:2, tension:0.2, borderColor: '#0ea5a4' }] },
    options: { 
      responsive: true,
      maintainAspectRatio: false,
      plugins:{ legend:{ display:false } }, 
      scales:{ 
        y: { 
          beginAtZero:false, 
          ticks: { color: '#9fb3c8' }, 
          grid: { color: 'rgba(159, 179, 200, 0.1)' } 
        }, 
        x: { 
          ticks: { color: '#9fb3c8' }, 
          grid: { color: 'rgba(159, 179, 200, 0.1)' } 
        } 
      } 
    }
  });
  // Force resize after creation
  window._chart.resize();
  // Cleanup Ùˆ Ø§ÛŒØ¬Ø§Ø¯ Ø®Ø· Ø§ÙÙ‚ÛŒ Ø¨Ø±Ø§ÛŒ Ú†Ø§Ø±Øª Ù…ÛŒÙ„Ù‡â€ŒØ§ÛŒ
  cleanupLineHandlers('horizontalLineContainerBar');
  createDraggableHorizontalLine('horizontalLineContainerBar', '.bar-chart-isolated canvas', true);
  // Cleanup Ùˆ Ø§ÛŒØ¬Ø§Ø¯ Ø®Ø· Ø§ÙÙ‚ÛŒ Ø¨Ø±Ø§ÛŒ Ú†Ø§Ø±Øª Ø®Ø·ÛŒ (mid)
  cleanupLineHandlers('horizontalLineContainerLine');
  createDraggableHorizontalLine('horizontalLineContainerLine', '#midChart', false);
  // Force initial resize for lines after creation
  setTimeout(resizeHorizontalLines, 50);

  summaryDiv.style.display = 'block';
  setupTableDragScroll();
  // ØªÙ†Ø¸ÛŒÙ… Ø§Ø³Ú©Ø±ÙˆÙ„ drag
}

// ØªØ§Ø¨Ø¹ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† modal Ø±Ø§Ù‡Ù†Ù…Ø§
function openGuideModal() {
  document.getElementById('guideContent').innerHTML = GUIDE_TEXT;
  document.getElementById('modalBg').style.display = 'block';
  document.getElementById('guideModal').style.display = 'block';
}

function closeGuideModal() {
  document.getElementById('guideModal').style.display = 'none';
  document.getElementById('modalBg').style.display = 'none';
}

// ØªØ§Ø¨Ø¹ cleanup handlerÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
function cleanupLineHandlers(containerId) {
  const container = document.getElementById(containerId);
  if (container && container.children.length > 0 && container.children[0]._localHandlers) {
    const { localMouseMove, localMouseUp } = container.children[0]._localHandlers;
    document.removeEventListener('mousemove', localMouseMove);
    document.removeEventListener('mouseup', localMouseUp);
  }
}

// ØªØ§Ø¨Ø¹ Ø§ÛŒØ¬Ø§Ø¯ Ø®Ø· Ø§ÙÙ‚ÛŒ draggable (Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„: ØªÙ†Ø¸ÛŒÙ… Ø§ÙˆÙ„ÛŒÙ‡ Ø¹Ø±Ø¶ Ø¨Ø§ timeout)
function createDraggableHorizontalLine(containerId, canvasSelector, isBarChart) {
  const container = document.getElementById(containerId);
  if (!container) return;
  const canvas = document.querySelector(canvasSelector);
  if (!canvas) return;
  const chartCont = canvas.parentElement;
  // parent container
  container.innerHTML = ''; // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‚Ø¨Ù„ÛŒ

  // wrapper Ø¨Ø±Ø§ÛŒ hit area (20px Ø§Ø±ØªÙØ§Ø¹ØŒ Ù†Ø§Ù…Ø±Ø¦ÛŒ) - unique per chart
  const wrapper = document.createElement('div');
  wrapper.className = 'horizontal-line-wrapper'; wrapper.style.pointerEvents = 'auto';
  wrapper.style.top = '50%'; // Ù…ÙˆÙ‚Ø¹ÛŒØª Ø§ÙˆÙ„ÛŒÙ‡ ÙˆØ³Ø· Ú†Ø§Ø±Øª
  wrapper.style.transform = 'translateY(-50%)';
  // Ø®Ø· Ø§ØµÙ„ÛŒ Ø¯Ø§Ø®Ù„ wrapper (1px Ù†Ø§Ø²Ú©)
  const line = document.createElement('div');
  line.className = 'horizontal-line';
  line.style.position = 'absolute';
  line.style.top = '50%';
  line.style.transform = 'translateY(-50%)';
  line.style.height = '1px';

  const guide = document.createElement('div');
  guide.className = 'line-guide';
  guide.textContent = isBarChart ?
  'Ø®Ø· Ù…ÛŒÙ„Ù‡â€ŒØ§ÛŒ: Ø¨Ø±Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ… Ø³Ø·Ø­ Ø²Ø§ÙˆÛŒÙ‡' : 'Ø®Ø· Mid: Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ù‚ÛŒÙ…Øª';
  line.appendChild(guide);

  wrapper.appendChild(line);
  container.appendChild(wrapper);
  // Set initial width (optimized for mobile: check rect, fallback to timeout)
  const setInitialWidth = () => {
    const rect = canvas.getBoundingClientRect();
    if (rect.width > 0) {
      wrapper.style.width = rect.width + 'px';
      line.style.width = rect.width + 'px';
    } else {
      // Fallback for initial render on mobile (width=0)
      setTimeout(() => {
        const rect2 = canvas.getBoundingClientRect();
        if (rect2.width > 0) {
          wrapper.style.width = rect2.width + 'px';
          line.style.width = rect2.width + 'px';
        }
      }, 50);
    }
  };
  setInitialWidth();

  // observe resizes to keep width in sync (use ResizeObserver if available)
  if (typeof ResizeObserver !== 'undefined') {
    const ro = new ResizeObserver(() => {
      setInitialWidth();
    });
    ro.observe(canvas);
  } else {
    window.addEventListener('resize', setInitialWidth);
  }

  // Local drag state
  let isDragging = false;
  let startY = 0;
  let startTop = 50;

  const getClientY = (e) => {
    if (e.touches && e.touches.length) return e.touches[0].clientY;
    if (e.changedTouches && e.changedTouches.length) return e.changedTouches[0].clientY;
    return e.clientY;
  };

  // pointer start (mouse)
  const onPointerDown = (e) => {
    if (e.type === 'mousedown' && e.button !== 0) return;
    e.stopPropagation();
    e.preventDefault();
    isDragging = true;
    startY = getClientY(e);
    startTop = parseFloat(wrapper.style.top) || 50;
    document.body.style.userSelect = 'none';
  };
  const onPointerMove = (e) => {
    if (!isDragging) return;
    e.stopPropagation();
    e.preventDefault();
    const clientY = getClientY(e);
    const deltaY = (clientY - startY) / chartCont.offsetHeight * 100;
    const newTop = Math.max(0, Math.min(100, startTop + deltaY)) + '%';
    wrapper.style.top = newTop;
  };

  const onPointerUp = (e) => {
    if (!isDragging) return;
    e.stopPropagation();
    e.preventDefault();
    isDragging = false;
    document.body.style.userSelect = '';
  };

  // Mouse events
  wrapper.addEventListener('mousedown', onPointerDown, { passive: false });
  document.addEventListener('mousemove', onPointerMove, { passive: false });
  document.addEventListener('mouseup', onPointerUp, { passive: false });
  // Touch events
  wrapper.addEventListener('touchstart', onPointerDown, { passive: false });
  document.addEventListener('touchmove', onPointerMove, { passive: false });
  document.addEventListener('touchend', onPointerUp, { passive: false });

  // Store handlers for cleanup if needed
  wrapper._localHandlers = { onPointerMove, onPointerUp, onPointerDown };
}

// ---------- Ø§Ø³Ú©Ø±ÙˆÙ„ drag Ø¨Ø±Ø§ÛŒ Ø¬Ø¯ÙˆÙ„ ----------
function setupTableDragScroll() {
  const container = document.getElementById('tableContainer');
  let isDragging = false;
  let startX;
  let scrollLeft;
  let clickCount = 0;
  let clickTimer = null;
  container.addEventListener('mousedown', (e) => {
    clickCount++;
    if (clickTimer) clearTimeout(clickTimer);
    clickTimer = setTimeout(() => {
      clickCount = 0;
    }, 300);

    if (clickCount >= 2 && e.detail === 2) {
      isDragging = false;
      container.style.userSelect = 'text';
      container.style.cursor = 'text';
      return;
    }

    isDragging = true;
    startX = e.pageX - container.offsetLeft;
    scrollLeft = 
      container.scrollLeft;
    container.classList.add('dragging');
    e.preventDefault();
  });
  container.addEventListener('mouseleave', () => {
    isDragging = false;
    container.classList.remove('dragging');
    container.style.userSelect = 'none';
    container.style.cursor = 'grab';
  });
  container.addEventListener('mouseup', () => {
    isDragging = false;
    container.classList.remove('dragging');
    container.style.userSelect = 'none';
    container.style.cursor = 'grab';
  });
  container.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    e.preventDefault();
    const x = e.pageX - container.offsetLeft;
    const walk = (x - startX) * 2;
    container.scrollLeft = scrollLeft - walk;
  });
  container.addEventListener('dblclick', (e) => {
    if (window.getSelection) {
      const selection = window.getSelection();
      const range = document.createRange();
      range.selectNodeContents(e.target);
      selection.removeAllRanges();
      selection.addRange(range);
    }
  });
}

// ---------- Event Listeners ----------
document.getElementById('deleteSelectedSymbol').addEventListener('click', ()=>{
  const sym = document.getElementById('selectedSymbol').value;
  if(!sym){ showToast('ÛŒÚ© Ø¬ÙØª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }
  if(!confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒ Ø¬ÙØª "${sym}" Ùˆ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒØ´ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ`)) return;
  delete store.symbols[sym];
  const idx = store.symbolOrder.indexOf(sym);
  if (idx > -1) store.symbolOrder.splice(idx, 1);
  saveStore();
  refreshSymbolsList();
  document.getElementById('summarySection').style.display = 'none';
  if(window._barChart) window._barChart.destroy();
  if (window._chart) window._chart.destroy();
});
  document.getElementById('addSymbolBtn').addEventListener('click', ()=>{
  const name = document.getElementById('newSymbol').value.trim().toUpperCase();
  if(!name){ showToast('Ù†Ø§Ù… Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  const sym = ensureSymbol(name);
  if(sym){
    document.getElementById('selectedSymbol').value = name;
    document.getElementById('selectedSymbol3').value = name;
    renderSummaryForRange(name, true, 5);
  }
});
  document.getElementById('useMidBtn').addEventListener('click', ()=>{
  const h = parseNum(document.getElementById('inputHigh').value);
  const l = parseNum(document.getElementById('inputLow').value);
  if(h===null && l===null){ showToast('Ø§Ø¨ØªØ¯Ø§ Ù…Ù‚Ø¯Ø§Ø± Mid ÛŒØ§ High/Low Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  if(h===null) document.getElementById('inputHigh').value = String(l);
  if(l===null) document.getElementById('inputLow').value = String(h);
});
  document.getElementById('addDayBtn').addEventListener('click', ()=>{
  const symName = document.getElementById('selectedSymbol').value;
  if(!symName){ showToast('Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø¬ÙØª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }
  const high = parseNum(document.getElementById('inputHigh').value);
  const low = parseNum(document.getElementById('inputLow').value);
  const date = document.getElementById('inputDate').value || null;
  if(high===null || low===null){ showToast('High Ùˆ Low Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  const ok = addDayToSymbol(symName, high, low, date);
  if(ok){ showToast('Ø«Ø¨Øª Ø´Ø¯'); renderSummaryForRange(symName, true, 5); document.getElementById('inputHigh').value = ''; document.getElementById('inputLow').value = ''; }
  else showToast('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª');
});
  document.getElementById('daysRangeToggle').addEventListener('click', () => {
  document.getElementById('daysRangeSection').style.display = 'block';
  document.getElementById('dateRangeSection').style.display = 'none';
  document.getElementById('daysRangeToggle').classList.add('active');
  document.getElementById('dateRangeToggle').classList.remove('active');
});
  document.getElementById('dateRangeToggle').addEventListener('click', () => {
  document.getElementById('daysRangeSection').style.display = 'none';
  document.getElementById('dateRangeSection').style.display = 'block';
  document.getElementById('dateRangeToggle').classList.add('active');
  document.getElementById('daysRangeToggle').classList.remove('active');
  
  const endDate = new Date();
  const startDate = new Date();
  startDate.setDate(startDate.getDate() - 7);
  
  document.getElementById('endDate').value = endDate.toISOString().slice(0,10);
  document.getElementById('startDate').value = startDate.toISOString().slice(0,10);
});
  document.getElementById('showDateRangeBtn').addEventListener('click', ()=>{
  const symName = document.getElementById('selectedSymbol3').value;
  if(!symName){ showToast('ÛŒÚ© Ø¬ÙØª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  
  if(!startDate || !endDate){ showToast('Ù„Ø·ÙØ§Ù‹ ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ùˆ Ù¾Ø§ÛŒØ§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }
  if(new Date(startDate) > new Date(endDate)){ showToast('ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø´Ø¯'); return; }
  
  renderSummaryForRange(symName, false, null, startDate, endDate);
});
  document.getElementById('showHistoryBtn').addEventListener('click', ()=>{
  const symName = document.getElementById('selectedSymbol3').value;
  if(!symName){ showToast('ÛŒÚ© Ø¬ÙØª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }
  const requestedDays = parseInt(document.getElementById('analysisDays').value) || 5;
  renderSummaryForRange(symName, true, requestedDays);
});
  document.getElementById('selectedSymbol3').addEventListener('change', () => {
  const symName = document.getElementById('selectedSymbol3').value;
  const isDaysRange = document.getElementById('daysRangeToggle').classList.contains('active');
  if (isDaysRange) {
    const requestedDays = parseInt(document.getElementById('analysisDays').value) || 5;
    renderSummaryForRange(symName, true, requestedDays);
  } else {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    if (startDate && endDate) {
      renderSummaryForRange(symName, false, null, startDate, endDate);
    }
  }
});
  document.getElementById('analysisDays').addEventListener('change', () => {
  const symName = document.getElementById('selectedSymbol3').value;
  if (symName && document.getElementById('daysRangeToggle').classList.contains('active')) {
    const requestedDays = parseInt(document.getElementById('analysisDays').value) || 5;
    renderSummaryForRange(symName, true, requestedDays);
  }
});
  document.getElementById('manualPruneBtn').addEventListener('click', function() {
  const days = parseInt(document.getElementById('manualPruneDays').value) || 365;
  if (days < 1) {
    showToast('ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² Û° Ø¨Ø§Ø´Ø¯');
    return;
  }
  
  if (confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ± Ø§Ø² ${days} Ø±ÙˆØ² Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ\nØ§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.`)) {
    const result = manualPruneOldEntries(days);
    if (result.totalDeleted > 0) {
      showToast(`âœ… ${result.totalDeleted} Ø±Ú©ÙˆØ±Ø¯ Ù‚Ø¯ÛŒÙ…ÛŒ Ø­Ø°Ù Ø´Ø¯.\nØ¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§ÛŒ affected: ${result.affectedSymbols.join(', ')}`);
      const currentSymbol = document.getElementById('selectedSymbol3').value;
      if (currentSymbol) {
    
        const isDaysRange = document.getElementById('daysRangeToggle').classList.contains('active');
        if (isDaysRange) {
          const requestedDays = parseInt(document.getElementById('analysisDays').value) || 5;
          renderSummaryForRange(currentSymbol, true, requestedDays);
        } else {
          const startDate = document.getElementById('startDate').value;
          const endDate = document.getElementById('endDate').value;
          if (startDate && endDate) {
            renderSummaryForRange(currentSymbol, false, null, startDate, endDate);
          }
        }
      }
    } else {
      showToast('â„¹ï¸ Ù‡ÛŒÚ† Ø±Ú©ÙˆØ±Ø¯ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù ÛŒØ§ÙØª Ù†Ø´Ø¯.');
    }
  }
});

document.getElementById('showStatsBtn').addEventListener('click', showSystemStats);
document.getElementById('closeStatsBtn').addEventListener('click', function() {
  document.getElementById('statsModal').style.display = 'none';
  document.getElementById('modalBg').style.display = 'none';
});
// ØªØ§Ø¨Ø¹ Ø§Ø¹Ù„Ø§Ù† Ø²ÛŒØ¨Ø§ (toast) Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯
function showToast(message, type = 'success') {
  let toast = document.getElementById('toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'toast';
    document.body.appendChild(toast);
  }
  toast.textContent = message;
  toast.className = `toast ${type}`;
  toast.classList.add('show');
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 300);
  }, 3000);
}

document.getElementById('exportBtn').addEventListener('click', ()=>{
  try {
    const dataStr = JSON.stringify(store, null, 2);
    const blob = new Blob([dataStr], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url;
    a.download = 'cst_analyzer-' + new Date().toISOString().slice(0,10) + '.json'; a.click(); URL.revokeObjectURL(url);
    showToast('âœ… ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯!');
  } catch (e) {
    showToast('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†: ' + e.message, 'error');
  }
});
// Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Ù†Ø± Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ Ø¬Ø¯ÛŒØ¯ ÙˆØ±ÙˆØ¯ÛŒ
document.getElementById('importBtn').addEventListener('click', () => {
    document.getElementById('importFile').click();
});
  document.getElementById('importFile').addEventListener('change', (e) => {
    const f = e.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = () => {
        try {
            let importedObj = JSON.parse(reader.result);
            if (!importedObj || !importedObj.symbols) {
                showToast('ÙØ§ÛŒÙ„ Ø¨Ú©â€ŒØ¢Ù¾ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª ÛŒØ§ Ø³Ø§Ø®ØªØ§Ø± Ø§Ø´ØªØ¨Ø§Ù‡ÛŒ Ø¯Ø§Ø±Ø¯.');
     
           return;
            }

            importedObj = sanitizeAndMigrateStore(importedObj);

            if (confirm('Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ§ÛŒÙ„ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø´ÙˆÙ†Ø¯ (OK) ÛŒØ§ Ø¨Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆÙ†Ø¯ (Cancel)ØŸ')) {
                store = importedObj;
            } else {
   
              Object.keys(importedObj.symbols || {}).forEach(k => {
                    store.symbols[k] = importedObj.symbols[k];
                });
                importedObj.symbolOrder.forEach(s => {
                    if (!store.symbolOrder.includes(s)) {
     
                   store.symbolOrder.push(s);
                    }
                });
             }

            saveStore();
            refreshSymbolsList();
            
            const sel = document.getElementById('selectedSymbol');
            const sel3 = document.getElementById('selectedSymbol3');
            if (sel.options.length > 0 && sel.options[0].value) {
                sel.value = sel.options[0].value;
                sel3.value = sel.options[0].value;
                const isDaysRange = document.getElementById('daysRangeToggle').classList.contains('active');
                if (isDaysRange) {
                  const requestedDays = parseInt(document.getElementById('analysisDays').value) ||
                  5;
                  renderSummaryForRange(sel.value, true, requestedDays);
                } else {
                  const startDate = document.getElementById('startDate').value;
                  const endDate = document.getElementById('endDate').value;
                  if (startDate && endDate) {
                    renderSummaryForRange(sel.value, false, null, startDate, endDate);
                  }
                }
            } else {
                document.getElementById('summarySection').style.display = 'none';
                if(window._barChart) window._barChart.destroy();
                if (window._chart) window._chart.destroy();
            }

            showToast('Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.');
            e.target.value = '';

        } catch (err) {
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„: ' + err);
        }
    };
    reader.readAsText(f);
});

// Ø¨Ù‚ÛŒÙ‡ event listeners Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±...
let currentEdit = null;
  function openEditModal(symName, idx){
  const sym = store.symbols[symName]; if(!sym) return;
  const rec = sym.history[idx]; if(!rec) return;
  currentEdit = { symName, idx };
  document.getElementById('editDate').value = rec.date;
  document.getElementById('editHigh').value = String(rec.high);
  document.getElementById('editLow').value = String(rec.low);
  document.getElementById('modalBg').style.display = 'block';
  document.getElementById('editModal').style.display = 'block';
}
document.getElementById('cancelEditBtn').addEventListener('click', ()=>{ currentEdit = null; document.getElementById('editModal').style.display='none'; document.getElementById('modalBg').style.display='none'; });
  document.getElementById('saveEditBtn').addEventListener('click', ()=>{
  if(!currentEdit) return;
  const { symName, idx } = currentEdit;
  const sym = store.symbols[symName]; if(!sym) return;
  const d = document.getElementById('editDate').value || new Date().toISOString().slice(0,10);
  const h = parseNum(document.getElementById('editHigh').value);
  const l = parseNum(document.getElementById('editLow').value);
  if(h===null || l===null){ showToast('High Ùˆ Low Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  sym.history[idx].date = d; sym.history[idx].high = h; sym.history[idx].low = l; sym.history[idx].mid = computeMid(h,l);
  recomputeAnalysesForSymbol(sym); saveStore();
  currentEdit = null; document.getElementById('editModal').style.display='none'; document.getElementById('modalBg').style.display='none';
  const isDaysRange = document.getElementById('daysRangeToggle').classList.contains('active');
  if (isDaysRange) {
    const requestedDays = parseInt(document.getElementById('analysisDays').value) ||
    5;
    renderSummaryForRange(symName, true, requestedDays);
  } else {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    if (startDate && endDate) {
      renderSummaryForRange(symName, false, null, startDate, endDate);
    }
  }
  checkAndAlertIfChange(symName);
});

let currentMove = null;
function openMoveModal(symName, idx){
  const sym = store.symbols[symName]; if(!sym) return;
  currentMove = { symName, idx };
  document.getElementById('moveToIndex').value = 1;
  document.getElementById('modalBg').style.display = 'block';
  document.getElementById('moveModal').style.display = 'block';
}
document.getElementById('cancelMoveBtn').addEventListener('click', ()=>{ currentMove = null; document.getElementById('moveModal').style.display='none'; document.getElementById('modalBg').style.display='none'; });
document.getElementById('doMoveBtn').addEventListener('click', ()=>{
  if(!currentMove) return;
  const { symName, idx } = currentMove;
  const sym = store.symbols[symName]; if(!sym) return;
  const to = parseInt(document.getElementById('moveToIndex').value);
  if(isNaN(to) || to < 1) { showToast('Ø´Ù…Ø§Ø±Ù‡Ù” Ø±Ø¯ÛŒÙ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†'); return; }
  const hist = sym.history;
  const toIndex = Math.max(0, Math.min(hist.length-1, hist.length - to));
  const [item] = hist.splice(idx,1);
  hist.splice(toIndex,0,item);
  recomputeAnalysesForSymbol(sym); saveStore();
  currentMove = null; document.getElementById('moveModal').style.display='none'; document.getElementById('modalBg').style.display='none';
  const isDaysRange = document.getElementById('daysRangeToggle').classList.contains('active');
  if (isDaysRange) {
    const requestedDays = parseInt(document.getElementById('analysisDays').value) || 5;
    renderSummaryForRange(symName, true, 
    requestedDays);
  } else {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    if (startDate && endDate) {
      renderSummaryForRange(symName, false, null, startDate, endDate);
    }
  }
  checkAndAlertIfChange(symName);
});

function speakTTS(text){
  if(!('speechSynthesis' in window)) return;
  const ut = new SpeechSynthesisUtterance(text); ut.lang = 'fa-IR';
  speechSynthesis.cancel(); speechSynthesis.speak(ut);
}
function playBeep(){
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine'; o.frequency.setValueAtTime(880, ctx.currentTime);
    g.gain.setTargetAtTime(0, ctx.currentTime, 0.02);
    o.connect(g); g.connect(ctx.destination); o.start();
    setTimeout(() => o.stop(), 400);
  } catch(e){}
}
function showAlertModal(title, body){
  const now = Date.now();
  if(now - lastAlertShownAt < ALERT_THROTTLE_MS) return;
  lastAlertShownAt = now;
  document.getElementById('alertTitle').textContent = title;
  document.getElementById('alertBody').textContent = body;
  document.getElementById('modalBg').style.display = 'block';
  document.getElementById('alertModal').style.display = 'block';
  const mode = document.getElementById('alertSoundMode').value;
  if(mode === 'tts' || mode === 'both') speakTTS('Ø§Ø­ØªÙ…Ø§Ù„ ØªØºÛŒÛŒØ± Ø±ÙˆÙ†Ø¯');
  if(mode === 'beep' || mode === 'both') playBeep();
}
document.getElementById('closeAlert').addEventListener('click', ()=>{ document.getElementById('alertModal').style.display = 'none'; document.getElementById('modalBg').style.display='none'; });
document.getElementById('testAlertBtn').addEventListener('click', ()=>{ showAlertModal('Ù‡Ø´Ø¯Ø§Ø± Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ','Ø§ÛŒÙ† ÛŒÚ© Ù‡Ø´Ø¯Ø§Ø± Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ø§Ø³Øª'); });
  function checkAndAlertIfChange(symName){
  const sym = store.symbols[symName]; if(!sym || !sym.lastSummary) return;
  const keyword = 'Ø§Ø­ØªÙ…Ø§Ù„ ØªØºÛŒÛŒØ±';
  const v5 = sym.lastSummary.last5 || ''; const v30 = sym.lastSummary.last30 || '';
  if((v5.includes(keyword)) || (v30.includes(keyword))){
    const body = `Ø¬ÙØª: ${symName}\nØªØ­Ù„ÛŒÙ„ Ûµ Ø±ÙˆØ²Ù‡: ${sym.lastSummary.last5}\nØªØ­Ù„ÛŒÙ„ Û³Û° Ø±ÙˆØ²Ù‡: ${sym.lastSummary.last30}`;
    showAlertModal('âš ï¸ Ø§Ø­ØªÙ…Ø§Ù„ ØªØºÛŒÛŒØ± Ø±ÙˆÙ†Ø¯ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯', body);
  }
}

function manualPruneOldEntries(days = 365) {
  const cutoffDate = new Date();
  cutoffDate.setDate(cutoffDate.getDate() - days);
  
  let totalDeleted = 0;
  let affectedSymbols = [];
  Object.keys(store.symbols).forEach(symbolName => {
    const symbol = store.symbols[symbolName];
    const initialLength = symbol.history.length;
    
    symbol.history = symbol.history.filter(record => {
      const recordDate = new Date(record.date);
      return recordDate >= cutoffDate;
    });
    
    const deletedCount = initialLength - symbol.history.length;
    if (deletedCount > 0) {
      totalDeleted += deletedCount;
      affectedSymbols.push(symbolName);
      recomputeAnalysesForSymbol(symbol);
    }
  });
  saveStore();
  return { totalDeleted, affectedSymbols };
}

function showSystemStats() {
  const totalSymbols = Object.keys(store.symbols).length;
  let totalRecords = 0;
  let oldestRecord = null;
  let newestRecord = null;

  Object.keys(store.symbols).forEach(symbolName => {
    const symbol = store.symbols[symbolName];
    totalRecords += symbol.history.length;
    
    symbol.history.forEach(record => {
      const recordDate = new Date(record.date);
      if (!oldestRecord || recordDate < oldestRecord) oldestRecord = recordDate;
      if (!newestRecord || recordDate > newestRecord) newestRecord = recordDate;
    });
  });
  const statsHTML = `
    <div style="background:#071826;padding:10px;border-radius:6px;margin-bottom:10px;">
      <div><strong>ğŸ“Š Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ Ø³ÛŒØ³ØªÙ…:</strong></div>
      <div>â€¢ ØªØ¹Ø¯Ø§Ø¯ Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§: ${totalSymbols}</div>
      <div>â€¢ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§: ${totalRecords}</div>
      <div>â€¢ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯: ${oldestRecord ?
      oldestRecord.toLocaleDateString('fa-IR') : '---'}</div>
      <div>â€¢ Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯: ${newestRecord ?
      newestRecord.toLocaleDateString('fa-IR') : '---'}</div>
    </div>
    <div style="background:#071826;padding:10px;border-radius:6px;">
      <div><strong>ğŸ”§ ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…:</strong></div>
      <div>â€¢ Ø­Ø°Ù Ø®ÙˆØ¯Ú©Ø§Ø±: âŒ ØºÛŒØ±ÙØ¹Ø§Ù„</div>
      <div>â€¢ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ: âœ… Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯</div>
      <div>â€¢ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªÛŒ: âœ… ÙØ¹Ø§Ù„</div>
    </div>
  `;
  document.getElementById('statsContent').innerHTML = statsHTML;
  document.getElementById('modalBg').style.display = 'block';
  document.getElementById('statsModal').style.display = 'block';
}

// Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ø³Ø§ÛŒØ² Ù¾Ù†Ø¬Ø±Ù‡ (Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ´Ø¯Ù‡)
window.addEventListener('resize', function() {
  if (window._barChart) {
    window._barChart.resize();
  }
  if (window._chart) {
    window._chart.resize();
  }
  resizeHorizontalLines(); // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ Ø§Ø³ØªØ®Ø±Ø§Ø¬â€ŒØ´Ø¯Ù‡
});
// ØªØ§Ø¨Ø¹ toggle Ø¨Ø±Ø§ÛŒ collapsible sections Ø¨Ø§ Ø°Ø®ÛŒØ±Ù‡ state (Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¨Ø®Ø´ Û²)
function toggleSection(sectionId) {
  const card = document.querySelector(`[data-section="${sectionId}"]`);
  const content = card.querySelector('.collapsible-content');
  const isOpen = card.classList.contains('open');
  card.classList.toggle('open');
  content.style.display = isOpen ? 'none' : 'block';
  saveSectionOpenState(sectionId, !isOpen);
  // Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø®Ø§Øµ Ø¨Ø±Ø§ÛŒ Ø¨Ø®Ø´ Û²: Ø§Ú¯Ø± Ø¨Ø§Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ summary Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ØŒ Ú†Ø§Ø±Øªâ€ŒÙ‡Ø§ Ùˆ Ø®Ø·ÙˆØ· Ø±Ø§ Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ Ú©Ù†
  if (sectionId === '2' && !isOpen) { // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ø¨Ø³ØªÙ‡ Ø¨ÙˆØ¯ Ùˆ Ø­Ø§Ù„Ø§ Ø¨Ø§Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯
    const symName = document.getElementById('selectedSymbol3').value;
    if (symName) {
      const isDaysRange = document.getElementById('daysRangeToggle').classList.contains('active');
      if (isDaysRange) {
        const requestedDays = parseInt(document.getElementById('analysisDays').value) || 5;
        setTimeout(() => renderSummaryForRange(symName, true, requestedDays), 100); // timeout Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ú©Ø§Ù…Ù„ Ø´Ø¯Ù† animation
      } else {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        if (startDate && endDate) {
          setTimeout(() => renderSummaryForRange(symName, false, null, startDate, endDate), 100);
        }
      }
    }
  }
}

// ---------- init ----------
document.addEventListener('DOMContentLoaded', () => {
  loadStore();
  loadSectionsOrder();
  refreshSymbolsList();
  const sel = document.getElementById('selectedSymbol');
  const sel3 = document.getElementById('selectedSymbol3');
  if(sel.value) { 
    const isDaysRange = document.getElementById('daysRangeToggle').classList.contains('active');
    if (isDaysRange) {
      const requestedDays = parseInt(document.getElementById('analysisDays').value) || 5;
      renderSummaryForRange(sel.value, true, requestedDays);
    } else {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      
      if (startDate && endDate) {
        
        renderSummaryForRange(sel.value, false, null, startDate, endDate);
      }
    }
    sel3.value = sel.value;
  }
  sel.addEventListener('change', ()=>{ 
    sel3.value = sel.value;
    const isDaysRange = document.getElementById('daysRangeToggle').classList.contains('active');
    if (isDaysRange) {
      const requestedDays = parseInt(document.getElementById('analysisDays').value) || 5;
      renderSummaryForRange(sel.value, true, requestedDays);
    } else {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      if (startDate && endDate) {
        renderSummaryForRange(sel.value, false, null, startDate, endDate);
      }
    }
  });
  if('speechSynthesis' in window){ window.speechSynthesis.onvoiceschanged = () => {};
  }

  // Ù„ÙˆØ¯ state Ø¨Ø§Ø²/Ø¨Ø³ØªÙ‡ Ø¨Ø®Ø´â€ŒÙ‡Ø§ Ø§Ø² localStorage (Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø³ØªÙ‡)
  document.querySelectorAll('.collapsible-card').forEach(card => {
    const sectionId = card.dataset.section;
    const isOpen = loadSectionOpenState(sectionId);
    if (isOpen) {
      card.classList.add('open');
      card.querySelector('.collapsible-content').style.display = 'block';
    } else {
      card.classList.remove('open');
      card.querySelector('.collapsible-content').style.display = 'none';
    }
  });
});

// Functions for store and sections (unchanged)
function sanitizeAndMigrateStore(data) {
    if (!data.symbols) data.symbols = {};
    if (!data.symbolOrder || !Array.isArray(data.symbolOrder)) {
        data.symbolOrder = Object.keys(data.symbols);
    } else {
        const symbolKeys = new Set(Object.keys(data.symbols));
        data.symbolOrder = data.symbolOrder.filter(s => symbolKeys.has(s));
        symbolKeys.forEach(s => {
            if (!data.symbolOrder.includes(s)) {
                data.symbolOrder.push(s);
            }
        });
    }
    return data;
}

function loadStore(){
  let s;
  try {
    s = localStorage.getItem(STORAGE_KEY);
    if(s) s = JSON.parse(s);
    else s = { symbols: {}, symbolOrder: [] };
  } catch(e){
    console.error(e);
    s = { symbols: {}, symbolOrder: [] };
  }
  store = sanitizeAndMigrateStore(s);
}

function saveStore(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
}

function loadSectionsOrder() {
  try {
    const saved = localStorage.getItem(SECTIONS_ORDER_KEY);
    if (saved) sectionsOrder = JSON.parse(saved);
  } catch (e) {
    console.error(e);
  }
}

function saveSectionsOrder() {
  localStorage.setItem(SECTIONS_ORDER_KEY, JSON.stringify(sectionsOrder));
}

function saveSectionOpenState(sectionId, isOpen) {
  localStorage.setItem(SECTION_OPEN_KEY + sectionId, isOpen ? 'open' : 'closed');
}

function loadSectionOpenState(sectionId) {
  try {
    return localStorage.getItem(SECTION_OPEN_KEY + sectionId) === 'open';
  } catch (e) {
    return false;
  }
}
</script>

<div class="footer">
    Ø·Ø±Ø§Ø­ÛŒ Ùˆ Ø³Ø§Ø®Øª ØªÙˆØ³Ø· â¤ï¸ Ø³Ø¹ÛŒØ¯ Ø´ÛŒØ® Ø§Ø­Ù…Ø¯ ØµÙØ§Ø±ÛŒ
</div>
  <BR>
    <BR>
</body>
</html>
