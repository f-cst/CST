<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CST Geometry Analyzer</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± */
  :root {
    --bg-primary: #071020;
    --bg-secondary: #0b1220;
    --bg-tertiary: #071826;
    --border-color: #163043;
    --text-primary: #e6eef8;
    --text-secondary: #9fb3c8;
    --accent-color: #0ea5a4;
    --danger-color: #ef4444;
    --success-color: #10b981;
  }
  
  * {
    box-sizing: border-box;
  }
  
  body {
    font-family: system-ui, "Segoe UI", Roboto, Tahoma, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    padding: 12px;
    margin: 0;
    line-height: 1.5;
  }
  
  .container {
    max-width: 1150px;
    margin: 0 auto;
  }
  
  .card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    padding: 16px;
    border-radius: 10px;
    margin-bottom: 16px;
    overflow: hidden;
  }
  
  h1, h2, h3 {
    margin-top: 0;
    color: var(--text-primary);
  }
  
  h1 {
    font-size: 1.5rem;
    text-align: center;
    margin-bottom: 20px;
  }
  
  h3 {
    font-size: 1.2rem;
    margin-bottom: 12px;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 8px;
  }
  
  label {
    display: block;
    margin-bottom: 6px;
    color: var(--text-secondary);
    font-size: 0.9rem;
  }
  
  input, select, textarea, button {
    font-family: inherit;
    font-size: 1rem;
  }
  
  input, select, textarea {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #234;
    background: var(--bg-tertiary);
    color: var(--text-primary);
    margin-bottom: 8px;
  }
  
  .row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 10px;
  }
  
  .col {
    flex: 1;
    min-width: 0;
  }
  
  button {
    background: var(--accent-color);
    color: #021;
    padding: 10px 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
    margin-bottom: 8px;
    white-space: nowrap;
    width: auto;
    min-width: 120px;
    display: inline-block;
  }
  
  button:hover {
    opacity: 0.9;
    transform: translateY(-1px);
  }
  
  .btn-full {
    width: 100%;
  }
  
  .btn-danger {
    background: var(--danger-color);
    color: white;
  }
  
  .btn-success {
    background: var(--success-color);
    color: white;
  }
  
  .btn-small {
    padding: 8px 12px;
    font-size: 0.85rem;
    min-width: 100px;
  }
  
  .btn-auto {
    width: auto;
  }
  
  .btn-group {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 8px;
    font-size: 0.85rem;
  }
  
  th, td {
    padding: 8px;
    border-bottom: 1px solid var(--bg-tertiary);
    text-align: center;
    white-space: nowrap;
  }
  
  th {
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    font-weight: 500;
  }
  
  .small {
    font-size: 0.8rem;
    color: var(--text-secondary);
    line-height: 1.4;
  }
  
  .symbols-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
    min-height: 60px;
    padding: 12px;
    background: var(--bg-tertiary);
    border-radius: 8px;
    border: 1px solid var(--border-color);
    align-items: flex-start;
  }
  
  .chip {
    display: inline-flex;
    padding: 10px 16px;
    border-radius: 8px;
    background: linear-gradient(135deg, #062b2a, #0a3a38);
    color: #9ff;
    cursor: grab;
    margin: 4px;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    font-weight: 500;
    user-select: none;
    border: 1px solid #0ea5a4;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    position: relative;
    min-width: 80px;
    justify-content: center;
    align-items: center;
  }
  
  .chip:hover {
    background: linear-gradient(135deg, #0ea5a4, #0d9488);
    color: #021;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(14, 165, 164, 0.3);
  }
  
  .chip.dragging {
    opacity: 0.8;
    cursor: grabbing;
    transform: rotate(5deg) scale(1.05);
    z-index: 1000;
    box-shadow: 0 6px 12px rgba(14, 165, 164, 0.4);
  }
  
  .chip-placeholder {
    display: inline-block;
    padding: 10px 16px;
    margin: 4px;
    border: 2px dashed #0ea5a4;
    border-radius: 8px;
    opacity: 0.6;
    background: rgba(14, 165, 164, 0.1);
    min-width: 80px;
    height: 40px;
  }
  
  .chip-overlay {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--accent-color);
    color: #021;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: bold;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .chip:hover .chip-overlay {
    opacity: 1;
  }
  
  .controls {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  
  pre {
    background: #041219;
    padding: 8px;
    border-radius: 6px;
    color: var(--text-secondary);
    white-space: pre-wrap;
    font-size: 0.8rem;
    overflow-x: auto;
  }
  
  .icon-btn {
    background: transparent;
    border: 1px solid #234;
    color: var(--text-secondary);
    padding: 6px 8px;
    border-radius: 6px;
    cursor: pointer;
    width: auto;
    margin: 2px;
    font-size: 0.8rem;
    min-width: auto;
  }
  
  .action-col {
    white-space: nowrap;
  }
  
  .action-col button {
    width: auto;
    display: inline-block;
    margin: 0 2px;
    min-width: auto;
  }
  
  #alertModal, #statsModal, #editModal, #moveModal {
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: #061322;
    border: 2px solid #16424a;
    padding: 20px;
    border-radius: 10px;
    z-index: 10000;
    display: none;
    width: 90%;
    max-width: 420px;
    max-height: 80vh;
    overflow-y: auto;
  }
  
  .modal-bg {
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.45);
    z-index: 9998;
    display: none;
  }
  
  .date-range-toggle {
    background: #1e3a5f;
    color: var(--text-primary);
    border: 1px solid #234;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    width: auto;
    min-width: auto;
  }
  
  .date-range-toggle.active {
    background: var(--accent-color);
    color: #021;
  }
  
  .danger-zone {
    background: #7f1d1d;
    border: 1px solid rgba(239,68,68,0.3);
    padding: 16px;
    border-radius: 8px;
    margin-top: 16px;
  }
  
  .text-center {
    text-align: center;
  }
  
  .mb-2 {
    margin-bottom: 8px;
  }
  
  .mt-2 {
    margin-top: 8px;
  }
  
  .w-full {
    width: 100%;
  }
  
  .flex {
    display: flex;
  }
  
  .flex-1 {
    flex: 1;
  }
  
  .items-center {
    align-items: center;
  }
  
  .gap-2 {
    gap: 8px;
  }
  
  .block {
    display: block;
  }
  
  .hidden {
    display: none;
  }
  
  .form-group {
    margin-bottom: 12px;
  }
  
  .chart-wrapper {
    position: relative;
    width: 100%;
    margin-top: 16px;
    background: var(--bg-tertiary);
    border-radius: 8px;
    padding: 16px;
    border: 1px solid var(--border-color);
  }
  
  .chart-container {
    position: relative;
    width: 100%;
    height: 400px;
  }
  
  @media (max-width: 768px) {
    body {
      padding: 8px;
    }
    
    .card {
      padding: 12px;
      margin-bottom: 12px;
    }
    
    h1 {
      font-size: 1.3rem;
    }
    
    h3 {
      font-size: 1.1rem;
    }
    
    .row {
      flex-direction: column;
      gap: 8px;
    }
    
    .col {
      width: 100%;
    }
    
    button {
      padding: 12px;
      font-size: 1rem;
      width: 100%;
      min-width: auto;
    }
    
    .btn-group {
      flex-direction: column;
    }
    
    .btn-group button {
      width: 100%;
    }
    
    .chart-container {
      height: 300px;
    }
    
    .chart-wrapper {
      padding: 12px;
    }
    
    .symbols-grid {
      padding: 8px;
      gap: 6px;
    }
    
    .chip {
      padding: 8px 12px;
      font-size: 0.8rem;
      min-width: 70px;
    }
    
    table {
      font-size: 0.75rem;
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }
    
    th, td {
      padding: 6px 4px;
    }
    
    .icon-btn {
      padding: 4px 6px;
      font-size: 0.7rem;
    }
    
    input, select, textarea {
      padding: 12px;
    }
  }
  
  @media (max-width: 480px) {
    body {
      padding: 6px;
    }
    
    .card {
      padding: 10px;
    }
    
    h1 {
      font-size: 1.2rem;
    }
    
    .chart-container {
      height: 250px;
    }
    
    .symbols-grid {
      padding: 6px;
      gap: 4px;
    }
    
    .chip {
      padding: 6px 10px;
      font-size: 0.75rem;
      min-width: 60px;
    }
    
    table {
      font-size: 0.7rem;
    }
    
    th, td {
      padding: 4px 2px;
    }
  }
  
  .history-table-container {
    overflow-x: auto;
    margin-top: 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
  }
  
  .history-card {
    background: var(--bg-tertiary);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    border: 1px solid var(--border-color);
  }
  
  .history-card .row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    padding-bottom: 6px;
  }
  
  .history-card .row:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }
  
  .history-card .label {
    color: var(--text-secondary);
    font-size: 0.8rem;
  }
  
  .history-card .value {
    color: var(--text-primary);
    font-size: 0.9rem;
    text-align: left;
  }
  
  .history-card .actions {
    display: flex;
    justify-content: center;
    gap: 6px;
    margin-top: 8px;
  }
  
  .footer {
    color: white;
    text-align: center;
    padding: 16px;
    font-family: Vazirmatn, system-ui;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    font-size: 14px;
    font-weight: 500;
    display: block;
    margin: 30px auto;
    width: fit-content;
    max-width: 90%;
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ù„Ø§Ù† Ø¯Ø§Ù†Ù„ÙˆØ¯ (toast) */
  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    min-width: 250px;
    background: var(--success-color);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 10001;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    font-size: 0.9rem;
    text-align: center;
    font-weight: 500;
  }
  
  .toast.show {
    transform: translateX(0);
  }
  
  .toast.error {
    background: var(--danger-color);
  }

  @media (max-width: 768px) {
    .toast {
      right: 10px;
      left: 10px;
      min-width: auto;
      top: 10px;
    }
  }
</style>
</head>
<body>
<div class="container">
  <h1>CST Geometry Analyzer â€” Ù¾ÛŒØ´Ø±ÙØªÙ‡</h1>

  <div class="card">
    <h3>Û±) Ù…Ø¯ÛŒØ±ÛŒØª Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§ (Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¢Ø²Ø§Ø¯)</h3>
    <div class="form-group">
      <label>Ù†Ø§Ù… Ø¬ÙØªâ€ŒØ§Ø±Ø² (Ù…Ø«Ø§Ù„: EURUSD ÛŒØ§ BTCUSD)</label>
      <input id="newSymbol" placeholder="Ù†Ø§Ù… Ø¬ÙØªâ€ŒØ§Ø±Ø² Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯">
    </div>
    
    <div class="btn-group">
      <button id="addSymbolBtn">Ø§ÙØ²ÙˆØ¯Ù† / Ø§Ù†ØªØ®Ø§Ø¨</button>
    </div>

    <div class="small">Ù„ÛŒØ³Øª Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§ (Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ / Ø¨Ø±Ø§ÛŒ Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¢Ø²Ø§Ø¯ Ø¨Ú©Ø´ÛŒØ¯ Ùˆ Ø±Ù‡Ø§ Ú©Ù†ÛŒØ¯):</div>
    
    <div id="symbolsList" class="symbols-grid">
    </div>
    
    <div style="margin-top:8px" class="small">
      ğŸ’¡ <strong>Ø§Ù…Ú©Ø§Ù† Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¢Ø²Ø§Ø¯:</strong> Ù‡Ø± Ø¬ÙØª Ø§Ø±Ø²ÛŒ Ø±Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯Ø± Ù‡Ø± Ù…ÙˆÙ‚Ø¹ÛŒØªÛŒ Ø§Ø² ØµÙØ­Ù‡ Ùˆ Ú©Ù†Ø§Ø± Ù‡Ø± Ø¬ÙØª Ø§Ø±Ø² Ø¯ÛŒÚ¯Ø±ÛŒ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯
    </div>
    <BR>
    <div class="btn-group">
      <button id="deleteSelectedSymbol" class="btn-danger">Ø­Ø°Ù Ø¬ÙØª Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡</button>
    </div>
  </div>

  <div class="card">
    <h3>Û²) ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† / Ø«Ø¨Øª Ø±ÙˆØ² Ø¬Ø¯ÛŒØ¯</h3>
    <div class="small">Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø¬ÙØª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†. Ø³Ù¾Ø³ High Ùˆ Low Ø±ÙˆØ² Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù† (ÛŒØ§ Mid).</div>

    <div class="row">
      <div class="col">
        <label>Ø¬ÙØª Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡</label>
        <select id="selectedSymbol"></select>
      </div>
      <div class="col">
        <label>ØªØ§Ø±ÛŒØ® (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
        <input id="inputDate" type="date">
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>High Ø±ÙˆØ² Ø¬Ø¯ÛŒØ¯</label>
        <input id="inputHigh" placeholder="Ù…Ø«Ø§Ù„: 76500">
      </div>
      <div class="col">
        <label>Low Ø±ÙˆØ² Ø¬Ø¯ÛŒØ¯</label>
        <input id="inputLow" placeholder="Ù…Ø«Ø§Ù„: 76300">
      </div>
    </div>
    
    <div class="btn-group">
      <button id="addDayBtn">Ø«Ø¨Øª Ø±ÙˆØ² Ø¬Ø¯ÛŒØ¯</button>
      <button id="useMidBtn" class="btn-small">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø®ÙˆØ¯Ú©Ø§Ø±</button>
      <button id="voiceToggle" class="btn-small">ğŸ”Š ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ ÙØ±Ù…Ø§Ù† ØµÙˆØªÛŒ</button>
    </div>

    <div style="margin-top:6px" class="small">Ø§Ú¯Ø± ÙÙ‚Ø· Mid Ø¯Ø§Ø±ÛŒØŒ High = Low = Mid Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡ ÛŒØ§ Ø§Ø² Ø¯Ú©Ù…Ù‡ Â«Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø®ÙˆØ¯Ú©Ø§Ø±Â» Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†.</div>
  </div>

  <div class="card">
    <h3>Û³) Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ùˆ ØªØ­Ù„ÛŒÙ„ (ÙˆÛŒØ±Ø§ÛŒØ´ / Ø­Ø°Ù / Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§)</h3>
    
    <div style="margin-bottom:12px">
      <label>Ù†ÙˆØ¹ Ø¨Ø§Ø²Ù‡ ØªØ­Ù„ÛŒÙ„</label>
      <div class="btn-group">
        <button id="daysRangeToggle" class="date-range-toggle active">ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø§Ø² Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†</button>
        <button id="dateRangeToggle" class="date-range-toggle">Ø¨Ø§Ø²Ù‡ ØªØ§Ø±ÛŒØ® Ø¯Ù„Ø®ÙˆØ§Ù‡</button>
      </div>
    </div>

    <div id="daysRangeSection">
      <div class="form-group">
        <label>Ø¨Ø§Ø²Ù‡Ù” ØªØ­Ù„ÛŒÙ„ (ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø§Ø² Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†)</label>
        <input id="analysisDays" type="number" min="2" max="1000" value="5">
        <div class="small">Ù¾ÛŒØ´â€ŒÙØ±Ø¶ = 5 Ø±ÙˆØ². Ø¨Ø±Ø§ÛŒ Ù…Ø«Ø§Ù„ 7 ÛŒØ§ 17 ÙˆØ§Ø±Ø¯ Ú©Ù† Ùˆ Ø³Ù¾Ø³ Â«Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ùˆ ØªØ­Ù„ÛŒÙ„Â» Ø±Ø§ Ø¨Ø²Ù†.</div>
      </div>
      
      <div class="btn-group">
        <button id="showHistoryBtn">Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ùˆ ØªØ­Ù„ÛŒÙ„</button>
      </div>
    </div>

    <div id="dateRangeSection" class="hidden">
      <div class="row">
        <div class="col">
          <label>ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</label>
          <input id="startDate" type="date">
        </div>
        <div class="col">
          <label>ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†</label>
          <input id="endDate" type="date">
        </div>
      </div>
      
      <div class="btn-group">
        <button id="showDateRangeBtn">Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ùˆ ØªØ­Ù„ÛŒÙ„</button>
      </div>
      
      <div class="small">ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ùˆ Ù¾Ø§ÛŒØ§Ù† Ø¯Ù„Ø®ÙˆØ§Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 2024-09-10 ØªØ§ 2024-09-13)</div>
    </div>

    <div id="analysisOut" style="margin-top:12px;display:none"></div>
    
    <div class="chart-wrapper">
      <div class="chart-container">
        <canvas id="midChart"></canvas>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Û´) Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h3>
    
    <div class="row">
      <div class="col">
        <label>Ù†ÙˆØ¹ Ù‡Ø´Ø¯Ø§Ø± ØµÙˆØªÛŒ Ù‡Ù†Ú¯Ø§Ù… Â«Ø§Ø­ØªÙ…Ø§Ù„ ØªØºÛŒÛŒØ± Ø±ÙˆÙ†Ø¯Â»</label>
        <select id="alertSoundMode">
          <option value="tts">TTS (ØµØ¯Ø§ÛŒ Ø²Ù†Ø§Ù†Ù‡ ÙØ§Ø±Ø³ÛŒ)</option>
          <option value="beep">Beep Ø³Ø§Ø¯Ù‡</option>
          <option value="both">Ù‡Ø± Ø¯Ùˆ (TTS + Beep)</option>
          <option value="off">Ø®Ø§Ù…ÙˆØ´</option>
        </select>
      </div>
      <div class="col">
        <label>&nbsp;</label>
        <button id="testAlertBtn">Ø¢Ø²Ù…Ø§ÛŒØ´ Ù‡Ø´Ø¯Ø§Ø±</button>
      </div>
    </div>

    <div class="btn-group">
      <button id="exportBtn">Ø®Ø±ÙˆØ¬ÛŒ (Backup)</button>
    </div>
    
    <div class="form-group">
      <label>ÙˆØ±ÙˆØ¯ÛŒ (Restore)</label>
      <input id="importFile" type="file" accept=".json">
    </div>

    <div class="danger-zone">
      <div class="text-center mb-2">
        <span style="color: white; font-weight: bold;">âš™ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</span>
      </div>
      
      <div class="mb-3">
        <label class="small block mb-1">Ø­Ø°Ù Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ± Ø§Ø²:</label>
        <div class="flex gap-2">
          <input id="manualPruneDays" type="number" min="1" max="3650" value="365" style="flex:1; text-align:center;">
          <span class="small flex items-center">Ø±ÙˆØ²</span>
        </div>
        <button id="manualPruneBtn" class="btn-danger w-full mt-2">
          Ø­Ø°Ù Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ
        </button>
      </div>

      <button id="showStatsBtn" class="w-full mb-2">
        Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
      </button>

      <p class="small text-center mt-2">Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù‡Ø³ØªÙ†Ø¯</p>
    </div>
  </div>

  <div class="card small">
    <strong>ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§:</strong>
    <ul>
      <li>âœ… <strong>Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯:</strong> Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ Ø·ÙˆØ± Ø¯Ø§Ø¦Ù…ÛŒ Ø­ÙØ¸ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ (Ø­ØªÛŒ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ)</li>
      <li>âœ… <strong>Ø­Ø°Ù Ø¯Ø³ØªÛŒ:</strong> ÙÙ‚Ø· Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø¨Ø®Ø´ "Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§" Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯</li>
      <li>ØªØ­Ù„ÛŒÙ„ Ø²Ø§ÙˆÛŒÙ‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Mid Ù‡Ø± Ø±ÙˆØ² Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Mid = (High+Low)/2). Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù†Ù…Ø§ÛŒØ´ ØªØ­Ù„ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¬ÙØª Ûµ Ø±ÙˆØ²Ù‡ Ø§Ø³Øª Ø§Ù…Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ø¹Ø¯Ø¯ Ø¯Ù„Ø®ÙˆØ§Ù‡ 2..1000 ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒ.</li>
      <li>ÙØ±Ù…Ø§Ù† ØµÙˆØªÛŒ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ø¬Ø§Ø²Ù‡ Ù…Ø±ÙˆØ±Ú¯Ø± Ø¯Ø§Ø±Ø¯ â€” Ù…Ù…Ú©Ù† Ø§Ø³Øª ÛŒÚ©â€ŒØ¨Ø§Ø± Ø§Ø¬Ø§Ø²Ù‡ Ø¨Ø®ÙˆØ§Ù‡Ø¯.</li>
    </ul>
  </div>

</div>

<div id="statsModal">
  <h3>ğŸ“Š Ø¢Ù…Ø§Ø± Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ…</h3>
  <div id="statsContent" style="margin-bottom:10px;color:#e6eef8"></div>
  <div class="btn-group">
    <button id="closeStatsBtn">Ø¨Ø³ØªÙ†</button>
  </div>
</div>

<div id="alertModal">
  <h3 id="alertTitle">âš ï¸ Ù‡Ø´Ø¯Ø§Ø±: Ø§Ø­ØªÙ…Ø§Ù„ ØªØºÛŒÛŒØ± Ø±ÙˆÙ†Ø¯</h3>
  <div id="alertBody" style="margin-bottom:10px;color:#ffd9d9"></div>
  <div class="btn-group">
    <button id="closeAlert">Ø¨Ø³ØªÙ†</button>
  </div>
</div>
<div class="modal-bg" id="modalBg"></div>

<div id="editModal">
  <h3>âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ø±Ú©ÙˆØ±Ø¯</h3>
  <div class="small" style="margin-bottom:6px">Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªØ§Ø±ÛŒØ®ØŒ High Ùˆ Low Ø±Ú©ÙˆØ±Ø¯ Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯.</div>
  <div style="margin-bottom:8px">
    <label>ØªØ§Ø±ÛŒØ®</label><input id="editDate" type="date">
    <label>High</label><input id="editHigh">
    <label>Low</label><input id="editLow">
  </div>
  <div class="btn-group">
    <button id="saveEditBtn">Ø°Ø®ÛŒØ±Ù‡</button>
    <button id="cancelEditBtn" class="btn-danger">Ø§Ù†ØµØ±Ø§Ù</button>
  </div>
</div>

<div id="moveModal">
  <h3>ğŸ”€ Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ø±Ú©ÙˆØ±Ø¯</h3>
  <div class="small" style="margin-bottom:6px">Ø´Ù…Ø§Ø±Ù‡Ù” Ø¬Ø¯ÛŒØ¯ Ø±Ø¯ÛŒÙ (1 = Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†ØŒ ...)</div>
  <div style="margin-bottom:8px">
    <label>Ø´Ù…Ø§Ø±Ù‡ Ø±Ø¯ÛŒÙ Ø¬Ø¯ÛŒØ¯ (1..30)</label><input id="moveToIndex" type="number" min="1" max="30" value="1">
  </div>
  <div class="btn-group">
    <button id="doMoveBtn">Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ</button>
    <button id="cancelMoveBtn" class="btn-danger">Ø§Ù†ØµØ±Ø§Ù</button>
  </div>
</div>

<script>
// ---------- helpers ----------
function parseNum(v){
  if(v===null||v===undefined) return null;
  v = String(v).trim();
  if(v==="") return null;
  v = v.replace(/[Û°-Û¹]/g, d => String('Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d)));
  v = v.replace(/,/g, '.');
  v = v.replace(/\./g, '');
  
  const n = Number(v);
  return isNaN(n)?null:n;
}

const STORAGE_KEY = 'cst_data_final_v5';
let store = { symbols: {}, symbolOrder: [] };
let voiceEnabled = false;
let lastAlertShownAt = 0;
const ALERT_THROTTLE_MS = 3000;

function sanitizeAndMigrateStore(data) {
    if (!data.symbols) data.symbols = {};
    if (!data.symbolOrder || !Array.isArray(data.symbolOrder)) {
        data.symbolOrder = Object.keys(data.symbols);
    } else {
        const symbolKeys = new Set(Object.keys(data.symbols));
        data.symbolOrder = data.symbolOrder.filter(s => symbolKeys.has(s));
        symbolKeys.forEach(s => {
            if (!data.symbolOrder.includes(s)) {
                data.symbolOrder.push(s);
            }
        });
    }
    return data;
}

function loadStore(){
  let s;
  try {
    s = localStorage.getItem(STORAGE_KEY);
    if(s) s = JSON.parse(s);
    else s = { symbols: {}, symbolOrder: [] };
  } catch(e){
    console.error(e);
    s = { symbols: {}, symbolOrder: [] };
  }
  store = sanitizeAndMigrateStore(s);
}

function saveStore(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); }

// ---------- Drag & Drop Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¢Ø²Ø§Ø¯ ----------
function refreshSymbolsList(){
  const container = document.getElementById('symbolsList');
  const sel = document.getElementById('selectedSymbol');
  const currentSelected = sel.value;
  
  container.innerHTML = ''; 
  sel.innerHTML = '';
  
  const names = store.symbolOrder || [];
  if(names.length === 0){
    container.innerHTML = '<div class="small" style="width:100%; text-align:center; padding:20px;">Ù‡ÛŒÚ† Ø¬ÙØªâ€ŒØ§Ø±Ø²ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡. ÛŒÚ© Ù†Ø§Ù… ÙˆØ§Ø±Ø¯ Ú©Ù† Ùˆ Â«Ø§ÙØ²ÙˆØ¯Ù†Â» Ø¨Ø²Ù†.</div>';
    const opt = document.createElement('option');
    opt.value = '';
    opt.text = '-- Ø¬ÙØª Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ --';
    sel.appendChild(opt);
    return;
  }

  names.forEach((name, index) => {
    const chip = createSymbolChip(name, index);
    container.appendChild(chip);
  });

  names.forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.text = name;
    sel.appendChild(opt);
  });
  
  if (currentSelected && names.includes(currentSelected)) {
    sel.value = currentSelected;
  } else if (names.length > 0) {
    sel.value = names[0];
  }

  setupFreeDragAndDrop(container);
}

function createSymbolChip(name, index) {
  const chip = document.createElement('div');
  chip.className = 'chip';
  chip.textContent = name;
  chip.dataset.symbolName = name;
  chip.dataset.index = index;
  chip.draggable = true;
  
  const overlay = document.createElement('div');
  overlay.className = 'chip-overlay';
  overlay.textContent = 'â‡…';
  chip.appendChild(overlay);
  
  chip.onclick = () => { 
    document.getElementById('selectedSymbol').value = name; 
    renderAnalysisFor(name); 
  };
  
  return chip;
}

function setupFreeDragAndDrop(container) {
  let draggedItem = null;
  let placeholder = null;

  container.querySelectorAll('.chip').forEach(chip => {
    chip.addEventListener('dragstart', function(e) {
      draggedItem = this;
      this.classList.add('dragging');
      
      placeholder = document.createElement('div');
      placeholder.className = 'chip-placeholder';
      this.parentNode.insertBefore(placeholder, this.nextSibling);
      
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', this.dataset.symbolName);
    });

    chip.addEventListener('dragend', function() {
      this.classList.remove('dragging');
      
      if (placeholder && placeholder.parentNode) {
        placeholder.parentNode.removeChild(placeholder);
      }
      
      draggedItem = null;
      placeholder = null;
      
      updateSymbolOrderFromFreeDOM();
    });
  });

  container.addEventListener('dragover', function(e) {
    e.preventDefault();
    if (!draggedItem) return;
    
    const afterElement = getFreeDragAfterElement(container, e.clientX, e.clientY);
    
    if (afterElement == null) {
      container.appendChild(placeholder);
    } else {
      container.insertBefore(placeholder, afterElement);
    }
  });

  container.addEventListener('drop', function(e) {
    e.preventDefault();
    if (!draggedItem) return;
    
    if (placeholder && placeholder.parentNode) {
      container.insertBefore(draggedItem, placeholder);
      placeholder.parentNode.removeChild(placeholder);
    }
    
    draggedItem.classList.remove('dragging');
    draggedItem = null;
    placeholder = null;
    
    updateSymbolOrderFromFreeDOM();
  });
}

function getFreeDragAfterElement(container, x, y) {
  const draggableElements = [...container.querySelectorAll('.chip:not(.dragging)')];
  
  return draggableElements.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offsetX = x - box.left - box.width / 2;
    const offsetY = y - box.top - box.height / 2;
    
    const distance = Math.sqrt(offsetX * offsetX + offsetY * offsetY);
    
    if (distance < 100 && distance > closest.distance) {
      return { distance: distance, element: child };
    } else {
      return closest;
    }
  }, { distance: Number.NEGATIVE_INFINITY, element: null }).element;
}

function updateSymbolOrderFromFreeDOM() {
  const container = document.getElementById('symbolsList');
  const newOrder = Array.from(container.querySelectorAll('.chip'))
    .map(chip => chip.dataset.symbolName);
  
  store.symbolOrder = newOrder;
  saveStore();
  
  refreshSymbolDropdown();
}

function refreshSymbolDropdown() {
  const sel = document.getElementById('selectedSymbol');
  const currentSelected = sel.value;
  sel.innerHTML = '';
  
  store.symbolOrder.forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.text = name;
    sel.appendChild(opt);
  });
  
  if (currentSelected && store.symbolOrder.includes(currentSelected)) {
    sel.value = currentSelected;
  } else if (store.symbolOrder.length > 0) {
    sel.value = store.symbolOrder[0];
  }
}

function ensureSymbol(name){
  name = String(name || '').trim().toUpperCase();
  if(!name) return null;
  if(!store.symbols[name]){
    store.symbols[name] = { name, history: [], created: Date.now() };
    if (!store.symbolOrder.includes(name)) {
      store.symbolOrder.push(name);
    }
    saveStore();
    refreshSymbolsList();
  }
  return store.symbols[name];
}

function computeMid(high, low){ return (high + low) / 2; }

function analyzeAnglesFor(midArray, windows=5){
  if(!midArray || midArray.length < 2) return {angles:[], avgAbs:0, verdict:'Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª'};
  const use = Math.min(windows, midArray.length);
  const arr = midArray.slice(-use);
  const angles = [];
  for(let i=0;i<arr.length-1;i++){
    const dp = arr[i+1] - arr[i];
    const ang = Math.atan(dp/1) * 180 / Math.PI;
    angles.push(ang);
  }
  const absAngles = angles.map(a=>Math.abs(a));
  const avgAbs = absAngles.length ? (absAngles.reduce((s,x)=>s+x,0)/absAngles.length) : 0;
  const pos = angles.filter(a=>a>0).length;
  const neg = angles.filter(a=>a<0).length;
  const lastSign = angles.length ? (angles[angles.length-1] > 0 ? 'pos' : (angles[angles.length-1] < 0 ? 'neg' : 'zero')) : 'zero';
  let verdict = '';
  const majority = pos >= neg ? 'pos' : 'neg';
  let weakening = false;
  if(absAngles.length >= 2){
    const la = absAngles;
    if(la[la.length-1] < la[la.length-2] && la[la.length-2] <= (la[la.length-3]||Infinity)) weakening = true;
  }
  if(lastSign !== 'zero' && lastSign !== majority) verdict = 'ğŸ”´ Ø§Ø­ØªÙ…Ø§Ù„ ØªØºÛŒÛŒØ± Ø±ÙˆÙ†Ø¯ (Ø¹Ù„Ø§Ù…Øª Ø§Ø®ÛŒØ± Ù…Ø®Ø§Ù„Ù Ø§Ú©Ø«Ø±ÛŒØª)';
  else {
    if(avgAbs > 45) verdict = 'ğŸ”µ Ø§Ø¯Ø§Ù…Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡Ù” Ù‚ÙˆÛŒ';
    else if(avgAbs >= 25) verdict = 'ğŸŸ¡ Ø±ÙˆÙ†Ø¯ Ù…ØªÙˆØ³Ø· â€” Ù…Ø±Ø§Ù‚Ø¨ Ø§ØµÙ„Ø§Ø­';
    else verdict = 'ğŸ”» ÙØ´Ø±Ø¯Ú¯ÛŒ ÛŒØ§ Ø¶Ø¹Ù Ø±ÙˆÙ†Ø¯ â€” Ø§Ø­ØªÙ…Ø§Ù„ ØªØºÛŒÛŒØ± ÛŒØ§ Ø´Ú©Ø³Øª Ù†Ø§Ú¯Ù‡Ø§Ù†ÛŒ';
    if(weakening) verdict += '\nâš ï¸ Ù†Ø´Ø§Ù†Ù‡Ù” ØªØ¶Ø¹ÛŒÙ: Ø²Ø§ÙˆÛŒÙ‡â€ŒÙ‡Ø§ Ú©Ø§Ù‡Ø´ ÛŒØ§ÙØªÙ‡â€ŒØ§Ù†Ø¯';
  }
  return {angles, avgAbs, verdict};
}

function addDayToSymbol(symName, high, low, dateStr=null){
  const sym = store.symbols[symName]; if(!sym) return false;
  const h = parseFloat(high); const l = parseFloat(low);
  if(isNaN(h) || isNaN(l)) return false;
  const mid = computeMid(h,l);
  const rec = { date: dateStr || new Date().toISOString().slice(0,10), high:h, low:l, mid };
  sym.history.push(rec);
  
  recomputeAnalysesForSymbol(sym);
  saveStore(); return true;
}

function recomputeAnalysesForSymbol(sym){
  sym.history.forEach((r, idx) => {
    const window5 = sym.history.slice(Math.max(0, idx-4), idx+1).map(x=>x.mid);
    r.analysis5 = analyzeAnglesFor(window5, window5.length).verdict || '';
    const window30 = sym.history.slice(Math.max(0, idx-29), idx+1).map(x=>x.mid);
    r.analysis30 = analyzeAnglesFor(window30, window30.length).verdict || '';
  });
  const mids = sym.history.map(r=>r.mid);
  const last5 = analyzeAnglesFor(mids, Math.min(5,mids.length));
  const last30 = analyzeAnglesFor(mids, Math.min(30,mids.length));
  sym.lastSummary = { date: (sym.history[sym.history.length-1]||{}).date || '', last5:last5.verdict, last30:last30.verdict, avgAngle5:last5.avgAbs, avgAngle30:last30.avgAbs };
}

// ---------- ØªÙˆØ§Ø¨Ø¹ ØªØ­Ù„ÛŒÙ„ Ùˆ Ù†Ù…Ø§ÛŒØ´ ----------
function renderAnalysisFor(symName){
  const out = document.getElementById('analysisOut');
  const sym = store.symbols[symName];
  if(!sym){ out.style.display='none'; if(window._chart) window._chart.destroy(); return; }

  const hist = sym.history.slice();
  if(hist.length===0){ out.style.display='block'; out.innerHTML='Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¬ÙØª Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.'; if(window._chart) window._chart.destroy(); return; }
  
  const requestedDays = (() => {
    const v = parseInt(document.getElementById('analysisDays').value);
    if(isNaN(v) || v < 2) return 5;
    return Math.min(1000, v);
  })();

  const midsForAnalysis = hist.map(h => h.mid);
  const lastN = analyzeAnglesFor(midsForAnalysis, Math.min(requestedDays, midsForAnalysis.length));
  
  const summaryHtml = `<div><strong>Ø®Ù„Ø§ØµÙ‡ (Ø¨Ø§Ø²Ù‡Ù” ${requestedDays} Ø±ÙˆØ²Ù‡ - Ø§Ø² Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø±ÙˆØ²):</strong><br>
    Ù†ØªÛŒØ¬Ù‡ ØªØ­Ù„ÛŒÙ„: ${lastN.verdict || '-'} <br>
    Ø²Ø§ÙˆÛŒÙ‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†: ${lastN.avgAbs.toFixed(2)}Â° <br>
    (ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ø¨Ø§Ø²Ù‡: ${Math.min(requestedDays, midsForAnalysis.length)})</div>`;

  let table = `<div class="history-table-container"><table><thead><tr>
    <th>Ø±Ø¯ÛŒÙ</th><th>ØªØ§Ø±ÛŒØ®</th><th>High</th><th>Low</th><th>Mid</th><th>ØªØ­Ù„ÛŒÙ„ Ûµâ€ŒØ±ÙˆØ²Ù‡</th><th>ØªØ­Ù„ÛŒÙ„ Û³Û°â€ŒØ±ÙˆØ²Ù‡</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
    </tr></thead><tbody>`;

  const startIndex = Math.max(0, hist.length - requestedDays);
  for(let i = hist.length - 1; i >= startIndex; i--){
    const r = hist[i];
    const rowIndex = hist.length - i;
    table += `<tr data-idx="${i}">
      <td>${rowIndex}</td><td>${r.date}</td><td>${r.high}</td><td>${r.low}</td><td>${r.mid.toFixed(2)}</td><td>${r.analysis5||''}</td><td>${r.analysis30||''}</td>
      <td class="action-col">
        <button class="icon-btn edit-btn" data-idx="${i}">âœï¸</button>
        <button class="icon-btn del-btn" data-idx="${i}">âŒ</button>
        <button class="icon-btn move-btn" data-idx="${i}">ğŸ”€</button>
      </td>
    </tr>`;
  }
  table += `</tbody></table></div>`;
  out.style.display='block';
  out.innerHTML = `<div class="small">${summaryHtml}</div>${table}`;

  out.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', () => openEditModal(symName, parseInt(btn.dataset.idx))));
  out.querySelectorAll('.del-btn').forEach(btn => btn.addEventListener('click', () => {
    if(!confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒ Ø§ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
    sym.history.splice(parseInt(btn.dataset.idx),1); recomputeAnalysesForSymbol(sym); saveStore(); renderAnalysisFor(symName); checkAndAlertIfChange(symName);
  }));
  out.querySelectorAll('.move-btn').forEach(btn => btn.addEventListener('click', () => openMoveModal(symName, parseInt(btn.dataset.idx))));

  const displayHist = hist.slice(-requestedDays);
  const chartLabels = displayHist.map(h=>h.date);
  const chartMids = displayHist.map(h=>h.mid);
  const ctx = document.getElementById('midChart').getContext('2d');
  if(window._chart) window._chart.destroy();
  window._chart = new Chart(ctx, {
    type: 'line',
    data: { labels: chartLabels, datasets: [{ label: symName + ' â€” Mid', data: chartMids, fill:false, borderWidth:2, tension:0.2, borderColor: '#0ea5a4' }] },
    options: { 
      responsive: true,
      maintainAspectRatio: false,
      plugins:{ legend:{ display:false } }, 
      scales:{ 
        y: { 
          beginAtZero:false, 
          ticks: { color: '#9fb3c8' }, 
          grid: { color: 'rgba(159, 179, 200, 0.1)' } 
        }, 
        x: { 
          ticks: { color: '#9fb3c8' }, 
          grid: { color: 'rgba(159, 179, 200, 0.1)' } 
        } 
      } 
    }
  });
}

function renderAnalysisForDateRange(symName, startDate, endDate) {
  const out = document.getElementById('analysisOut');
  const sym = store.symbols[symName];
  if(!sym){ out.style.display='none'; if(window._chart) window._chart.destroy(); return; }

  const hist = sym.history.slice();
  if(hist.length===0){ out.style.display='block'; out.innerHTML='Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¬ÙØª Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.'; if(window._chart) window._chart.destroy(); return; }
  
  // Filter records by date range
  const filteredHist = hist.filter(record => {
    const recordDate = new Date(record.date);
    const start = new Date(startDate);
    const end = new Date(endDate);
    return recordDate >= start && recordDate <= end;
  });

  if(filteredHist.length === 0) {
    out.style.display='block'; 
    out.innerHTML=`Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¯Ø± Ø¨Ø§Ø²Ù‡ ${startDate} ØªØ§ ${endDate} ÛŒØ§ÙØª Ù†Ø´Ø¯.`;
    if(window._chart) window._chart.destroy(); 
    return;
  }

  const midsForAnalysis = filteredHist.map(h => h.mid);
  const analysis = analyzeAnglesFor(midsForAnalysis, midsForAnalysis.length);
  
  const summaryHtml = `<div><strong>Ø®Ù„Ø§ØµÙ‡ (Ø¨Ø§Ø²Ù‡ ØªØ§Ø±ÛŒØ® ${startDate} ØªØ§ ${endDate}):</strong><br>
    Ù†ØªÛŒØ¬Ù‡ ØªØ­Ù„ÛŒÙ„: ${analysis.verdict || '-'} <br>
    Ø²Ø§ÙˆÛŒÙ‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†: ${analysis.avgAbs.toFixed(2)}Â° <br>
    (ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ø¨Ø§Ø²Ù‡: ${filteredHist.length})</div>`;

  let table = `<div class="history-table-container"><table><thead><tr>
    <th>Ø±Ø¯ÛŒÙ</th><th>ØªØ§Ø±ÛŒØ®</th><th>High</th><th>Low</th><th>Mid</th><th>ØªØ­Ù„ÛŒÙ„ Ûµâ€ŒØ±ÙˆØ²Ù‡</th><th>ØªØ­Ù„ÛŒÙ„ Û³Û°â€ŒØ±ÙˆØ²Ù‡</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
    </tr></thead><tbody>`;

  for(let i = filteredHist.length - 1; i >= 0; i--){
    const r = filteredHist[i];
    const rowIndex = filteredHist.length - i;
    // Find original index for operations
    const originalIdx = hist.findIndex(origRec => origRec.date === r.date && origRec.high === r.high && origRec.low === r.low);
    
    table += `<tr data-idx="${originalIdx}">
      <td>${rowIndex}</td><td>${r.date}</td><td>${r.high}</td><td>${r.low}</td><td>${r.mid.toFixed(2)}</td><td>${r.analysis5||''}</td><td>${r.analysis30||''}</td>
      <td class="action-col">
        <button class="icon-btn edit-btn" data-idx="${originalIdx}">âœï¸</button>
        <button class="icon-btn del-btn" data-idx="${originalIdx}">âŒ</button>
        <button class="icon-btn move-btn" data-idx="${originalIdx}">ğŸ”€</button>
      </td>
    </tr>`;
  }
  table += `</tbody></table></div>`;
  out.style.display='block';
  out.innerHTML = `<div class="small">${summaryHtml}</div>${table}`;

  out.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', () => openEditModal(symName, parseInt(btn.dataset.idx))));
  out.querySelectorAll('.del-btn').forEach(btn => btn.addEventListener('click', () => {
    if(!confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒ Ø§ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
    sym.history.splice(parseInt(btn.dataset.idx),1); recomputeAnalysesForSymbol(sym); saveStore(); renderAnalysisForDateRange(symName, startDate, endDate); checkAndAlertIfChange(symName);
  }));
  out.querySelectorAll('.move-btn').forEach(btn => btn.addEventListener('click', () => openMoveModal(symName, parseInt(btn.dataset.idx))));

  const chartLabels = filteredHist.map(h=>h.date);
  const chartMids = filteredHist.map(h=>h.mid);
  const ctx = document.getElementById('midChart').getContext('2d');
  if(window._chart) window._chart.destroy();
  window._chart = new Chart(ctx, {
    type: 'line',
    data: { labels: chartLabels, datasets: [{ label: symName + ' â€” Mid', data: chartMids, fill:false, borderWidth:2, tension:0.2, borderColor: '#0ea5a4' }] },
    options: { 
      responsive: true,
      maintainAspectRatio: false,
      plugins:{ legend:{ display:false } }, 
      scales:{ 
        y: { 
          beginAtZero:false, 
          ticks: { color: '#9fb3c8' }, 
          grid: { color: 'rgba(159, 179, 200, 0.1)' } 
        }, 
        x: { 
          ticks: { color: '#9fb3c8' }, 
          grid: { color: 'rgba(159, 179, 200, 0.1)' } 
        } 
      } 
    }
  });
}

// ---------- Event Listeners ----------
// [Ù‡Ù…Ø§Ù† event listeners Ù‚Ø¨Ù„ÛŒ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±]

document.getElementById('deleteSelectedSymbol').addEventListener('click', ()=>{
  const sym = document.getElementById('selectedSymbol').value;
  if(!sym){ alert('ÛŒÚ© Ø¬ÙØª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }
  if(!confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒ Ø¬ÙØª "${sym}" Ùˆ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒØ´ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ`)) return;
  delete store.symbols[sym];
  const idx = store.symbolOrder.indexOf(sym);
  if (idx > -1) store.symbolOrder.splice(idx, 1);
  saveStore();
  refreshSymbolsList();
  document.getElementById('analysisOut').style.display = 'none';
  if(window._chart) window._chart.destroy();
});

document.getElementById('addSymbolBtn').addEventListener('click', ()=>{
  const name = document.getElementById('newSymbol').value.trim().toUpperCase();
  if(!name){ alert('Ù†Ø§Ù… Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  const sym = ensureSymbol(name);
  if(sym){
    document.getElementById('selectedSymbol').value = name;
    renderAnalysisFor(name);
  }
});

document.getElementById('useMidBtn').addEventListener('click', ()=>{
  const h = parseNum(document.getElementById('inputHigh').value);
  const l = parseNum(document.getElementById('inputLow').value);
  if(h===null && l===null){ alert('Ø§Ø¨ØªØ¯Ø§ Ù…Ù‚Ø¯Ø§Ø± Mid ÛŒØ§ High/Low Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  if(h===null) document.getElementById('inputHigh').value = String(l);
  if(l===null) document.getElementById('inputLow').value = String(h);
});

document.getElementById('addDayBtn').addEventListener('click', ()=>{
  const symName = document.getElementById('selectedSymbol').value;
  if(!symName){ alert('Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø¬ÙØª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }
  const high = parseNum(document.getElementById('inputHigh').value);
  const low = parseNum(document.getElementById('inputLow').value);
  const date = document.getElementById('inputDate').value || null;
  if(high===null || low===null){ alert('High Ùˆ Low Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  const ok = addDayToSymbol(symName, high, low, date);
  if(ok){ alert('Ø«Ø¨Øª Ø´Ø¯'); renderAnalysisFor(symName); document.getElementById('inputHigh').value = ''; document.getElementById('inputLow').value = ''; }
  else alert('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª');
});

document.getElementById('daysRangeToggle').addEventListener('click', () => {
  document.getElementById('daysRangeSection').style.display = 'block';
  document.getElementById('dateRangeSection').style.display = 'none';
  document.getElementById('daysRangeToggle').classList.add('active');
  document.getElementById('dateRangeToggle').classList.remove('active');
});

document.getElementById('dateRangeToggle').addEventListener('click', () => {
  document.getElementById('daysRangeSection').style.display = 'none';
  document.getElementById('dateRangeSection').style.display = 'block';
  document.getElementById('dateRangeToggle').classList.add('active');
  document.getElementById('daysRangeToggle').classList.remove('active');
  
  const endDate = new Date();
  const startDate = new Date();
  startDate.setDate(startDate.getDate() - 7);
  
  document.getElementById('endDate').value = endDate.toISOString().slice(0,10);
  document.getElementById('startDate').value = startDate.toISOString().slice(0,10);
});

document.getElementById('showDateRangeBtn').addEventListener('click', ()=>{
  const symName = document.getElementById('selectedSymbol').value;
  if(!symName){ alert('ÛŒÚ© Ø¬ÙØª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  
  if(!startDate || !endDate){ alert('Ù„Ø·ÙØ§Ù‹ ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ùˆ Ù¾Ø§ÛŒØ§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }
  if(new Date(startDate) > new Date(endDate)){ alert('ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø´Ø¯'); return; }
  
  renderAnalysisForDateRange(symName, startDate, endDate);
});

document.getElementById('showHistoryBtn').addEventListener('click', ()=>{
  const symName = document.getElementById('selectedSymbol').value;
  if(!symName){ alert('ÛŒÚ© Ø¬ÙØª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }
  renderAnalysisFor(symName);
});

document.getElementById('manualPruneBtn').addEventListener('click', function() {
  const days = parseInt(document.getElementById('manualPruneDays').value) || 365;
  if (days < 1) {
    alert('ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² Û° Ø¨Ø§Ø´Ø¯');
    return;
  }
  
  if (confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ± Ø§Ø² ${days} Ø±ÙˆØ² Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ\nØ§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.`)) {
    const result = manualPruneOldEntries(days);
    if (result.totalDeleted > 0) {
      alert(`âœ… ${result.totalDeleted} Ø±Ú©ÙˆØ±Ø¯ Ù‚Ø¯ÛŒÙ…ÛŒ Ø­Ø°Ù Ø´Ø¯.\nØ¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§ÛŒ affected: ${result.affectedSymbols.join(', ')}`);
      const currentSymbol = document.getElementById('selectedSymbol').value;
      if (currentSymbol) {
        renderAnalysisFor(currentSymbol);
      }
    } else {
      alert('â„¹ï¸ Ù‡ÛŒÚ† Ø±Ú©ÙˆØ±Ø¯ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù ÛŒØ§ÙØª Ù†Ø´Ø¯.');
    }
  }
});

document.getElementById('showStatsBtn').addEventListener('click', showSystemStats);
document.getElementById('closeStatsBtn').addEventListener('click', function() {
  document.getElementById('statsModal').style.display = 'none';
  document.getElementById('modalBg').style.display = 'none';
});

// ØªØ§Ø¨Ø¹ Ø§Ø¹Ù„Ø§Ù† Ø²ÛŒØ¨Ø§ (toast) Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯
function showToast(message, type = 'success') {
  let toast = document.getElementById('toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'toast';
    document.body.appendChild(toast);
  }
  toast.textContent = message;
  toast.className = `toast ${type}`;
  toast.classList.add('show');
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 300);
  }, 3000);
}

document.getElementById('exportBtn').addEventListener('click', ()=>{
  try {
    const dataStr = JSON.stringify(store, null, 2);
    const blob = new Blob([dataStr], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url;
    a.download = 'cst_analyzer-' + new Date().toISOString().slice(0,10) + '.json'; a.click(); URL.revokeObjectURL(url);
    showToast('âœ… ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯!');
  } catch (e) {
    showToast('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†: ' + e.message, 'error');
  }
});

document.getElementById('importFile').addEventListener('change', (e) => {
    const f = e.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = () => {
        try {
            let importedObj = JSON.parse(reader.result);
            if (!importedObj || !importedObj.symbols) {
                alert('ÙØ§ÛŒÙ„ Ø¨Ú©â€ŒØ¢Ù¾ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª ÛŒØ§ Ø³Ø§Ø®ØªØ§Ø± Ø§Ø´ØªØ¨Ø§Ù‡ÛŒ Ø¯Ø§Ø±Ø¯.');
                return;
            }

            importedObj = sanitizeAndMigrateStore(importedObj);

            if (confirm('Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ§ÛŒÙ„ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø´ÙˆÙ†Ø¯ (OK) ÛŒØ§ Ø¨Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆÙ†Ø¯ (Cancel)ØŸ')) {
                store = importedObj;
            } else {
                Object.keys(importedObj.symbols || {}).forEach(k => {
                    store.symbols[k] = importedObj.symbols[k];
                });
                importedObj.symbolOrder.forEach(s => {
                    if (!store.symbolOrder.includes(s)) {
                        store.symbolOrder.push(s);
                    }
                });
            }

            saveStore();
            refreshSymbolsList();
            
            const sel = document.getElementById('selectedSymbol');
            if (sel.options.length > 0 && sel.options[0].value) {
                sel.value = sel.options[0].value;
                renderAnalysisFor(sel.value);
            } else {
                document.getElementById('analysisOut').style.display = 'none';
                if(window._chart) window._chart.destroy();
            }

            alert('Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.');
            e.target.value = '';

        } catch (err) {
            alert('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„: ' + err);
        }
    };
    reader.readAsText(f);
});

// Ø¨Ù‚ÛŒÙ‡ event listeners Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±...
let currentEdit = null;
function openEditModal(symName, idx){
  const sym = store.symbols[symName]; if(!sym) return;
  const rec = sym.history[idx]; if(!rec) return;
  currentEdit = { symName, idx };
  document.getElementById('editDate').value = rec.date;
  document.getElementById('editHigh').value = String(rec.high);
  document.getElementById('editLow').value = String(rec.low);
  document.getElementById('modalBg').style.display = 'block';
  document.getElementById('editModal').style.display = 'block';
}
document.getElementById('cancelEditBtn').addEventListener('click', ()=>{ currentEdit = null; document.getElementById('editModal').style.display='none'; document.getElementById('modalBg').style.display='none'; });
document.getElementById('saveEditBtn').addEventListener('click', ()=>{
  if(!currentEdit) return;
  const { symName, idx } = currentEdit;
  const sym = store.symbols[symName]; if(!sym) return;
  const d = document.getElementById('editDate').value || new Date().toISOString().slice(0,10);
  const h = parseNum(document.getElementById('editHigh').value);
  const l = parseNum(document.getElementById('editLow').value);
  if(h===null || l===null){ alert('High Ùˆ Low Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  sym.history[idx].date = d; sym.history[idx].high = h; sym.history[idx].low = l; sym.history[idx].mid = computeMid(h,l);
  recomputeAnalysesForSymbol(sym); saveStore();
  currentEdit = null; document.getElementById('editModal').style.display='none'; document.getElementById('modalBg').style.display='none';
  renderAnalysisFor(symName); checkAndAlertIfChange(symName);
});

let currentMove = null;
function openMoveModal(symName, idx){
  const sym = store.symbols[symName]; if(!sym) return;
  currentMove = { symName, idx };
  document.getElementById('moveToIndex').value = 1;
  document.getElementById('modalBg').style.display = 'block';
  document.getElementById('moveModal').style.display = 'block';
}
document.getElementById('cancelMoveBtn').addEventListener('click', ()=>{ currentMove = null; document.getElementById('moveModal').style.display='none'; document.getElementById('modalBg').style.display='none'; });
document.getElementById('doMoveBtn').addEventListener('click', ()=>{
  if(!currentMove) return;
  const { symName, idx } = currentMove;
  const sym = store.symbols[symName]; if(!sym) return;
  const to = parseInt(document.getElementById('moveToIndex').value);
  if(isNaN(to) || to < 1) { alert('Ø´Ù…Ø§Ø±Ù‡Ù” Ø±Ø¯ÛŒÙ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†'); return; }
  const hist = sym.history;
  const toIndex = Math.max(0, Math.min(hist.length-1, hist.length - to));
  const [item] = hist.splice(idx,1);
  hist.splice(toIndex,0,item);
  recomputeAnalysesForSymbol(sym); saveStore();
  currentMove = null; document.getElementById('moveModal').style.display='none'; document.getElementById('modalBg').style.display='none';
  renderAnalysisFor(symName); checkAndAlertIfChange(symName);
});

function enableVoiceForField(fieldId){
  const el = document.getElementById(fieldId); if(!el) return;
  el.addEventListener('click', ()=>{
    if(!window.webkitSpeechRecognition && !window.SpeechRecognition){ alert('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² ÙØ±Ù…Ø§Ù† ØµÙˆØªÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯ (Chrome Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯).'); return; }
    const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new Rec();
    recognition.lang = 'fa-IR'; recognition.interimResults = false; recognition.maxAlternatives = 1;
    recognition.start();
    recognition.onresult = (ev) => { el.value = ev.results[0][0].transcript.replace(/[Û°-Û¹]/g, d => String('Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d))).replace(/[^\d\.\-\,]/g, ''); };
  });
}
document.getElementById('voiceToggle').addEventListener('click', ()=>{
  voiceEnabled = !voiceEnabled;
  if(voiceEnabled){
    ['inputHigh','inputLow','editHigh','editLow'].forEach(id=>enableVoiceForField(id));
    alert('ÙØ±Ù…Ø§Ù† ØµÙˆØªÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯.');
    document.getElementById('voiceToggle').textContent = 'ğŸ”Š ÙØ±Ù…Ø§Ù† ØµÙˆØªÛŒ ÙØ¹Ø§Ù„ Ø§Ø³Øª';
  } else {
    alert('ÙØ±Ù…Ø§Ù† ØµÙˆØªÛŒ Ø®Ø§Ù…ÙˆØ´ Ø´Ø¯.');
    document.getElementById('voiceToggle').textContent = 'ğŸ”Š ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ ÙØ±Ù…Ø§Ù† ØµÙˆØªÛŒ';
  }
});

function speakTTS(text){
  if(!('speechSynthesis' in window)) return;
  const ut = new SpeechSynthesisUtterance(text); ut.lang = 'fa-IR';
  speechSynthesis.cancel(); speechSynthesis.speak(ut);
}
function playBeep(){
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator(); const g = ctx.createGain();
    o.type = 'sine'; o.frequency.setValueAtTime(880, ctx.currentTime);
    g.gain.setTargetAtTime(0, ctx.currentTime, 0.02);
    o.connect(g); g.connect(ctx.destination); o.start();
    setTimeout(() => o.stop(), 400);
  } catch(e){}
}
function showAlertModal(title, body){
  const now = Date.now();
  if(now - lastAlertShownAt < ALERT_THROTTLE_MS) return;
  lastAlertShownAt = now;
  document.getElementById('alertTitle').textContent = title;
  document.getElementById('alertBody').textContent = body;
  document.getElementById('modalBg').style.display = 'block';
  document.getElementById('alertModal').style.display = 'block';
  const mode = document.getElementById('alertSoundMode').value;
  if(mode === 'tts' || mode === 'both') speakTTS('Ø§Ø­ØªÙ…Ø§Ù„ ØªØºÛŒÛŒØ± Ø±ÙˆÙ†Ø¯');
  if(mode === 'beep' || mode === 'both') playBeep();
}
document.getElementById('closeAlert').addEventListener('click', ()=>{ document.getElementById('alertModal').style.display = 'none'; document.getElementById('modalBg').style.display='none'; });
document.getElementById('testAlertBtn').addEventListener('click', ()=>{ showAlertModal('Ù‡Ø´Ø¯Ø§Ø± Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ','Ø§ÛŒÙ† ÛŒÚ© Ù‡Ø´Ø¯Ø§Ø± Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ø§Ø³Øª'); });

function checkAndAlertIfChange(symName){
  const sym = store.symbols[symName]; if(!sym || !sym.lastSummary) return;
  const keyword = 'Ø§Ø­ØªÙ…Ø§Ù„ ØªØºÛŒÛŒØ±';
  const v5 = sym.lastSummary.last5 || ''; const v30 = sym.lastSummary.last30 || '';
  if((v5.includes(keyword)) || (v30.includes(keyword))){
    const body = `Ø¬ÙØª: ${symName}\nØªØ­Ù„ÛŒÙ„ Ûµ Ø±ÙˆØ²Ù‡: ${sym.lastSummary.last5}\nØªØ­Ù„ÛŒÙ„ Û³Û° Ø±ÙˆØ²Ù‡: ${sym.lastSummary.last30}`;
    showAlertModal('âš ï¸ Ø§Ø­ØªÙ…Ø§Ù„ ØªØºÛŒÛŒØ± Ø±ÙˆÙ†Ø¯ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯', body);
  }
}

function manualPruneOldEntries(days = 365) {
  const cutoffDate = new Date();
  cutoffDate.setDate(cutoffDate.getDate() - days);
  
  let totalDeleted = 0;
  let affectedSymbols = [];

  Object.keys(store.symbols).forEach(symbolName => {
    const symbol = store.symbols[symbolName];
    const initialLength = symbol.history.length;
    
    symbol.history = symbol.history.filter(record => {
      const recordDate = new Date(record.date);
      return recordDate >= cutoffDate;
    });
    
    const deletedCount = initialLength - symbol.history.length;
    if (deletedCount > 0) {
      totalDeleted += deletedCount;
      affectedSymbols.push(symbolName);
      recomputeAnalysesForSymbol(symbol);
    }
  });

  saveStore();
  return { totalDeleted, affectedSymbols };
}

function showSystemStats() {
  const totalSymbols = Object.keys(store.symbols).length;
  let totalRecords = 0;
  let oldestRecord = null;
  let newestRecord = null;

  Object.keys(store.symbols).forEach(symbolName => {
    const symbol = store.symbols[symbolName];
    totalRecords += symbol.history.length;
    
    symbol.history.forEach(record => {
      const recordDate = new Date(record.date);
      if (!oldestRecord || recordDate < oldestRecord) oldestRecord = recordDate;
      if (!newestRecord || recordDate > newestRecord) newestRecord = recordDate;
    });
  });

  const statsHTML = `
    <div style="background:#071826;padding:10px;border-radius:6px;margin-bottom:10px;">
      <div><strong>ğŸ“Š Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ Ø³ÛŒØ³ØªÙ…:</strong></div>
      <div>â€¢ ØªØ¹Ø¯Ø§Ø¯ Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§: ${totalSymbols}</div>
      <div>â€¢ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§: ${totalRecords}</div>
      <div>â€¢ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯: ${oldestRecord ? oldestRecord.toLocaleDateString('fa-IR') : '---'}</div>
      <div>â€¢ Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯: ${newestRecord ? newestRecord.toLocaleDateString('fa-IR') : '---'}</div>
    </div>
    <div style="background:#071826;padding:10px;border-radius:6px;">
      <div><strong>ğŸ”§ ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…:</strong></div>
      <div>â€¢ Ø­Ø°Ù Ø®ÙˆØ¯Ú©Ø§Ø±: âŒ ØºÛŒØ±ÙØ¹Ø§Ù„</div>
      <div>â€¢ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ: âœ… Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯</div>
      <div>â€¢ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªÛŒ: âœ… ÙØ¹Ø§Ù„</div>
    </div>
  `;

  document.getElementById('statsContent').innerHTML = statsHTML;
  document.getElementById('modalBg').style.display = 'block';
  document.getElementById('statsModal').style.display = 'block';
}

// Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ø³Ø§ÛŒØ² Ù¾Ù†Ø¬Ø±Ù‡
window.addEventListener('resize', function() {
  if (window._chart) {
    window._chart.resize();
  }
});

// ---------- init ----------
document.addEventListener('DOMContentLoaded', () => {
  loadStore();
  refreshSymbolsList();
  const sel = document.getElementById('selectedSymbol');
  if(sel.value) { renderAnalysisFor(sel.value); }
  sel.addEventListener('change', ()=>{ renderAnalysisFor(sel.value); });
  if('speechSynthesis' in window){ window.speechSynthesis.onvoiceschanged = () => {}; }

  // Ø­ÙØ¸ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø§Ø³Ú©Ø±ÙˆÙ„
  const SCROLL_KEY = 'cst_scroll_position';
  const savedScroll = localStorage.getItem(SCROLL_KEY);
  if (savedScroll) {
    window.scrollTo(0, parseInt(savedScroll));
  }

  window.addEventListener('scroll', () => {
    localStorage.setItem(SCROLL_KEY, window.scrollY);
  });

  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      const pos = localStorage.getItem(SCROLL_KEY);
      if (pos) {
        window.scrollTo(0, parseInt(pos));
      }
    }
  });

  window.addEventListener('focus', () => {
    const pos = localStorage.getItem(SCROLL_KEY);
    if (pos) {
      window.scrollTo(0, parseInt(pos));
    }
  });
});
</script>

<div class="footer">
    Ø·Ø±Ø§Ø­ÛŒ Ùˆ Ø³Ø§Ø®Øª ØªÙˆØ³Ø· â¦™ Ø³Ø¹ÛŒØ¯ Ø´ÛŒØ® Ø§Ø­Ù…Ø¯ ØµÙØ§Ø±ÛŒ
</div>
  <BR>
    <BR>
</body>
</html>
